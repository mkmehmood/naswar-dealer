<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#000000">

    <link rel="apple-touch-icon" href="192.png">

    <title>GULL AND ZUBAIR NASWAR DEALERS</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

 <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').then(reg => {
        console.log('Service Worker Registered!', reg);
        
        // Check for updates every time page loads
        reg.update();
        
        // Listen for new updates found
        reg.onupdatefound = () => {
          const installingWorker = reg.installing;
          installingWorker.onstatechange = () => {
            if (installingWorker.state === 'installed') {
              if (navigator.serviceWorker.controller) {
                console.log('New content is available; please refresh.');
                // Optional: Show a toast here asking user to refresh
              } else {
                console.log('Content is cached for offline use.');
              }
            }
          };
        };
      }).catch(err => console.log('Service Worker Registration Failed', err));

      // Force refresh when new SW takes control
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    });
  }

  // Your existing URL param logic
  const urlParams = new URLSearchParams(window.location.search);
  const action = urlParams.get('action');
  if(action === 'sales') showTab('sales');
  if(action === 'production') showTab('prod');
  if(action === 'calc') showTab('calc');
</script>


    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Great+Vibes&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
</head>

    
    <style>
        /* === iOS 26 LIQUID GLASS THEME === */
        :root {
            /* Dark Gradient Background */
            --bg-gradient: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            
            /* Glass Elements with Depth */
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            
            /* Text Colors */
            --text-main: #ffffff;
            --text-muted: #a0a0b0;
            
            /* Accent Colors - Vibrant & Futuristic */
            --accent: #007aff;
            --accent-emerald: #30d158;
            --warning: #ff9f0a;
            --danger: #ff375f;
            
            /* Input & Interactive Elements */
            --input-bg: rgba(255, 255, 255, 0.06);
            --card-hover: rgba(255, 255, 255, 0.1);
            
            /* Shadows with Depth */
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2);
            
            /* Blur Effects */
            --backdrop-blur: blur(40px) saturate(180%);
            
            /* Highlight */
            --highlight-bg: rgba(0, 122, 255, 0.15);
            --highlight-border: rgba(0, 122, 255, 0.4);
            
            /* Store Colors */
            --store-a: #007aff;
            --store-b: #bf5af2;
            --store-c: #30d158;
            
            /* Transaction Colors */
            --cash-color: #30d158;
            --credit-color: #ff9f0a;
            
            /* Liquid Backgrounds */
            --liquid-blue: rgba(0, 122, 255, 0.12);
            --liquid-green: rgba(48, 209, 88, 0.12);
            
            /* Name Colors */
            --noran-color: #007aff;
            --noman-color: #30d158;
            
            /* Supply Colors */
            --supply-a: #007aff;
            --supply-b: #bf5af2;
            
            /* Factory Colors */
            --factory-std: #007aff;
            --factory-asn: #bf5af2;
            
            /* Toggle Switch */
            --toggle-bg: rgba(255, 255, 255, 0.15);
            --toggle-active: linear-gradient(135deg, #007aff 0%, #00c7ff 100%);
            --toggle-knob: #ffffff;
        }
        
        /* === LIGHT MODE THEME === */
        [data-theme="light"] {
            /* Light Gradient Background */
            --bg-gradient: linear-gradient(135deg, #f0f8ff 0%, #e6f0ff 50%, #ebf8ff 100%);
            
            /* Glass Elements with Depth */
            --glass: rgba(255, 255, 255, 0.92);
            --glass-border: rgba(37, 99, 235, 0.15);
            
            /* Text Colors */
            --text-main: #1e3a8a;
            --text-muted: #4b5563;
            
            /* Input & Interactive Elements */
            --input-bg: rgba(240, 248, 255, 0.85);
            --card-hover: rgba(255, 255, 255, 0.98);
            
            /* Shadows with Depth */
            --shadow: 0 8px 32px rgba(37, 99, 235, 0.12);
            
            /* Blur Effects */
            --backdrop-blur: blur(20px);
            
            /* Highlight */
            --highlight-bg: rgba(37, 99, 235, 0.12);
            --highlight-border: rgba(37, 99, 235, 0.3);
            
            /* Store Colors */
            --store-a: #3b82f6;
            --store-b: #8b5cf6;
            --store-c: #10b981;
            
            /* Transaction Colors */
            --cash-color: #059669;
            --credit-color: #f59e0b;
            
            /* Liquid Backgrounds */
            --liquid-blue: rgba(37, 99, 235, 0.08);
            --liquid-green: rgba(5, 150, 105, 0.08);
            
            /* Name Colors */
            --noran-color: #2563eb;
            --noman-color: #059669;
            
            /* Supply Colors */
            --supply-a: #3b82f6;
            --supply-b: #8b5cf6;
            
            /* Factory Colors */
            --factory-std: #3b82f6;
            --factory-asn: #8b5cf6;
            
            /* Toggle Switch */
            --toggle-bg: rgba(0, 0, 0, 0.1);
            --toggle-active: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        }
        
        /* Native-like smooth scrolling & Performance */
html {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: contain;
}

        body {
    font-family: 'SF Pro Display', 'Inter', 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--text-main);
    margin: 0;
    padding: 20px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    /* Native feel: Prevent text selection and tap highlight */
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
    /* Layout Stability */
    overflow-x: hidden;
    width: 100%;
    box-sizing: border-box;
    /* Global Font Size Reduction for Compact Look */
    font-size: 13px;
}

*, *::before, *::after {
    box-sizing: inherit;
    -webkit-font-smoothing: antialiased;
}

/* Enable text selection for input areas */
input, textarea, select, [contenteditable] {
    -webkit-user-select: text;
    user-select: text;
}

/* Better scrollbar styling - iOS 26 Dark Theme */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Prevent content shift when scrollbar appears */
.container {
    max-width: 1200px;
    margin: auto;
    position: relative;
    /* Prevent layout shift */
    scrollbar-gutter: stable;
}

        /* --- LIQUID GLASSMORPHISM EFFECTS --- */
        @keyframes liquidFlow {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-8px) scale(1.02); }
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .liquid-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.08) 0%, 
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.03) 100%);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            /* GPU Acceleration for smoother feel */
            transform: translateZ(0);
            will-change: transform, box-shadow;
            transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            box-shadow: var(--shadow);
        }

        .liquid-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            pointer-events: none;
        }
        
        .liquid-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, 
                rgba(0, 122, 255, 0.1), 
                transparent 60%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .liquid-card:hover {
            transform: translateY(-4px) translateZ(0);
            box-shadow: var(--shadow), 0 16px 48px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .liquid-card:hover::after {
            opacity: 1;
        }

        /* Active state for native feedback */
        .liquid-card:active {
            transform: translateY(-2px) scale(0.99) translateZ(0);
        }
        
        /* === LIGHT MODE SPECIFIC OVERRIDES === */
        [data-theme="light"] .liquid-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.92) 0%, rgba(255, 255, 255, 0.85) 100%);
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.12);
        }
        
        [data-theme="light"] .liquid-card::before {
            background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.3), transparent);
        }
        
        [data-theme="light"] .liquid-card:hover {
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.12), 0 12px 24px rgba(37, 99, 235, 0.15);
        }
        
        [data-theme="light"] .section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.92) 0%, rgba(255, 255, 255, 0.85) 100%);
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.12);
        }
        
        [data-theme="light"] .section:hover {
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.12), 0 10px 25px rgba(37, 99, 235, 0.1);
        }
        
        [data-theme="light"] .system-controls {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.92) 0%, rgba(255, 255, 255, 0.85) 100%);
        }
        
        [data-theme="light"] .nav-tabs {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
            border-top: 1px solid var(--glass-border);
        }
        
        [data-theme="light"] #splash-screen {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #60a5fa 100%);
        }
        
        [data-theme="light"] .chart-box,
        [data-theme="light"] .sales-rep-chart-box {
            background: var(--glass);
            backdrop-filter: var(--backdrop-blur);
        }
        
        [data-theme="light"] .ios-toggle-container {
            background: rgba(240, 248, 255, 0.85);
            border-color: rgba(37, 99, 235, 0.15);
        }
        
        [data-theme="light"] .ios-toggle-container:hover {
            background: rgba(255, 255, 255, 0.98);
            border-color: rgba(37, 99, 235, 0.2);
        }
        
        [data-theme="light"] input[type="radio"]:checked + .ios-toggle-container {
            background: rgba(37, 99, 235, 0.12);
            border-color: rgba(37, 99, 235, 0.3);
        }
        
        [data-theme="light"] .ios-toggle-switch {
            background: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] input[type="radio"]:checked + .ios-toggle-container .ios-toggle-switch {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
        }
        
        [data-theme="light"] .card,
        [data-theme="light"] .stat-card {
            background: rgba(255, 255, 255, 0.92);
            border-color: rgba(37, 99, 235, 0.15);
        }
        
        [data-theme="light"] input[type="text"],
        [data-theme="light"] input[type="number"],
        [data-theme="light"] input[type="date"],
        [data-theme="light"] input[type="tel"],
        [data-theme="light"] input[type="password"],
        [data-theme="light"] select,
        [data-theme="light"] textarea {
            background: rgba(240, 248, 255, 0.85);
            border-color: rgba(37, 99, 235, 0.15);
            color: var(--text-main);
        }
        
        [data-theme="light"] button,
        [data-theme="light"] .btn {
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.3);
        }
        
        [data-theme="light"] table {
            background: rgba(255, 255, 255, 0.5);
            border-color: rgba(37, 99, 235, 0.1);
        }
        
        [data-theme="light"] thead {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
        }
        
        [data-theme="light"] tbody tr:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .shimmer-text {
            background: linear-gradient(90deg, var(--text-main) 0%, var(--accent) 50%, var(--text-main) 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s ease-in-out infinite;
        }
        /* Removed redundant body and container styles to prevent layout shifts */

        /* --- AESTHETIC SPLASH SCREEN --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #007aff 0%, #bf5af2 50%, #00c7ff 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow: hidden;
            animation: fadeOut 0.5s ease-in-out 1.25s forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                pointer-events: none;
            }
        }

        /* Flower Decorations */
        .flower {
            position: absolute;
            font-size: 3rem;
            opacity: 0.3;
            animation: float 6s ease-in-out infinite;
        }

        .flower1 { top: 10%; left: 10%; animation-delay: 0s; }
        .flower2 { top: 20%; right: 15%; animation-delay: 1s; font-size: 2.5rem; }
        .flower3 { bottom: 15%; left: 20%; animation-delay: 2s; font-size: 4rem; }
        .flower4 { bottom: 25%; right: 10%; animation-delay: 0.5s; font-size: 3.5rem; }
        .flower5 { top: 50%; left: 5%; animation-delay: 1.5s; font-size: 2rem; }
        .flower6 { top: 60%; right: 8%; animation-delay: 2.5s; font-size: 2.8rem; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        .splash-content {
            text-align: center;
            color: white;
            padding: 40px;
            z-index: 2;
            animation: slideUp 0.8s ease-out;
            position: relative;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .splash-logo {
            font-family: 'Great Vibes', cursive;
            font-size: 5rem;
            font-weight: 400;
            margin-bottom: 20px;
            text-shadow: 0 4px 30px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            background: linear-gradient(to right, #ffffff, #fef3c7, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s ease-in-out infinite;
        }

        .splash-subtitle {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            font-weight: 400;
            margin-bottom: 30px;
            letter-spacing: 4px;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .splash-quote {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 400;
            margin: 30px 0;
            font-style: italic;
            max-width: 700px;
            line-height: 1.8;
            opacity: 0.95;
        }

        .splash-author {
            font-family: 'Great Vibes', cursive;
            font-size: 1.3rem;
            opacity: 0.85;
            margin-top: 15px;
        }

        .splash-loader {
            margin-top: 50px;
            width: 70px;
            height: 70px;
            border: 5px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .splash-ornament {
            position: absolute;
            width: 100px;
            height: 2px;
            background: linear-gradient(to right, transparent, white, transparent);
            opacity: 0.4;
        }

        .ornament-top { top: 35%; left: 50%; transform: translateX(-50%); }
        .ornament-bottom { bottom: 35%; left: 50%; transform: translateX(-50%); }

        /* --- Header & Controls --- */
        .system-controls {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.08) 0%, 
                rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        

        
        /* MODERN BOTTOM NAVIGATION */
        .nav-tabs { 
            display: flex; 
            gap: 0; 
            justify-content: space-around; 
            margin: 0;
            flex-wrap: nowrap;
            overflow-x: hidden;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(135deg, 
                rgba(10, 10, 15, 0.95) 0%, 
                rgba(26, 26, 46, 0.95) 100%);
            padding: 10px 5px calc(10px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 10px 5px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-weight: 700;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .tab-btn.active {
            color: var(--accent);
            background: transparent;
        }

        .tab-btn.active::after {
            content: '';
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            margin-top: 2px;
        }

        /* IMPROVED TOGGLES */
        .toggle-group {
            background: var(--input-bg);
            padding: 4px;
            border-radius: 12px;
            display: flex;
            gap: 4px;
            border: 1px solid var(--glass-border);
            width: fit-content;
        }

        .toggle-opt { 
            padding: 8px 16px; 
            font-size: 11px; 
            font-weight: 700; 
            color: var(--text-muted); 
            cursor: pointer; 
            border-radius: 8px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            white-space: nowrap;
            text-align: center;
            border: 1px solid transparent;
        }
        
        .toggle-opt.active { 
            background: white; 
            color: var(--accent);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
            border-color: rgba(37, 99, 235, 0.1);
        }

        /* === iOS 26 TOGGLE SWITCH (ULTRA SMALL) === */
        .ios-toggle-container {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            background: var(--input-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        
        .ios-toggle-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(0, 122, 255, 0.05), 
                rgba(191, 90, 242, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .ios-toggle-container:hover {
            background: var(--card-hover);
            border-color: rgba(255, 255, 255, 0.15);
        }
        
        .ios-toggle-container:hover::before {
            opacity: 1;
        }
        
        .ios-toggle-container:active {
            transform: scale(0.97);
        }
        
        .ios-toggle-switch {
            position: relative;
            width: 32px;
            height: 18px;
            background: var(--toggle-bg);
            border-radius: 18px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }
        
        .ios-toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: var(--toggle-knob);
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
        }
        
        input[type="radio"]:checked + .ios-toggle-container .ios-toggle-switch {
            background: var(--toggle-active);
            box-shadow: 0 0 12px rgba(0, 122, 255, 0.4),
                        inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        input[type="radio"]:checked + .ios-toggle-container .ios-toggle-switch::before {
            left: 16px;
            box-shadow: 0 1px 6px rgba(0, 122, 255, 0.3);
        }
        
        input[type="radio"]:checked + .ios-toggle-container {
            background: rgba(0, 122, 255, 0.12);
            border-color: rgba(0, 122, 255, 0.3);
        }
        
        .ios-toggle-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            transition: color 0.3s ease;
            letter-spacing: 0.2px;
        }
        
        input[type="radio"]:checked + .ios-toggle-container .ios-toggle-label {
            color: var(--text-main);
            font-weight: 600;
        }
        
        /* Hide the actual radio input */
        input[type="radio"].ios-toggle-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        /* === VARIANT: Inline Toggle Row === */
        .toggle-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 8px 0;
        }
        
        .toggle-row .ios-toggle-container {
            flex: 1;
            min-width: 100px;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .ios-toggle-container {
                padding: 3px 8px;
                gap: 6px;
            }
            
            .ios-toggle-switch {
                width: 28px;
                height: 16px;
            }
            
            .ios-toggle-switch::before {
                width: 12px;
                height: 12px;
            }
            
            input[type="radio"]:checked + .ios-toggle-container .ios-toggle-switch::before {
                left: 14px;
            }
            
            .ios-toggle-label {
                font-size: 10px;
            }
        }

        /* Layout Fixes */
        body {
            padding-bottom: 100px !important;
        }
    
        /* --- Sections & Cards --- */
        .section { 
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.08) 0%, 
                rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 20px; 
            border: 1px solid var(--glass-border);
            padding: 20px; 
            margin-bottom: 20px; 
            position: relative;
            box-shadow: var(--shadow);
        }

        .section:hover {
            box-shadow: var(--shadow), 0 16px 48px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        .grid-inputs { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 12px; 
            margin-bottom: 15px; 
        }
        
        .field { 
            display: flex; 
            flex-direction: column; 
        }
        
        label { 
            font-size: 0.7rem; 
            font-weight: 800; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            margin-bottom: 6px; 
            letter-spacing: 0.5px;
        }
        
        input, select { 
            background: var(--input-bg); 
            border: 1px solid var(--glass-border);
            padding: 10px; 
            border-radius: 12px; 
            color: var(--text-main); 
            outline: none;
            font-family: inherit; 
            transition: border-color 0.2s, box-shadow 0.2s; 
            font-weight: 500;
            backdrop-filter: var(--backdrop-blur);
            -webkit-appearance: none; /* Native look on iOS */
            font-size: 16px; /* Prevent auto-zoom on iOS */
        }
        
        input:focus, select:focus { 
            border-color: var(--accent); 
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            background: white;
        }

        /* --- Search Bars --- */
        .search-bar {
            width: 100%;
            padding: 10px 16px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-main);
            font-size: 0.85rem;
            transition: all 0.3s;
            backdrop-filter: var(--backdrop-blur);
        }

        .search-bar:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            background: white;
        }

        .search-bar::placeholder {
            color: var(--text-muted);
        }

        /* --- Native-Feel Buttons --- */
        .btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 14px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative;
            overflow: hidden;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* Prevent text selection */
            user-select: none;
            -webkit-user-select: none;
            /* GPU acceleration */
            transform: translateZ(0);
        }
        
        .btn:active {
            transform: scale(0.97) translateZ(0);
            opacity: 0.9;
        }
        
        .btn-main { 
            background: var(--accent); 
            color: white; 
            width: 100%; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
        .btn-noman { 
            background: var(--accent-emerald); 
            color: white; 
            width: 100%; 
            margin-top: 8px; 
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        }
        
        .btn-sm { 
            padding: 8px 14px; 
            font-size: 0.8rem; 
            width: auto; 
            margin: 0; 
            border-radius: 10px;
            font-weight: 500;
        }
        
        /* Layout Stability: Prevent layout shift on scrollbar */
        .container {
            max-width: 1200px;
            margin: auto;
            position: relative;
            padding-bottom: 40px;
        }
        
        .btn-theme { 
            background: var(--input-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            font-size: 1.2rem;
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .btn-theme:hover {
            background: var(--card-hover);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-theme:active {
            transform: scale(0.95);
        }

        /* --- Store Selection Styles --- */
        .store-select-container {
            margin-bottom: 15px;
        }

        .store-selector {
            width: 100%;
            background: linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%);
            color: white;
            font-weight: 700;
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 10px;
            outline: none;
            cursor: pointer;
            transition: 0.3s;
            backdrop-filter: var(--backdrop-blur);
            font-size: 0.85rem;
        }

        .store-selector:hover {
            opacity: 0.9;
        }

        /* Store badges for history */
        .store-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            backdrop-filter: var(--backdrop-blur);
        }

        .store-badge.store-a { 
            background: linear-gradient(135deg, var(--store-a) 0%, #1d4ed8 100%); 
        }
        
        .store-badge.store-b { 
            background: linear-gradient(135deg, var(--store-b) 0%, #7c3aed 100%); 
        }
        
        .store-badge.store-c { 
            background: linear-gradient(135deg, var(--store-c) 0%, #059669 100%); 
        }

        /* Combined Overview Stats */
        .combined-overview {
            background: var(--glass);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .overview-report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .overview-card {
            background: var(--card-hover);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            position: relative;
            transition: all 0.3s;
            box-shadow: var(--shadow);
            backdrop-filter: var(--backdrop-blur);
            min-height: 150px;
            display: flex;
            flex-direction: column;
        }

        .overview-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow), 0 8px 15px rgba(37, 99, 235, 0.1);
        }

        .overview-card h4 {
            margin: 0 0 12px 0;
            color: var(--accent);
            text-transform: uppercase;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 8px;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .overview-card p {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 12px;
            font-weight: 400; /* Updated: Lighter font weight */
        }

        /* --- Data Display --- */
        .report-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        
        .card { 
            background: var(--card-hover); 
            border: 1px solid var(--glass-border); 
            border-radius: 16px; 
            padding: 15px; 
            position: relative;
            transition: all 0.3s; 
            box-shadow: var(--shadow);
            backdrop-filter: var(--backdrop-blur);
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }
        
        .card.highlight-card {
            background: var(--highlight-bg);
            border: 2px solid var(--highlight-border);
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.25);
            order: -1;
            z-index: 10;
            animation: liquidFlow 3s ease-in-out infinite;
        }

        .card h4 { 
            margin: 0 0 12px 0; 
            color: var(--accent); 
            text-transform: uppercase; 
            border-bottom: 1px solid var(--glass-border); 
            padding-bottom: 8px; 
            font-size: 0.8rem; 
            letter-spacing: 0.5px;
        }
        
        .card p { 
            display: flex; 
            justify-content: space-between; 
            margin: 5px 0; 
            font-size: 12px; 
            font-weight: 400; /* Updated: Lighter font weight */
        }
        
        .qty-val { color: var(--warning); font-weight: 800; }
        .rev-val { color: var(--accent); font-weight: 800; }
        .profit-val { color: var(--accent-emerald); font-weight: 800; }
        .cost-val { color: var(--danger); font-weight: 800; }

        .balance-pos { color: var(--danger); }
        .balance-neg { color: var(--accent); }

        .result-box { 
            padding: 12px; 
            border-radius: 10px; 
            margin: 8px 0; 
            background: var(--input-bg); 
            font-weight: 700; 
            border: 1px solid var(--glass-border); 
            backdrop-filter: var(--backdrop-blur);
            font-size: 0.85rem;
        }
        
        .discrepancy-alert {
            border-left: 4px solid var(--danger); 
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); 
            color: var(--danger); 
        }
        
        .discrepancy-ok { 
            border-left: 4px solid var(--accent); 
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%); 
            color: var(--accent); 
        }

        /* --- Tables & Lists --- */
        .comp-table { 
            width: 100%; 
            border-collapse: collapse;
            margin-top: 0; 
            font-size: 11px;
            display: table;
        }
        
        .comp-table thead {
            display: table-header-group;
        }
        
        .comp-table tbody {
            display: table-row-group;
        }
        
        .comp-table tr {
            display: table-row;
        }
        
        .comp-table th,
        .comp-table td {
            display: table-cell;
        }
        
        .comp-table th { 
            background: linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%); 
            color: white; 
            padding: 12px 8px; 
            text-align: center; 
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .comp-table td { 
            padding: 12px 8px; 
            border-bottom: 1px solid var(--glass-border); 
            text-align: center; 
            color: var(--text-main); 
            font-weight: 400;
            background: transparent;
            transition: background 0.2s ease;
        }
        
        .comp-table tbody tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .comp-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .winner-cell { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.1) 100%); 
            color: var(--warning); 
            font-weight: 800; 
        }

        /* --- Charts & Toggles --- */
        .chart-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 12px; 
            margin: 12px 0; 
        }
        
        .chart-box { 
            background: var(--glass); 
            border-radius: 14px; 
            padding: 12px; 
            border: 1px solid var(--glass-border); 
            position: relative; 
            height: 280px; 
            backdrop-filter: var(--backdrop-blur);
        }
        
        .toggle-group { 
            display: flex; 
            background: var(--input-bg); 
            border-radius: 8px; 
            padding: 2px; 
            gap: 2px; 
            border: 1px solid var(--glass-border); 
            flex-wrap: wrap; 
            backdrop-filter: var(--backdrop-blur);
            width: fit-content;
        }
        
        .toggle-opt { 
            padding: 3px 6px; 
            font-size: 9px; 
            font-weight: 700; 
            color: var(--text-muted); 
            cursor: pointer; 
            border-radius: 5px; 
            transition: 0.2s; 
            white-space: nowrap;
        }
        
        .toggle-opt.active { 
            background: linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%); 
            color: white; 
        }

        .debt-panel { 
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(0,0,0,0.01)); 
            border: 1px solid var(--accent); 
            border-radius: 16px; 
            padding: 15px; 
            margin-top: 15px; 
            backdrop-filter: var(--backdrop-blur);
        }

        .hidden { display: none; }
        
        hr { 
            border: 0; 
            border-top: 1px solid var(--glass-border); 
            margin: 10px 0; 
        }
        
        .seller-badge { 
            background: linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%); 
            color: white; 
            padding: 2px 6px; 
            border-radius: 5px; 
            font-size: 9px; 
            position: absolute; 
            top: 12px; 
            right: 12px; 
            backdrop-filter: var(--backdrop-blur);
        }
        
        .customer-name {
            font-size: 1rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .payment-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            backdrop-filter: var(--backdrop-blur);
        }

        .payment-badge.cash { 
            background: linear-gradient(135deg, var(--cash-color) 0%, #047857 100%); 
        }
        
        .payment-badge.credit { 
            background: linear-gradient(135deg, var(--credit-color) 0%, #d97706 100%); 
        }

        .payment-badge.received { 
            background: linear-gradient(135deg, #059669 0%, #047857 100%); 
        }

        .payment-type-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 5px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
        }

        .payment-option input[type="radio"] {
            width: 12px;
            height: 12px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .payment-option label {
            margin: 0;
            cursor: pointer;
            font-size: 0.85rem;
            text-transform: none;
            font-weight: 400; /* Updated: Lighter font weight */
        }

        /* Credit Received Checkbox Styles */
        .credit-checkbox-container {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            background: rgba(5, 150, 105, 0.05);
            border-radius: 3px;
            margin-top: 5px;
            border: 1px solid rgba(5, 150, 105, 0.2);
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: var(--backdrop-blur);
        }

        .credit-checkbox-container:hover {
            background: rgba(5, 150, 105, 0.1);
            border-color: rgba(5, 150, 105, 0.4);
        }

        .credit-checkbox-container.received {
            background: rgba(5, 150, 105, 0.15);
            border-color: rgba(5, 150, 105, 0.5);
        }

        .credit-checkbox {
            width: 12px;
            height: 12px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .credit-checkbox-label {
            margin: 0;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 400; /* Updated: Lighter font weight */
            color: var(--text-main);
            flex: 1;
        }

        .credit-status-icon {
            font-size: 1rem;
        }

        /* Store Comparison Graph Toggle */
        .store-comparison-toggle {
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .comparison-metric-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .metric-btn {
            padding: 6px 12px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .metric-btn.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-emerald) 100%);
            color: white;
            border-color: transparent;
        }

        .metric-btn:hover:not(.active) {
            background: var(--card-hover);
            transform: translateY(-2px);
        }

        /* Summary Section Enhancements */
        .summary-enhanced .card p {
            font-size: 11px;
            margin: 5px 0;
        }

        .summary-enhanced .card h4 {
            font-size: 0.8rem;
            padding-bottom: 6px;
        }

        /* Liquid Background Elements */
        .liquid-bg-element {
            position: absolute;
            border-radius: 50%;
            filter: blur(30px);
            opacity: 0.1;
            z-index: -1;
            animation: liquidFlow 10s ease-in-out infinite;
        }

        .liquid-1 {
            width: 250px;
            height: 250px;
            background: var(--accent);
            top: 10%;
            right: 10%;
            animation-delay: 0s;
        }

        .liquid-2 {
            width: 180px;
            height: 180px;
            background: var(--accent-emerald);
            bottom: 10%;
            left: 5%;
            animation-delay: 2s;
        }

        .liquid-3 {
            width: 120px;
            height: 120px;
            background: var(--store-b);
            top: 50%;
            left: 15%;
            animation-delay: 4s;
        }
        
        /* Sales Representative Performance Charts */
        .sales-rep-chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }
        
        .sales-rep-chart-box {
            background: var(--glass);
            border-radius: 14px;
            padding: 12px;
            border: 1px solid var(--glass-border);
            position: relative;
            height: 300px;
            backdrop-filter: var(--backdrop-blur);
        }
        
        .sales-rep-metric-selector {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 8px;
            margin-bottom: 12px;
        }
        
        .sales-rep-metric-dropdown {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-main);
            padding: 8px;
            font-size: 0.75rem;
            font-weight: 400; /* Updated: Lighter font weight */
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: var(--backdrop-blur);
        }
        
        .sales-rep-metric-dropdown:hover {
            border-color: var(--accent);
        }
        
        .sales-rep-metric-dropdown:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .noran-badge {
            background: linear-gradient(135deg, var(--noran-color) 0%, #1d4ed8 100%);
        }
        
        .noman-badge {
            background: linear-gradient(135deg, var(--noman-color) 0%, #047857 100%);
        }
        
        /* Percentage Toggle for Pie Charts */
        .percentage-toggle-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
        }
        
        .percentage-toggle-btn {
            padding: 5px 10px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 5px;
            color: var(--text-muted);
            font-size: 0.65rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .percentage-toggle-btn:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
        }
        
        .percentage-toggle-btn.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-emerald) 100%);
            color: white;
            border-color: transparent;
        }

        /* Received Credit Indicator */
        .received-indicator {
            display: inline-block;
            padding: 3px 6px;
            background: rgba(5, 150, 105, 0.15);
            color: var(--accent-emerald);
            border-radius: 5px;
            font-size: 0.65rem;
            font-weight: 400; /* Updated: Lighter font weight */
            margin-left: 5px;
            border: 1px solid rgba(5, 150, 105, 0.3);
        }

        /* Daily performance overview styles */
        .daily-performance-overview {
            margin-top: 15px;
            margin-bottom: 15px;
        }

        /* Consistent font sizes */
        h1, h2, h3, h4 {
            font-family: 'Inter', 'Plus Jakarta Sans', sans-serif;
        }

        h1 {
            font-size: 1.4rem;
            font-weight: 800;
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 700;
        }

        h3 {
            font-size: 1rem;
            font-weight: 700;
        }

        /* Calculator tab specific fixes */
        #tab-calc h2 {
            color: var(--accent);
            font-weight: 800;
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        /* All stores overview toggle */
        .all-stores-toggle {
            margin-bottom: 15px;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 250px;
            height: 90%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.92) 100%);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border-left: 1px solid var(--glass-border);
            box-shadow: -5px 0 30px rgba(37, 99, 235, 0.15);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }

        .settings-section {
            margin-bottom: 20px;
            background: var(--card-hover);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
        }

        .settings-section h4 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 8px;
        }

        .settings-input-group {
            margin-bottom: 12px;
        }

        .settings-input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 700;
        }

        .settings-input-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--input-bg);
            color: var(--text-main);
            font-weight: 400; /* Updated: Lighter font weight */
            transition: all 0.3s;
        }

        .settings-input-group input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            z-index: 999;
            display: none;
        }

        .settings-overlay.active {
            display: block;
        }

        /* Production Entry Toggle */
        .production-toggle-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .production-toggle-btn {
            padding: 6px 12px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .production-toggle-btn.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-emerald) 100%);
            color: white;
            border-color: transparent;
        }

        /* Supply Line Tags */
        .supply-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 400; /* Updated: Lighter font weight */
            margin-top: 5px;
            backdrop-filter: var(--backdrop-blur);
        }

        .supply-tag.store-a {
            background: linear-gradient(135deg, var(--supply-a) 0%, #1d4ed8 100%);
            color: white;
        }

        .supply-tag.store-b {
            background: linear-gradient(135deg, var(--supply-b) 0%, #7c3aed 100%);
            color: white;
        }

        /* Sales Store Selection */
        .sales-store-selection {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .sales-store-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .sales-store-option input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .sales-store-option label {
            margin: 0;
            cursor: pointer;
            font-size: 0.85rem;
            text-transform: none;
            font-weight: 400; /* Updated: Lighter font weight */
        }

        /* Factory Tab Specific Styles */
        .factory-store-selector {
            display: flex;
            background: var(--input-bg);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
            margin-bottom: 15px;
        }

        .factory-store-opt {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--text-muted);
            transition: 0.3s;
        }

        .factory-store-opt.active {
            background: white;
            color: var(--accent);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .factory-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--glass-border);
            font-size: 0.85rem;
            font-weight: 400; /* Updated: Lighter font weight */
        }

        .factory-summary-row:last-child {
            border-bottom: none;
        }

        .factory-summary-label {
            color: var(--text-muted);
            font-weight: 400; /* Updated: Lighter font weight */
        }

        .factory-history-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            margin-bottom: 10px;
            backdrop-filter: var(--backdrop-blur);
            transition: all 0.3s ease;
        }
        
        .factory-history-item:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
        }

        .factory-history-item:last-child {
            margin-bottom: 0;
        }

        .factory-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
            text-transform: uppercase;
            font-weight: 800;
        }

        .factory-badge-std {
            background: var(--factory-std);
        }

        .factory-badge-asn {
            background: var(--factory-asn);
        }

        .factory-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            /* FIX: Ensure full-screen coverage and proper scrolling on mobile */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .factory-overlay-card {
            background: var(--glass);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px; /* Reduced padding for mobile */
            width: 95%; /* Increased width for mobile */
            max-width: 650px;
            max-height: 90vh; /* Increased height for mobile */
            overflow-y: auto;
            box-shadow: var(--shadow);
            /* FIX: Allow card to scroll on mobile */
            margin: 10px;
        }

        /* Factory Material Input Grid */
        .factory-material-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr; /* Adjusted for mobile */
            gap: 5px;
            margin-bottom: 5px;
            font-size: 0.65rem; /* Smaller font for mobile */
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Formula Display */
        .formula-display {
            background: rgba(37, 99, 235, 0.05);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            margin: 15px 0;
            border: 1px dashed var(--glass-border);
        }

        /* Calculator Prices Display */
        .calculator-prices-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: var(--backdrop-blur);
        }

        .calculator-prices-card h4 {
            color: var(--accent);
            text-transform: uppercase;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        /* Factory Inventory Table */
        .factory-inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .factory-inventory-table th {
            background: rgba(37, 99, 235, 0.1);
            color: var(--accent);
            padding: 10px;
            text-align: left;
            font-weight: 800;
            border-radius: 6px;
        }

        .factory-inventory-table td {
            padding: 10px;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-main);
            font-weight: 400; /* Updated: Lighter font weight */
        }

        .factory-inventory-table tr:last-child td {
            border-bottom: none;
        }

        /* Factory Formula Grid */
        .factory-formula-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr; /* Adjusted for mobile */
            gap: 5px;
            margin-bottom: 10px;
        }
        
        /* Ensure inputs inside the grid don't overflow */
        .factory-formula-grid select, 
        .factory-formula-grid input {
            width: 100%;
            min-width: 0; /* Allow shrinking */
            padding: 8px 4px; /* Tighter padding */
            font-size: 0.8rem;
        }

        /* Cost Display Styles */
        .cost-display {
            padding: 10px;
            background: rgba(220, 38, 38, 0.1);
            border-radius: 8px;
            color: var(--danger);
            font-weight: 800;
            text-align: center;
            margin: 5px 0;
        }

        /* Factory Stats Cards */
        .factory-stats-card {
            background: var(--card-hover);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            position: relative;
            transition: all 0.3s;
            box-shadow: var(--shadow);
            backdrop-filter: var(--backdrop-blur);
            min-height: 150px;
        }

        .factory-stats-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow), 0 8px 15px rgba(37, 99, 235, 0.1);
        }
        
        /* Units Available Indicator */
        .units-available-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 800;
            margin-left: 10px;
            backdrop-filter: var(--backdrop-blur);
        }
        
        .units-available-good {
            background: rgba(5, 150, 105, 0.15);
            color: var(--accent-emerald);
            border: 1px solid rgba(5, 150, 105, 0.3);
        }
        
        .units-available-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .units-available-danger {
            background: rgba(220, 38, 38, 0.15);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        
        /* Warning Message */
        .warning-message {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.8rem;
            color: var(--warning);
            font-weight: 400; /* Updated: Lighter font weight */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .warning-message::before {
            content: "";
            font-size: 1rem;
        }
        
        /* Real-time Update Indicator */
        .update-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-emerald);
            margin-left: 5px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* Production Unit Info */
        .production-unit-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(37, 99, 235, 0.05);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 8px 0;
            font-size: 0.75rem;
            font-weight: 400; /* Updated: Lighter font weight */
        }
        
        /* Formula Unit Display */
        .formula-unit-display {
            background: rgba(37, 99, 235, 0.08);
            border: 1px dashed rgba(37, 99, 235, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

/* Mobile Responsive Chart Fix */
@media (max-width: 768px) {
    .chart-container {
        grid-template-columns: 1fr;
    }
    
    .chart-box {
        height: 250px;
    }
    
    .sales-rep-chart-container {
        grid-template-columns: 1fr;
    }
    
    .sales-rep-chart-box {
        height: 250px;
    }
    
    #combinedExportArea .chart-container {
        max-width: 100%;
        overflow: hidden;
    }
    
    #performanceChart,
    #compositionChart {
        max-width: 100% !important;
    }
} /* <--- ADD THIS CLOSING BRACKET HERE */

/* Add this to your existing media query section */
@media (max-width: 768px) {
    /* Entity List Table Mobile Fix */
    #entityListTable {
        font-size: 0.7rem;
    }
    
    #entityListTable th,
    #entityListTable td {
        padding: 6px 4px;
    }
    
    .entity-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
        gap: 8px;
    }
    
    .entity-card {
        padding: 10px !important;
    }
    
    .entity-card .customer-name {
        font-size: 0.8rem !important;
    }
    
    .entity-card .btn-sm {
        font-size: 0.65rem !important;
        padding: 3px 5px !important;
    }
    
    /* Adjust actions column for mobile */
    #entityListTable td:last-child .btn-theme {
        padding: 2px 6px !important;
        font-size: 0.6rem !important;
    }
}

        /* All Times Summary Styles */
        .all-times-summary {
            background: var(--highlight-bg);
            border: 2px solid var(--highlight-border);
        }
        
        /* Date selection for factory tab */
        .factory-date-selector {
            margin-bottom: 15px;
        }
        
        /* Entity Grid Styles */
        .entity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .entity-card {
            background: var(--card-hover);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            position: relative;
            transition: all 0.3s;
            backdrop-filter: var(--backdrop-blur);
        }
        
        .entity-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .entity-type-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            backdrop-filter: var(--backdrop-blur);
        }
        
        .entity-type-payee {
            background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
        }
        
        .entity-type-payor {
            background: linear-gradient(135deg, var(--accent-emerald) 0%, #047857 100%);
        }
        
        /* Net Cash Dashboard Styles */
        .net-cash-dashboard {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border: 2px solid var(--highlight-border);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .net-cash-value {
            font-size: 3rem;
            font-weight: 800;
            text-align: center;
            margin: 20px 0;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-emerald) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .formula-breakdown {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 15px;
            border-top: 1px solid var(--glass-border);
            padding-top: 15px;
        }
        
        .formula-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .formula-value {
            font-weight: 700;
        }
        
        /* Horizontal Entity Scroller */
        .entity-scroller {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0;
            margin: 15px 0;
            scrollbar-width: thin;
        }
        
        .entity-scroller::-webkit-scrollbar {
            height: 6px;
        }
        
        .entity-scroller::-webkit-scrollbar-track {
            background: var(--input-bg);
            border-radius: 3px;
        }
        
        .entity-scroller::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }
        
        .entity-chip {
            flex: 0 0 auto;
            padding: 8px 16px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .entity-chip:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
        }
        
        .entity-chip.active {
            background: linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%);
            color: white;
            border-color: transparent;
        }
        .cust-history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--input-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 8px;
}

        /* Add to your existing CSS */
#cash-net-total {
    font-size: 1.4rem !important;
    font-weight: 800 !important;
    padding: 5px;
    border-radius: 8px;
    background: rgba(37, 99, 235, 0.05);
}

#credit-total {
    font-size: 1.4rem !important;
    font-weight: 800 !important;
    padding: 5px;
    border-radius: 8px;
    background: rgba(245, 158, 11, 0.05);
}

/* Mobile Responsive Chart Fix */
@media (max-width: 768px) {
    .chart-container {
        grid-template-columns: 1fr;
    }
    
    .chart-box {
        height: 250px;
    }
    
    .sales-rep-chart-container {
        grid-template-columns: 1fr;
    }
    
    .sales-rep-chart-box {
        height: 250px;
    }
    
    #combinedExportArea .chart-container {
        max-width: 100%;
        overflow: hidden;
    }
    
    #performanceChart,
    #compositionChart {
        max-width: 100% !important;
    }
    
    /* Entity List Table Mobile Fix */
    #entityListTable {
        font-size: 0.7rem;
    }
    
    #entityListTable th,
    #entityListTable td {
        padding: 6px 4px;
    }
    
    .entity-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
        gap: 8px;
    }
    
    .entity-card {
        padding: 10px !important;
    }
    
    .entity-card .customer-name {
        font-size: 0.8rem !important;
    }
    
    .entity-card .btn-sm {
        font-size: 0.65rem !important;
        padding: 3px 5px !important;
    }
    
    /* Adjust actions column for mobile */
    #entityListTable td:last-child .btn-theme {
        padding: 2px 6px !important;
        font-size: 0.6rem !important;
    }
    
    /* All Times Summary Styles */
    .all-times-summary {
        background: var(--highlight-bg);
        border: 2px solid var(--highlight-border);
    }
    
    /* Date selection for factory tab */
    .factory-date-selector {
        margin-bottom: 15px;
    }
    
    /* Entity Grid Styles */
    .entity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 15px;
    }
    
    .entity-card {
        background: var(--card-hover);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 15px;
        position: relative;
        transition: all 0.3s;
        backdrop-filter: var(--backdrop-blur);
    }
    
    .entity-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }
    
    .entity-type-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.6rem;
        font-weight: 800;
        color: white;
        text-transform: uppercase;
        backdrop-filter: var(--backdrop-blur);
    }
    
    .entity-type-payee {
        background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
    }
    
    .entity-type-payor {
        background: linear-gradient(135deg, var(--accent-emerald) 0%, #047857 100%);
    }
    
    /* Net Cash Dashboard Styles */
    .net-cash-dashboard {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
        border: 2px solid var(--highlight-border);
        padding: 25px;
        margin-bottom: 25px;
    }
    
    .net-cash-value {
        font-size: 3rem;
        font-weight: 800;
        text-align: center;
        margin: 20px 0;
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-emerald) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .formula-breakdown {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 15px;
        border-top: 1px solid var(--glass-border);
        padding-top: 15px;
    }
    
    .formula-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
    }
    
    .formula-value {
        font-weight: 700;
    }
    
    /* Horizontal Entity Scroller */
    .entity-scroller {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding: 10px 0;
        margin: 15px 0;
        scrollbar-width: thin;
    }
    
    .entity-scroller::-webkit-scrollbar {
        height: 6px;
    }
    
    .entity-scroller::-webkit-scrollbar-track {
        background: var(--input-bg);
        border-radius: 3px;
    }
    
    .entity-scroller::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 3px;
    }
    
    .entity-chip {
        flex: 0 0 auto;
        padding: 8px 16px;
        background: var(--input-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        font-size: 0.8rem;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .entity-chip:hover {
        background: var(--card-hover);
        transform: translateY(-2px);
    }
    
    .entity-chip.active {
        background: linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%);
        color: white;
        border-color: transparent;
    }
    /* Add to your existing styles */
.entity-balance-positive {
    color: var(--accent-emerald);
}

.entity-balance-negative {
    color: var(--danger);
}

.entity-balance-neutral {
    color: var(--text-main);
}

.entity-type-badge {
    font-size: 0.65rem;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 800;
    text-transform: uppercase;
    backdrop-filter: var(--backdrop-blur);
}
/* --- SIGNAL INDICATOR STYLES --- */
#connection-indicator {
    position: fixed;
    bottom: 15px;       /* Fixed to bottom */
    left: 15px;         /* Fixed to left side */
    width: 12px;
    height: 12px;
    border-radius: 50%;
    z-index: 10002;     /* On top of everything */
    background-color: var(--danger); /* Default Red */
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    pointer-events: auto;
}

#connection-indicator:hover {
    transform: scale(1.2);
}

/* Status States */
.signal-online {
    background-color: #10b981 !important; /* Green */
    box-shadow: 0 0 8px #10b981, 0 0 15px rgba(16, 185, 129, 0.4) !important;
}

.signal-connecting {
    background-color: #f59e0b !important; /* Orange */
    animation: pulse-signal 1s infinite;
}

.signal-offline {
    background-color: #ef4444 !important; /* Red */
    opacity: 0.7;
}

@keyframes pulse-signal {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(0.8); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

    /* Add to your existing CSS */
    #cash-net-total {
        font-size: 1.4rem !important;
        font-weight: 800 !important;
        padding: 5px;
        border-radius: 8px;
        background: rgba(37, 99, 235, 0.05);
    }
    
    #credit-total {
        font-size: 1.4rem !important;
        font-weight: 800 !important;
        padding: 5px;
        border-radius: 8px;
        background: rgba(245, 158, 11, 0.05);
    }
    #connection-indicator {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    z-index: 10005;
    border: 2px solid white;
    box-shadow: 0 0 8px rgba(0,0,0,0.4);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    background-color: #ef4444; /* Default Red */
    cursor: help;
}

/* Green State */
.sig-online {
    background-color: #10b981 !important;
    box-shadow: 0 0 12px #10b981 !important;
}

/* Orange/Pulse State */
.sig-connecting {
    background-color: #f59e0b !important;
    animation: sig-pulse 1.2s infinite ease-in-out;
}

@keyframes sig-pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(0.7); opacity: 0.6; }
    100% { transform: scale(1); opacity: 1; }
}

    /* Responsive adjustments for the new cards */
    @media (max-width: 768px) {
        .report-grid[style*="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))"] {
            grid-template-columns: 1fr !important;
        }
        
        #cash-net-total,
        #credit-total {
            font-size: 1.2rem !important;
        }
    }
    /* Entity Cards Grid Styles */
.entity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    margin-top: 10px;
}

.entity-card-compact {
    background: var(--card-hover);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 15px;
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: var(--backdrop-blur);
    cursor: pointer;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.entity-card-compact:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow), 0 8px 15px rgba(37, 99, 235, 0.1);
    border-color: var(--accent);
}

.entity-card-compact.active {
    border: 2px solid var(--accent);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%);
}

.entity-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.entity-name {
    font-size: 0.95rem;
    font-weight: 800;
    color: var(--text-main);
    margin: 0;
    line-height: 1.2;
}

.entity-type-badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 800;
    color: white;
    text-transform: uppercase;
    backdrop-filter: var(--backdrop-blur);
    min-width: 60px;
    text-align: center;
}

.entity-type-payee {
    background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
}

.entity-type-payor {
    background: linear-gradient(135deg, var(--accent-emerald) 0%, #047857 100%);
}

.entity-contact {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.entity-balance {
    margin-top: 10px;
    text-align: right;
}

.entity-balance-label {
    font-size: 0.65rem;
    color: var(--text-muted);
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.entity-balance-value {
    font-size: 1.1rem;
    font-weight: 800;
    margin-top: 5px;
}

.entity-balance-positive {
    color: var(--accent-emerald);
}

.entity-balance-negative {
    color: var(--danger);
}

.entity-balance-neutral {
    color: var(--text-main);
}

.entity-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    justify-content: flex-end;
}

.entity-action-btn {
    padding: 4px 10px;
    border: 1px solid var(--glass-border);
    border-radius: 6px;
    background: var(--input-bg);
    color: var(--text-muted);
    font-size: 0.7rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    flex: 1;
}

.entity-action-btn:hover {
    background: var(--card-hover);
    transform: translateY(-2px);
}

.entity-action-btn.edit {
    background: linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%);
    color: white;
    border-color: transparent;
}

.entity-action-btn.transactions {
    background: linear-gradient(135deg, var(--accent-emerald) 0%, #059669 100%);
    color: white;
    border-color: transparent;
}

/* Compact View */
.entity-grid.compact {
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
}

.entity-grid.compact .entity-card-compact {
    min-height: 100px;
    padding: 12px;
}

.entity-grid.compact .entity-name {
    font-size: 0.85rem;
}

.entity-grid.compact .entity-type-badge {
    font-size: 0.6rem;
    padding: 2px 6px;
    min-width: 50px;
}

.entity-grid.compact .entity-contact {
    font-size: 0.7rem;
}

.entity-grid.compact .entity-balance-value {
    font-size: 1rem;
}

/* No Entities Message */
.no-entities-message {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.no-entities-message .btn-theme {
    margin-top: 15px;
}

/* Dark Mode Adjustments */
body.dark-mode .entity-card-compact {
    background: rgba(30, 41, 59, 0.7);
    border-color: rgba(96, 165, 250, 0.2);
}

body.dark-mode .entity-card-compact:hover {
    background: rgba(51, 65, 85, 0.8);
    border-color: rgba(96, 165, 250, 0.4);
}

body.dark-mode .entity-action-btn {
    background: rgba(30, 41, 59, 0.8);
    border-color: rgba(96, 165, 250, 0.2);
    color: #94a3b8;
}

/* Responsive */
@media (max-width: 768px) {
    .entity-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 10px;
    }
    
    .entity-grid.compact {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
}
    
    /* Payment Transaction Cards */
    .transaction-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 9px;
        font-weight: 800;
        color: white;
        text-transform: uppercase;
        backdrop-filter: var(--backdrop-blur);
    }
    
    .transaction-in {
        background: linear-gradient(135deg, var(--accent-emerald) 0%, #047857 100%);
    }
    
    .transaction-out {
        background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
    }
} /* <-- THIS CLOSING BRACKET WAS MISSING */

/* --- DARK THEME (LIQUID NIGHT MODE) - Native Feel --- */
body.dark-mode {
    --bg-gradient: linear-gradient(135deg, #020617 0%, #0f172a 100%);
    --glass: rgba(15, 23, 42, 0.9);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --accent: #3b82f6;
    --accent-emerald: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --input-bg: rgba(2, 6, 23, 0.8);
    --card-hover: rgba(30, 41, 59, 0.95);
    --shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    --highlight-bg: rgba(59, 130, 246, 0.1);
    --highlight-border: rgba(59, 130, 246, 0.2);
    --store-a: #3b82f6;
    --store-b: #8b5cf6;
    --store-c: #10b981;
    --cash-color: #10b981;
    --credit-color: #f59e0b;
    --liquid-blue: rgba(59, 130, 246, 0.08);
    --liquid-green: rgba(16, 185, 129, 0.08);
    --noran-color: #3b82f6;
    --noman-color: #10b981;
    --supply-a: #3b82f6;
    --supply-b: #8b5cf6;
    --factory-std: #3b82f6;
    --factory-asn: #8b5cf6;
}

body.dark-mode .liquid-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.9) 100%);
}

body.dark-mode .nav-tabs {
    background: var(--bg-gradient);
}

body.dark-mode .tab-btn {
    background: var(--input-bg);
    border-color: var(--glass-border);
}

body.dark-mode input, body.dark-mode select {
    background: var(--input-bg);
    border-color: var(--glass-border);
}

body.dark-mode input:focus {
    background: #1e293b;
}

/* Dark mode specific adjustments */
body.dark-mode .shimmer-text {
    background: linear-gradient(90deg, #f1f5f9 0%, #60a5fa 50%, #f1f5f9 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

body.dark-mode .nav-tabs {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

body.dark-mode .tab-btn {
    background: rgba(30, 41, 59, 0.8);
    color: #94a3b8;
    border: 1px solid rgba(96, 165, 250, 0.2);
}

body.dark-mode .tab-btn.active {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}

body.dark-mode .tab-btn:hover:not(.active) {
    background: rgba(51, 65, 85, 0.8);
}

body.dark-mode input,
body.dark-mode select,
body.dark-mode .search-bar {
    background: rgba(30, 41, 59, 0.8);
    color: #f1f5f9;
    border-color: rgba(96, 165, 250, 0.2);
}

body.dark-mode input:focus,
body.dark-mode select:focus,
body.dark-mode .search-bar:focus {
    border-color: #60a5fa;
    box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
}

body.dark-mode .comp-table th {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

body.dark-mode .comp-table td {
    background: transparent;
    border-color: rgba(96, 165, 250, 0.1);
}

body.dark-mode .comp-table tbody tr:hover td {
    background: rgba(59, 130, 246, 0.1);
}

body.dark-mode .winner-cell {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(251, 191, 36, 0.1) 100%);
    color: #fbbf24;
}

/* Dark mode factory history cards */
body.dark-mode .factory-history-item {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(96, 165, 250, 0.2);
}

body.dark-mode .factory-history-item .factory-summary-row {
    border-bottom: 1px dashed rgba(96, 165, 250, 0.15);
}

/* Dark mode entity cards */
body.dark-mode .entity-card {
    background: rgba(30, 41, 59, 0.7);
    border-color: rgba(96, 165, 250, 0.2);
}

/* Dark mode payment badges */
body.dark-mode .payment-badge.cash {
    background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
}

body.dark-mode .payment-badge.credit {
    background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
}

body.dark-mode .payment-badge.received {
    background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
}

/* Dark mode store badges */
body.dark-mode .store-badge.store-a {
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
}

body.dark-mode .store-badge.store-b {
    background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
}

body.dark-mode .store-badge.store-c {
    background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
}

/* Dark mode transaction badges */
body.dark-mode .transaction-badge {
    backdrop-filter: var(--backdrop-blur);
}

body.dark-mode .transaction-in {
    background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
}

body.dark-mode .transaction-out {
    background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
}

/* Dark mode result boxes */
body.dark-mode .result-box {
    background: rgba(30, 41, 59, 0.8);
    border-color: rgba(96, 165, 250, 0.2);
}

body.dark-mode .discrepancy-alert {
    background: linear-gradient(135deg, rgba(248, 113, 113, 0.15) 0%, rgba(248, 113, 113, 0.08) 100%);
    border-left: 4px solid #f87171;
    color: #f87171;
}

body.dark-mode .discrepancy-ok {
    background: linear-gradient(135deg, rgba(96, 165, 250, 0.15) 0%, rgba(96, 165, 250, 0.08) 100%);
    border-left: 4px solid #60a5fa;
    color: #60a5fa;
}

/* Dark mode formula displays */
body.dark-mode .formula-display,
body.dark-mode .formula-unit-display {
    background: rgba(96, 165, 250, 0.08);
    border-color: rgba(96, 165, 250, 0.2);
}

/* Dark mode warning messages */
body.dark-mode .warning-message {
    background: rgba(251, 191, 36, 0.15);
    border-color: rgba(251, 191, 36, 0.3);
    color: #fbbf24;
}

/* Dark mode credit checkbox */
body.dark-mode .credit-checkbox-container {
    background: rgba(52, 211, 153, 0.1);
    border-color: rgba(52, 211, 153, 0.2);
}

body.dark-mode .credit-checkbox-container:hover {
    background: rgba(52, 211, 153, 0.15);
    border-color: rgba(52, 211, 153, 0.3);
}

body.dark-mode .credit-checkbox-container.received {
    background: rgba(52, 211, 153, 0.2);
    border-color: rgba(52, 211, 153, 0.4);
}

/* Dark mode buttons */
body.dark-mode .btn-main {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

body.dark-mode .btn-noman {
    background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
}

body.dark-mode .btn-danger {
    background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
}


/* Removed outdated body.dark-mode styles - now using [data-theme] attribute */


/* Dark mode liquid background elements */
body.dark-mode .liquid-bg-element {
    opacity: 0.15;
}

body.dark-mode .liquid-1 {
    background: #60a5fa;
}

body.dark-mode .liquid-2 {
    background: #34d399;
}

body.dark-mode .liquid-3 {
    background: #a78bfa;
}

/* Dark mode economic dashboard */
body.dark-mode .net-cash-dashboard {
    background: linear-gradient(135deg, rgba(96, 165, 250, 0.15) 0%, rgba(52, 211, 153, 0.15) 100%);
    border-color: rgba(96, 165, 250, 0.3);
}

/* Dark mode cash tracker card */
body.dark-mode .card[style*="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1)"] {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.08) 100%) !important;
    border-color: rgba(251, 191, 36, 0.3) !important;
}

/* Dark mode highlight cards */
body.dark-mode .highlight-card {
    background: rgba(96, 165, 250, 0.15);
    border-color: rgba(96, 165, 250, 0.3);
}

/* Dark mode all-times summary */
body.dark-mode .all-times-summary {
    background: rgba(96, 165, 250, 0.2);
    border-color: rgba(96, 165, 250, 0.4);
}

/* Dark mode toggle group */
body.dark-mode .toggle-group {
    background: rgba(30, 41, 59, 0.8);
    border-color: rgba(96, 165, 250, 0.2);
}

body.dark-mode .toggle-opt {
    color: #94a3b8;
}

body.dark-mode .toggle-opt.active {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

/* Dark mode metric buttons */
body.dark-mode .metric-btn {
    background: rgba(30, 41, 59, 0.8);
    border-color: rgba(96, 165, 250, 0.2);
    color: #94a3b8;
}

body.dark-mode .metric-btn.active {
    background: linear-gradient(135deg, #60a5fa 0%, #34d399 100%);
    border-color: transparent;
    color: white;
}


/* Dark mode store selector */
body.dark-mode .store-selector {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-color: rgba(96, 165, 250, 0.3);
}

/* Dark mode factory store options */
body.dark-mode .factory-store-opt {
    background: rgba(30, 41, 59, 0.8);
    color: #94a3b8;
    border-color: rgba(96, 165, 250, 0.2);
}

body.dark-mode .factory-store-opt.active {
    background: #1e293b;
    color: #f1f5f9;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

/* Dark mode factory inventory table */
body.dark-mode .factory-inventory-table th {
    background: rgba(96, 165, 250, 0.15);
    color: #60a5fa;
}

body.dark-mode .factory-inventory-table td {
    border-bottom-color: rgba(96, 165, 250, 0.1);
}

/* Dark mode cost display */
body.dark-mode .cost-display {
    background: rgba(248, 113, 113, 0.15);
    color: #f87171;
}

/* Dark mode debt panel */
body.dark-mode .debt-panel {
    background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(30, 41, 59, 0.05));
    border-color: #60a5fa;
}

/* Dark mode units available indicators */
body.dark-mode .units-available-good {
    background: rgba(52, 211, 153, 0.15);
    color: #34d399;
    border-color: rgba(52, 211, 153, 0.3);
}

body.dark-mode .units-available-warning {
    background: rgba(251, 191, 36, 0.15);
    color: #fbbf24;
    border-color: rgba(251, 191, 36, 0.3);
}

body.dark-mode .units-available-danger {
    background: rgba(248, 113, 113, 0.15);
    color: #f87171;
    border-color: rgba(248, 113, 113, 0.3);
}
/* Customer Management Overlay Styles */
.cust-history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--input-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.2s;
}

.cust-history-item:hover {
    background: var(--card-hover);
    transform: translateX(2px);
}

.cust-history-info {
    flex: 1;
}

.cust-history-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.status-toggle-btn {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 700;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
}

.status-pending {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border-color: rgba(245, 158, 11, 0.3);
}

.status-received {
    background: rgba(5, 150, 105, 0.1);
    color: var(--accent-emerald);
    border-color: rgba(5, 150, 105, 0.3);
}


    </style>
</head>
<body>
<!-- Liquid Background Elements -->
<div class="liquid-bg-element liquid-1"></div>
<div class="liquid-bg-element liquid-2"></div>
<div class="liquid-bg-element liquid-3"></div>

<!-- Factory Settings Overlay -->
<div id="factorySettingsOverlay" class="factory-overlay">
    <div class="factory-overlay-card liquid-card">
        <div class="section-header">
            <h3 id="factorySettingsModalTitle">Factory Formulas</h3>
            <button class="btn-theme" onclick="closeFactorySettings()"></button>
        </div>
        
        <div class="factory-store-selector">
            <div class="factory-store-opt active" onclick="selectFactoryStore('standard', this)">STANDARD</div>
            <div class="factory-store-opt" onclick="selectFactoryStore('asaan', this)">ASAAN</div>
        </div>
        
        <!-- Additional Cost Field -->
        <div class="grid-inputs" style="margin-bottom: 15px;">
            <div class="field">
                <label>Additional Cost (Per Unit)</label>
                <input type="number" id="additional-cost-per-unit" step="0.01" min="0" value="0" oninput="updateFactoryFormulasSummary()">
            </div>
        </div>
        
        <!-- NEW: Cost Adjustment (X) Input -->
        <div class="grid-inputs" style="margin-bottom: 15px;">
            <div class="field">
                <label>Cost Adjustment for Sales & Calculator (X)</label>
                <input type="number" id="cost-adjustment-factor" step="0.01" min="1" value="1" oninput="updateFactoryFormulasSummary()">
                <div style="font-size:0.6rem; color:var(--text-muted); margin-top:3px; font-weight: 400;">
                    Used in Sales & Calculator tabs: Cost per kg = (Raw Material Cost + Additional Cost) / X
                </div>
            </div>
        </div>
        
        <!-- NEW: Sale Price Inputs -->
        <div class="grid-inputs" style="margin-bottom: 15px;">
            <div class="field">
                <label>Sale Price - Standard (per kg)</label>
                <input type="number" id="sale-price-standard" step="0.01" min="0" value="0" oninput="updateFactoryFormulasSummary()">
                <div style="font-size:0.6rem; color:var(--text-muted); margin-top:3px; font-weight: 400;">
                    Used by Zubair, Mahmood stores and Calculator
                </div>
            </div>
            <div class="field">
                <label>Sale Price - Asaan (per kg)</label>
                <input type="number" id="sale-price-asaan" step="0.01" min="0" value="0" oninput="updateFactoryFormulasSummary()">
                <div style="font-size:0.6rem; color:var(--text-muted); margin-top:3px; font-weight: 400;">
                    Used by Asaan store and Sales tab
                </div>
            </div>
        </div>
        
        <div class="factory-material-grid">
            <div>Material</div>
            <div>Cost (Per Unit)</div>
            <div>Qty (kg)</div>
        </div>
        
        <div id="factoryRawMaterialsContainer">
            <!-- Material rows will be populated by JavaScript -->
        </div>
        
        <button class="btn btn-theme" style="width:100%; border:1px dashed var(--accent); margin:15px 0; color:var(--accent); font-size:0.8rem;" onclick="addFactoryMaterialRow()">+ Add Ingredient Row</button>
        
        <div style="background:rgba(37,99,235,0.05); padding:10px; border-radius:8px; margin-bottom:15px;">
            <div class="factory-summary-row">
                <span class="factory-summary-label">Unit Weight:</span>
                <span class="qty-val" id="factorySettingsUnitWeight">0.00 kg</span>
            </div>
            <div class="factory-summary-row">
                <span class="factory-summary-label">Raw Material Cost per Unit:</span>
                <span class="cost-val" id="factorySettingsRawCostPerUnit">0.00 PKR</span>
            </div>
            <div class="factory-summary-row">
                <span class="factory-summary-label">Total Cost per Unit:</span>
                <span class="cost-val" id="factorySettingsPerUnit">0.00 PKR</span>
            </div>
            <div class="factory-summary-row">
                <span class="factory-summary-label">Available Units:</span>
                <span class="qty-val" id="factorySettingsAvailableUnits">0</span>
            </div>
            <div class="factory-summary-row">
                <span class="factory-summary-label">Cost per kg for Sales/Calculator:</span>
                <span class="cost-val" id="factorySettingsSalesCostPerKg">0.00 PKR</span>
            </div>
        </div>
        
        <button class="btn btn-noman" onclick="(async () => { await saveFactoryFormulas() })()">Save Formula Settings</button>
    </div>
</div>

<div id="factoryInventoryOverlay" class="factory-overlay">
    <div class="factory-overlay-card liquid-card">
        <div class="section-header">
            <h3 id="factoryInventoryModalTitle">Add Raw Material</h3>
            <button class="btn-theme" onclick="closeFactoryInventoryModal()"></button>
        </div>
        
        <div class="grid-inputs">
            <div class="field">
                <label>Material Name</label>
                <input type="text" id="factoryMaterialName" placeholder="Material Name">
            </div>
            <div class="field">
                <label>Quantity</label>
                <input type="number" id="factoryMaterialQuantity" placeholder="0">
            </div>
        </div>
        
        <div class="grid-inputs">
            <div class="field">
                <label>Unit</label>
                <select id="factoryMaterialUnit">
                    <option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="pcs">pcs</option>
                    <option value="pack">pack</option>
                    <option value="l">liter</option>
                </select>
            </div>
            <div class="field">
                <label>Cost Price (Per Unit)</label>
                <input type="number" id="factoryMaterialCost" placeholder="0.00">
            </div>
        </div>
        
        <div style="margin-top: 15px; padding: 15px; background: rgba(37, 99, 235, 0.05); border-radius: 10px;">
            <h4 style="color: var(--accent); margin: 0 0 10px 0; font-size: 0.9rem;">Supplier Information</h4>
            
            <div class="grid-inputs">
                <div class="field">
                    <label>Supplier Action</label>
                    <select id="factoryMaterialSupplierType" onchange="toggleSupplierFields()">
                        <option value="none">No Supplier Link</option>
                        <option value="existing">Select Existing Entity</option>
                        <option value="new">Add New Supplier Entity</option>
                    </select>
                </div>
            </div>
            
            <div id="existingSupplierSection" class="hidden">
                <div class="field">
                    <label>Select Supplier (Payee)</label>
                    <select id="factoryExistingSupplier" class="store-selector">
                        <option value="">Choose Supplier</option>
                    </select>
                </div>
            </div>
            
            <div id="newSupplierSection" class="hidden">
                <div class="grid-inputs">
                    <div class="field">
                        <label>Supplier Name</label>
                        <input type="text" id="factorySupplierName" placeholder="Company/Person Name">
                    </div>
                    <div class="field">
                        <label>Contact (Phone)</label>
                        <input type="tel" id="factorySupplierPhone" placeholder="Phone Number">
                    </div>
                </div>
                
                <div class="field" style="margin-top: 10px; background: rgba(5, 150, 105, 0.1); padding: 10px; border-radius: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="factorySupplierAutoEntity" checked disabled style="width: 16px; height: 16px; margin-right: 10px; accent-color: var(--accent);">
                        <span style="font-size: 0.8rem; font-weight: 700; color: var(--accent-emerald);">
                             Add to Quick Entity Selection
                        </span>
                    </label>
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-left: 26px;">
                        This will automatically create a <strong>PAYEE</strong> entity. Any debts to this supplier will appear in "Supplier Payables" in the Economic Dashboard.
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-danger" id="deleteFactoryInventoryBtn" onclick="(async () => { await deleteFactoryInventoryItem() })()" style="display:none; flex:1;">Delete</button>
            <button class="btn btn-noman" onclick="(async () => { await saveFactoryInventoryItem() })()" style="flex:2;">Save Material & Update Entities</button>
        </div>
    </div>
</div>


<!-- Entity Management Overlay -->
<div id="entityManagementOverlay" class="factory-overlay">
    <div class="factory-overlay-card liquid-card">
        <div class="section-header">
            <h3 id="entityManagementModalTitle">Add Entity</h3>
            <button class="btn-theme" onclick="closeEntityManagement()"></button>
        </div>
        
        <div class="grid-inputs">
            <div class="field">
                <label>Entity Name</label>
                <input type="text" id="entityName" placeholder="Name">
            </div>
            <div class="field">
                <label>Type</label>
                <select id="entityType">
                    <option value="payee">Payee (We pay them)</option>
                    <option value="payor">Payor (They pay us)</option>
                </select>
            </div>
        </div>
        
        <div class="grid-inputs">
            <div class="field">
                <label>Phone Number</label>
                <input type="tel" id="entityPhone" placeholder="Phone">
            </div>
            <div class="field">
                <label>Wallet Details</label>
                <input type="text" id="entityWallet" placeholder="Wallet/Account Details">
            </div>
        </div>
        
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-danger" id="deleteEntityBtn" onclick="(async () => { await deleteEntity() })()" style="display:none; flex:1;">Delete</button>
            <button class="btn btn-noman" onclick="(async () => { await saveEntity() })()" style="flex:2;">Save Entity</button>
        </div>
    </div>
</div>
<!-- Entity Transactions Overlay -->
<div id="entityDetailsOverlay" class="factory-overlay">
    <div class="factory-overlay-card liquid-card" style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="section-header">
            <div>
                <h3 id="manageEntityTitle" style="margin:0; color:var(--text-main);">Entity Name</h3>
                <span id="manageEntityStats" style="font-size: 0.75rem; color:var(--text-muted);">Current Balance: Rs 0.00</span>
            </div>
            <button class="btn-theme" onclick="closeEntityDetailsOverlay()"></button>
        </div>

        <div class="debt-panel" style="margin-bottom: 20px; flex-shrink: 0;">
            <h4 style="margin: 0 0 10px 0; font-size: 0.85rem; color: var(--accent);">Quick Transaction</h4>
            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                <div class="field" style="flex: 1; min-width: 120px;">
                    <label>Amount (Rs)</label>
                    <input type="number" id="quickEntityAmount" placeholder="0.00" style="width: 100%;">
                </div>
                <div class="field" style="flex: 1.5; min-width: 150px;">
                    <label>Type</label>
                    <div class="toggle-group" style="width: 100%; display: flex;">
                        <div class="toggle-opt active" id="quick-type-out" onclick="setQuickEntityType('OUT')" style="flex:1;">Payment OUT (Paid)</div>
                        <div class="toggle-opt" id="quick-type-in" onclick="setQuickEntityType('IN')" style="flex:1;">Payment IN (Recvd)</div>
                    </div>
                </div>
                <button class="btn btn-noman" style="width: auto; height: 42px; margin-bottom: 1px;" onclick="(async () => { await saveQuickEntityTransaction() })()">Save</button>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;">
                * "Payment OUT" reduces what you owe. "Payment IN" reduces what they owe you.
            </div>
        </div>

        <div style="margin-bottom: 10px; flex-shrink: 0;">
            <input type="text" id="entity-trans-search" class="search-bar" placeholder="Search history..." oninput="filterEntityManagementHistory()">
        </div>

        <div style="flex: 1; overflow-y: auto; padding-right: 5px;" id="entityManagementHistoryList">
            </div>
        
        <div style="margin-top: 15px; pt: 10px; border-top: 1px solid var(--glass-border); text-align: right;">
             <button class="btn btn-danger btn-sm" onclick="deleteCurrentEntity()">Delete Entity Permanently</button>
        </div>
    </div>
</div>


<div id="customerManagementOverlay" class="factory-overlay">
    <div class="factory-overlay-card liquid-card" style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="section-header">
            <div>
                <h3 id="manageCustomerTitle" style="margin:0; color:var(--text-main);">Customer Name</h3>
                <span id="manageCustomerStats" style="font-size: 0.75rem; color:var(--text-muted);">Current Debt: Rs 0.00</span>
            </div>
            <button class="btn-theme" onclick="closeCustomerManagement()"></button>
        </div>

        <div class="debt-panel" style="margin-bottom: 20px; flex-shrink: 0;">
            <h4 style="margin: 0 0 10px 0; font-size: 0.85rem; color: var(--accent);">Bulk Credit Payment</h4>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="field" style="flex: 1;">
                    <label>Amount Received</label>
                    <input type="number" id="bulkPaymentAmount" placeholder="Enter amount..." style="width: 100%;">
                </div>
                <button class="btn btn-noman" style="width: auto;" onclick="(async () => { await processBulkPayment() })()">Process Payment</button>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;">
                * This will automatically mark oldest credit transactions as "Received" up to this amount.
            </div>
        </div>

        <div style="margin-bottom: 10px; flex-shrink: 0;">
            <input type="text" id="cust-trans-search" class="search-bar" placeholder="Search history..." oninput="filterCustomerManagementHistory()">
        </div>

        <div style="flex: 1; overflow-y: auto; padding-right: 5px;" id="customerManagementHistoryList">
            </div>
    </div>
</div>
<div id="customerEditOverlay" class="factory-overlay" style="z-index: 10002;">
    <div class="factory-overlay-card liquid-card" style="max-width: 350px;">
        <div class="section-header">
            <h3 style="color:var(--text-main); margin:0;">Edit Customer Details</h3>
            <button class="btn-theme" onclick="closeCustomerEditModal()"></button>
        </div>
        
        <div class="grid-inputs" style="margin-bottom: 20px;">
            <div class="field">
                <label>Customer Name</label>
                <input type="text" id="edit-cust-name" readonly style="background: rgba(0,0,0,0.05); color: var(--text-muted); font-weight: 700;">
            </div>
            
            <div class="field">
                <label>Phone Number</label>
                <input type="tel" id="edit-cust-phone" placeholder="03XX-XXXXXXX">
            </div>
            
            <div class="field">
                <label>Address / Location</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="edit-cust-address" placeholder="Area, Shop #, etc." style="flex: 1;">
                    <button class="btn-theme" onclick="fetchDeviceLocation()" title="Auto-Fetch Location" style="border: 1px solid var(--accent); color: var(--accent); padding: 0 10px;">
                        
                    </button>
                </div>
                <div id="location-status" style="font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; font-style: italic;"></div>
            </div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn btn-main" onclick="(async () => { await saveCustomerDetails() })()">Update Details</button>
        </div>
    </div>
</div>

<!-- AESTHETIC SPLASH SCREEN -->
<div id="splash-screen">
    <!-- Flower Decorations -->
    <div class="flower flower1"></div>
    <div class="flower flower2"></div>
    <div class="flower flower3"></div>
    <div class="flower flower4"></div>
    <div class="flower flower5"></div>
    <div class="flower flower6"></div>
    
    <div class="splash-ornament ornament-top"></div>
    
    <div class="splash-content">
        <div class="splash-subtitle">GULL AND ZUBAIR NASWAR DEALERS</div>
        <div class="splash-quote" id="splash-quote">wisdom</div>
        <div class="splash-author" id="splash-author"> Inspiring Minds</div>
        <div class="splash-loader"></div>
    </div>
    
    <div class="splash-ornament ornament-bottom"></div>
</div>

<!-- Replace this part in your system-controls div: -->
<div class="system-controls">
    <span style="font-weight:800; font-size:0.85rem; color:var(--accent);" class="shimmer-text">MAHMOOD KHAN</span>
    
    <div style="display:flex; gap:8px; align-items: center;">
        <button class="btn-theme" id="themeToggle" onclick="(async () => { await toggleDarkMode() })()" title="Toggle Dark Mode"></button>
        <button class="btn-theme" id="cloudMenuBtn" onclick="(async () => { await openDataMenu() })()" title="Data Management"></button>
    </div>
</div>

<input type="file" id="restoreInput" class="hidden" accept=".json" onchange="(async () => { await unifiedRestore(event) })()">

<div id="dataMenuOverlay" class="factory-overlay">
    <div class="factory-overlay-card liquid-card" style="max-width: 350px; text-align: center;">
        <div class="section-header">
            <h3 style="color:var(--text-main); margin:0;">Data Options</h3>
            <button class="btn-theme" onclick="closeDataMenu()"></button>
        </div>
        <hr style="width: 100%; border: 0; border-top: 1px solid var(--glass-border); margin: 5px 0;">
<button class="btn" id="bio-toggle-btn" style="background: rgba(37, 99, 235, 0.1); color: var(--text-main); border: 1px solid var(--glass-border);" onclick="enableBiometricLock()">
    Enable Biometric Lock 
</button>

<div id="admin-controls-section" style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--warning);">
    <h4 style="margin: 0 0 10px 0; color: var(--warning); font-size: 0.8rem;">ADMIN CONTROLS</h4>
    <div class="field" style="margin-bottom: 10px;">
        <label>Set Admin PIN</label>
        <input type="password" id="setting-admin-pin" placeholder="Default: 1234" maxlength="4" style="text-align:center;">
    </div>
    <div class="field" style="margin-bottom: 10px;">
        <label>Select Rep for this Device</label>
        <select id="setting-rep-select" class="store-selector">
            <option value="NORAN SHAH">NORAN SHAH</option>
            <option value="NOMAN SHAH">NOMAN SHAH</option>
        </select>
    </div>
    <button class="btn btn-danger" onclick="(async () => { await activateRepMode() })()"> Switch to Rep Mode</button>
</div>

<hr style="width: 100%; border: 0; border-top: 1px solid var(--glass-border); margin: 5px 0;">

        
        <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 15px;">
    <button class="btn btn-main" id="sync-btn" onclick="performOneClickSync()" style="background: linear-gradient(135deg, #2563eb 0%, #059669 100%); font-size: 1rem; padding: 15px;">
         SYNC DATA 
    </button>
    <div style="font-size: 0.7rem; color: var(--text-muted); text-align: center; margin-bottom: 10px;">
        
    </div>
</div>
<div class="field">

            
            <hr style="width: 100%; border: 0; border-top: 1px solid var(--glass-border); margin: 5px 0;">

            <button class="btn" id="upload-old-btn" style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.18), rgba(5, 150, 105, 0.18)); color: var(--text-main); border: 1px solid rgba(37, 99, 235, 0.35); font-weight: 600;" onclick="document.getElementById('uploadOldDataInput').click();">
                 Upload Old Data to Cloud
            </button>
            <input type="file" id="uploadOldDataInput" class="hidden" accept=".json" onchange="(async () => { await uploadOldDataToCloud(event) })()">

            <hr style="width: 100%; border: 0; border-top: 1px solid var(--glass-border); margin: 5px 0;">
            
            <button class="btn" style="background: rgba(37, 99, 235, 0.1); color: var(--text-main); border: 1px solid var(--glass-border);" onclick="(async () => { await triggerLocalBackup() })()">
                 Backup to Phone
            </button>
            <button class="btn" style="background: rgba(37, 99, 235, 0.1); color: var(--text-main); border: 1px solid var(--glass-border);" onclick="document.getElementById('restoreInput').click(); closeDataMenu();">
                 Restore from Phone
            </button>
        </div>
        
        <div id="lastSyncDisplay" style="margin-top: 15px; font-size: 0.7rem; color: var(--text-muted);">
            Last Synced: Checking...
        </div>
    </div>
</div>


    <div class="nav-tabs">
    <button class="tab-btn active" onclick="showTab('prod')">PRODUCTION</button>
    <button class="tab-btn" onclick="showTab('sales')">SALES</button>
    <button class="tab-btn" onclick="showTab('calc')">CALCULATOR</button>
    <button class="tab-btn" onclick="showTab('factory')">FACTORY</button>
    <button class="tab-btn" onclick="showTab('payments')">PAYMENTS</button>
    <button class="tab-btn" onclick="showTab('rep')">REP SALES</button>
</div>



<div id="adminPinOverlay" class="factory-overlay">
    <div class="factory-overlay-card liquid-card" style="max-width: 300px; text-align: center;">
        <h3 style="color:var(--text-main); margin-bottom: 15px;">Enter Admin PIN</h3>
        <input type="password" id="admin-pin-input" class="search-bar" style="text-align: center; font-size: 1.5rem; letter-spacing: 5px; margin-bottom: 20px;" maxlength="4" placeholder="">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn" style="background: var(--input-bg); border: 1px solid var(--glass-border);" onclick="closeAdminPinModal()">Cancel</button>
            <button class="btn btn-main" onclick="verifyAdminPin()">Unlock</button>
        </div>
    </div>
</div>
<div id="tab-rep" class="hidden">
    
<div id="admin-rep-controls" class="section liquid-card hidden">
    <div class="section-header">
        <h3 style="margin:0; color:var(--text-main); font-size: 0.9rem;">Admin View</h3>
    </div>
    
    <div class="grid-inputs" style="margin-top: 10px;">
        <div class="field">
            <label style="color: var(--accent);">View For:</label>
            <select id="admin-rep-selector" class="store-selector" onchange="adminSwitchRepProfile(this.value)">
                <option value="NORAN SHAH">NORAN SHAH</option>
                <option value="NOMAN SHAH">NOMAN SHAH</option>
            </select>
        </div>
        <div class="field">
            <label>Select Date</label>
            <input type="date" id="admin-rep-date" onchange="handleAdminRepDateChange(this.value)">
        </div>
    </div>

    <div id="rep-map-container" style="height: 300px; width: 100%; margin-top: 15px; border-radius: 12px; border: 2px solid var(--glass-border); z-index: 1;"></div>
    
    <div style="text-align: right; font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;">
         Cash Sale |  Collection |  Credit Sale
    </div>
</div>



    <div id="rep-header" style="margin-bottom: 20px; display: none; justify-content: space-between; align-items: center; background: var(--glass); padding: 15px; border-radius: 20px; border: 1px solid var(--glass-border);">
        <div>
         <h2 style="margin:0; color:var(--accent);"> <span id="current-rep-name-display">REP MODE</span></h2>
        <span style="font-size: 0.7rem; color: var(--text-muted);"> </span>
    </div>
    <button class="btn btn-danger" onclick="openAdminPinModal()">  Access</button>
    </div>

   <div id="rep-new-transaction-card" class="section liquid-card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="color:var(--accent); margin:0;">New Transaction</h3>        
        <div style="background:var(--input-bg); padding:4px; border-radius:8px; border:1px solid var(--glass-border); display:flex;">
            <button id="btn-mode-sale" class="toggle-opt active" onclick="setRepMode('sale')" style="padding:6px 12px; font-size:0.8rem;"> Sale</button>
            <button id="btn-mode-coll" class="toggle-opt" onclick="setRepMode('collection')" style="padding:6px 12px; font-size:0.8rem;">Collection</button>
        </div>
    </div>
        
        <div class="grid-inputs">
            <div class="field"><label>Date</label><input type="date" id="rep-date" onchange="renderRepHistory()"></div>

            <div class="field">
                <label>Customer Name</label>
                <input type="text" id="rep-cust-name" placeholder="Search customer..." 
                       oninput="handleCustomerInput(this.value, 'rep')" autocomplete="off">
                <div id="rep-customer-search-results" class="hidden" style="position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 10px; margin-top: 60px; box-shadow: var(--shadow);"></div>
            </div>
        </div>

        <div id="rep-new-customer-phone-container" class="hidden" style="margin-top: 8px; animation: slideDown 0.3s ease;">
            <div class="field">
                <label style="color: var(--accent-emerald);">Mobile number</label>
                <input type="tel" id="rep-new-cust-phone" placeholder="03XX-XXXXXXX" style="border-color: var(--accent-emerald);">
            </div>
        </div>

        <div id="rep-sale-inputs">
            <div class="grid-inputs">
                <div class="field"><label>Quantity (kg)</label><input type="number" id="rep-quantity" step="0.001" oninput="calculateRepSalePreview()"></div>
          <div class="field">
    <label>Payment Type</label>
    <div class="toggle-row" style="display: flex; flex-wrap: nowrap; gap: 8px; width: 100%;">
        
        <input type="radio" id="rep-pay-credit" name="rep-payment" value="CREDIT" checked onchange="calculateRepSalePreview()" class="ios-toggle-input">
        <label for="rep-pay-credit" class="ios-toggle-container" style="flex: 1; min-width: 0; white-space: nowrap; justify-content: center;">
            <div class="ios-toggle-switch"></div>
            <span class="ios-toggle-label">Credit</span>
        </label>   
        
        <input type="radio" id="rep-pay-cash" name="rep-payment" value="CASH" onchange="calculateRepSalePreview()" class="ios-toggle-input">
        <label for="rep-pay-cash" class="ios-toggle-container" style="flex: 1; min-width: 0; white-space: nowrap; justify-content: center;">
            <div class="ios-toggle-switch"></div>
            <span class="ios-toggle-label">Cash</span>
        </label>
        
    </div>
</div>

      </div>
        </div>

        <div id="rep-coll-inputs" class="hidden">
            <div class="field">
                <label>Amount Collected (Rs)</label>
                <input type="number" id="rep-amount-collected" step="1" placeholder="Enter Cash Received">
            </div>
        </div>

        <div id="rep-customer-info-display" class="hidden" style="margin: 10px 0; padding: 12px; background: rgba(37, 99, 235, 0.05); border-radius: 10px; border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700;">Current Debt:</span>
                <span id="rep-customer-current-credit" style="color: var(--warning); font-weight: 800;">Rs 0.00</span>
            </div>
        </div>

        <div class="result-box" style="display: flex; justify-content: space-between; align-items: center;">
            <span id="rep-result-label">Transaction Value:</span>
            <span id="rep-total-value" style="font-size: 1.1rem; color: var(--accent);">Rs 0.00</span>
        </div>

        <button class="btn btn-main" onclick="(async () => { await saveRepTransaction() })()">Submit Transaction</button>
    </div>

    <div class="section liquid-card">
        <div class="section-header" style="position: relative;">
            <h3 style="color:var(--text-main); margin:0;">Customer List</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="rep-filter" class="search-bar" placeholder="Filter list..." style="width: 120px; font-size: 0.7rem;" oninput="renderRepCustomerTable()">
                <button class="btn-theme" onclick="exportCustomerData('rep')" title="Download CSV" style="color: var(--accent-emerald); border-color: var(--accent-emerald);">
                    
                </button>
            </div>
        </div>

        <div style="overflow-x: auto; max-height: 400px; overflow-y: auto; border-radius: 12px; background: rgba(255, 255, 255, 0.02); border: 1px solid var(--glass-border); min-height: 100px;">
            <table class="comp-table" style="font-size: 0.75rem; margin-top: 0; display: table;">
                <thead>
                    <tr style="display: table-row;">
                        <th style="text-align: left; font-weight: 800; padding-left: 16px; display: table-cell;">Customer</th>
                        <th style="text-align: right; font-weight: 800; display: table-cell;">Credit</th>
                        <th style="text-align: right; font-weight: 800; display: table-cell;">Activity</th>
                        <th style="text-align: center; font-weight: 800; padding-right: 16px; display: table-cell;">Actions</th>
                    </tr>
                </thead>
                <tbody id="rep-customers-table-body" style="display: table-row-group;"></tbody>
            </table>
        </div>
    </div>

    <div class="section liquid-card">
        <h3 style="color:var(--text-main); margin:0 0 15px 0;">Today's Activity</h3>
        <div id="repHistoryList" class="report-grid"></div>
    </div>
</div>

    <!-- PRODUCTION TAB -->
    <div id="tab-prod">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
            <h1 style="color:var(--text-main); font-weight:800; margin:0;" class="shimmer-text">Manufacturing</h1>
            <div class="production-toggle-container">
                <button class="production-toggle-btn active" onclick="setProductionView('combined', event)">Combined</button>
                <button class="production-toggle-btn" onclick="setProductionView('store', event)">Store Entry</button>
            </div>
        </header>

        <!-- Production Entry Card -->
        <div id="production-entry-section" class="section liquid-card">
            <h3 style="color:var(--accent); margin-top:0;">New Entry</h3>
            
            <!-- Units Available Indicator -->
            <div id="unitsAvailableIndicator" class="production-unit-info">
                <span>Formula Units Available:</span>
                <span id="currentUnitsAvailable" class="units-available-good">Calculating...</span>
            </div>
            
            <div class="grid-inputs">
                <div class="field"><label>Select Date</label><input type="date" id="sys-date" onchange="refreshUI()"></div>
                <div class="field"><label>Gross Weight (kg)</label><input type="number" id="gross-wt" step="0.001" oninput="calcNet()"></div>
                <div class="field"><label>Container Weight (kg)</label><input type="number" id="cont-wt" step="0.001" oninput="calcNet()"></div>
            </div>
            
            <div class="grid-inputs">
                <div class="field">
                    <label>Net Production (kg)</label>
                    <input type="number" id="net-wt" readonly style="background:rgba(37, 99, 235, 0.1); color:var(--accent); font-weight:bold;">
                    <div style="font-size:0.7rem; color:var(--text-muted); margin-top:5px; font-weight: 400;">
                        Dynamic Cost Value: <span id="display-cost-value" style="color:var(--danger);">Rs 0.00</span>
                    </div>
                </div>
                
                <!-- Store Selection -->
                <div class="field">
                    <label>Select Store:</label>
                    <select id="storeSelector" class="store-selector" onchange="updateProductionCostOnStoreChange()">
                        <option value="STORE_A">ZUBAIR</option>
                        <option value="STORE_B">MAHMOOD</option>
                        <option value="STORE_C">ASAAN</option>
                    </select>
                </div>
            </div>

            <!-- Payment Status Toggle (Visible only for STORE_C) -->
            <div id="paymentStatusContainer" class="hidden" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Payment Status:</label>
                <div class="payment-type-container">
                    <input type="radio" id="production-payment-cash" name="production-payment-type" value="CASH" checked class="ios-toggle-input">
                    <label for="production-payment-cash" class="ios-toggle-container">
                        <div class="ios-toggle-switch"></div>
                        <span class="ios-toggle-label">Cash</span>
                    </label>
                    
                    <input type="radio" id="production-payment-credit" name="production-payment-type" value="CREDIT" class="ios-toggle-input">
                    <label for="production-payment-credit" class="ios-toggle-container">
                        <div class="ios-toggle-switch"></div>
                        <span class="ios-toggle-label">Credit</span>
                    </label>
                </div>
            </div>

            <!-- New Fields: Formula Units and Sale Price (REMOVED) -->
            <div class="grid-inputs">
                <div class="field">
                    <label>Formula Units Used</label>
                    <input type="number" id="formula-units" step="0.001" min="0" value="1" oninput="calculateDynamicProductionCost()">
                    <div style="font-size:0.6rem; color:var(--text-muted); margin-top:3px; font-weight: 400;">
                        Units of factory mixture consumed
                    </div>
                </div>
                
                <!-- REMOVED: Sale Price input field -->
                <div class="field">
                    <label>Sale Price (per kg)</label>
                    <div class="result-box" style="background:rgba(37, 99, 235, 0.05);">
                        <span id="production-sale-price-display" style="color:var(--accent); font-weight:800;">Rs 0.00/kg</span>
                    </div>
                </div>
            </div>

            <!-- Dynamic Cost Calculation Display -->
            <div class="formula-unit-display">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.75rem;">
                    <span style="color:var(--text-muted);">Formula Unit Cost:</span>
                    <span id="formula-unit-cost-display" style="color:var(--danger); font-weight:800;">Rs 0.00/unit</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.75rem;">
                    <span style="color:var(--text-muted);">Total Formula Cost:</span>
                    <span id="total-formula-cost-display" style="color:var(--danger); font-weight:800;">Rs 0.00</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                    <span style="color:var(--text-muted);">Cost per kg:</span>
                    <span id="dynamic-cost-per-kg" style="color:var(--danger); font-weight:800;">Rs 0.00/kg</span>
                </div>
            </div>

            <!-- Cost and Profit Display -->
            <div class="result-box" style="background:rgba(37, 99, 235, 0.05);">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:0.75rem; color:var(--text-muted); font-weight: 400;">Dynamic Cost Price:</span>
                    <span id="factory-cost-price" style="color:var(--danger); font-weight:800;">Rs 0.00/kg</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:0.75rem; color:var(--text-muted); font-weight: 400;">Sale Price:</span>
                    <span id="profit-sale-price" style="color:var(--accent); font-weight:800;">Rs 0.00/kg</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-size:0.75rem; color:var(--text-muted); font-weight: 400;">Profit (per kg):</span>
                    <span id="profit-per-kg" style="color:var(--accent-emerald); font-weight:800;">Rs 0.00</span>
                </div>
            </div>

            <!-- Warning Message for Insufficient Units -->
            <div id="insufficientUnitsWarning" class="warning-message hidden">
                Insufficient formula units available! Please reduce formula units used.
            </div>

            <button class="btn btn-main" onclick="(async () => { await recordEntry() })()">Save Production</button>
        </div>

        <!-- Combined Overview -->
        <div id="combinedOverview" class="combined-overview liquid-card">
            <h3 style="margin:0 0 15px 0; text-align:center; color:var(--accent); font-size:0.95rem; text-transform:uppercase; font-weight:800;" class="shimmer-text">All Stores Overview</h3>
            
            <!-- Toggle for daily, weekly, monthly, yearly, all times -->
            <div class="all-stores-toggle">
                <div class="toggle-group">
                    <div class="toggle-opt active" id="overview-day-btn" onclick="setOverviewMode('day')">Daily</div>
                    <div class="toggle-opt" id="overview-week-btn" onclick="setOverviewMode('week')">Weekly</div>
                    <div class="toggle-opt" id="overview-month-btn" onclick="setOverviewMode('month')">Monthly</div>
                    <div class="toggle-opt" id="overview-year-btn" onclick="setOverviewMode('year')">Yearly</div>
                    <div class="toggle-opt" id="overview-all-btn" onclick="setOverviewMode('all')">All Times</div>
                </div>
            </div>
            
            <div class="overview-report-grid" id="all-stores-grid">
                <!-- Cards will be populated by JavaScript -->
            </div>

            <!-- Store Comparison Graph Toggle -->
            <div class="store-comparison-toggle">
                <label style="display: block; margin-bottom: 6px; font-size: 0.65rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Compare Stores By:</label>
                <div class="comparison-metric-selector">
                    <button class="metric-btn active" onclick="setStoreComparisonMetric('weight', event)">Weight (kg)</button>
                    <button class="metric-btn" onclick="setStoreComparisonMetric('value', event)">Total Value</button>
                    <button class="metric-btn" onclick="setStoreComparisonMetric('cost', event)">Total Cost</button>
                    <button class="metric-btn" onclick="setStoreComparisonMetric('profit', event)">Net Profit</button>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-box">
                    <canvas id="storeComparisonChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section liquid-card">
            <div class="section-header">
                <h3 style="color:var(--text-main); margin:0;">Analytics</h3>
                <div class="toggle-group">
                    <div class="toggle-opt active" id="mfg-week-btn" onclick="setMfgChartMode('week')">Weekly</div>
                    <div class="toggle-opt" id="mfg-month-btn" onclick="setMfgChartMode('month')">Monthly</div>
                    <div class="toggle-opt" id="mfg-year-btn" onclick="setMfgChartMode('year')">Yearly</div>
                    <div class="toggle-opt" id="mfg-all-btn" onclick="setMfgChartMode('all')">All Times</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-box">
                    <canvas id="mfgBarChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="percentage-toggle-container">
                        <button class="percentage-toggle-btn" id="mfgPiePercentageToggle" onclick="togglePercentage('mfgPieChart')">Show %</button>
                    </div>
                    <canvas id="mfgPieChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section-header">
            <h3>Summary Reports <span class="update-indicator" id="summaryUpdateIndicator"></span></h3>
        </div>
        <div class="report-grid summary-enhanced" id="prod-summary-grid">
            <div class="card highlight-card liquid-card">
                <h4>Daily Summary</h4>
                <p><span>Net Weight:</span> <span class="qty-val" id="day-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="day-value">Rs 0.00</span></p>
                <p><span>Total Cost:</span> <span class="cost-val" id="day-cost">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="day-profit">Rs 0.00</span></p>
                <hr style="margin: 6px 0;">
                <p><span>Formula Units Used:</span> <span class="qty-val" id="day-formula-units">0.00</span></p>
                <p><span>Formula Cost:</span> <span class="cost-val" id="day-formula-cost">Rs 0.00</span></p>
            </div>
            <div class="card liquid-card">
                <h4>Weekly Summary</h4>
                <p><span>Net Weight:</span> <span class="qty-val" id="week-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="week-value">Rs 0.00</span></p>
                <p><span>Total Cost:</span> <span class="cost-val" id="week-cost">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="week-profit">Rs 0.00</span></p>
                <hr style="margin: 6px 0;">
                <p><span>Formula Units Used:</span> <span class="qty-val" id="week-formula-units">0.00</span></p>
                <p><span>Formula Cost:</span> <span class="cost-val" id="week-formula-cost">Rs 0.00</span></p>
            </div>
            <div class="card liquid-card">
                <h4>Monthly Summary</h4>
                <p><span>Net Weight:</span> <span class="qty-val" id="month-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="month-value">Rs 0.00</span></p>
                <p><span>Total Cost:</span> <span class="cost-val" id="month-cost">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="month-profit">Rs 0.00</span></p>
                <hr style="margin: 6px 0;">
                <p><span>Formula Units Used:</span> <span class="qty-val" id="month-formula-units">0.00</span></p>
                <p><span>Formula Cost:</span> <span class="cost-val" id="month-formula-cost">Rs 0.00</span></p>
            </div>
            <div class="card liquid-card">
                <h4>Yearly Summary</h4>
                <p><span>Net Weight:</span> <span class="qty-val" id="year-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="year-value">Rs 0.00</span></p>
                <p><span>Total Cost:</span> <span class="cost-val" id="year-cost">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="year-profit">Rs 0.00</span></p>
                <hr style="margin: 6px 0;">
                <p><span>Formula Units Used:</span> <span class="qty-val" id="year-formula-units">0.00</span></p>
                <p><span>Formula Cost:</span> <span class="cost-val" id="year-formula-cost">Rs 0.00</span></p>
            </div>
            <div class="card all-times-summary liquid-card" id="all-times-production-card" style="display: none;">
                <h4>All Times Summary</h4>
                <p><span>Net Weight:</span> <span class="qty-val" id="all-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="all-value">Rs 0.00</span></p>
                <p><span>Total Cost:</span> <span class="cost-val" id="all-cost">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="all-profit">Rs 0.00</span></p>
                <hr style="margin: 6px 0;">
                <p><span>Formula Units Used:</span> <span class="qty-val" id="all-formula-units">0.00</span></p>
                <p><span>Formula Cost:</span> <span class="cost-val" id="all-formula-cost">Rs 0.00</span></p>
            </div>
        </div>

        <div class="section-header" style="margin-top:25px;">
            <h3>History</h3>
        </div>

        <!-- Search Bar for Production History -->
        <div class="section liquid-card">
            <input type="text" id="production-search" class="search-bar" placeholder=" Search production history by date or store..." oninput="filterProductionHistory()">
        </div>

        <div id="prodHistoryList" class="report-grid"></div>
    </div>

    <!-- SALES TAB -->
    <div id="tab-sales" class="hidden">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
            <h1 style="color:var(--text-main); font-weight:800; margin:0;" class="shimmer-text">Sales</h1>
        </header>

        <div class="section liquid-card">
            <h3 style="color:var(--accent); margin-top:0;">New Sale</h3>
            <!-- In SALES TAB, replace the customer name input section -->
<div class="grid-inputs">
    <div class="field"><label>Date</label><input type="date" id="cust-date" onchange="refreshCustomerSales()"></div>
    <div class="field">
        <div class="field">
    <label>Customer Name</label>
    <input type="text" id="cust-name" list="customer-list" placeholder="Search or type new..." 
           oninput="handleCustomerInput(this.value, 'admin')" autocomplete="off">
    <div id="customer-search-results" class="hidden" style="position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 10px; margin-top: 5px; box-shadow: var(--shadow);"></div>
</div>

<div id="new-customer-phone-container" class="hidden" style="margin-top: 8px; animation: slideDown 0.3s ease;">
    <div class="field">
        <label style="color: var(--accent-emerald);">Mobile number</label>
        <input type="tel" id="new-cust-phone" placeholder="03XX-XXXXXXX" style="border-color: var(--accent-emerald);">
    </div>
</div>


        <datalist id="customer-list"></datalist>
        <div id="customer-search-results" class="hidden" style="position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 10px; margin-top: 5px; box-shadow: var(--shadow);"></div>
    </div>
</div>

<div class="field" style="margin-bottom: 15px;">
    <label>Sales Representative (For Calculator Link)</label>
    
    <div class="toggle-row" style="display: flex; flex-wrap: nowrap; gap: 8px; width: 100%;">
        
        <input type="radio" id="rep-none" name="sales-rep" value="NONE" checked onchange="autoFillCustomerName()" class="ios-toggle-input">
        <label for="rep-none" class="ios-toggle-container" style="flex: 1; min-width: 0; white-space: nowrap; justify-content: center; padding: 4px 8px;">
            <div class="ios-toggle-switch"></div>
            <span class="ios-toggle-label">Direct</span>
        </label>

        <input type="radio" id="rep-noran" name="sales-rep" value="NORAN SHAH" onchange="autoFillCustomerName()" class="ios-toggle-input">
        <label for="rep-noran" class="ios-toggle-container" style="flex: 1; min-width: 0; white-space: nowrap; justify-content: center; padding: 4px 8px;">
            <div class="ios-toggle-switch"></div>
            <span class="ios-toggle-label">Noran</span>
        </label>

        <input type="radio" id="rep-noman" name="sales-rep" value="NOMAN SHAH" onchange="autoFillCustomerName()" class="ios-toggle-input">
        <label for="rep-noman" class="ios-toggle-container" style="flex: 1; min-width: 0; white-space: nowrap; justify-content: center; padding: 4px 8px;">
            <div class="ios-toggle-switch"></div>
            <span class="ios-toggle-label">Noman</span>
        </label>
        
    </div>
</div>



            <div class="grid-inputs">
                <div class="field"><label>Quantity (kg)</label><input type="number" id="cust-quantity" step="0.001" oninput="calculateCustomerSale()"></div>
            </div>
            <!-- Add this section after the quantity input and before store selection -->
<div id="customer-info-display" class="hidden" style="margin: 10px 0; padding: 12px; background: rgba(37, 99, 235, 0.05); border-radius: 10px; border: 1px solid var(--glass-border);">
    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 400;">Current Credit:</span>
        <span id="customer-current-credit" style="color: var(--warning); font-weight: 400;">0.00</span>
    </div>
    <div style="display: flex; justify-content: space-between;">
        <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 400;">Total Quantity:</span>
        <span id="customer-total-quantity" style="color: var(--accent); font-weight: 400;">0.00</span>
    </div>
</div>
            <!-- Store Selection for Sales -->
         <div class="field" style="margin-bottom: 15px;">
    <label>Supply</label>
    
    <div class="toggle-row" style="display: flex; flex-wrap: nowrap; gap: 8px; width: 100%;">
        
        <input type="radio" id="supply-store-a" name="supply-store" value="STORE_A" checked class="ios-toggle-input">
        <label for="supply-store-a" class="ios-toggle-container" style="flex: 1; min-width: 0; white-space: nowrap; justify-content: center; padding: 4px 8px;">
            <div class="ios-toggle-switch"></div>
            <span class="ios-toggle-label">ZUBAIR</span>
        </label>

        <input type="radio" id="supply-store-b" name="supply-store" value="STORE_B" class="ios-toggle-input">
        <label for="supply-store-b" class="ios-toggle-container" style="flex: 1; min-width: 0; white-space: nowrap; justify-content: center; padding: 4px 8px;">
            <div class="ios-toggle-switch"></div>
            <span class="ios-toggle-label">MAHMOOD</span>
        </label>

        <input type="radio" id="supply-store-c" name="supply-store" value="STORE_C" class="ios-toggle-input">
        <label for="supply-store-c" class="ios-toggle-container" style="flex: 1; min-width: 0; white-space: nowrap; justify-content: center; padding: 4px 8px;">
            <div class="ios-toggle-switch"></div>
            <span class="ios-toggle-label">ASAAN</span>
        </label>
        
    </div>
</div>

            
            <div class="field" style="margin-bottom: 15px;">
                <label>Payment:</label>
                <div class="payment-type-container">
                    <input type="radio" id="payment-cash" name="payment-type" value="CASH" checked class="ios-toggle-input">
                    <label for="payment-cash" class="ios-toggle-container">
                        <div class="ios-toggle-switch"></div>
                        <span class="ios-toggle-label">Cash</span>
                    </label>
                    
                    <input type="radio" id="payment-credit" name="payment-type" value="CREDIT" class="ios-toggle-input">
                    <label for="payment-credit" class="ios-toggle-container">
                        <div class="ios-toggle-switch"></div>
                        <span class="ios-toggle-label">Credit</span>
                    </label>
                </div>
            </div>

            <!-- Cost and Profit Display -->

            <div class="result-box">
                Total Cost: Rs <span id="cust-total-cost">0.00</span>
            </div>
            <div class="result-box">
                Total Value: Rs <span id="cust-total-value">0.00</span>
            </div>
            <div class="result-box">
                Profit: Rs <span id="cust-profit">0.00</span>
            </div>

            <button class="btn btn-main" onclick="(async () => { await saveCustomerSale() })()">Save Transaction</button>
        </div>
<!-- CUSTOMERS CARD - Updated with Edit Button -->
<div class="section liquid-card" id="customers-card">
   <div class="section-header">
    <h3 style="color:var(--text-main); margin:0;">CUSTOMERS</h3>
    <div style="display: flex; gap: 8px; align-items: center;">
        <input type="text" id="customer-filter" class="search-bar" placeholder="Filter customers..." 
               style="width: 150px; font-size: 0.7rem;" oninput="filterCustomers()">
        <span id="customer-count" style="font-size: 0.7rem; color: var(--text-muted); display:none;">0 customers</span>
        
        <button class="btn-theme" onclick="exportCustomerData('admin')" title="Download Customer List" style="color: var(--accent); border-color: var(--accent); padding: 5px 10px;">
             
        </button>
    </div>
</div>

    
    <!-- Customer List Table -->
    <div style="overflow-x: auto; max-height: 300px; overflow-y: auto; margin-top: 10px;">
        <table class="comp-table" style="font-size: 0.75rem;">
            <thead>
                <tr>
                    <th style="text-align: left; font-weight: 800;">Customer</th>
                    <th style="text-align: right; font-weight: 800;">Credit</th>
                    <th style="text-align: right; font-weight: 800;">Quantity</th>
                    <th style="text-align: center; font-weight: 800;">Actions</th>
                </tr>
            </thead>
            <tbody id="customers-table-body">
                <!-- Customer rows will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
    
    <!-- Summary Footer -->
    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--glass-border);">
        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
            <span style="color: var(--text-muted); font-weight: 400;">Total Outstanding Credit:</span>
            <span id="customers-total-credit" style="color: var(--warning); font-weight: 400;">0.00</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
            <span style="color: var(--text-muted); font-weight: 400;">Total Quantity Sold:</span>
            <span id="customers-total-quantity" style="color: var(--accent); font-weight: 400;">0.00</span>
        </div>
    </div>
</div>
        <div class="section liquid-card">
            <div class="section-header">
                <h3 style="color:var(--text-main); margin:0;">Analytics</h3>
                <div class="toggle-group">
                    <div class="toggle-opt active" id="cust-week-btn" onclick="setCustomerChartMode('week')">Weekly</div>
                    <div class="toggle-opt" id="cust-month-btn" onclick="setCustomerChartMode('month')">Monthly</div>
                    <div class="toggle-opt" id="cust-year-btn" onclick="setCustomerChartMode('year')">Yearly</div>
                    <div class="toggle-opt" id="cust-all-btn" onclick="setCustomerChartMode('all')">All Times</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-box">
                    <canvas id="custSalesChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="percentage-toggle-container">
                        <button class="percentage-toggle-btn" id="custPaymentPercentageToggle" onclick="togglePercentage('custPaymentChart')">Show %</button>
                    </div>
                    <canvas id="custPaymentChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section-header">
            <h3>Summary</h3>
        </div>
        <div class="report-grid">
            <div class="card highlight-card liquid-card">
                <h4>Daily Sales</h4>
                <p><span>Total Quantity:</span> <span class="qty-val" id="cust-day-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="cust-day-value">Rs 0.00</span></p>
                <p><span>Cash (Inc. Received):</span> <span style="color:#059669; font-weight:800;" id="cust-day-cash">Rs 0.00</span></p>
                <p><span>Pending Credits:</span> <span style="color:#f59e0b; font-weight:800;" id="cust-day-credit">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="cust-day-profit">Rs 0.00</span></p>
            </div>
            <div class="card liquid-card">
                <h4>Weekly Sales</h4>
                <p><span>Total Quantity:</span> <span class="qty-val" id="cust-week-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="cust-week-value">Rs 0.00</span></p>
                <p><span>Cash (Inc. Received):</span> <span style="color:#059669; font-weight:800;" id="cust-week-cash">Rs 0.00</span></p>
                <p><span>Pending Credits:</span> <span style="color:#f59e0b; font-weight:800;" id="cust-week-credit">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="cust-week-profit">Rs 0.00</span></p>
            </div>
            <div class="card liquid-card">
                <h4>Monthly Sales</h4>
                <p><span>Total Quantity:</span> <span class="qty-val" id="cust-month-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="cust-month-value">Rs 0.00</span></p>
                <p><span>Cash (Inc. Received):</span> <span style="color:#059669; font-weight:800;" id="cust-month-cash">Rs 0.00</span></p>
                <p><span>Pending Credits:</span> <span style="color:#f59e0b; font-weight:800;" id="cust-month-credit">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="cust-month-profit">Rs 0.00</span></p>
            </div>
            <div class="card liquid-card">
                <h4>Yearly Sales</h4>
                <p><span>Total Quantity:</span> <span class="qty-val" id="cust-year-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="cust-year-value">Rs 0.00</span></p>
                <p><span>Cash (Inc. Received):</span> <span style="color:#059669; font-weight:800;" id="cust-year-cash">Rs 0.00</span></p>
                <p><span>Pending Credits:</span> <span style="color:#f59e0b; font-weight:800;" id="cust-year-credit">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="cust-year-profit">Rs 0.00</span></p>
            </div>
            <div class="card all-times-summary liquid-card" id="all-times-sales-card" style="display: none;">
                <h4>All Times Sales</h4>
                <p><span>Total Quantity:</span> <span class="qty-val" id="cust-all-qty">0.00 kg</span></p>
                <p><span>Total Value:</span> <span class="rev-val" id="cust-all-value">Rs 0.00</span></p>
                <p><span>Cash (Inc. Received):</span> <span style="color:#059669; font-weight:800;" id="cust-all-cash">Rs 0.00</span></p>
                <p><span>Pending Credits:</span> <span style="color:#f59e0b; font-weight:800;" id="cust-all-credit">Rs 0.00</span></p>
                <p><span>Net Profit:</span> <span class="profit-val" id="cust-all-profit">Rs 0.00</span></p>
            </div>
        </div>

        <div class="section-header" style="margin-top:25px;">
            <h3>Transaction History</h3>
        </div>

        <div class="section liquid-card">
            <input type="text" id="customer-search" class="search-bar" placeholder="Search sales by name" oninput="filterCustomerTransactions()">
        </div>

        <div id="custHistoryList" class="report-grid"></div>
    </div>

    <!-- CALCULATOR TAB -->
    <div id="tab-calc" class="hidden">
        <h2 style="color:var(--accent); font-weight:800;" class="shimmer-text">CALCULATOR</h2>

        <div class="section liquid-card">
            <label>Sales Representative:</label>
            <select id="sellerSelect" class="store-selector" onchange="(async () => { await loadSalesData() })()">
                <option value="NORAN SHAH">NORAN SHAH</option>
                <option value="NOMAN SHAH">NOMAN SHAH</option>
                <option value="COMBINED">COMPARISON</option>
            </select>

            <div id="entrySection" class="hidden">
                <div class="grid-inputs">
                    <div class="field"><label>Date</label><input type="date" id="sale-date" onchange="(async () => { await loadSalesData() })()"></div>
                    <div class="field">
    <label>Total Sold Qty</label>
    <input type="number" id="totalSold" readonly style="background:rgba(37, 99, 235, 0.1); color:var(--text-main); font-weight:800; border:1px solid var(--accent);">
</div>

                  <div class="field"><label>Returned Qty</label><input type="number" id="returnedQuantity" oninput="handleReturnQtyInput()"></div>

<div id="returnStoreSection" class="hidden" style="grid-column: 1 / -1; margin: 10px 0; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border: 1px solid var(--warning);">
    <label style="color: var(--warning); font-weight: 800; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;"> Return Stock To Physical Inventory:</label>
    <div class="payment-type-container" style="margin-top: 8px;">
        <div class="payment-option">
            <input type="radio" id="ret-store-a" name="return-store" value="STORE_A">
            <label for="ret-store-a" style="color: var(--text-main);">ZUBAIR</label>
        </div>
        <div class="payment-option">
            <input type="radio" id="ret-store-b" name="return-store" value="STORE_B">
            <label for="ret-store-b" style="color: var(--text-main);">MAHMOOD</label>
        </div>
    </div>
    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;">
        * This will increase the store's stock level without creating a new production record.
    </div>
</div>


                </div>
                <div class="grid-inputs">
                    <div class="field"><label>Credit Sales Qty</label><input type="number" id="creditSales" oninput="calculateSales()"></div>
                    <div class="field"><label>Recovered Credit</label><input type="number" id="prevCreditReceived" oninput="calculateSales()"></div>
                    <div class="field"><label>Physical Cash In Hand</label><input type="number" id="receivedCash" oninput="calculateSales()"></div>
                </div>

                <div class="result-box">Expected Cash: Rs <span id="totalExpectedCash">0.00</span></div>
                <div class="result-box" id="discrepancyBox">Status: <span id="discrepancyStatus">OK</span></div>
                
                <button class="btn btn-noman" onclick="(async () => { await saveTransaction() })()">Save Transaction</button>
            </div>

            <div id="combinedSection" class="hidden">
                <div class="section-header">
                    <h3 style="color:var(--text-main); margin:0;">Comparison</h3>
                    <div class="toggle-group">
                        <div class="toggle-opt" id="comp-week-btn" onclick="(async () => { await loadSalesData('week') })()">Week</div>
                        <div class="toggle-opt" id="comp-month-btn" onclick="(async () => { await loadSalesData('month') })()">Month</div>
                        <div class="toggle-opt" id="comp-year-btn" onclick="(async () => { await loadSalesData('year') })()">Year</div>
                        <div class="toggle-opt active" id="comp-all-btn" onclick="(async () => { await loadSalesData('all') })()">All Time</div>
                    </div>
                </div>
                
                <div id="combinedExportArea">
                    <div class="field" style="margin-bottom: 12px;">
                        <label>View Chart For:</label>
                        <select id="metricSelector" class="store-selector" onchange="(async () => { await loadSalesData(currentCompMode) })()">
                            <option value="prof">Net Profit (Value)</option>
                            <option value="rev">Gross Revenue (Value)</option>
                            <option value="sold">Quantity Sold</option>
                        </select>
                    </div>

                    <div class="chart-container">
                        <div class="chart-box">
                            <p style="font-size: 10px; text-align: center; color: var(--accent); margin: 0 0 8px 0; font-weight: 800;">COMPETITION</p>
                            <canvas id="performanceChart"></canvas>
                        </div>
                        <div class="chart-box">
                            <div class="percentage-toggle-container">
                                <button class="percentage-toggle-btn" id="compositionPercentageToggle" onclick="togglePercentage('compositionChart')">Show %</button>
                            </div>
                            <p style="font-size: 10px; text-align: center; color: var(--accent); margin: 0 0 8px 0; font-weight: 800;">MARKET COMPOSITION</p>
                            <canvas id="compositionChart"></canvas>
                        </div>
                    </div>

                    <table class="comp-table">
                        <thead><tr><th>Metric Comparison</th><th id="thNoran">Noran</th><th id="thNoman">Noman</th></tr></thead>
                        <tbody id="comparisonBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Individual Sales Representative Performance Charts -->
            <div id="individualChartSection" class="hidden">
                <div class="section liquid-card">
                    <div class="section-header">
                        <h3 style="color:var(--text-main); margin:0;">Performance Analytics for <span id="selectedSellerName">...</span></h3>
                        <div class="toggle-group">
                            <div class="toggle-opt active" id="ind-week-btn" onclick="setIndChartMode('week')">Weekly</div>
                            <div class="toggle-opt" id="ind-month-btn" onclick="setIndChartMode('month')">Monthly</div>
                            <div class="toggle-opt" id="ind-year-btn" onclick="setIndChartMode('year')">Yearly</div>
                            <div class="toggle-opt" id="ind-all-btn" onclick="setIndChartMode('all')">All Times</div>
                        </div>
                    </div>
                    
                    <div class="sales-rep-metric-selector">
                        <label style="font-size: 0.65rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Select Metric:</label>
                        <select id="indMetricSelector" class="sales-rep-metric-dropdown" onchange="setIndChartMetric(this.value)">
                            <option value="weight">Weight (kg)</option>
                            <option value="value">Total Value (Rs)</option>
                            <option value="cost">Total Cost (Rs)</option>
                            <option value="profit">Net Profit (Rs)</option>
                            <option value="cash">Cash Sales (Rs)</option>
                            <option value="credit">Credit Sales (Rs)</option>
                        </select>
                    </div>
                    
                    <div class="sales-rep-chart-container">
                        <div class="sales-rep-chart-box">
                            <canvas id="indPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Performance Overview Added -->
        <div class="daily-performance-overview">
            <h3 style="margin-bottom:15px;">Performance Overview (<span id="reportSellerName">...</span>)</h3>
            <div class="report-grid" id="summary-section">
                <div id="dailyReport"></div>
                <div id="weeklyReport"></div>
                <div id="monthlyReport"></div>
                <div id="yearlyReport"></div>
                <div id="allTimeReport"></div>
                
              <div class="card all-times-summary liquid-card" id="all-times-calculator-card" style="display: none;">
                    <h4>All Times Summary</h4>
                    <p><span>Total Sold:</span> <span class="qty-val" id="all-sold">0.00</span></p>
                    <p><span>Returns:</span> <span class="qty-val" id="all-ret">0.00</span></p>
                    <p><span>Revenue:</span> <span class="rev-val" id="all-revenue">Rs 0.00</span></p>
                    <p><span>Profit:</span> <span class="profit-val" id="all-profit-calc">Rs 0.00</span></p>
                    <hr>
                    <p><span>Credit Out:</span> <span class="cost-val" id="all-creditVal">Rs 0.00</span></p>
                    <p><span>Credit In:</span> <span class="profit-val" id="all-collected">Rs 0.00</span></p>
                    <p><span>Net Debt:</span> <span class="balance-neg" id="all-balance">Rs 0.00</span></p>
                </div>
            </div>
        </div>
        
        <div class="debt-panel liquid-card">
            <div style="text-align:center; font-weight:800; font-size:13px; text-transform:uppercase; margin-bottom:12px; color:var(--text-main);"><span id="debtSellerName">...</span> Market Debt Tracker</div>
            <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(100,100,100,0.1);">
                <span>Total Credit Issued:</span> <span id="ltCredit">Rs 0.00</span>
            </div>
            <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(100,100,100,0.1);">
                <span>Total Cash Recovered:</span> <span id="ltCollected">Rs 0.00</span>
            </div>
            <div style="display:flex; justify-content:space-between; padding:12px 0 0 0; font-size:1.1rem; font-weight:800;">
                <span>Current Market Debt:</span> <span id="ltBalance">Rs 0.00</span>
            </div>
        </div>

        <div class="section-header" style="margin-top:25px;">
            <h3>Transaction History</h3>
        </div>

        <!-- Search Bar for Calculator History -->
        <div class="section liquid-card">
            <input type="text" id="calculator-search" class="search-bar" placeholder=" Search calculator history by date or seller..." oninput="filterCalculatorHistory()">
        </div>

        <div id="historyList" class="report-grid"></div>
    </div>

    <!-- FACTORY TAB -->
    <div id="tab-factory" class="hidden">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
            <h1 style="color:var(--text-main); font-weight:800; margin:0;" class="shimmer-text">Factory</h1>
            <div style="display:flex; gap:10px;">
                <button class="btn-theme" onclick="openFactorySettings()"></button>
            </div>
        </header>

        <!-- ADDED: Date Selection for Factory Tab -->
        <div class="section liquid-card">
            <div class="section-header">
                <h3 style="color:var(--accent); margin-top:0;">Date Selection</h3>
            </div>
            <div class="field">
                <label>Select Date for Reports</label>
                <input type="date" id="factory-date" onchange="refreshFactoryTab()">
            </div>
        </div>

        <div class="section liquid-card">
            <div class="section-header">
                <h3 style="color:var(--accent); margin-top:0;">New Production Entry</h3>
            </div>
            
            <div class="factory-store-selector">
                <div class="factory-store-opt active" onclick="selectFactoryEntryStore('standard', this)">STANDARD STORE</div>
                <div class="factory-store-opt" onclick="selectFactoryEntryStore('asaan', this)">ASAAN STORE</div>
            </div>

            <div class="grid-inputs">
                <div class="field">
                    <label>Units to Produce</label>
                    <input type="number" id="factoryProductionUnits" value="1" min="1" oninput="calculateFactoryProduction()">
                </div>
                <div class="field">
                    <label>Total Cost</label>
                    <div id="factoryTotalProductionCostDisplay" class="cost-display">0 PKR</div>
                </div>
            </div>

            <div id="factoryFormulaDisplay" class="formula-display">
                Select a store...
            </div>

            <button class="btn btn-noman" onclick="(async () => { await saveFactoryProductionEntry() })()">Save Production Entry</button>
        </div>

        <div class="section liquid-card">
            <div class="section-header">
                <h3 style="color:var(--text-main); margin:0;">Units Available <span class="update-indicator" id="unitsUpdateIndicator"></span></h3>
                <div class="toggle-group">
                    <div class="toggle-opt active" onclick="setFactoryAvailableStore('standard', this)">Standard Store</div>
                    <div class="toggle-opt" onclick="setFactoryAvailableStore('asaan', this)">Asaan Store</div>
                </div>
            </div>

            <div id="factoryAvailStatsStandard">
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Available Units</span>
                    <span class="qty-val" id="factoryStdUnits">0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Used Units</span>
                    <span class="qty-val" id="factoryStdUsedUnits">0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Per Unit Cost</span>
                    <span class="cost-val" id="factoryStdUnitCost">PKR 0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Total Cost Value</span>
                    <span class="rev-val" id="factoryStdTotalVal">PKR 0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Output Quantity</span>
                    <span class="qty-val" id="factoryStdOutput">0 kg</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Raw Materials Used</span>
                    <span class="qty-val" id="factoryStdRawUsed">0 kg</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Materials Value</span>
                    <span class="cost-val" id="factoryStdMatVal">PKR 0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Total Profit</span>
                    <span class="profit-val" id="factoryStdProfit">PKR 0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Profit Per Unit</span>
                    <span class="profit-val" id="factoryStdProfitUnit">PKR 0</span>
                </div>
            </div>

            <div id="factoryAvailStatsAsaan" class="hidden">
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Available Units</span>
                    <span class="qty-val" id="factoryAsaanUnits">0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Used Units</span>
                    <span class="qty-val" id="factoryAsaanUsedUnits">0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Per Unit Cost</span>
                    <span class="cost-val" id="factoryAsaanUnitCost">PKR 0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Total Cost Value</span>
                    <span class="rev-val" id="factoryAsaanTotalVal">PKR 0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Output Quantity</span>
                    <span class="qty-val" id="factoryAsaanOutput">0 kg</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Raw Materials Used</span>
                    <span class="qty-val" id="factoryAsaanRawUsed">0 kg</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Materials Value</span>
                    <span class="cost-val" id="factoryAsaanMatVal">PKR 0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Total Profit</span>
                    <span class="profit-val" id="factoryAsaanProfit">PKR 0</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Profit Per Unit</span>
                    <span class="profit-val" id="factoryAsaanProfitUnit">PKR 0</span>
                </div>
            </div>
        </div>

        <div class="section liquid-card">
            <div class="section-header">
                <h3 style="color:var(--text-main); margin:0;">Raw Material Inventory</h3>
                <button class="btn-theme" style="font-size:0.8rem;" onclick="openFactoryInventoryModal()"></button>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="factory-inventory-table">
                    <thead>
                        <tr>
                            <th>Material Name</th>
                            <th style="text-align:center;">Stock</th>
                            <th style="text-align:right;">Cost/Unit</th>
                            <th style="text-align:right;">Total Value</th>
                            <th style="text-align:center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="factoryInventoryTableBody">
                        <!-- Inventory rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top:15px; text-align:right; font-weight:800; color:var(--text-main);">
                Total Inventory Value: <span class="rev-val" id="factoryTotalInventoryValue">0 PKR</span>
            </div>
        </div>

        <div class="section liquid-card">
            <div class="section-header">
                <h3 style="color:var(--text-main); margin:0;">Performance Summary</h3>
                <div class="toggle-group">
                    <div class="toggle-opt active" onclick="setFactorySummaryMode('daily', this)">Daily</div>
                    <div class="toggle-opt" onclick="setFactorySummaryMode('weekly', this)">Weekly</div>
                    <div class="toggle-opt" onclick="setFactorySummaryMode('monthly', this)">Monthly</div>
                    <div class="toggle-opt" onclick="setFactorySummaryMode('yearly', this)">Yearly</div>
                    <div class="toggle-opt" onclick="setFactorySummaryMode('all', this)">All Times</div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="comp-table">
                    <tbody id="factorySummaryTableBody">
                        <tr>
                            <td>Available Units</td>
                            <td style="text-align:right;" class="qty-val" id="factorySumUnits">0</td>
                        </tr>
                        <tr>
                            <td>Used Units</td>
                            <td style="text-align:right;" class="qty-val" id="factorySumUsedUnits">0</td>
                        </tr>
                        <tr>
                            <td>Per Unit Cost</td>
                            <td style="text-align:right;" class="cost-val" id="factorySumUnitCost">PKR 0.00</td>
                        </tr>
                        <tr>
                            <td>Total Cost Value</td>
                            <td style="text-align:right;" class="rev-val" id="factorySumTotalCost">PKR 0.00</td>
                        </tr>
                        <tr>
                            <td>Output Quantity</td>
                            <td style="text-align:right;" class="qty-val" id="factorySumOutput">0.00 kg</td>
                        </tr>
                        <tr>
                            <td>Raw Materials Used</td>
                            <td style="text-align:right;" class="qty-val" id="factorySumRawUsed">0.00 kg</td>
                        </tr>
                        <tr>
                            <td>Materials Value</td>
                            <td style="text-align:right;" class="cost-val" id="factorySumMatVal">PKR 0.00</td>
                        </tr>
                        <tr>
                            <td>Total Profit</td>
                            <td style="text-align:right;" class="profit-val" id="factorySumProfit">PKR 0.00</td>
                        </tr>
                        <tr>
                            <td>Profit Per Unit</td>
                            <td style="text-align:right;" class="profit-val" id="factorySumProfitUnit">PKR 0.00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section liquid-card">
            <div class="section-header">
                <h3 style="color:var(--text-main); margin:0;">Recent Production Activity</h3>
            </div>
            <div id="factoryHistoryList">
                <!-- History items will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- PAYMENTS TAB -->
    <div id="tab-payments" class="hidden">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
            <h1 style="color:var(--text-main); font-weight:800; margin:0;" class="shimmer-text">Payments</h1>
            <button class="btn-theme" onclick="openEntityManagement()"></button>
        </header>

        <!-- NET CASH & ECONOMIC HEALTH DASHBOARD -->
<div class="section liquid-card net-cash-dashboard">
    <h3 style="color:var(--accent); margin-top:0; text-align:center;">ECONOMIC HEALTH DASHBOARD</h3>
    
    <!-- Main Cash Indicator -->
    <div class="net-cash-value" id="netCashValue">Rs 0.00</div>
    
    <!-- Operating Cash Flow -->
    <div class="formula-item" style="background:rgba(37, 99, 235, 0.1); padding:10px; border-radius:8px; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="color:var(--accent); font-weight:800; font-size:0.9rem;">Operating Cash Flow:</span>
            <span style="font-weight:800; font-size:1.1rem; color:var(--accent-emerald);" id="operatingCashFlow">Rs 0.00</span>
        </div>
    </div>
    
    <!-- DETAILED CASH IN HAND BREAKDOWN -->
    <div class="formula-breakdown">
        <h4 style="color:var(--accent-emerald); margin:15px 0 10px 0; border-bottom:2px solid var(--accent-emerald); padding-bottom:5px;">CASH IN HAND DETAILS</h4>
        
        <div class="formula-item">
            <span>Net Sales Cash (Direct Customers):</span>
            <span class="formula-value" id="cashDetailDirectSales">Rs 0.00</span>
        </div>
        
        <div class="formula-item">
            <span>Net Production Cash (After Credits):</span>
            <span class="formula-value" id="cashDetailProductionCash">Rs 0.00</span>
        </div>
        
        <div class="formula-item">
            <span>Representative Collections:</span>
            <span class="formula-value" id="cashDetailRepCollections">Rs 0.00</span>
        </div>
        
        <div class="formula-item">
            <span>External Payments Received:</span>
            <span class="formula-value" id="cashDetailPaymentsIn">Rs 0.00</span>
        </div>
        
        <div class="formula-item" style="background:rgba(220, 38, 38, 0.1); padding:5px; border-radius:5px;">
            <span>External Payments Made:</span>
            <span class="formula-value" style="color:var(--danger);" id="cashDetailPaymentsOut">Rs 0.00</span>
        </div>
        
        <div class="formula-item" style="font-weight:800; background:rgba(37, 99, 235, 0.1); padding:8px; border-radius:6px; margin-top:5px;">
            <span>NET CASH IN HAND:</span>
            <span class="formula-value" style="color:var(--accent-emerald);" id="cashDetailNet">Rs 0.00</span>
        </div>
        
        <!-- CURRENT ASSETS SECTION -->
        <h4 style="color:var(--store-a); margin:15px 0 10px 0; border-bottom:2px solid var(--store-a); padding-bottom:5px;">CURRENT ASSETS</h4>
        
        <div class="formula-item">
            <span>Cash in Hand (Above):</span>
            <span class="formula-value" id="formulaProdTotal">Rs 0.00</span>
        </div>
        
        <div class="formula-item">
            <span>Raw Materials Inventory:</span>
            <span class="formula-value" style="color:var(--store-a);" id="formulaRawMaterials">Rs 0.00</span>
        </div>
        
        <div class="formula-item">
            <span>Formula Units Inventory:</span>
            <span class="formula-value" style="color:var(--store-b);" id="formulaUnitsValue">Rs 0.00</span>
        </div>
        
        <!-- ACCOUNTS RECEIVABLE -->
        <h4 style="color:var(--accent); margin:15px 0 10px 0; border-bottom:2px solid var(--accent); padding-bottom:5px;">ACCOUNTS RECEIVABLE</h4>
        
        <div class="formula-item">
            <span>Direct Customer Credits:</span>
            <span class="formula-value" id="salesReceivables">Rs 0.00</span>
        </div>
        <div class="formula-item">
    <span>Production Tab Credits:</span>
    <span class="formula-value" id="productionReceivables">Rs 0.00</span>
</div>
        <div class="formula-item">
            <span>Representative Credits:</span>
            <span class="formula-value" id="calculatorReceivables">Rs 0.00</span>
        </div>
        
        <div class="formula-item" style="font-weight:800; background:rgba(37, 99, 235, 0.05); padding:8px; border-radius:6px;">
            <span>TOTAL RECEIVABLES:</span>
            <span class="formula-value" style="color:var(--accent);" id="formulaReceivables">Rs 0.00</span>
        </div>
        
        <!-- CURRENT ASSETS TOTAL -->
        <div class="formula-item" style="font-weight:800; background:rgba(37, 99, 235, 0.1); padding:8px; border-radius:6px; margin-top:10px;">
            <span>TOTAL CURRENT ASSETS:</span>
            <span class="formula-value" style="color:var(--accent-emerald);" id="currentAssetsTotal">Rs 0.00</span>
        </div>
        
        <!-- CURRENT LIABILITIES -->
        <h4 style="color:var(--danger); margin:15px 0 10px 0; border-bottom:2px solid var(--danger); padding-bottom:5px;">CURRENT LIABILITIES</h4>

        <!-- ACCOUNTS PAYABLE SECTION -->
        <div class="formula-item" style="font-weight:700; color:var(--danger);">
            <span>ACCOUNTS PAYABLE:</span>
        </div>

        <div class="formula-item" style="margin-left:15px;">
            <span>Supplier Payables (Inventory Purchases):</span>
            <span class="formula-value" style="color:var(--danger);" id="supplierPayables">Rs 0.00</span>
        </div>

        <!-- OTHER PAYABLES BREAKDOWN -->
        <div class="formula-item" style="margin-left:15px;">
            <span>Other Payables:</span>
        </div>
        <div class="formula-item" style="margin-left:30px; font-size:0.8rem;">
            <span>Operating Expenses:</span>
            <span class="formula-value" style="color:var(--danger);" id="otherPayablesOperating">Rs 0.00</span>
        </div>
        <div class="formula-item" style="margin-left:30px; font-size:0.8rem;">
            <span>Loan/Debt Payments:</span>
            <span class="formula-value" style="color:var(--danger);" id="otherPayablesLoans">Rs 0.00</span>
        </div>
        <div class="formula-item" style="margin-left:30px; font-size:0.8rem;">
            <span>Miscellaneous Payments:</span>
            <span class="formula-value" style="color:var(--danger);" id="otherPayablesMisc">Rs 0.00</span>
        </div>

        <div class="formula-item" style="margin-left:15px; font-weight:700; background:rgba(220, 38, 38, 0.05); padding:5px; border-radius:5px;">
            <span>TOTAL ACCOUNTS PAYABLE:</span>
            <span class="formula-value" style="color:var(--danger);" id="formulaPayOut">Rs 0.00</span>
        </div>

        <!-- TOTAL CURRENT LIABILITIES -->
        <div class="formula-item" style="font-weight:800; background:rgba(220, 38, 38, 0.1); padding:8px; border-radius:6px; margin-top:10px;">
            <span>TOTAL CURRENT LIABILITIES:</span>
            <span class="formula-value" style="color:var(--danger);" id="currentLiabilitiesTotal">Rs 0.00</span>
        </div>
        
        <!-- Key Economic Indicators -->
        <div class="formula-item" style="font-weight:800; color:var(--accent-emerald); background:rgba(5, 150, 105, 0.1); padding:10px; border-radius:8px;">
            <span>Net Working Capital:</span>
            <span class="formula-value" id="formulaPayIn">Rs 0.00</span>
        </div>
        
        <div class="formula-item" style="font-weight:800; color:var(--accent); background:rgba(37, 99, 235, 0.1); padding:10px; border-radius:8px;">
            <span>Total Enterprise Value:</span>
            <span class="formula-value" id="formulaFinal">Rs 0.00</span>
        </div>
        
        <!-- Financial Ratios -->
        <h4 style="color:var(--text-main); margin:15px 0 10px 0; border-bottom:1px solid var(--glass-border); padding-bottom:5px;">FINANCIAL RATIOS</h4>
        
        <div class="formula-item">
            <span>Current Ratio:</span>
            <span class="formula-value" id="formulaCalcDisc">1.00</span>
        </div>
        
        <div class="formula-item">
            <span>Quick Ratio:</span>
            <span class="formula-value" id="quickRatio">1.00</span>
        </div>
        
        <div class="formula-item">
            <span>Cash Ratio:</span>
            <span class="formula-value" id="cashRatio">1.00</span>
        </div>
    </div>
</div>
<!-- Add this after the NET CASH DASHBOARD section -->
<div class="section liquid-card">
    <div class="section-header">
        <h3 style="color:var(--text-main); margin:0;">CASH IN HAND TRACKER</h3>
        <div class="toggle-group">
            <div class="toggle-opt active" onclick="setCashTrackerMode('day')">Daily</div>
            <div class="toggle-opt" onclick="setCashTrackerMode('week')">Weekly</div>
            <div class="toggle-opt" onclick="setCashTrackerMode('month')">Monthly</div>
            <div class="toggle-opt" onclick="setCashTrackerMode('year')">Yearly</div>
            <div class="toggle-opt" onclick="setCashTrackerMode('all')">All Times</div>
        </div>
    </div>
    
    <div class="report-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
        <!-- Cash Tracker Card -->
        <div class="card highlight-card liquid-card">
            <h4>Net Cash Flow</h4>
            <p><span>Production Value:</span> <span class="rev-val" id="cash-prod-value">Rs 0.00</span></p>
            <p><span>Production Credits:</span> <span class="cost-val" id="cash-prod-credits">Rs 0.00</span></p>
            <p><span>Sales Tab Cash:</span> <span class="profit-val" id="cash-sales-cash">Rs 0.00</span></p>
            <p><span>Calculator Cash:</span> <span class="profit-val" id="cash-calculator-cash">Rs 0.00</span></p>
            <p><span>Payments In:</span> <span class="profit-val" id="cash-payments-in">Rs 0.00</span></p>
            <p><span>Payments Out:</span> <span class="cost-val" id="cash-payments-out">Rs 0.00</span></p>
            <hr style="margin: 10px 0;">
            <p><span>NET CASH:</span> <span class="profit-val" id="cash-net-total" style="font-size:1.2rem;">Rs 0.00</span></p>
        </div>
        
        <!-- Total Credits Card -->
        <!-- Find this card in your HTML (around line 1530) -->
<div class="card liquid-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border-color: rgba(245, 158, 11, 0.3);">
    <h4 style="color:var(--warning);">TOTAL OUTSTANDING CREDITS</h4>
    <p><span>Production Tab Credits:</span> <span class="qty-val" id="credit-production">Rs 0.00</span></p>
    <p><span>Sales Tab Credits:</span> <span class="qty-val" id="credit-sales-tab">Rs 0.00</span></p>
    <p><span>Calculator Credits:</span> <span class="qty-val" id="credit-calculator">Rs 0.00</span></p>
    <hr style="margin: 10px 0; border-color: rgba(245, 158, 11, 0.2);">
    <p><span>TOTAL CREDITS:</span> <span class="cost-val" id="credit-total" style="font-size:1.2rem; color:var(--warning);">Rs 0.00</span></p>
    <div style="font-size:0.7rem; color:var(--text-muted); margin-top:8px;">
        <span class="update-indicator"></span> Credits awaiting collection
    </div>
</div>
    </div>
</div>


        <!-- Entity Selection -->
        <div class="section liquid-card">
            <div class="section-header">
                <h3 style="color:var(--text-main); margin:0;">Quick Entity Selection</h3>
            </div>
            <div class="entity-scroller" id="entityScroller">
                <!-- Entities will be populated by JavaScript -->
            </div>
            <div style="text-align:center; margin-top:10px; font-size:0.75rem; color:var(--text-muted);">
                Click an entity to select it for transaction
            </div>
        </div>

        <!-- Transaction Entry -->
        <div class="section liquid-card">
            <h3 style="color:var(--accent); margin-top:0;">New Payment Transaction</h3>
            
            <div class="grid-inputs">
                <div class="field">
                    <label>Entity</label>
                    <select id="paymentEntity" class="store-selector">
                        <option value="">Select Entity</option>
                    </select>
                </div>
                <div class="field">
                    <label>Date</label>
                    <input type="date" id="paymentDate">
                </div>
            </div>
            
            <div class="grid-inputs">
                <div class="field">
                    <label>Amount (Rs)</label>
                    <input type="number" id="paymentAmount" step="0.01" min="0">
                </div>
                <div class="field">
                    <label>Description</label>
                    <input type="text" id="paymentDescription" placeholder="Purpose of payment">
                </div>
            </div>
            
            <div class="field" style="margin-bottom: 15px;">
                <label>Transaction Type:</label>
                <div class="payment-type-container">
                    <div class="payment-option">
                        <input type="radio" id="payment-type-out" name="paymentTransactionType" value="OUT" checked>
                        <label for="payment-type-out">Payment out</label>
                    </div>
                    <div class="payment-option">
                        <input type="radio" id="payment-type-in" name="paymentTransactionType" value="IN">
                        <label for="payment-type-in">Payment IN</label>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-main" onclick="(async () => { await savePaymentTransaction() })()">Save Transaction</button>
        </div>
        <div id="entityManagementOverlay" class="factory-overlay">
    <div class="factory-overlay-card liquid-card" style="max-width: 400px;">
        <div class="section-header">
            <h3 id="entityManagementModalTitle">Add New Entity</h3>
            <button class="btn-theme" onclick="closeEntityManagement()"></button>
        </div>
        
        <div class="grid-inputs">
            <div class="field">
                <label>Entity Name</label>
                <input type="text" id="entityName" placeholder="Name (e.g. John Doe)">
            </div>
            <div class="field">
                <label>Type</label>
                <select id="entityType">
                    <option value="payee">Payee (Supplier/Receiver)</option>
                    <option value="payor">Payor (Customer/Payer)</option>
                </select>
            </div>
        </div>
        
        <div class="grid-inputs">
            <div class="field">
                <label>Phone Number</label>
                <input type="tel" id="entityPhone" placeholder="03XX-XXXXXXX">
            </div>
            <div class="field">
                <label>Wallet/Note</label>
                <input type="text" id="entityWallet" placeholder="Easypaisa/JazzCash etc.">
            </div>
        </div>
        
        <button class="btn btn-noman" onclick="(async () => { await saveEntity() })()" style="margin-top: 15px;">Save Entity</button>
    </div>
</div>

<!-- ENTITY LIST CARD - REPLACED TABLE WITH CARD VIEW -->
<div class="section liquid-card" id="entities-card">
    <div class="section-header">
        <h3 style="color:var(--text-main); margin:0;">Entities & Balances</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" id="entity-list-filter" class="search-bar" placeholder="Filter entities..." 
                   style="width: 140px; font-size: 0.7rem;" oninput="renderEntityTable()">
            
            <button class="btn-theme" onclick="exportEntityData()" title="Download CSV" style="color: var(--accent-emerald); border-color: var(--accent-emerald); padding: 5px 10px;">
                
            </button>
            
            <button class="btn-theme" onclick="openEntityManagement()" title="Add New Entity" style="color: var(--accent); border-color: var(--accent); padding: 5px 10px;">
                + Add
            </button>
        </div>
    </div>

    <div style="overflow-x: auto; max-height: 400px; overflow-y: auto; margin-top: 10px;">
        <table class="comp-table" style="font-size: 0.75rem;">
            <thead>
                <tr>
                    <th style="text-align: left; font-weight: 800;">Entity Name</th>
                    <th style="text-align: right; font-weight: 800;">Net Balance</th>
                    <th style="text-align: right; font-weight: 800;">Contact</th>
                    <th style="text-align: center; font-weight: 800;">Actions</th>
                </tr>
            </thead>
            <tbody id="entity-table-body">
                </tbody>
        </table>
    </div>

    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--glass-border);">
        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
            <span style="color: var(--text-muted); font-weight: 400;">Total Receivables (Green):</span>
            <span id="total-receivables" style="color: var(--accent-emerald); font-weight: 800;">Rs 0.00</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
            <span style="color: var(--text-muted); font-weight: 400;">Total Payables (Red):</span>
            <span id="total-payables" style="color: var(--danger); font-weight: 800;">Rs 0.00</span>
        </div>
    </div>
</div>

        <!-- Summary Reports -->
        <div class="section-header">
            <h3>Payment Summary</h3>
        </div>
        <div class="report-grid">
            <div class="card highlight-card liquid-card">
                <h4>Daily Payments</h4>
                <p><span>Total IN:</span> <span class="profit-val" id="payments-day-in">Rs 0.00</span></p>
                <p><span>Total OUT:</span> <span class="cost-val" id="payments-day-out">Rs 0.00</span></p>
                <p><span>Net Flow:</span> <span class="rev-val" id="payments-day-net">Rs 0.00</span></p>
                <p><span>Transaction Count:</span> <span class="qty-val" id="payments-day-count">0</span></p>
            </div>
            <div class="card liquid-card">
                <h4>Weekly Payments</h4>
                <p><span>Total IN:</span> <span class="profit-val" id="payments-week-in">Rs 0.00</span></p>
                <p><span>Total OUT:</span> <span class="cost-val" id="payments-week-out">Rs 0.00</span></p>
                <p><span>Net Flow:</span> <span class="rev-val" id="payments-week-net">Rs 0.00</span></p>
                <p><span>Transaction Count:</span> <span class="qty-val" id="payments-week-count">0</span></p>
            </div>
            <div class="card liquid-card">
                <h4>Monthly Payments</h4>
                <p><span>Total IN:</span> <span class="profit-val" id="payments-month-in">Rs 0.00</span></p>
                <p><span>Total OUT:</span> <span class="cost-val" id="payments-month-out">Rs 0.00</span></p>
                <p><span>Net Flow:</span> <span class="rev-val" id="payments-month-net">Rs 0.00</span></p>
                <p><span>Transaction Count:</span> <span class="qty-val" id="payments-month-count">0</span></p>
            </div>
            <div class="card liquid-card">
                <h4>Yearly Payments</h4>
                <p><span>Total IN:</span> <span class="profit-val" id="payments-year-in">Rs 0.00</span></p>
                <p><span>Total OUT:</span> <span class="cost-val" id="payments-year-out">Rs 0.00</span></p>
                <p><span>Net Flow:</span> <span class="rev-val" id="payments-year-net">Rs 0.00</span></p>
                <p><span>Transaction Count:</span> <span class="qty-val" id="payments-year-count">0</span></p>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="section-header" style="margin-top:25px;">
            <h3>Payment History</h3>
        </div>
        
        <div class="section liquid-card">
            <input type="text" id="payment-search" class="search-bar" placeholder=" Search payment history by entity or description..." oninput="filterPaymentHistory()">
        </div>

        <div id="paymentHistoryList" class="report-grid"></div>
    </div>
</div>
<div id="connection-indicator" title="Checking Connection..."></div>


<script>

    // --- GLOBAL ENFORCEMENT ---
    const USE_IDB_ONLY = true;

    // --- INDEXEDDB STORAGE MANAGER ---
    const IDB_CONFIG = {
        name: 'NaswarDealersDB',
        version: 1,
        store: 'app_data'
    };

    const idb = {
        db: null,
        async init() {
            if (this.db) return this.db;
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(IDB_CONFIG.name, IDB_CONFIG.version);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(IDB_CONFIG.store)) {
                        db.createObjectStore(IDB_CONFIG.store);
                    }
                };
                request.onsuccess = (e) => {
                    this.db = e.target.result;
                    resolve(this.db);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        },
        async get(key, defaultValue = null) {
            await this.init();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(IDB_CONFIG.store, 'readonly');
                const store = transaction.objectStore(IDB_CONFIG.store);
                const request = store.get(key);
                request.onsuccess = () => {
                    const val = request.result;
                    if (val === undefined) resolve(defaultValue);
                    else {
                        try {
                            resolve(JSON.parse(val));
                        } catch (e) {
                            resolve(val);
                        }
                    }
                };
                request.onerror = () => reject(request.error);
            });
        },
        async set(key, value) {
            await this.init();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(IDB_CONFIG.store, 'readwrite');
                const store = transaction.objectStore(IDB_CONFIG.store);
                const val = typeof value === 'string' ? value : JSON.stringify(value);
                const request = store.put(val, key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        },
        async remove(key) {
            await this.init();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(IDB_CONFIG.store, 'readwrite');
                const store = transaction.objectStore(IDB_CONFIG.store);
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
    };

 // Global data loading function with Strict Purge Protocol
async function loadAllData() {
    // 1. Purge Protocol: One-time migration from LocalStorage to IndexedDB
    const keysToMigrate = [
        'mfg_pro_pkr', 'noman_history', 'customer_sales', 'factory_inventory_data',
        'factory_production_history', 'factory_default_formulas', 'factory_additional_costs',
        'factory_sale_prices', 'factory_cost_adjustment_factor', 'factory_unit_tracking',
        'payment_entities', 'payment_transactions', 'stock_returns', 'naswar_default_settings',
        'appMode', 'repProfile', 'adminPin', 'theme', 'bio_enabled', 'bio_cred_id', 'last_synced',
        'deleted_records' // Added to migration list
    ];

    let migrationNeeded = false;
    for (const key of keysToMigrate) {
        if (localStorage.getItem(key) !== null) {
            migrationNeeded = true;
            break;
        }
    }

    if (migrationNeeded) {
        console.log(" LocalStorage data detected. Initiating Purge Protocol...");
        for (const key of keysToMigrate) {
            const lsValue = localStorage.getItem(key);
            if (lsValue !== null) {
                try {
                    let parsedValue;
                    try {
                        parsedValue = JSON.parse(lsValue);
                    } catch (e) {
                        parsedValue = lsValue;
                    }
                    await idb.set(key, parsedValue);
                } catch (e) {
                    console.error(`Migration failed for key ${key}:`, e);
                }
            }
        }
        localStorage.clear();
        console.log(" Data migrated and LocalStorage purged successfully.");
    }

    // 2. Strict Initialization: Load data exclusively from IndexedDB
    const [
        idb_db, 
        idb_salesHistory, 
        idb_customerSales, 
        idb_repSales,
        idb_factoryInventoryData,
        idb_factoryProductionHistory, 
        idb_factoryDefaultFormulas, 
        idb_factoryAdditionalCosts,
        idb_factorySalePrices, 
        idb_factoryCostAdjustmentFactor, 
        idb_factoryUnitTracking,
        idb_paymentEntities, 
        idb_paymentTransactions, 
        idb_stockReturns, 
        idb_defaultSettings,
        idb_appMode, 
        idb_currentRepProfile, 
        idb_adminPin,
        idb_deletedRecords // <--- NEW: Retrieve deleted records list
    ] = await Promise.all([
        idb.get('mfg_pro_pkr', []),
        idb.get('noman_history', []),
        idb.get('customer_sales', []),
        idb.get('rep_sales', []),
        idb.get('factory_inventory_data', []),
        idb.get('factory_production_history', []),
        idb.get('factory_default_formulas', { standard: [], asaan: [] }),
        idb.get('factory_additional_costs', { standard: 0, asaan: 0 }),
        idb.get('factory_sale_prices', { standard: 0, asaan: 0 }),
        idb.get('factory_cost_adjustment_factor', { standard: 1, asaan: 1 }),
        idb.get('factory_unit_tracking', {
            standard: { produced: 0, consumed: 0, available: 0, unitCostHistory: [] },
            asaan: { produced: 0, consumed: 0, available: 0, unitCostHistory: [] }
        }),
        idb.get('payment_entities', []),
        idb.get('payment_transactions', []),
        idb.get('stock_returns', []),
        idb.get('naswar_default_settings', {}),
        idb.get('appMode', 'admin'),
        idb.get('repProfile', 'NORAN SHAH'),
        idb.get('adminPin', '1234'),
        idb.get('deleted_records', []) // <--- NEW: Add to database fetch
    ]);

    // Populate global variables
    db = idb_db;
    salesHistory = idb_salesHistory;
    customerSales = idb_customerSales;
    repSales = idb_repSales;
    factoryInventoryData = idb_factoryInventoryData;
    factoryProductionHistory = idb_factoryProductionHistory;
    factoryDefaultFormulas = idb_factoryDefaultFormulas;
    factoryAdditionalCosts = idb_factoryAdditionalCosts;
    factorySalePrices = idb_factorySalePrices;
    factoryCostAdjustmentFactor = idb_factoryCostAdjustmentFactor;
    factoryUnitTracking = idb_factoryUnitTracking;
    paymentEntities = idb_paymentEntities;
    paymentTransactions = idb_paymentTransactions;
    stockReturns = idb_stockReturns;
    defaultSettings = idb_defaultSettings;
    appMode = idb_appMode;
    currentRepProfile = idb_currentRepProfile;
    adminPin = idb_adminPin;
    
    // NEW: Initialize global deletion registry
    deletedRecordIds = new Set(idb_deletedRecords || []);
    
    console.log(` Global variables populated. Loaded ${deletedRecordIds.size} tombstoned deletion records.`);
}

    // --- DATA INITIALIZATION ---
    let db = [];
    let salesHistory = [];
    let customerSales = [];
    let repSales = []; // Isolated Rep Data Structure

    // --- MIGRATION LOGIC: customerSales to repSales ---
    async function migrateRepData() {
        const hasMigrated = await idb.get('rep_data_migrated', false);
        if (hasMigrated) return;

        console.log("Starting Rep Data Migration...");
        const repEntries = customerSales.filter(s => s.isRepModeEntry === true);
        
        if (repEntries.length > 0) {
            // Merge with existing repSales just in case
            repSales = [...new Set([...repSales, ...repEntries])];
            await idb.set('rep_sales', repSales);
            
            // Remove from customerSales
            customerSales = customerSales.filter(s => s.isRepModeEntry !== true);
            await idb.set('customer_sales', customerSales);
            
            console.log(`Migrated ${repEntries.length} entries to repSales.`);
        }
        
        await idb.set('rep_data_migrated', true);
    }
    
    // Factory data
    let factoryInventoryData = [];
    let factoryProductionHistory = [];
    let factoryDefaultFormulas = { standard: [], asaan: [] };
    
    // Factory additional costs per unit
    let factoryAdditionalCosts = { standard: 0, asaan: 0 };
    
    // NEW: Factory sale prices
    let factorySalePrices = { standard: 0, asaan: 0 };
    
    // NEW: Cost adjustment factor (X)
    let factoryCostAdjustmentFactor = { standard: 1, asaan: 1 };
    
    // Unit tracking data structure
    let factoryUnitTracking = {
        standard: {
            produced: 0,
            consumed: 0,
            available: 0,
            unitCostHistory: []
        },
        asaan: {
            produced: 0,
            consumed: 0,
            available: 0,
            unitCostHistory: []
        }
    };
    function generateUUID(prefix = 'txn') {
        return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    // --- DARK MODE TOGGLE ---
async function toggleDarkMode() {
    const html = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    
    // Get current theme
    const currentTheme = html.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    // Set the new theme
    html.setAttribute('data-theme', newTheme);
    
    // Update the button with emojis
    if (newTheme === 'dark') {
        themeToggle.textContent = '';
        themeToggle.title = "Switch to Light Mode";
        await idb.set('theme', 'dark');
    } else {
        themeToggle.textContent = '';
        themeToggle.title = "Switch to Dark Mode";
        await idb.set('theme', 'light');
    }
    
    // Update meta theme-color
    const metaThemeColor = document.querySelector('meta[name="theme-color"]');
    if (metaThemeColor) {
        metaThemeColor.setAttribute('content', newTheme === 'light' ? '#ffffff' : '#000000');
    }
    
    // Update charts if they exist
    if (mfgBarChart) mfgBarChart.update();
    if (mfgPieChart) mfgPieChart.update();
    if (custSalesChart) custSalesChart.update();
    if (custPaymentChart) custPaymentChart.update();
    if (storeComparisonChart) storeComparisonChart.update();
    if (salesPerfChart) salesPerfChart.update();
    if (salesCompChart) salesCompChart.update();
    if (indPerformanceChart) indPerformanceChart.update();
}

// Check for saved theme preference on load
async function initTheme() {
    const savedTheme = await idb.get('theme');
    const themeToggle = document.getElementById('themeToggle');
    
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        if (themeToggle) themeToggle.textContent = '';
    } else {
        if (themeToggle) themeToggle.textContent = '';
    }
}

// Call initTheme when the page loads
window.addEventListener('DOMContentLoaded', initTheme);
// ============================================
// IMPROVED REAL-TIME SYNC SYSTEM (NON-BLOCKING)
// ============================================

const syncState = {
    lastUpdate: {
        production: 0,
        sales: 0,
        calculator: 0,
        factory: 0,
        payments: 0,
        entities: 0
    },
    isRefreshing: false,
    syncInterval: null,
    pendingUpdates: new Set()
};


// Central data change notifier (non-blocking)
function notifyDataChange(dataType) {
    syncState.lastUpdate[dataType] = Date.now();
    syncState.pendingUpdates.add(dataType);
    
    // 1. Schedule local sync (existing logic)
    if (!syncState.isRefreshing) {
        requestAnimationFrame(() => processSync());
    }

    // 2. TRIGGER SEAMLESS CLOUD BACKUP (New Logic)
    // This will wait 5 seconds after the last change, then push to cloud
    if (typeof triggerSeamlessBackup === 'function') {
        triggerSeamlessBackup();
    }
}


// Process sync queue
function processSync() {
    if (syncState.isRefreshing || syncState.pendingUpdates.size === 0) return;
    
    syncState.isRefreshing = true;
    const updates = Array.from(syncState.pendingUpdates);
    syncState.pendingUpdates.clear();
    
    try {
        // Sync based on what changed
        updates.forEach(dataType => {
            switch(dataType) {
                case 'production':
                    if (typeof syncProductionTab === 'function') syncProductionTab();
                    break;
                case 'sales':
                    if (typeof syncSalesTab === 'function') syncSalesTab();
                    break;
                case 'calculator':
                    if (typeof syncCalculatorTab === 'function') syncCalculatorTab();
                    break;
                case 'factory':
                    if (typeof syncFactoryTab === 'function') syncFactoryTab();
                    break;
                case 'payments':
                case 'entities':
                    if (typeof syncPaymentsTab === 'function') syncPaymentsTab();
                    break;
            }
        });
        
        // Always update core displays
        syncCoreDisplays();
        
    } catch (error) {
        console.error('[SYNC ERROR]', error);
    } finally {
        syncState.isRefreshing = false;
        
        // Process any updates that came in during sync
        if (syncState.pendingUpdates.size > 0) {
            requestAnimationFrame(() => processSync());
        }
    }
}

// Get currently active tab
function getCurrentActiveTab() {
    if (!document.getElementById('tab-prod').classList.contains('hidden')) return 'prod';
    if (!document.getElementById('tab-sales').classList.contains('hidden')) return 'sales';
    if (!document.getElementById('tab-calc').classList.contains('hidden')) return 'calc';
    if (!document.getElementById('tab-factory').classList.contains('hidden')) return 'factory';
    if (!document.getElementById('tab-payments').classList.contains('hidden')) return 'payments';
    return 'prod';
}

// Core displays sync
function syncCoreDisplays() {
    try {
        if (typeof updateUnitsAvailableIndicator === 'function') {
            updateUnitsAvailableIndicator();
        }
        if (typeof calculateNetCash === 'function') {
            calculateNetCash();
        }
        if (typeof calculateCashTracker === 'function') {
            calculateCashTracker();
        }
    } catch (error) {
        console.error('[CORE SYNC ERROR]', error);
    }
}

// Tab-specific sync functions
function syncProductionTab() {
    try {
        if (typeof refreshUI === 'function') refreshUI();
        if (typeof updateAllStoresOverview === 'function') updateAllStoresOverview(currentOverviewMode);
        if (typeof updateMfgCharts === 'function') updateMfgCharts();
    } catch (error) {
        console.error('[PRODUCTION SYNC ERROR]', error);
    }
}

function syncSalesTab() {
    try {
        if (typeof refreshCustomerSales === 'function') refreshCustomerSales();
        if (typeof updateCustomerCharts === 'function') updateCustomerCharts();
        if (typeof renderCustomersTable === 'function') renderCustomersTable();
    } catch (error) {
        console.error('[SALES SYNC ERROR]', error);
    }
}

async function syncCalculatorTab() {
    try {
        if (typeof loadSalesData === 'function') await loadSalesData(currentCompMode);
        if (typeof autoFillTotalSoldQuantity === 'function') autoFillTotalSoldQuantity();
    } catch (error) {
        console.error('[CALCULATOR SYNC ERROR]', error);
    }
}

function syncFactoryTab() {
    try {
        if (typeof updateFactoryUnitsAvailableStats === 'function') updateFactoryUnitsAvailableStats();
        if (typeof updateFactorySummaryCard === 'function') updateFactorySummaryCard();
        if (typeof renderFactoryInventory === 'function') renderFactoryInventory();
        if (typeof renderFactoryHistory === 'function') renderFactoryHistory();
    } catch (error) {
        console.error('[FACTORY SYNC ERROR]', error);
    }
}

function syncPaymentsTab() {
    try {
        if (typeof refreshPaymentTab === 'function') refreshPaymentTab();
        if (typeof renderEntityTable === 'function') renderEntityTable();
    } catch (error) {
        console.error('[PAYMENTS SYNC ERROR]', error);
    }
}

// Debounced sync (every 2 seconds instead of 1)
function startPeriodicSync() {
    if (syncState.syncInterval) {
        clearInterval(syncState.syncInterval);
    }
    
    syncState.syncInterval = setInterval(() => {
        if (syncState.pendingUpdates.size > 0) {
            processSync();
        }
    }, 2000);
}

function stopPeriodicSync() {
    if (syncState.syncInterval) {
        clearInterval(syncState.syncInterval);
        syncState.syncInterval = null;
    }
}

// Listen for storage changes


// Reload data from storage
async function reloadDataFromStorage() {
    try {
        await loadAllData();
    } catch (error) {
        console.error('[RELOAD ERROR]', error);
    }
}


// Manual force sync
window.forceSync = async function() {
    console.log('[FORCE SYNC] Manually triggered');
    await reloadDataFromStorage();
    syncState.pendingUpdates.add('all');
    processSync();
};

// Tab visibility change sync
document.addEventListener('visibilitychange', async function() {
    if (!document.hidden) {
        await reloadDataFromStorage();
        notifyDataChange('all');
    }
});

// Enhanced showTab with sync
const originalShowTab = window.showTab;
if (typeof originalShowTab === 'function') {
    window.showTab = function(tab) {
        originalShowTab(tab);
        setTimeout(() => notifyDataChange(tab), 100);
    };
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        startPeriodicSync();
        console.log(' Non-blocking sync system active');
    }, 1000);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopPeriodicSync();
});
window.addEventListener('online',  subscribeToRealtime);
window.addEventListener('offline', () => updateSignalUI('offline'));


    // NEW: Payment entities and transactions
    let paymentEntities = [];
    let paymentTransactions = [];
    
    // Default settings
    let defaultSettings = {
        production: {
            STORE_A: { cost: 0, sale: 0 },
            STORE_B: { cost: 0, sale: 0 },
            STORE_C: { cost: 0, sale: 0 }
        },
        calculator: {
            NORAN_SHAH: { cost: 0, sale: 0 },
            NOMAN_SHAH: { cost: 0, sale: 0 }
        },
        sales: { cost: 0, sale: 0 }
    };
    
    // Chart instances
    let mfgBarChart = null, mfgPieChart = null, salesPerfChart = null, salesCompChart = null;
    let custSalesChart = null, custPaymentChart = null;
    let storeComparisonChart = null;
    let indPerformanceChart = null;
    
    // Global variables
    let currentMfgMode = 'week';
    let currentCompMode = 'all';
    let currentCustomerChartMode = 'week';
    let currentStore = 'STORE_A';
    let currentStoreComparisonMetric = 'weight';
    let currentIndMode = 'week';
    let currentIndMetric = 'weight';
    let currentOverviewMode = 'day';
    let currentProductionView = 'combined';
    
    // Factory tab variables
    let currentFactoryEntryStore = 'standard';
    let currentFactorySettingsStore = 'standard';
    let currentFactorySummaryMode = 'daily';
    let editingFactoryInventoryId = null;
    let currentFactoryDate = new Date().toISOString().split('T')[0]; // Default to today
    
    // Payment tab variables
    let editingEntityId = null;
    let selectedEntityId = null;
    
    // Percentage toggle states
    let mfgPieChartShowPercentage = false;
    let custPaymentChartShowPercentage = false;
    let compositionChartShowPercentage = false;

    // --- SPLASH SCREEN QUOTES ---
    const splashQuotes = [
        { quote: "Excellence is not a skill, it's an attitude.", author: "Ralph Marston" },
        { quote: "Quality is not an act, it is a habit.", author: "Aristotle" },
        { quote: "Success is the sum of small efforts repeated day in and day out.", author: "Robert Collier" },
        { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
        { quote: "Innovation distinguishes between a leader and a follower.", author: "Steve Jobs" },
        { quote: "Your work is going to fill a large part of your life, make it count.", author: "Warren Buffett" },
        { quote: "Precision today, perfection tomorrow.", author: "Manufacturing Wisdom" },
        { quote: "Every number tells a story. Make yours remarkable.", author: "Data Philosophy" },
        { quote: "Consistency is the foundation of excellence.", author: "Business Principle" },
        { quote: "In the world of business, the people who are most successful are those who are doing what they love.", author: "Warren Buffett" },
        { quote: "Dream bigger. Work smarter. Achieve more.", author: "Liquid Glass" },
        { quote: "Your dedication today shapes tomorrow's success.", author: "Entrepreneurial Spirit" },
        { quote: "The secret of getting ahead is getting started.", author: "Mark Twain" },
        { quote: "It always seems impossible until it's done.", author: "Nelson Mandela" },
        { quote: "Quality means doing it right when no one is looking.", author: "Henry Ford" },
        { quote: "The best way to predict the future is to create it.", author: "Peter Drucker" },
        { quote: "Focus on being productive instead of busy.", author: "Tim Ferriss" },
        { quote: "Do not wait; the time will never be 'just right'.", author: "Napoleon Hill" },
        { quote: "Everything you've ever wanted is on the other side of fear.", author: "George Addair" },
        { quote: "Opportunities don't happen. You create them.", author: "Chris Grosser" }
    ];

    function initSplashScreen() {
        const randomQuote = splashQuotes[Math.floor(Math.random() * splashQuotes.length)];
        document.getElementById('splash-quote').textContent = `"${randomQuote.quote}"`;
        document.getElementById('splash-author').textContent = `${randomQuote.author}`;
        
        setTimeout(() => {
        }, 3800);            
    }

    // --- PRODUCTION TAB: CREDIT SALES FEATURE ---
    function updatePaymentStatusVisibility() {
        const storeSelector = document.getElementById('storeSelector');
        const paymentStatusContainer = document.getElementById('paymentStatusContainer');
        
        if (storeSelector.value === 'STORE_C') {
            paymentStatusContainer.classList.remove('hidden');
        } else {
            paymentStatusContainer.classList.add('hidden');
            // Reset to cash when not STORE_C
            document.getElementById('production-payment-cash').checked = true;
        }
    }

    // Update recordEntry to include payment status
    async function recordEntry() {
        const net = parseFloat(document.getElementById('net-wt').value) || 0;
        const inputDate = document.getElementById('sys-date').value;
        const store = document.getElementById('storeSelector').value;
        const formulaUnits = parseFloat(document.getElementById('formula-units').value) || 0;
        
        let formulaStore = 'standard';
        let salePrice = 0;
        
        if (store === 'STORE_C') {
            formulaStore = 'asaan';
            salePrice = factorySalePrices.asaan || 0;
        } else {
            salePrice = factorySalePrices.standard || 0;
        }

        const validation = validateFormulaAvailability(store, formulaUnits);
        if (!validation.sufficient) {
            alert(`Insufficient formula units! Available: ${validation.available}, Requested: ${formulaUnits}`);
            return;
        }

        const costData = calculateDynamicCost(store, formulaUnits, net);

        if (net <= 0) {
            alert("Net production must be greater than zero. Please check weights.");
            return;
        }
        if (!inputDate) {
            alert("Please select a date.");
            return;
        }
        if (salePrice <= 0) {
            alert("Please set a sale price in Factory Formulas first.");
            return;
        }
        if (formulaUnits <= 0) {
            alert("Please enter formula units used.");
            return;
        }

        const totalCost = net * costData.dynamicCostPerKg;
        const totalSale = net * salePrice;
        const profit = totalSale - totalCost;
        
        // Get payment status (only for STORE_C)
        let paymentStatus = 'CASH';
        if (store === 'STORE_C') {
            const paymentType = document.querySelector('input[name="production-payment-type"]:checked');
            paymentStatus = paymentType ? paymentType.value : 'CASH';
        }

        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${ampm}`;

        db.push({
            id: generateUUID('prod'), 
            timestamp: Date.now(),
            date: inputDate,
            time: timeString,
            store: store,
            net, 
            cp: costData.dynamicCostPerKg, 
            sp: salePrice, 
            totalCost, 
            totalSale, 
            profit,
            formulaUnits: formulaUnits,
            formulaStore: costData.formulaStore,
            formulaCost: costData.totalFormulaCost,
            paymentStatus: paymentStatus, // NEW: Add payment status
            timestamp: new Date(inputDate).getTime()
        });
        
        await idb.set('mfg_pro_pkr', db);
        notifyDataChange('all');
        
        // Realtime Broadcast
        emitSyncUpdate({ mfg_pro_pkr: db });

        syncFactoryProductionStats();
        
        document.getElementById('gross-wt').value = '';
        document.getElementById('cont-wt').value = '';
        document.getElementById('net-wt').value = '';
        document.getElementById('formula-units').value = '1';
        document.getElementById('display-cost-value').innerText = 'Rs 0.00';
        document.getElementById('profit-per-kg').innerText = 'Rs 0.00';
        document.getElementById('formula-unit-cost-display').innerText = 'Rs 0.00/unit';
        document.getElementById('total-formula-cost-display').innerText = 'Rs 0.00';
        document.getElementById('dynamic-cost-per-kg').innerText = 'Rs 0.00/kg';
        
        await refreshAllDisplays();
        alert("Production record saved successfully!");
    }


   
    // --- DELETION REGISTRY HELPER ---
async function registerDeletion(id) {
    if (!id) return;
    deletedRecordIds.add(id);
    // Save as array because IndexedDB/JSON can't store Sets directly
    await idb.set('deleted_records', Array.from(deletedRecordIds));
    console.log(`[TOMBSTONE] Registered deletion for ID: ${id}`);
}


    // --- PAYMENTS TAB: ENTITY MANAGEMENT ---
    function openEntityDetailsOverlay(id) {
    currentEntityId = id;
    const entity = paymentEntities.find(e => e.id === id);
    if (!entity) return;

    // Reset Inputs
    document.getElementById('quickEntityAmount').value = '';
    setQuickEntityType('OUT');

    document.getElementById('entityDetailsOverlay').style.display = 'flex';
    renderEntityOverlayContent(entity);
}

function closeEntityDetailsOverlay() {
    document.getElementById('entityDetailsOverlay').style.display = 'none';
    currentEntityId = null;
    refreshPaymentTab(); // Refresh main table on close
}

function setQuickEntityType(type) {
    currentQuickType = type;
    document.getElementById('quick-type-out').className = `toggle-opt ${type === 'OUT' ? 'active' : ''}`;
    document.getElementById('quick-type-in').className = `toggle-opt ${type === 'IN' ? 'active' : ''}`;
}

async function renderEntityOverlayContent(entity) {
    document.getElementById('manageEntityTitle').innerText = entity.name;

    // Calculate current balance
    const balances = calculateEntityBalances();
    const balance = balances[entity.id] || 0;
    
    const statsEl = document.getElementById('manageEntityStats');
    if (balance > 0) {
        statsEl.innerHTML = `<span style="color:var(--danger); font-weight:800;">Current Payable: Rs ${balance.toFixed(2)}</span>`;
    } else if (balance < 0) {
        statsEl.innerHTML = `<span style="color:var(--accent-emerald); font-weight:800;">Current Receivable: Rs ${Math.abs(balance).toFixed(2)}</span>`;
    } else {
        statsEl.innerHTML = `<span style="color:var(--accent); font-weight:800;">Balance Settled</span>`;
    }

    // Render Transaction History List
    const list = document.getElementById('entityManagementHistoryList');
    list.innerHTML = '';

    // Get transactions
    const transactions = paymentTransactions.filter(t => t.entityId === entity.id);
    
    // Sort: Newest first
    transactions.sort((a,b) => b.timestamp - a.timestamp);

    if (transactions.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted);">No transaction history</div>`;
        return;
    }

    transactions.forEach(t => {
        const isOut = t.type === 'OUT';
        const colorClass = isOut ? 'cost-val' : 'profit-val'; // Red for OUT, Green for IN
        const badgeBg = isOut ? 'rgba(220, 38, 38, 0.1)' : 'rgba(5, 150, 105, 0.1)';
        const badgeColor = isOut ? 'var(--danger)' : 'var(--accent-emerald)';
        const label = isOut ? 'PAYMENT OUT' : 'PAYMENT IN';

        const item = document.createElement('div');
        item.className = 'cust-history-item'; // Reusing customer history style class
        item.innerHTML = `
            <div class="cust-history-info">
                <div style="font-weight:700; font-size:0.85rem; color:var(--text-main);">${t.date}</div>
                <div style="font-size:0.75rem; color:var(--text-muted);">${t.description || 'No description'}</div>
            </div>
            <div style="text-align:right; margin-right:10px;">
                <span style="background:${badgeBg}; color:${badgeColor}; padding:2px 6px; border-radius:4px; font-size:0.65rem; font-weight:700;">${label}</span>
                <div class="${colorClass}" style="font-size:0.9rem; margin-top:2px;">Rs ${t.amount.toFixed(2)}</div>
            </div>
            <button class="btn btn-sm btn-danger" style="padding:4px 8px;" onclick="deleteEntityTransaction(${t.id})"></button>
        `;
        list.appendChild(item);
    });
}

function filterEntityManagementHistory() {
    const term = document.getElementById('entity-trans-search').value.toLowerCase();
    const items = document.querySelectorAll('#entityManagementHistoryList .cust-history-item');
    items.forEach(item => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(term) ? 'flex' : 'none';
    });
}
// Save Quick Transaction from Overlay
async function saveQuickEntityTransaction() {
    const amount = parseFloat(document.getElementById('quickEntityAmount').value);
    if (!amount || amount <= 0) {
        showToast("Please enter a valid amount", "warning");
        return;
    }

    if (!currentEntityId) return;
    const entity = paymentEntities.find(e => e.id === currentEntityId);

    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    paymentTransactions.push({
        id: Date.now(),
        entityId: entity.id,
        entityName: entity.name,
        entityType: entity.type,
        date: dateStr,
        time: timeString,
        amount: amount,
        description: `Quick ${currentQuickType} from Manager`,
        type: currentQuickType,
        isPayable: false, // Default for manual entry
        timestamp: now.getTime()
    });

    await idb.set('payment_transactions', paymentTransactions);
    notifyDataChange('all');

    // UI Feedback
    document.getElementById('quickEntityAmount').value = '';
    renderEntityOverlayContent(entity); // Refresh overlay list
    calculateNetCash(); // Update global dashboard
    showToast("Transaction saved successfully", "success");
}

// Delete Specific Transaction
async function deleteEntityTransaction(id) {
    if (confirm("Permanently delete this transaction?")) {
        paymentTransactions = paymentTransactions.filter(t => t.id !== id);
        await idb.set('payment_transactions', paymentTransactions);
        notifyDataChange('all');
        
        // Refresh Current View
        const entity = paymentEntities.find(e => e.id === currentEntityId);
        if(entity) renderEntityOverlayContent(entity);
        
        calculateNetCash();
        showToast("Transaction deleted", "success");
    }
}

// Delete Entire Entity
async function deleteCurrentEntity() {
    if(!currentEntityId) return;
    
    // Check if it has transactions
    const hasTrans = paymentTransactions.some(t => t.entityId === currentEntityId);
    
    let msg = "Permanently delete this entity?";
    if(hasTrans) msg += "\n\nWARNING: This will delete ALL associated transaction history and cannot be undone.";
    
    if(confirm(msg)) {
        // Remove Entity
        paymentEntities = paymentEntities.filter(e => e.id !== currentEntityId);
        
        // Remove Transactions
        paymentTransactions = paymentTransactions.filter(t => t.entityId !== currentEntityId);
        
        await idb.set('payment_entities', paymentEntities);
        await idb.set('payment_transactions', paymentTransactions);
        notifyDataChange('all');
        
        closeEntityDetailsOverlay();
        refreshPaymentTab();
        showToast("Entity deleted successfully", "success");
    }
}

// Export CSV
function exportEntityData() {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Entity Name,Type,Phone,Net Balance (Rs),Status\n";

    const balances = calculateEntityBalances();

    paymentEntities.forEach(e => {
        const bal = balances[e.id] || 0;
        let status = "Settled";
        if(bal > 0) status = "Payable (You Owe)";
        if(bal < 0) status = "Receivable (Owes You)";
        
        // Escape commas
        const safeName = e.name.replace(/,/g, " ");
        
        csvContent += `"${safeName}","${e.type}","${e.phone || ''}",${bal.toFixed(2)},"${status}"\n`;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Entities_List.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast("Entity list exported", "success");
}

    // --- CASH TRACKER FUNCTIONS ---
let currentCashTrackerMode = 'day';

function setCashTrackerMode(mode) {
    currentCashTrackerMode = mode;
    
    // Update toggle UI
    document.querySelectorAll('#tab-payments .toggle-group .toggle-opt').forEach(opt => {
        opt.classList.remove('active');
    });
    const parent = event.target.parentElement;
    parent.querySelectorAll('.toggle-opt').forEach(opt => {
        opt.classList.remove('active');
    });
    event.target.classList.add('active');
    
    calculateCashTracker();
}
// ============================================
// CASH TRACKER & CREDIT TRACKER (TIME SENSITIVE)
// ============================================

function calculateCashTracker() {
    // 1. Determine Date Range based on currentCashTrackerMode
    const selectedDate = document.getElementById('paymentDate').value || new Date().toISOString().split('T')[0];
    const selectedDateObj = new Date(selectedDate);
    const selectedYear = selectedDateObj.getFullYear();
    const selectedMonth = selectedDateObj.getMonth();
    
    let startDate = new Date(selectedDate);
    let endDate = new Date(selectedDate);
    
    // Start of day
    startDate.setHours(0,0,0,0);
    // End of day
    endDate.setHours(23,59,59,999);
    
    if (currentCashTrackerMode === 'week') {
        startDate.setDate(selectedDateObj.getDate() - 6);
    } else if (currentCashTrackerMode === 'month') {
        startDate = new Date(selectedYear, selectedMonth, 1);
        endDate = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59);
    } else if (currentCashTrackerMode === 'year') {
        startDate = new Date(selectedYear, 0, 1);
        endDate = new Date(selectedYear, 11, 31, 23, 59, 59);
    } else if (currentCashTrackerMode === 'all') {
        startDate = new Date('2000-01-01');
        endDate = new Date('2100-12-31');
    }
    
    let rawData = {
        totalProductionValue: 0,
        totalProductionQuantity: 0,
        productionCredits: 0,
        totalSalesValue: 0,
        totalSalesQuantity: 0,
        salesCash: 0,
        salesCredits: 0,
        repSalesValue: 0,
        repSalesQuantity: 0,
        repSalesCash: 0,
        repSalesCredits: 0,
        calculatorCash: 0,
        calculatorCredits: 0,   
        calculatorRecovered: 0, 
        paymentsIn: 0,
        paymentsOut: 0 
    };
    
    // 1. Collect PRODUCTION data (Filtered by Date)
    db.forEach(item => {
        const itemDate = new Date(item.date);
        if (itemDate >= startDate && itemDate <= endDate) {
            rawData.totalProductionValue += item.totalSale || 0;
            rawData.totalProductionQuantity += item.net || 0;
            if (item.store === 'STORE_C' && item.paymentStatus === 'CREDIT') {
                rawData.productionCredits += item.totalSale || 0;
            }
        }
    });
    
    // 2. Collect SALES data (Filtered by Date)
    customerSales.forEach(sale => {
        const saleDate = new Date(sale.date);
        if (saleDate >= startDate && saleDate <= endDate) {
            rawData.totalSalesValue += sale.totalValue || 0;
            rawData.totalSalesQuantity += sale.quantity || 0;
            
            const isRepSale = (sale.salesRep === 'NORAN SHAH' || sale.salesRep === 'NOMAN SHAH');
            
            if (isRepSale) {
                rawData.repSalesValue += sale.totalValue || 0;
                rawData.repSalesQuantity += sale.quantity || 0;
                
                if (sale.paymentType === 'CASH' || sale.creditReceived) {
                    rawData.repSalesCash += sale.totalValue || 0;
                } else if (sale.paymentType === 'CREDIT' && !sale.creditReceived) {
                    rawData.repSalesCredits += sale.totalValue || 0;
                }
            }
            
            if (sale.paymentType === 'CASH' || sale.creditReceived) {
                rawData.salesCash += sale.totalValue || 0;
            } else if (sale.paymentType === 'CREDIT' && !sale.creditReceived) {
                rawData.salesCredits += sale.totalValue || 0;
            }
        }
    });

    // 3. Collect CALCULATOR data (Filtered by Date)
    salesHistory.forEach(item => {
        const itemDate = new Date(item.date);
        if (itemDate >= startDate && itemDate <= endDate) {
            rawData.calculatorCash += item.received || 0;
            rawData.calculatorCredits += item.creditValue || 0;
            rawData.calculatorRecovered += item.prevColl || 0;
        }
    });
    
    // 4. Collect PAYMENTS data (Filtered by Date)
    paymentTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        if (transDate >= startDate && transDate <= endDate) {
            if (transaction.type === 'IN') {
                rawData.paymentsIn += transaction.amount;
            } else if (transaction.type === 'OUT') {
                if (!transaction.isPayable) {
                    rawData.paymentsOut += transaction.amount;
                }
            }
        }
    });

    // ========== PHASE 2: Calculate NET values ==========
    const netProductionValue = Math.max(0, rawData.totalProductionValue - rawData.totalSalesValue);
    const netSalesCash = rawData.salesCash - rawData.repSalesCash;
    const netSalesCredits = rawData.salesCredits - rawData.repSalesCredits;
    const netCalculatorDebt = rawData.calculatorCredits - rawData.calculatorRecovered;
    const netProductionQuantity = Math.max(0, rawData.totalProductionQuantity - rawData.totalSalesQuantity);
    
    const finalTotals = {
        productionValue: netProductionValue,
        productionQuantity: netProductionQuantity,
        productionCredits: rawData.productionCredits,
        salesTabCash: netSalesCash,
        salesTabCredits: netSalesCredits,
        calculatorCash: rawData.calculatorCash,
        calculatorCredits: netCalculatorDebt,
        paymentsIn: rawData.paymentsIn,
        paymentsOut: rawData.paymentsOut
    };
    
    // Calculate NET CASH for the period
    const netCash = finalTotals.productionValue - finalTotals.productionCredits + 
                    finalTotals.salesTabCash + finalTotals.calculatorCash + 
                    finalTotals.paymentsIn - finalTotals.paymentsOut;
    
    // Calculate TOTAL CREDITS for the period
    const totalCredits = finalTotals.salesTabCredits + 
                        finalTotals.calculatorCredits + 
                        finalTotals.productionCredits;
    
    // ========== PHASE 3: Update UI (Only Tracker & Credits Cards) ==========
    
    const elCashProdValue = document.getElementById('cash-prod-value');
    if (elCashProdValue) elCashProdValue.textContent = `Rs ${safeValue(finalTotals.productionValue).toFixed(2)}`;

    const elCashProdCredits = document.getElementById('cash-prod-credits');
    if (elCashProdCredits) elCashProdCredits.textContent = `Rs ${safeValue(finalTotals.productionCredits).toFixed(2)}`;

    const elCashSalesCash = document.getElementById('cash-sales-cash');
    if (elCashSalesCash) elCashSalesCash.textContent = `Rs ${safeValue(finalTotals.salesTabCash).toFixed(2)}`;

    const elCashCalcCash = document.getElementById('cash-calculator-cash');
    if (elCashCalcCash) elCashCalcCash.textContent = `Rs ${safeValue(finalTotals.calculatorCash).toFixed(2)}`;

    const elCashPayIn = document.getElementById('cash-payments-in');
    if (elCashPayIn) elCashPayIn.textContent = `Rs ${safeValue(finalTotals.paymentsIn).toFixed(2)}`;

    const elCashPayOut = document.getElementById('cash-payments-out');
    if (elCashPayOut) elCashPayOut.textContent = `Rs ${safeValue(finalTotals.paymentsOut).toFixed(2)}`;

    const elCashNet = document.getElementById('cash-net-total');
    if (elCashNet) {
        elCashNet.textContent = `Rs ${safeValue(netCash).toFixed(2)}`;
        if (netCash < 0) {
            elCashNet.style.color = 'var(--danger)';
        } else {
            elCashNet.style.color = 'var(--accent-emerald)';
        }
    }
    
    // Update Credits Card
    const elCreditSales = document.getElementById('credit-sales-tab');
    if (elCreditSales) elCreditSales.textContent = `Rs ${safeValue(finalTotals.salesTabCredits).toFixed(2)}`;

    const elCreditCalc = document.getElementById('credit-calculator');
    if (elCreditCalc) elCreditCalc.textContent = `Rs ${safeValue(finalTotals.calculatorCredits).toFixed(2)}`;
    
    const productionCreditsElement = document.getElementById('credit-production');
    if (productionCreditsElement) {
        productionCreditsElement.textContent = `Rs ${safeValue(finalTotals.productionCredits).toFixed(2)}`;
    }
    
    const elCreditTotal = document.getElementById('credit-total');
    if (elCreditTotal) elCreditTotal.textContent = `Rs ${safeValue(totalCredits).toFixed(2)}`;
    
    return finalTotals;
}



// ========== NEW HELPER FUNCTION ==========
function updateEconomicDashboardWithNetValues(totals, totalCredits) {
    // This function updates the Economic Dashboard with NET values
    // We need to update key elements in the dashboard
    
    // 1. Update Operating Cash Flow (Net Sales Cash + Calculator Cash)
    const operatingCashFlow = totals.salesTabCash + totals.calculatorCash;
    const operatingCashElement = document.getElementById('operatingCashFlow');
    if (operatingCashElement) {
        operatingCashElement.textContent = `Rs ${safeValue(operatingCashFlow).toFixed(2)}`;
    }
    
    // 2. Update Cash Details Breakdown
    document.getElementById('cashDetailDirectSales').textContent = `Rs ${safeValue(totals.salesTabCash).toFixed(2)}`;
    document.getElementById('cashDetailRepCollections').textContent = `Rs ${safeValue(totals.calculatorCash).toFixed(2)}`;
    
    // 3. Update Total Credits in Dashboard
    const creditTotalElement = document.getElementById('formulaSalesCredit');
    if (creditTotalElement) {
        creditTotalElement.textContent = `Rs ${safeValue(totalCredits).toFixed(2)}`;
    }
    
    // 4. Update Sales Receivables (NET of rep sales)
    const salesReceivablesElement = document.getElementById('salesReceivables');
    if (salesReceivablesElement) {
        salesReceivablesElement.textContent = `Rs ${safeValue(totals.salesTabCredits).toFixed(2)}`;
    }
    
    // 5. Update Production Inventory Value (NET)
    const productionValueElement = document.getElementById('formulaProdTotal');
    if (productionValueElement) {
        productionValueElement.textContent = `Rs ${safeValue(totals.productionValue).toFixed(2)}`;
    }
}


    
    // --- ENTITY TRANSACTIONS OVERLAY ---
function openEntityTransactions(entityId) {
    const entity = paymentEntities.find(e => e.id === entityId);
    if (!entity) return;
    
    // Get all transactions for this entity
    const entityTransactions = paymentTransactions.filter(t => t.entityId === entityId);
    
    // Calculate totals
    let totalIn = 0, totalOut = 0;
    entityTransactions.forEach(t => {
        if (t.type === 'IN') totalIn += t.amount;
        else if (t.type === 'OUT') totalOut += t.amount;
    });
    const netBalance = totalIn - totalOut;
    
    // Update overlay title and summary
    document.getElementById('entityTransactionsTitle').textContent = `${entity.name} - Transactions`;
    document.getElementById('entityTotalIn').textContent = `Rs ${totalIn.toFixed(2)}`;
    document.getElementById('entityTotalOut').textContent = `Rs ${totalOut.toFixed(2)}`;
    document.getElementById('entityNetBalance').textContent = `Rs ${netBalance.toFixed(2)}`;
    document.getElementById('entityTotalTransactions').textContent = entityTransactions.length;
    
    // Render transactions list
    const transactionsList = document.getElementById('entityTransactionsList');
    transactionsList.innerHTML = '';
    
    if (entityTransactions.length === 0) {
        transactionsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No transactions found for this entity.</div>';
    } else {
        // Sort by date (newest first)
        const sortedTransactions = [...entityTransactions].sort((a, b) => b.timestamp - a.timestamp);
        
        sortedTransactions.forEach(transaction => {
            const transactionCard = document.createElement('div');
            transactionCard.className = 'liquid-card';
            transactionCard.style.padding = '15px';
            transactionCard.style.position = 'relative';
            
            const badgeClass = transaction.type === 'IN' ? 'transaction-in' : 'transaction-out';
            const badgeText = transaction.type === 'IN' ? 'IN' : 'OUT';
            const amountClass = transaction.type === 'IN' ? 'profit-val' : 'cost-val';
            
            transactionCard.innerHTML = `
                <span class="transaction-badge ${badgeClass}" style="position: absolute; top: 10px; right: 10px;">${badgeText}</span>
                <div style="margin-bottom: 8px;">
                    <strong style="color: var(--accent); font-size: 0.9rem;">${transaction.date}</strong>
                    <span style="color: var(--text-muted); font-size: 0.75rem; margin-left: 10px;">${transaction.time || ''}</span>
                </div>
                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 8px;">
                    ${transaction.description}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--glass-border);">
                    <span style="font-size: 0.75rem; color: var(--text-muted);">Amount:</span>
                    <span class="${amountClass}" style="font-size: 1.1rem; font-weight: 800;">Rs ${transaction.amount.toFixed(2)}</span>
                </div>
            `;
            
            transactionsList.appendChild(transactionCard);
        });
    }
    
    // Show overlay
    document.getElementById('entityTransactionsOverlay').style.display = 'flex';
}

function closeEntityTransactions() {
    document.getElementById('entityTransactionsOverlay').style.display = 'none';
}
    function renderEntities() {
        const entityScroller = document.getElementById('entityScroller');
        const entitySelect = document.getElementById('paymentEntity');
        
        entityScroller.innerHTML = '';
        entitySelect.innerHTML = '<option value="">Select Entity</option>';
        
        paymentEntities.forEach(entity => {
            // Add to scroller
            const chip = document.createElement('div');
            chip.className = `entity-chip ${selectedEntityId === entity.id ? 'active' : ''}`;
            chip.dataset.id = entity.id;
            chip.innerHTML = `${entity.name} <span style="font-size:0.7rem; opacity:0.7;">(${entity.type === 'payee' ? 'Payee' : 'Payor'})</span>`;
            chip.onclick = () => selectEntity(entity.id);
            entityScroller.appendChild(chip);
            
            // Add to dropdown
            const option = document.createElement('option');
            option.value = entity.id;
            option.textContent = `${entity.name} (${entity.type === 'payee' ? 'Payee' : 'Payor'})`;
            entitySelect.appendChild(option);
        });
    }

// ============================================
// FIXED: SAVE PAYMENT TRANSACTION (Proper Balance Updates)
// ============================================

async function savePaymentTransaction() {
    const entityId = parseInt(document.getElementById('paymentEntity').value);
    const date = document.getElementById('paymentDate').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
    const description = document.getElementById('paymentDescription').value.trim();
    const type = document.querySelector('input[name="paymentTransactionType"]:checked').value;
    
    if (!entityId) {
        showToast("Please select an entity", 'warning');
        return;
    }
    if (!date) {
        showToast("Please select a date", 'warning');
        return;
    }
    if (amount <= 0) {
        showToast("Please enter a valid amount", 'warning');
        return;
    }
    if (!description) {
        showToast("Please enter a description", 'warning');
        return;
    }
    
    const entity = paymentEntities.find(e => e.id === entityId);
    if (!entity) {
        showToast("Selected entity not found", 'error');
        return;
    }
    
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${ampm}`;
    
    // Check if this payment is settling a material purchase
    let isPayable = false;
    let materialId = null;
    
    // FIXED LOGIC: Payment OUT to supplier
    if (type === 'OUT' && entity.isSupplier) {
        const pendingMaterials = factoryInventoryData.filter(m => 
            m.supplierId === entityId && 
            m.paymentStatus === 'pending' &&
            m.totalPayable > 0
        );
        
        if (pendingMaterials.length > 0) {
            // Auto-mark oldest pending material as paid
            const oldestMaterial = pendingMaterials[0];
            if (amount >= oldestMaterial.totalPayable) {
                oldestMaterial.paymentStatus = 'paid';
                oldestMaterial.paidDate = date;
                materialId = oldestMaterial.id;
                isPayable = true;
                await idb.set('factory_inventory_data', factoryInventoryData);
                notifyDataChange('all');

            }
        }
    }
    
    // Create the transaction
    // NOTE: The balance calculation in calculateEntityBalances() handles the math
    // - OUT transaction: balance -= amount (DECREASES their balance, reduces liability)
    // - IN transaction: balance += amount (INCREASES their balance, creates receivable)
    
    paymentTransactions.push({
        id: generateUUID('pay'),
        timestamp: Date.now(),
        entityId: entityId,
        entityName: entity.name,
        entityType: entity.type,
        date: date,
        time: timeString,
        amount: amount,
        description: description,
        type: type, // 'IN' or 'OUT'
        materialId: materialId,
        isPayable: isPayable,
        timestamp: new Date(date).getTime()
    });
    
    await idb.set('payment_transactions', paymentTransactions);
    notifyDataChange('all');
    
    // Realtime Broadcast
    emitSyncUpdate({ payment_transactions: paymentTransactions });

    // Clear form
    document.getElementById('paymentAmount').value = '';
    document.getElementById('paymentDescription').value = '';
    document.getElementById('payment-type-out').checked = true;
    
    refreshPaymentTab();
    calculateNetCash();
    calculateCashTracker();
    
    let message = `Payment ${type === 'IN' ? 'received from' : 'made to'} ${entity.name}`;
    if (isPayable) {
        message += ' (Material purchase settled - liability reduced)';
    }

    showToast(message, 'success');
}

    
    async function deletePaymentTransaction(id) {
        if (confirm("Are you sure you want to delete this payment transaction?")) {
        await registerDeletion(id); 
            paymentTransactions = paymentTransactions.filter(t => t.id !== id);
            await idb.set('payment_transactions', paymentTransactions);
            notifyDataChange('all');

            refreshPaymentTab();
            calculateNetCash();
            alert("Transaction deleted successfully!");
        }
    }
    
    function filterPaymentHistory() {
        const searchTerm = document.getElementById('payment-search').value.toLowerCase();
        const allCards = document.querySelectorAll('#paymentHistoryList .card');
        
        allCards.forEach(card => {
            const cardText = card.textContent.toLowerCase();
            if (cardText.includes(searchTerm)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }
// ============================================
// ECONOMIC DASHBOARD - STRICTLY ALL-TIME DATA
// ============================================

function calculateNetCash() {
    // ========== PHASE 1: Gather ALL-TIME raw data ==========
    let rawData = {
        // Production data
        totalProductionValue: 0,
        totalProductionQuantity: 0,
        productionCredits: 0, 
        
        // Sales data (including reps)
        totalSalesValue: 0,
        totalSalesQuantity: 0,
        salesCash: 0,
        salesCredits: 0,
        
        // Rep-specific sales
        repSalesValue: 0,
        repSalesQuantity: 0,
        repSalesCash: 0,
        repSalesCredits: 0,
        
        // Calculator data
        calculatorCash: 0,
        calculatorTotalIssued: 0,
        calculatorTotalRecovered: 0,
        
        // Payments data
        paymentsIn: 0,
        paymentsOut: 0
    };
    
    // 1. Collect ALL PRODUCTION data (No Date Filter)
    db.forEach(item => {
        rawData.totalProductionValue += item.totalSale || 0;
        rawData.totalProductionQuantity += item.net || 0;
        
        // Track production credits
        if (item.store === 'STORE_C' && item.paymentStatus === 'CREDIT') {
            rawData.productionCredits += item.totalSale || 0;
        }
    });

   // 2. Collect ALL SALES data (No Date Filter)
    customerSales.forEach(sale => {
        // --- ISOLATION: SKIP REP MODE ENTRIES ---
        if (sale.isRepModeEntry === true) return;
        
        rawData.totalSalesValue += sale.totalValue || 0;
        rawData.totalSalesQuantity += sale.quantity || 0;
        
        const isRepSale = (sale.salesRep === 'NORAN SHAH' || sale.salesRep === 'NOMAN SHAH');
        
        if (isRepSale) {
            rawData.repSalesValue += sale.totalValue || 0;
            rawData.repSalesQuantity += sale.quantity || 0;
            
            if (sale.paymentType === 'CASH' || sale.creditReceived) {
                rawData.repSalesCash += sale.totalValue || 0;
            } else if (sale.paymentType === 'CREDIT' && !sale.creditReceived) {
                rawData.repSalesCredits += sale.totalValue || 0;
            }
        }
        
        if (sale.paymentType === 'CASH' || sale.creditReceived) {
            rawData.salesCash += sale.totalValue || 0;
        } else if (sale.paymentType === 'CREDIT' && !sale.creditReceived) {
            rawData.salesCredits += sale.totalValue || 0;
        }
    });
    
    // 3. Collect ALL CALCULATOR data (No Date Filter)
    salesHistory.forEach(item => {
        rawData.calculatorCash += item.received || 0;
        rawData.calculatorTotalIssued += item.creditValue || 0;
        rawData.calculatorTotalRecovered += item.prevColl || 0;
    });
    
    // 4. Collect ALL PAYMENTS data (No Date Filter)
    paymentTransactions.forEach(trans => {
        if (trans.type === 'IN') {
            rawData.paymentsIn += trans.amount;
        } else if (trans.type === 'OUT') {
            // ONLY count as cash expense if NOT settling a payable
            if (!trans.isPayable) {
                rawData.paymentsOut += trans.amount;
            }
        }
    });
    
    // ========== PHASE 2: Calculate NET values ==========
    
    // A. NET PRODUCTION VALUE
    const netProductionValue = Math.max(0, rawData.totalProductionValue - rawData.totalSalesValue);
    
    // B. NET SALES CASH
    const netSalesCash = rawData.salesCash - rawData.repSalesCash;
    
    // C. NET SALES CREDITS
    const netSalesCredits = rawData.salesCredits - rawData.repSalesCredits;
    
    // D. COMBINED MARKET DEBT TRACKER
    const combinedMarketDebt = rawData.calculatorTotalIssued - rawData.calculatorTotalRecovered;
    
    // ========== PHASE 3: Calculate FINAL CASH IN HAND ==========
    
    const cashInHand = netProductionValue - rawData.productionCredits + 
                      netSalesCash + rawData.calculatorCash + 
                      rawData.paymentsIn - rawData.paymentsOut;
    
    // ========== PHASE 4: Calculate ACCOUNTS RECEIVABLE ==========
    let AccountsReceivable = {
        productionCredits: rawData.productionCredits, 
        salesTabCredit: netSalesCredits,
        calculatorCredit: Math.max(0, combinedMarketDebt),
        total: 0
    };
    
    AccountsReceivable.total = AccountsReceivable.productionCredits +
                               AccountsReceivable.salesTabCredit + 
                               AccountsReceivable.calculatorCredit;
    
    // ========== PHASE 5: Calculate CURRENT ASSETS ==========
    // A. Raw Materials Inventory Value
    let RawMaterialsValue = 0;
    factoryInventoryData.forEach(item => {
        RawMaterialsValue += (item.quantity * item.cost) || 0;
    });
    
    // B. Formula Units Inventory Value
    let FormulaUnitsValue = 0;
    const stdTracking = factoryUnitTracking?.standard || { available: 0 };
    const asaanTracking = factoryUnitTracking?.asaan || { available: 0 };
    const stdCostPerUnit = getCostPerUnit('standard');
    const asaanCostPerUnit = getCostPerUnit('asaan');
    FormulaUnitsValue = (stdTracking.available * stdCostPerUnit) + 
                       (asaanTracking.available * asaanCostPerUnit);
    
    const CURRENT_ASSETS = cashInHand + 
                          RawMaterialsValue + 
                          FormulaUnitsValue + 
                          AccountsReceivable.total;
    
    // ========== PHASE 6: Calculate CURRENT LIABILITIES ==========
    let CurrentLiabilities = {
        accountsPayable: {
            supplierPayables: 0,
            otherPayables: {
                operating: 0,
                loans: 0,
                miscellaneous: 0,
                total: 0
            },
            total: 0
        },
        total: 0
    };
    
    // A. ACCOUNTS PAYABLE - Supplier Payables
    let countedMaterialIds = new Set();
    
    // 1. Count from paymentTransactions
    paymentTransactions.forEach(trans => {
        if (trans.type === 'OUT' && trans.isPayable) {
            CurrentLiabilities.accountsPayable.supplierPayables += trans.amount;
            if (trans.materialId) {
                countedMaterialIds.add(trans.materialId);
            }
        }
    });
    
    // 2. Add any unpaid materials from factoryInventoryData
    if (factoryInventoryData && factoryInventoryData.length > 0) {
        factoryInventoryData.forEach(material => {
            if (material.paymentStatus === 'pending' && 
                material.totalPayable && 
                !countedMaterialIds.has(material.id)) {
                CurrentLiabilities.accountsPayable.supplierPayables += material.totalPayable;
                countedMaterialIds.add(material.id);
            }
        });
    }
    
    // B. OTHER PAYABLES (Using balances from Entity Calculation)
    // Note: To ensure this is 100% all-time correct, we recalculate entity balances here on the fly
    const balances = {};
    paymentEntities.forEach(entity => { balances[entity.id] = 0; });
    paymentTransactions.forEach(t => {
        if(balances[t.entityId] !== undefined) {
            if(t.type === 'OUT') balances[t.entityId] -= t.amount;
            else if(t.type === 'IN') balances[t.entityId] += t.amount;
        }
    });
    
    const nonSupplierEntities = paymentEntities.filter(e => e.type === 'payee' && !e.isSupplier);
    nonSupplierEntities.forEach(entity => {
        const balance = balances[entity.id] || 0;
        // If balance is positive, we owe them (Liability)
        if (balance > 0.01) { 
            CurrentLiabilities.accountsPayable.otherPayables.miscellaneous += balance;
        }
    });
    
    // Calculate Other Payables Total
    CurrentLiabilities.accountsPayable.otherPayables.total = 
        CurrentLiabilities.accountsPayable.otherPayables.miscellaneous;
    
    // Calculate TOTAL ACCOUNTS PAYABLE
    CurrentLiabilities.accountsPayable.total = 
        CurrentLiabilities.accountsPayable.supplierPayables +
        CurrentLiabilities.accountsPayable.otherPayables.total;
    
    // Calculate TOTAL CURRENT LIABILITIES
    CurrentLiabilities.total = CurrentLiabilities.accountsPayable.total;
    
    // ========== PHASE 7: FINAL CALCULATIONS ==========
    const WORKING_CAPITAL = CURRENT_ASSETS - CurrentLiabilities.total;
    const ENTERPRISE_VALUE = CURRENT_ASSETS - CurrentLiabilities.total; // Simplified for this context
    
    // ========== PHASE 8: FINANCIAL RATIOS ==========
    const liquidityRatios = {
        currentRatio: CurrentLiabilities.total > 0 ? CURRENT_ASSETS / CurrentLiabilities.total : 0,
        quickRatio: CurrentLiabilities.total > 0 ? (CURRENT_ASSETS - RawMaterialsValue - FormulaUnitsValue) / CurrentLiabilities.total : 0,
        cashRatio: CurrentLiabilities.total > 0 ? cashInHand / CurrentLiabilities.total : 0
    };
    
    // ========== PHASE 9: RETURN INDICATORS OBJECT ==========
    const indicators = {
        cashInHand: cashInHand,
        cashDetails: {
            directSales: netSalesCash,
            productionCash: netProductionValue - rawData.productionCredits,
            repCollections: rawData.calculatorCash,
            paymentsIn: rawData.paymentsIn,
            paymentsOut: rawData.paymentsOut
        },
        operatingCashFlow: netSalesCash + (netProductionValue - rawData.productionCredits) + rawData.calculatorCash,
        assets: {
            cash: cashInHand,
            rawMaterials: RawMaterialsValue,
            formulaUnits: FormulaUnitsValue,
            accountsReceivable: AccountsReceivable.total,
            currentAssetsTotal: CURRENT_ASSETS
        },
        receivables: {
            productionCredits: AccountsReceivable.productionCredits,
            salesTab: AccountsReceivable.salesTabCredit,
            calculator: AccountsReceivable.calculatorCredit,
            total: AccountsReceivable.total
        },
        liabilities: {
            accountsPayable: {
                supplierPayables: CurrentLiabilities.accountsPayable.supplierPayables,
                otherPayables: CurrentLiabilities.accountsPayable.otherPayables,
                total: CurrentLiabilities.accountsPayable.total
            },
            total: CurrentLiabilities.total
        },
        workingCapital: WORKING_CAPITAL,
        netWorkingCapital: WORKING_CAPITAL,
        totalEnterpriseValue: ENTERPRISE_VALUE,
        liquidityRatios: liquidityRatios
    };
    
    updateEconomicDashboard(indicators);
    return indicators;
}


// ============================================
// UPDATED: ECONOMIC DASHBOARD UI
// ============================================

// UPDATED: updateEconomicDashboard with production credits display
function updateEconomicDashboard(indicators) {
    // 1. MAIN CASH DISPLAY
    const netCashValueElement = document.getElementById('netCashValue');
    if (netCashValueElement) {
        netCashValueElement.textContent = `Rs ${safeValue(indicators.cashInHand).toFixed(2)}`;
        netCashValueElement.style.color = indicators.cashInHand < 0 ? 'var(--danger)' : 
                                         indicators.cashInHand < 10000 ? 'var(--warning)' : 
                                         'var(--accent-emerald)';
    }
    
    // 2. OPERATING CASH FLOW
    const operatingCashElement = document.getElementById('operatingCashFlow');
    if (operatingCashElement) {
        operatingCashElement.textContent = `Rs ${safeValue(indicators.operatingCashFlow).toFixed(2)}`;
    }
    
    // 3. CASH DETAILS BREAKDOWN
    document.getElementById('cashDetailDirectSales').textContent = `Rs ${safeValue(indicators.cashDetails.directSales).toFixed(2)}`;
    document.getElementById('cashDetailProductionCash').textContent = `Rs ${safeValue(indicators.cashDetails.productionCash).toFixed(2)}`;
    document.getElementById('cashDetailRepCollections').textContent = `Rs ${safeValue(indicators.cashDetails.repCollections).toFixed(2)}`;
    document.getElementById('cashDetailPaymentsIn').textContent = `Rs ${safeValue(indicators.cashDetails.paymentsIn).toFixed(2)}`;
    document.getElementById('cashDetailPaymentsOut').textContent = `Rs ${safeValue(indicators.cashDetails.paymentsOut).toFixed(2)}`;
    document.getElementById('cashDetailNet').textContent = `Rs ${safeValue(indicators.cashInHand).toFixed(2)}`;
    
    // 4. CURRENT ASSETS
    document.getElementById('formulaProdTotal').textContent = `Rs ${safeValue(indicators.assets.cash).toFixed(2)}`;
    document.getElementById('formulaRawMaterials').textContent = `Rs ${safeValue(indicators.assets.rawMaterials).toFixed(2)}`;
    document.getElementById('formulaUnitsValue').textContent = `Rs ${safeValue(indicators.assets.formulaUnits).toFixed(2)}`;
    
    // 5. ACCOUNTS RECEIVABLE (NEW: Now includes production credits)
    
    // Add production credits display (if element exists in your HTML)
    const productionCreditsElement = document.getElementById('productionReceivables');
    if (productionCreditsElement) {
        productionCreditsElement.textContent = `Rs ${safeValue(indicators.receivables.productionCredits).toFixed(2)}`;
    }
    
    document.getElementById('salesReceivables').textContent = `Rs ${safeValue(indicators.receivables.salesTab).toFixed(2)}`;
    document.getElementById('calculatorReceivables').textContent = `Rs ${safeValue(indicators.receivables.calculator).toFixed(2)}`;
    document.getElementById('formulaReceivables').textContent = `Rs ${safeValue(indicators.receivables.total).toFixed(2)}`;
    
    // 6. CURRENT LIABILITIES
    document.getElementById('supplierPayables').textContent = `Rs ${safeValue(indicators.liabilities.accountsPayable.supplierPayables).toFixed(2)}`;
    document.getElementById('otherPayablesOperating').textContent = `Rs ${safeValue(indicators.liabilities.accountsPayable.otherPayables.operating).toFixed(2)}`;
    document.getElementById('otherPayablesLoans').textContent = `Rs ${safeValue(indicators.liabilities.accountsPayable.otherPayables.loans).toFixed(2)}`;
    document.getElementById('otherPayablesMisc').textContent = `Rs ${safeValue(indicators.liabilities.accountsPayable.otherPayables.miscellaneous).toFixed(2)}`;
    document.getElementById('formulaPayOut').textContent = `Rs ${safeValue(indicators.liabilities.accountsPayable.total).toFixed(2)}`;
    
    // 7. TOTALS
    document.getElementById('currentAssetsTotal').textContent = `Rs ${safeValue(indicators.assets.currentAssetsTotal).toFixed(2)}`;
    document.getElementById('currentLiabilitiesTotal').textContent = `Rs ${safeValue(indicators.liabilities.total).toFixed(2)}`;
    
    // 8. ECONOMIC HEALTH INDICATORS
    const workingCapitalElement = document.getElementById('formulaPayIn');
    if (workingCapitalElement) {
        workingCapitalElement.textContent = `Rs ${safeValue(indicators.workingCapital).toFixed(2)}`;
        workingCapitalElement.style.color = indicators.workingCapital < 0 ? 'var(--danger)' : 
                                           indicators.workingCapital < 50000 ? 'var(--warning)' : 
                                           'var(--accent-emerald)';
    }
    
    document.getElementById('formulaFinal').textContent = `Rs ${safeValue(indicators.totalEnterpriseValue).toFixed(2)}`;
    
    // 9. FINANCIAL RATIOS
    const currentRatioElement = document.getElementById('formulaCalcDisc');
    if (currentRatioElement) {
        const currentRatio = indicators.liquidityRatios.currentRatio;
        currentRatioElement.textContent = currentRatio.toFixed(2);
        currentRatioElement.style.color = currentRatio < 1 ? 'var(--danger)' : 
                                         currentRatio < 2 ? 'var(--warning)' : 
                                         'var(--accent-emerald)';
    }
    
    const quickRatioElement = document.getElementById('quickRatio');
    if (quickRatioElement) {
        quickRatioElement.textContent = indicators.liquidityRatios.quickRatio.toFixed(2);
    }
    
    const cashRatioElement = document.getElementById('cashRatio');
    if (cashRatioElement) {
        cashRatioElement.textContent = indicators.liquidityRatios.cashRatio.toFixed(2);
    }
}
function getCostPerUnit(storeType) {
    const formula = factoryDefaultFormulas[storeType];
    if (!formula || formula.length === 0) return 0;
    
    let totalMaterialCost = 0;
    formula.forEach(item => {
        totalMaterialCost += (item.cost * item.quantity);
    });
    
    const additionalCost = factoryAdditionalCosts[storeType] || 0;
    return totalMaterialCost + additionalCost;
}

function calculateFactoryInventoryValue() {
    let totalValue = 0;
    
    // Raw Materials
    if (factoryInventoryData && factoryInventoryData.length > 0) {
        factoryInventoryData.forEach(item => {
            totalValue += (item.quantity * item.cost) || 0;
        });
    }
    
    // Formula Units (Finished/Semi-finished Goods)
    const stdTracking = factoryUnitTracking?.standard || { available: 0 };
    const asaanTracking = factoryUnitTracking?.asaan || { available: 0 };
    
    const stdCostPerUnit = getCostPerUnit('standard');
    const asaanCostPerUnit = getCostPerUnit('asaan');
    
    totalValue += (stdTracking.available * stdCostPerUnit);
    totalValue += (asaanTracking.available * asaanCostPerUnit);
    
    return totalValue;
}

function updateFactoryInventoryDisplay() {
    const factoryValue = calculateFactoryInventoryValue();
    
    // Raw materials value
    let rawMaterialsValue = 0;
    if (factoryInventoryData && factoryInventoryData.length > 0) {
        factoryInventoryData.forEach(item => {
            rawMaterialsValue += (item.quantity * item.cost) || 0;
        });
    }
    
    // Formula units value
    const stdTracking = factoryUnitTracking?.standard || { available: 0 };
    const asaanTracking = factoryUnitTracking?.asaan || { available: 0 };
    const stdCostPerUnit = getCostPerUnit('standard');
    const asaanCostPerUnit = getCostPerUnit('asaan');
    const formulaUnitsValue = (stdTracking.available * stdCostPerUnit) + 
                               (asaanTracking.available * asaanCostPerUnit);
    
    // Update UI
    const rawMaterialsEl = document.getElementById('formulaRawMaterials');
    const unitsValueEl = document.getElementById('formulaUnitsValue');
    
    if (rawMaterialsEl) rawMaterialsEl.textContent = `Rs ${safeValue(rawMaterialsValue).toFixed(2)}`;
    if (unitsValueEl) unitsValueEl.textContent = `Rs ${safeValue(formulaUnitsValue).toFixed(2)}`;
}
    // --- PAYMENTS TAB: SUMMARY CALCULATIONS ---
    function calculatePaymentSummaries() {
        const today = new Date().toISOString().split('T')[0];
        const todayObj = new Date();
        const year = todayObj.getFullYear();
        const month = todayObj.getMonth();
        const day = todayObj.getDate();
        
        const weekStart = new Date(todayObj);
        weekStart.setDate(day - 6);
        
        const summaries = {
            day: { in: 0, out: 0, count: 0 },
            week: { in: 0, out: 0, count: 0 },
            month: { in: 0, out: 0, count: 0 },
            year: { in: 0, out: 0, count: 0 }
        };
        
        paymentTransactions.forEach(transaction => {
            const transDate = new Date(transaction.date);
            const transYear = transDate.getFullYear();
            const transMonth = transDate.getMonth();
            const transDay = transDate.getDate();
            
            // Daily
            if (transaction.date === today) {
                if (transaction.type === 'IN') summaries.day.in += transaction.amount;
                else summaries.day.out += transaction.amount;
                summaries.day.count++;
            }
            
            // Weekly
            if (transDate >= weekStart && transDate <= todayObj) {
                if (transaction.type === 'IN') summaries.week.in += transaction.amount;
                else summaries.week.out += transaction.amount;
                summaries.week.count++;
            }
            
            // Monthly
            if (transYear === year && transMonth === month) {
                if (transaction.type === 'IN') summaries.month.in += transaction.amount;
                else summaries.month.out += transaction.amount;
                summaries.month.count++;
            }
            
            // Yearly
            if (transYear === year) {
                if (transaction.type === 'IN') summaries.year.in += transaction.amount;
                else summaries.year.out += transaction.amount;
                summaries.year.count++;
            }
        });
        
        // Update displays
        const updateSummary = (prefix, data) => {
            document.getElementById(`${prefix}-in`).textContent = `Rs ${safeValue(data.in).toFixed(2)}`;
            document.getElementById(`${prefix}-out`).textContent = `Rs ${safeValue(data.out).toFixed(2)}`;
            document.getElementById(`${prefix}-net`).textContent = `Rs ${safeValue(data.in - data.out).toFixed(2)}`;
            document.getElementById(`${prefix}-count`).textContent = data.count;
        };
        
        updateSummary('payments-day', summaries.day);
        updateSummary('payments-week', summaries.week);
        updateSummary('payments-month', summaries.month);
        updateSummary('payments-year', summaries.year);
    }

    // --- PAYMENTS TAB: REFRESH FUNCTION ---
    async function refreshPaymentTab() {
    // First ensure all suppliers are properly loaded into entities
    await syncSuppliersToEntities();
    
    renderEntityTable(); // <--- UPDATED THIS CALL
    
    
    // 1. Update Economic Health Dashboard (ALL TIME - FIXED)
    calculateNetCash();
    
    // 2. Update Payment Summaries & History (Time Sensitive)
    calculatePaymentSummaries();
    renderEntityTable();
    
    // 3. Update Cash Tracker & Credits Card (Responsive to Toggles)
    calculateCashTracker();
    
    // Render transaction history
    const historyList = document.getElementById('paymentHistoryList');
    if (!historyList) return;
    
    historyList.innerHTML = '';
    
    const sortedTransactions = [...paymentTransactions].sort((a, b) => b.timestamp - a.timestamp);
    
    sortedTransactions.forEach(transaction => {
        // ... existing card rendering logic ...
        const entity = paymentEntities.find(e => e.id === transaction.entityId);
        const badgeClass = transaction.type === 'IN' ? 'transaction-in' : 'transaction-out';
        const badgeText = transaction.type === 'IN' ? 'IN' : 'OUT';
        
        const card = document.createElement('div');
        card.className = 'card liquid-card';
        card.innerHTML = `
            <span class="transaction-badge ${badgeClass}">${badgeText}</span>
            <h4>${transaction.date} @ ${transaction.time || 'N/A'}</h4>
            <div class="customer-name">${entity ? entity.name : 'Unknown Entity'}</div>
            <p><span>Type:</span> <span>${entity ? (entity.type === 'payee' ? 'Payee' : 'Payor') : 'Unknown'}</span></p>
            <p><span>Description:</span> <span>${transaction.description || 'No description'}</span></p>
            <hr>
            <p><span>Amount:</span> <span class="${transaction.type === 'IN' ? 'profit-val' : 'cost-val'}">Rs ${safeValue(transaction.amount).toFixed(2)}</span></p>
            <button class="btn btn-danger" style="width:100%; font-size:9px; padding:4px; margin-top:8px;" onclick="(async () => { await deletePaymentTransaction(${transaction.id}) })()">Delete</button>
        `;
        historyList.appendChild(card);
    });
    
    if (sortedTransactions.length === 0) {
        historyList.innerHTML = '<p style="text-align:center; color:var(--text-muted); width:100%; font-size:0.85rem;">No payment transactions found.</p>';
    }
}


    // --- FACTORY FORMULA FUNCTIONS (UPDATED) ---
    function openFactorySettings() {
        document.getElementById('factorySettingsOverlay').style.display = 'flex';
        renderFactorySettingsRows();
    }
    
    function closeFactorySettings() { 
        document.getElementById('factorySettingsOverlay').style.display = 'none'; 
    }
    
    function selectFactoryStore(store, el) {
        currentFactorySettingsStore = store;
        document.querySelectorAll('#factorySettingsOverlay .factory-store-opt').forEach(o => o.classList.remove('active'));
        if(el) el.classList.add('active');
        renderFactorySettingsRows();
    }
    
    async function renderFactorySettingsRows() {
        const container = document.getElementById('factoryRawMaterialsContainer');
        container.innerHTML = '';
        const formula = factoryDefaultFormulas[currentFactorySettingsStore];
        
        let totalRawCost = 0, totalWeight = 0;
        
        if(formula.length > 0) {
            formula.forEach(ing => {
                totalRawCost += (ing.cost * ing.quantity);
                totalWeight += ing.quantity;
                createFactorySettingRow(container, ing.id, ing.quantity);
            });
        }
        
        // Get available units
        const available = factoryUnitTracking[currentFactorySettingsStore]?.available || 0;
        
        // Load additional cost
        const additionalCost = factoryAdditionalCosts[currentFactorySettingsStore] || 0;
        document.getElementById('additional-cost-per-unit').value = additionalCost;
        
        // Load cost adjustment factor (X)
        const adjustmentFactor = factoryCostAdjustmentFactor[currentFactorySettingsStore] || 1;
        document.getElementById('cost-adjustment-factor').value = adjustmentFactor;
        
        // Load sale prices
        const salePriceStandard = factorySalePrices.standard || 0;
        const salePriceAsaan = factorySalePrices.asaan || 0;
        document.getElementById('sale-price-standard').value = salePriceStandard;
        document.getElementById('sale-price-asaan').value = salePriceAsaan;
        
        const perUnitCost = totalRawCost + additionalCost;
        const salesCostPerKg = adjustmentFactor > 0 ? perUnitCost / adjustmentFactor : perUnitCost;
        
        document.getElementById('factorySettingsUnitWeight').innerText = totalWeight.toFixed(2) + ' kg';
        document.getElementById('factorySettingsRawCostPerUnit').innerText = await formatCurrency(totalRawCost);
        document.getElementById('factorySettingsPerUnit').innerText = await formatCurrency(perUnitCost);
        document.getElementById('factorySettingsAvailableUnits').innerText = available;
        document.getElementById('factorySettingsSalesCostPerKg').innerText = await formatCurrency(salesCostPerKg);
    }
    
    function createFactorySettingRow(container, selectedId = '', qtyVal = '') {
        const div = document.createElement('div');
        div.className = 'factory-formula-grid';
        
        // Material Dropdown
        let options = '<option value="">Select Material</option>';
        factoryInventoryData.forEach(i => {
            options += `<option value="${i.id}" ${i.id == selectedId ? 'selected' : ''} data-cost="${i.cost}">${i.name}</option>`;
        });

        // Current cost
        let currentCost = 0;
        if(selectedId) {
            const m = factoryInventoryData.find(i => i.id == selectedId);
            if(m) currentCost = m.cost;
        }

        div.innerHTML = `
            <select class="factory-mat-select" onchange="updateFactoryRowCost(this)">${options}</select>
            <input type="number" class="factory-mat-cost" value="${currentCost}" readonly style="background:rgba(0,0,0,0.05); color:var(--text-muted);">
            <input type="number" class="factory-mat-qty" value="${qtyVal}" placeholder="0">
        `;
        container.appendChild(div);
    }
    
    function addFactoryMaterialRow() {
        const container = document.getElementById('factoryRawMaterialsContainer');
        createFactorySettingRow(container);
    }
    
    function updateFactoryRowCost(selectEl) {
        const costInput = selectEl.parentElement.querySelector('.factory-mat-cost');
        const selectedOption = selectEl.options[selectEl.selectedIndex];
        const cost = selectedOption.getAttribute('data-cost');
        costInput.value = cost || 0;
        updateFactoryFormulasSummary();
    }
    
    async function updateFactoryFormulasSummary() {
        const container = document.getElementById('factoryRawMaterialsContainer');
        const rows = container.querySelectorAll('.factory-formula-grid');
        let totalRawCost = 0, totalWeight = 0;
        
        rows.forEach(row => {
            const sel = row.querySelector('.factory-mat-select');
            const qtyIn = row.querySelector('.factory-mat-qty');
            const costIn = row.querySelector('.factory-mat-cost');
            
            if(sel && sel.value && qtyIn.value > 0 && costIn.value > 0) {
                totalRawCost += (parseFloat(costIn.value) * parseFloat(qtyIn.value));
                totalWeight += parseFloat(qtyIn.value);
            }
        });
        
        const additionalCost = parseFloat(document.getElementById('additional-cost-per-unit').value) || 0;
        const adjustmentFactor = parseFloat(document.getElementById('cost-adjustment-factor').value) || 1;
        const perUnitCost = totalRawCost + additionalCost;
        const available = factoryUnitTracking[currentFactorySettingsStore]?.available || 0;
        const salesCostPerKg = adjustmentFactor > 0 ? perUnitCost / adjustmentFactor : perUnitCost;
        
        document.getElementById('factorySettingsUnitWeight').innerText = totalWeight.toFixed(2) + ' kg';
        document.getElementById('factorySettingsRawCostPerUnit').innerText = await formatCurrency(totalRawCost);
        document.getElementById('factorySettingsPerUnit').innerText = await formatCurrency(perUnitCost);
        document.getElementById('factorySettingsAvailableUnits').innerText = available;
        document.getElementById('factorySettingsSalesCostPerKg').innerText = await formatCurrency(salesCostPerKg);
    }
    
    async function saveFactoryFormulas() {
        const container = document.getElementById('factoryRawMaterialsContainer');
        const rows = container.querySelectorAll('.factory-formula-grid');
        const newFormula = [];
        
        rows.forEach(row => {
            const sel = row.querySelector('.factory-mat-select');
            const qtyIn = row.querySelector('.factory-mat-qty');
            const costIn = row.querySelector('.factory-mat-cost');
            if(sel && sel.value && qtyIn.value > 0 && costIn.value > 0) {
                const item = factoryInventoryData.find(i => i.id == sel.value);
                if(item) {
                    newFormula.push({ 
                        id: item.id, 
                        name: item.name, 
                        cost: parseFloat(costIn.value), 
                        quantity: parseFloat(qtyIn.value) 
                    });
                }
            }
        });

        factoryDefaultFormulas[currentFactorySettingsStore] = newFormula;
        
        // Save additional cost
        const additionalCost = parseFloat(document.getElementById('additional-cost-per-unit').value) || 0;
        factoryAdditionalCosts[currentFactorySettingsStore] = additionalCost;
        
        // Save cost adjustment factor (X)
        const adjustmentFactor = parseFloat(document.getElementById('cost-adjustment-factor').value) || 1;
        factoryCostAdjustmentFactor[currentFactorySettingsStore] = adjustmentFactor;
        
        // Save sale prices
        const salePriceStandard = parseFloat(document.getElementById('sale-price-standard').value) || 0;
        const salePriceAsaan = parseFloat(document.getElementById('sale-price-asaan').value) || 0;
        factorySalePrices.standard = salePriceStandard;
        factorySalePrices.asaan = salePriceAsaan;
        
        // Atomic Save: Group all factory settings updates
        try {
            await Promise.all([
                idb.set('factory_default_formulas', factoryDefaultFormulas),
                idb.set('factory_additional_costs', factoryAdditionalCosts),
                idb.set('factory_cost_adjustment_factor', factoryCostAdjustmentFactor),
                idb.set('factory_sale_prices', factorySalePrices)
            ]);
        } catch (e) {
            console.error("Atomic settings save failed:", e);
            alert("Failed to save settings. Please try again.");
            return;
        }
        notifyDataChange('all');

        calculateFactoryProduction(); // Recalculate preview
        updateAllTabsWithFactoryCosts();
        closeFactorySettings();
        alert("Formula saved successfully!");
    }
    
    // --- FACTORY INVENTORY FUNCTIONS ---
    function openFactoryInventoryModal() {
        document.getElementById('factoryInventoryOverlay').style.display = 'flex';
        document.getElementById('factoryInventoryModalTitle').innerText = 'Add Raw Material';
        document.getElementById('deleteFactoryInventoryBtn').style.display = 'none'; 
        clearFactoryInventoryForm();
        editingFactoryInventoryId = null;
    }
    
    function closeFactoryInventoryModal() { 
        document.getElementById('factoryInventoryOverlay').style.display = 'none'; 
    }
    
    function clearFactoryInventoryForm() {
        document.getElementById('factoryMaterialName').value = '';
        document.getElementById('factoryMaterialQuantity').value = '';
        document.getElementById('factoryMaterialUnit').value = 'kg';
        document.getElementById('factoryMaterialCost').value = '';
    }
    
    // UPDATED: Edit Factory Inventory Item with Supplier Display
function editFactoryInventoryItem(id) {
    const item = factoryInventoryData.find(i => i.id === id);
    if(item) {
        openFactoryInventoryModal();
        document.getElementById('factoryInventoryModalTitle').innerText = 'Edit Material';
        document.getElementById('deleteFactoryInventoryBtn').style.display = 'block'; 
        
        document.getElementById('factoryMaterialName').value = item.name;
        document.getElementById('factoryMaterialQuantity').value = item.quantity;
        document.getElementById('factoryMaterialUnit').value = item.unit;
        document.getElementById('factoryMaterialCost').value = item.cost;
        
        // Handle supplier display
        const supplierTypeSelect = document.getElementById('factoryMaterialSupplierType');
        const existingSupplierSection = document.getElementById('existingSupplierSection');
        const newSupplierSection = document.getElementById('newSupplierSection');
        
        if (item.supplierId) {
            // Material is linked to a supplier
            supplierTypeSelect.value = 'existing';
            existingSupplierSection.classList.remove('hidden');
            newSupplierSection.classList.add('hidden');
            
            loadExistingSuppliers();
            document.getElementById('factoryExistingSupplier').value = item.supplierId;
            
            // Show unlink option
            showSupplierUnlinkOption(item);
        } else {
            // No supplier linked
            supplierTypeSelect.value = 'none';
            existingSupplierSection.classList.add('hidden');
            newSupplierSection.classList.add('hidden');
        }
        
        editingFactoryInventoryId = id;
    }
}

// NEW: Show supplier unlink option in modal
function showSupplierUnlinkOption(material) {
    const existingSupplierSection = document.getElementById('existingSupplierSection');
    
    // Check if unlink button already exists
    let unlinkButton = existingSupplierSection.querySelector('.unlink-supplier-btn');
    
    if (!unlinkButton) {
        unlinkButton = document.createElement('button');
        unlinkButton.className = 'btn btn-danger unlink-supplier-btn';
        unlinkButton.style.cssText = 'width: 100%; margin-top: 10px; font-size: 0.8rem;';
        unlinkButton.innerHTML = ' Unlink Supplier & Reverse Transactions';
        unlinkButton.onclick = function(e) {
            e.preventDefault();
            unlinkSupplierConfirmation(material);
        };
        
        existingSupplierSection.appendChild(unlinkButton);
    }
}

// NEW: Confirmation dialog for unlinking supplier
async function unlinkSupplierConfirmation(material) {
    const linkedTransactions = paymentTransactions.filter(t => 
        t.materialId === material.id && 
        t.entityId === material.supplierId && 
        t.isPayable === true
    );
    
    let confirmMsg = ` Unlink ${material.supplierName} from ${material.name}?\n\n`;
    confirmMsg += `This will:\n`;
    confirmMsg += ` Remove supplier association\n`;
    confirmMsg += ` Reset payment status to 'pending'\n`;
    
    if (linkedTransactions.length > 0) {
        const totalReversed = linkedTransactions.reduce((sum, t) => sum + t.amount, 0);
        confirmMsg += ` Reverse ${linkedTransactions.length} payment transaction(s) totaling Rs ${totalReversed.toFixed(2)}\n`;
    }
    
    confirmMsg += `\nThe material will be ready to link with a different supplier.`;
    
    if (confirm(confirmMsg)) {
        await unlinkSupplierFromMaterial(material);
        
        // Refresh modal display
        closeFactoryInventoryModal();
        setTimeout(() => editFactoryInventoryItem(material.id), 100);
        
        // Refresh all displays
        refreshPaymentTab();
        calculateNetCash();
        renderFactoryInventory();
    }
}
// ============================================
// DYNAMIC SUPPLIER LINKING SYSTEM
// ============================================

// UPDATED: saveFactoryInventoryItem with dynamic unlinking capability
async function saveFactoryInventoryItem() {
    const name = document.getElementById('factoryMaterialName').value;
    const qty = parseFloat(document.getElementById('factoryMaterialQuantity').value) || 0;
    const cost = parseFloat(document.getElementById('factoryMaterialCost').value) || 0;
    const unit = document.getElementById('factoryMaterialUnit').value;
    const supplierType = document.getElementById('factoryMaterialSupplierType').value;

    if(!name) return showToast("Name required", 'warning');

    const totalValue = qty * cost;
    const materialId = editingFactoryInventoryId || generateUUID('mat');
    let existingMaterial = null;

    // Handle editing existing material
    if(editingFactoryInventoryId) {
        const idx = factoryInventoryData.findIndex(i => i.id === editingFactoryInventoryId);
        if(idx !== -1) {
            existingMaterial = factoryInventoryData[idx];
            
            // Check if supplier is being changed or removed
            const oldSupplierId = existingMaterial.supplierId;
            const isSupplierChanging = (supplierType === 'none' && oldSupplierId) || 
                                      (supplierType === 'existing' && oldSupplierId !== parseInt(document.getElementById('factoryExistingSupplier').value));
            
            // If supplier is changing, unlink the old one first
            if (isSupplierChanging) {
                await unlinkSupplierFromMaterial(existingMaterial);
            }
            
            // Update material data
            factoryInventoryData[idx] = { 
                ...factoryInventoryData[idx], 
                name, 
                quantity: qty, 
                cost, 
                unit, 
                totalValue 
            };
        }
    } else {
        // Create new material
        factoryInventoryData.push({ 
            id: materialId, 
            name, 
            quantity: qty, 
            cost, 
            unit, 
            totalValue,
            paymentStatus: 'pending'
        });
    }

    // Handle supplier linkage based on selection
    if (supplierType === 'none') {
        // No supplier - ensure material is clean
        const material = factoryInventoryData.find(m => m.id === materialId);
        if (material) {
            delete material.supplierId;
            delete material.supplierName;
            delete material.supplierContact;
            delete material.supplierType;
            material.paymentStatus = 'pending';
            delete material.totalPayable;
        }
    } 
    else if (supplierType === 'existing') {
        const existingSupplierId = parseInt(document.getElementById('factoryExistingSupplier').value);
        if (existingSupplierId) {
            await linkMaterialToSupplier(materialId, existingSupplierId, totalValue);
        }
    } 
    else if (supplierType === 'new') {
        const supplierName = document.getElementById('factorySupplierName').value.trim();
        const supplierPhone = document.getElementById('factorySupplierPhone').value.trim();
        
        if (supplierName) {
            const newSupplier = await createSupplierFromMaterial({
                name: supplierName,
                phone: supplierPhone,
                materialId: materialId,
                materialName: name,
                materialTotal: totalValue
            });
            
            if (newSupplier && newSupplier.id) {
                await linkMaterialToSupplier(materialId, newSupplier.id, totalValue);
            }
        }
    }

    await idb.set('factory_inventory_data', factoryInventoryData);
    renderFactoryInventory();
    closeFactoryInventoryModal();
    
    refreshPaymentTab();
    calculateNetCash();
    
    showToast("Material saved successfully!", 'success');
}

// NEW: Function to unlink supplier from material
async function unlinkSupplierFromMaterial(material) {
    if (!material || !material.supplierId) return;
    
    const supplierId = material.supplierId;
    const materialId = material.id;
    
    console.log(` Unlinking supplier ${material.supplierName} from material ${material.name}`);
    
    // Step 1: Find and remove any payment transactions linked to this material
    const linkedTransactions = paymentTransactions.filter(t => 
        t.materialId === materialId && 
        t.entityId === supplierId && 
        t.isPayable === true
    );
    
    if (linkedTransactions.length > 0) {
        console.log(`   Found ${linkedTransactions.length} linked payment(s) to reverse`);
        
        linkedTransactions.forEach(transaction => {
            // Remove the transaction
            paymentTransactions = paymentTransactions.filter(t => t.id !== transaction.id);
            console.log(`    Reversed payment transaction: ${transaction.description} - Rs ${transaction.amount}`);
        });
        
        await idb.set('payment_transactions', paymentTransactions);
        notifyDataChange('all');

    }
    
    // Step 2: Clear supplier information from material
    delete material.supplierId;
    delete material.supplierName;
    delete material.supplierContact;
    delete material.supplierType;
    material.paymentStatus = 'pending';
    delete material.totalPayable;
    delete material.paidDate;
    
    console.log(`    Supplier link removed from material`);
    
    await idb.set('factory_inventory_data', factoryInventoryData);
    
    showToast(`Supplier unlinked from ${material.name}. All linked transactions reversed.`, 'info');
}

// UPDATED: createSupplierFromMaterial - NO immediate transaction
async function createSupplierFromMaterial(supplierData) {
    const existingSupplier = paymentEntities.find(e => 
        e.name.toLowerCase() === supplierData.name.toLowerCase() && e.type === 'payee'
    );
    
    if (existingSupplier) {
        return existingSupplier;
    }
    
    const supplierEntity = {
        id: Date.now(),
        name: supplierData.name,
        type: 'payee',
        phone: supplierData.phone || '',
        wallet: '',
        createdAt: Date.now(),
        updatedAt: Date.now(),
        isSupplier: true,
        supplierCategory: 'raw_materials'
    };
    
    paymentEntities.push(supplierEntity);
    await idb.set('payment_entities', paymentEntities);
    notifyDataChange('all');

    return supplierEntity;
}


// --- UPDATED: LINK MATERIAL TO SUPPLIER FUNCTION ---
async function linkMaterialToSupplier(materialId, supplierId, totalCost) {
    // Find the material
    const material = factoryInventoryData.find(m => m.id === materialId);
    if (!material) return;
    
    // Find the supplier entity
    const supplier = paymentEntities.find(e => e.id === supplierId);
    if (!supplier) return;
    
    // Update material with supplier info
    material.supplierId = supplierId;
    material.supplierName = supplier.name;
    material.supplierContact = supplier.phone || '';
    material.supplierType = 'payee';
    material.paymentStatus = 'pending';
    material.totalPayable = totalCost;
    
    await idb.set('factory_inventory_data', factoryInventoryData);
    notifyDataChange('all');

    // Refresh payment tab to show updated entity list
    refreshPaymentTab();
}
    
    // UPDATED: renderFactoryInventory with unlink capability
async function renderFactoryInventory() {
    const tbody = document.getElementById('factoryInventoryTableBody');
    tbody.innerHTML = '';
    let totalVal = 0;

    if (factoryInventoryData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">No items in inventory</td></tr>';
    } else {
        for (const item of factoryInventoryData) {
            totalVal += item.totalValue;
            
            // Build supplier info section
            let supplierHtml = '';
            if (item.supplierName) {
                const paymentStatus = item.paymentStatus === 'paid' ? 
                    '<span style="color:var(--accent-emerald);"> PAID</span>' : 
                    '<span style="color:var(--warning);">PENDING</span>';
                
                supplierHtml = `
                    <div style="font-size:0.65rem; color:var(--text-muted); margin-top:2px;">
                        <div style="background:rgba(37, 99, 235, 0.1); color:var(--accent); padding:2px 6px; border-radius:3px; display:inline-block; margin-bottom:3px;">
                            <strong>SUPPLIER:</strong> ${item.supplierName}
                        </div>
                        <div style="margin-top:2px;">
                            ${paymentStatus} | ${(item.totalPayable || 0).toFixed(2)}
                        </div>
                    </div>
                `;
            } else {
                supplierHtml = `
                    <div style="font-size:0.65rem; color:var(--text-muted); margin-top:2px; font-style:italic;">
                        No supplier linked
                    </div>
                `;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight:700;">${item.name}</div>
                    ${supplierHtml}
                </td>
                <td style="text-align:center;">${item.quantity} ${item.unit}</td>
                <td style="text-align:right;">${await formatCurrency(item.cost)}</td>
                <td style="text-align:right; font-weight:700;">${await formatCurrency(item.totalValue)}</td>
                <td style="text-align:center;">
                    <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                        <button class="btn-theme" style="padding:2px 8px; font-size:0.75rem;" onclick="editFactoryInventoryItem(${item.id})">Edit</button>
                        ${item.supplierId ? `
                            <button class="btn btn-danger btn-sm" style="padding:2px 8px; font-size:0.7rem;" onclick="unlinkSupplierFromMaterialById(${item.id})">
                               Unlink
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }
    document.getElementById('factoryTotalInventoryValue').innerText = await formatCurrency(totalVal);
}

// NEW: Quick unlink function for table button
async function unlinkSupplierFromMaterialById(materialId) {
    const material = factoryInventoryData.find(m => m.id === materialId);
    if (!material) {
        showToast("Material not found", 'error');
        return;
    }
    
    if (!material.supplierId) {
        showToast("Material has no supplier linked", 'warning');
        return;
    }
    
    const linkedTransactions = paymentTransactions.filter(t => 
        t.materialId === materialId && 
        t.entityId === material.supplierId && 
        t.isPayable === true
    );
    
    let confirmMsg = `Unlink ${material.supplierName} from ${material.name}?\n\n`;
    if (linkedTransactions.length > 0) {
        const totalReversed = linkedTransactions.reduce((sum, t) => sum + t.amount, 0);
        confirmMsg += `This will reverse ${linkedTransactions.length} payment(s) totaling Rs ${totalReversed.toFixed(2)}.`;
    }
    
    if (confirm(confirmMsg)) {
        await unlinkSupplierFromMaterial(material);
        renderFactoryInventory();
        refreshPaymentTab();
        calculateNetCash();
        showToast("Supplier unlinked successfully", 'success');
    }
}

    
    // --- FACTORY SUPPLIER MANAGEMENT ---
function toggleSupplierFields() {
    const supplierType = document.getElementById('factoryMaterialSupplierType').value;
    const existingSection = document.getElementById('existingSupplierSection');
    const newSection = document.getElementById('newSupplierSection');
    
    if (existingSection) existingSection.classList.add('hidden');
    if (newSection) newSection.classList.add('hidden');
    
    if (supplierType === 'existing') {
        if (existingSection) {
            existingSection.classList.remove('hidden');
            loadExistingSuppliers();
        }
    } else if (supplierType === 'new') {
        if (newSection) newSection.classList.remove('hidden');
    }
}

function loadExistingSuppliers() {
    const selectElement = document.getElementById('factoryExistingSupplier');
    if (!selectElement) return;
    
    selectElement.innerHTML = '<option value="">Choose Supplier</option>';
    
    // Get all existing suppliers from payment entities
    const suppliers = paymentEntities.filter(entity => entity.type === 'payee');
    
    suppliers.forEach(supplier => {
        const option = document.createElement('option');
        option.value = supplier.id;
        option.textContent = `${supplier.name} ${supplier.phone ? `(${supplier.phone})` : ''}`;
        selectElement.appendChild(option);
    });
    
    if (suppliers.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "No suppliers found. Create a new one.";
        option.disabled = true;
        selectElement.appendChild(option);
    }
}

async function createSupplierFromMaterial(supplierData) {
    // Create a new entity for the supplier
    const supplierEntity = {
        id: Date.now(),
        name: supplierData.name,
        type: 'payee', // Supplier is someone we pay
        phone: supplierData.phone || '',
        email: supplierData.email || '',
        contactPerson: supplierData.contact || '',
        paymentTerms: supplierData.paymentTerms || 'cash',
        wallet: supplierData.email || '',
        createdAt: Date.now(),
        updatedAt: Date.now(),
        isSupplier: true,
        supplierId: supplierData.id || Date.now(),
        supplierCategory: 'raw_materials'
    };
    
    // Add to payment entities
    paymentEntities.push(supplierEntity);
    await idb.set('payment_entities', paymentEntities);
    notifyDataChange('all');

    // Create an initial payable transaction for this material purchase
    const today = new Date().toISOString().split('T')[0];
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${ampm}`;
    
    paymentTransactions.push({
        id: Date.now(),
        entityId: supplierEntity.id,
        entityName: supplierEntity.name,
        entityType: 'payee',
        date: today,
        time: timeString,
        amount: supplierData.materialTotal || 0,
        description: `Initial material purchase: ${supplierData.materialName}`,
        type: 'OUT', // Money going out to supplier
        materialId: supplierData.materialId,
        supplierTransaction: true,
        timestamp: new Date(today).getTime()
    });
    
    await idb.set('payment_transactions', paymentTransactions);
    notifyDataChange('all');

    return supplierEntity;
}

// UPDATED: linkMaterialToSupplier - Enhanced with unlinking capability
async function linkMaterialToSupplier(materialId, supplierId, totalCost) {
    const material = factoryInventoryData.find(m => m.id === materialId);
    if (!material) return;
    
    const supplier = paymentEntities.find(e => e.id === supplierId);
    if (!supplier) return;
    
    // If material was previously linked to a different supplier, unlink first
    if (material.supplierId && material.supplierId !== supplierId) {
        await unlinkSupplierFromMaterial(material);
    }
    
    // Update material with new supplier info
    material.supplierId = supplierId;
    material.supplierName = supplier.name;
    material.supplierContact = supplier.phone || '';
    material.supplierType = 'payee';
    material.paymentStatus = 'pending';
    material.totalPayable = totalCost;
    
    await idb.set('factory_inventory_data', factoryInventoryData);
    notifyDataChange('all');

    console.log(` Linked material ${material.name} to supplier ${supplier.name}`);
    
    refreshPaymentTab();
}


    // --- FACTORY PRODUCTION FUNCTIONS ---
    function selectFactoryEntryStore(store, el) {
        currentFactoryEntryStore = store;
        document.querySelectorAll('.factory-store-selector .factory-store-opt').forEach(o => o.classList.remove('active'));
        if(el) el.classList.add('active');
        calculateFactoryProduction();
    }
    
    async function calculateFactoryProduction() {
        const units = parseInt(document.getElementById('factoryProductionUnits').value) || 1;
        const settings = factoryDefaultFormulas[currentFactoryEntryStore];
        const additionalCost = factoryAdditionalCosts[currentFactoryEntryStore] || 0;
        
        let baseCost = 0;
        let rawMaterialsUsed = 0;
        let html = `<h4 style="margin:0 0 5px 0; font-size:0.9rem;">${currentFactoryEntryStore.toUpperCase()} Formula (${units} Units)</h4>`;
        
        if (settings && settings.length > 0) {
            for (const i of settings) {
                const lineTotal = i.cost * i.quantity * units;
                baseCost += lineTotal;
                rawMaterialsUsed += i.quantity * units;
                html += `<div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:2px;">
                    <span>${i.name} (${i.quantity * units} kg)</span>
                    <span>${await formatCurrency(lineTotal)}</span>
                </div>`;
            }
            
            // Add additional cost line
            const totalAdditionalCost = additionalCost * units;
            if (totalAdditionalCost > 0) {
                html += `<div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:2px; color:var(--danger);">
                    <span>Additional Cost (${additionalCost} per unit)</span>
                    <span>${await formatCurrency(totalAdditionalCost)}</span>
                </div>`;
                baseCost += totalAdditionalCost;
            }
        } else {
            html += `<div style="color:var(--text-muted);">No formula set.</div>`;
        }

        document.getElementById('factoryFormulaDisplay').innerHTML = html;
        document.getElementById('factoryTotalProductionCostDisplay').innerText = await formatCurrency(baseCost);
    }
    
    async function saveFactoryProductionEntry() {
        const units = parseInt(document.getElementById('factoryProductionUnits').value) || 0;
        if(units <= 0) return alert("Invalid units");

        const settings = factoryDefaultFormulas[currentFactoryEntryStore];
        const additionalCost = factoryAdditionalCosts[currentFactoryEntryStore] || 0;
        
        let baseCost = 0;
        let rawMat = 0;
        if(settings) {
            baseCost = settings.reduce((acc, cur) => acc + (cur.cost * cur.quantity), 0) * units;
            rawMat = settings.reduce((acc, cur) => acc + cur.quantity, 0) * units;
        }
        
        const totalAdditionalCost = additionalCost * units;
        const totalCost = baseCost + totalAdditionalCost;
        
        // Deduct raw materials from inventory
        let inventoryUpdated = false;
        if(settings && settings.length > 0) {
            settings.forEach(item => {
                const materialUsed = item.quantity * units;
                const inventoryItem = factoryInventoryData.find(i => i.id === item.id);
                if(inventoryItem) {
                    if(inventoryItem.quantity >= materialUsed) {
                        inventoryItem.quantity -= materialUsed;
                        inventoryItem.totalValue = inventoryItem.quantity * inventoryItem.cost;
                        inventoryUpdated = true;
                    } else {
                        alert(`Insufficient ${inventoryItem.name} in inventory! Available: ${inventoryItem.quantity}, Required: ${materialUsed}`);
                        return;
                    }
                }
            });
            
            // Atomic Update: Group inventory and production history saves
            if(inventoryUpdated) {
                // We will save both together below to ensure integrity
            }
        }

        factoryProductionHistory.unshift({
            id: generateUUID('fact_prod'),
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            store: currentFactoryEntryStore,
            units, 
            totalCost, 
            materialsCost: baseCost, 
            additionalCost: totalAdditionalCost,
            rawMaterialsUsed: rawMat, 
            timestamp: Date.now()
        });

        // Atomic Save: Ensure both inventory and history are updated or neither is
        try {
            await Promise.all([
                idb.set('factory_inventory_data', factoryInventoryData),
                idb.set('factory_production_history', factoryProductionHistory)
            ]);
        } catch (e) {
            console.error("Atomic save failed:", e);
            alert("Failed to save production data. Please try again.");
            return; // Prevent UI refresh if save fails
        }
        
        // Update unit tracking
        await syncFactoryProductionStats();
        
        // Update all displays
        updateFactorySummaryCard();
        updateFactoryUnitsAvailableStats();
        renderFactoryHistory();
        updateAllTabsWithFactoryCosts();
        renderFactoryInventory();
        
        // Clear form
        document.getElementById('factoryProductionUnits').value = '1';
                
        alert("Production saved successfully!");
    }
    
    // --- FACTORY SUMMARY MODE SETTER ---
    function setFactorySummaryMode(mode, el) {
        currentFactorySummaryMode = mode;
        document.querySelectorAll('#tab-factory .toggle-group .toggle-opt').forEach(opt => opt.classList.remove('active'));
        if(el) el.classList.add('active');
        
        updateFactorySummaryCard();
    }
    
    // --- FACTORY UNITS AVAILABLE FUNCTIONS ---
    function setFactoryAvailableStore(store, el) {
        document.getElementById('factoryAvailStatsStandard').classList.add('hidden');
        document.getElementById('factoryAvailStatsAsaan').classList.add('hidden');
        
        const statsElement = document.getElementById('factoryAvailStats' + (store === 'standard' ? 'Standard' : 'Asaan'));
        if (statsElement) {
            statsElement.classList.remove('hidden');
        }

        // Update toggle UI
        const parent = el.parentElement;
        parent.querySelectorAll('.toggle-opt').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        
        updateFactoryUnitsAvailableStats();
    }
    async function renderFactoryHistory() {
        const list = document.getElementById('factoryHistoryList');
        list.innerHTML = '';

        if (factoryProductionHistory.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No recent activity</div>';
            return;
        }

        // Sort by Timestamp Descending (Newest First)
        const recent = [...factoryProductionHistory].sort((a, b) => {
            const timeA = a.timestamp || new Date(a.date + ' ' + a.time).getTime();
            const timeB = b.timestamp || new Date(b.date + ' ' + b.time).getTime();
            return timeB - timeA;
        });

        for (const entry of recent) {
            const dateObj = new Date(entry.date);
            const dateStr = dateObj.toLocaleDateString() + ' ' + entry.time;
            const badgeClass = entry.store === 'standard' ? 'factory-badge-std' : 'factory-badge-asn';
            const storeLabel = entry.store === 'standard' ? 'STD' : 'ASN';

            // Calculate statistics
            const perUnitCost = entry.units > 0 ? entry.totalCost / entry.units : 0;

            // Get additional cost info
            const additionalCostPerUnit = factoryAdditionalCosts[entry.store] || 0;
            const totalAdditionalCost = additionalCostPerUnit * entry.units;

            const div = document.createElement('div');
            div.className = 'factory-history-item';

            // FIX: Added single quotes around ${entry.id} in the onclick attribute below
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid var(--glass-border); padding-bottom:5px;">
                    <span style="font-size:0.75rem; color:var(--text-muted);">${dateStr}</span>
                    <span class="factory-badge ${badgeClass}">${storeLabel}</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Units Produced</span>
                    <span class="qty-val">${entry.units}</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Material Cost</span>
                    <span class="cost-val">${await formatCurrency(entry.materialsCost || 0)}</span>
                </div>
                ${totalAdditionalCost > 0 ? `<div class="factory-summary-row">
                    <span class="factory-summary-label">Additional Cost</span>
                    <span class="cost-val">${await formatCurrency(totalAdditionalCost)}</span>
                </div>` : ''}
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Per Unit Cost</span>
                    <span class="cost-val">${await formatCurrency(perUnitCost)}</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Total Cost</span>
                    <span class="rev-val">${await formatCurrency(entry.totalCost)}</span>
                </div>
                <div class="factory-summary-row">
                    <span class="factory-summary-label">Raw Materials Used</span>
                    <span class="qty-val">${entry.rawMaterialsUsed.toFixed(2)} kg</span>
                </div>
                <button class="btn btn-danger" style="width:100%; font-size:9px; padding:4px; margin-top:8px;" onclick="deleteFactoryEntry('${entry.id}')">Delete & Restore Inventory</button>
            `;
            list.appendChild(div);
        }
    }

    async function deleteFactoryEntry(id) {
        const entryIndex = factoryProductionHistory.findIndex(e => e.id === id);
        if (entryIndex === -1) return;

        const entry = factoryProductionHistory[entryIndex];

        if (confirm(`Delete production of ${entry.units} units? \nThis will RESTORE raw materials to inventory.`)) {
                await registerDeletion(id);
            
            // 1. Attempt to Restore Raw Materials
            const formula = factoryDefaultFormulas[entry.store];
            
            if (formula && formula.length > 0) {
                let inventoryUpdated = false;
                
                formula.forEach(formulaItem => {
                    const materialToRestore = formulaItem.quantity * entry.units;
                    const inventoryItem = factoryInventoryData.find(i => i.id === formulaItem.id);
                    
                    if (inventoryItem) {
                        inventoryItem.quantity += materialToRestore;
                        inventoryItem.totalValue = inventoryItem.quantity * inventoryItem.cost;
                        inventoryUpdated = true;
                    }
                });

                if (inventoryUpdated) {
                    await idb.set('factory_inventory_data', factoryInventoryData);
                    renderFactoryInventory();
                }
            }

            // 2. Remove entry from history
            factoryProductionHistory.splice(entryIndex, 1);
            await idb.set('factory_production_history', factoryProductionHistory);

            // 3. Recalculate all stats
            syncFactoryProductionStats();
            updateFactorySummaryCard();
            updateFactoryUnitsAvailableStats();
            renderFactoryHistory();
            updateAllTabsWithFactoryCosts();

            alert("Entry deleted and inventory restored.");
        }
    }

    // --- DYNAMIC COST CALCULATION FUNCTIONS (UPDATED) ---
    function calculateDynamicCost(storeType, formulaUnits, netWeight) {
        let formulaStore = 'standard';
        
        if (storeType === 'STORE_C' || storeType === 'asaan') {
            formulaStore = 'asaan';
        }
        
        const formula = factoryDefaultFormulas[formulaStore];
        if (!formula || formula.length === 0 || netWeight <= 0) {
            return {
                costPerUnit: 0,
                totalFormulaCost: 0,
                dynamicCostPerKg: 0,
                formulaStore: formulaStore,
                rawMaterialCost: 0
            };
        }
        
        let totalMaterialCost = 0;
        let totalWeight = 0;
        
        formula.forEach(item => {
            totalMaterialCost += (item.cost * item.quantity);
            totalWeight += item.quantity;
        });
        
        const additionalCost = factoryAdditionalCosts[formulaStore] || 0;
        const costPerUnit = totalMaterialCost + additionalCost;
        
        const dynamicCostPerKg = formulaUnits > 0 ? (costPerUnit * formulaUnits) / netWeight : 0;
        
        return {
            costPerUnit: costPerUnit,
            totalMaterialCost: totalMaterialCost,
            additionalCost: additionalCost,
            totalFormulaCost: costPerUnit * formulaUnits,
            dynamicCostPerKg: dynamicCostPerKg,
            formulaStore: formulaStore,
            rawMaterialCost: totalMaterialCost,
            unitWeight: totalWeight
        };
    }
    
    // NEW: Calculate cost for Sales and Calculator tabs (divided by X)
    function calculateSalesCostPerKg(formulaStore) {
        const formula = factoryDefaultFormulas[formulaStore];
        if (!formula || formula.length === 0) {
            return 0;
        }
        
        let rawMaterialCost = 0;
        formula.forEach(item => {
            rawMaterialCost += (item.cost * item.quantity);
        });
        
        const additionalCost = factoryAdditionalCosts[formulaStore] || 0;
        const totalCostPerUnit = rawMaterialCost + additionalCost;
        
        const adjustmentFactor = factoryCostAdjustmentFactor[formulaStore] || 1;
        const costPerKgForSales = adjustmentFactor > 0 ? totalCostPerUnit / adjustmentFactor : totalCostPerUnit;
        
        return costPerKgForSales;
    }
    
    async function updateFormulaInventory() {
        const tracking = {
            standard: { produced: 0, consumed: 0, available: 0, unitCostHistory: [] },
            asaan: { produced: 0, consumed: 0, available: 0, unitCostHistory: [] }
        };
        
        // Count units produced in factory
        factoryProductionHistory.forEach(entry => {
            if (entry.store && entry.units > 0) {
                tracking[entry.store].produced += entry.units;
                
                if (entry.totalCost && entry.units > 0) {
                    tracking[entry.store].unitCostHistory.push({
                        date: entry.date,
                        costPerUnit: entry.totalCost / entry.units,
                        units: entry.units
                    });
                }
            }
        });
        
        // Count units consumed in production
        db.forEach(entry => {
            let formulaStore = 'standard';
            if (entry.store === 'STORE_C') {
                formulaStore = 'asaan';
            }
            
            if (entry.formulaUnits) {
                tracking[formulaStore].consumed += entry.formulaUnits;
            }
        });
        
        // Calculate available units
        tracking.standard.available = Math.max(0, tracking.standard.produced - tracking.standard.consumed);
        tracking.asaan.available = Math.max(0, tracking.asaan.produced - tracking.asaan.consumed);
        
        // Save to IndexedDB
        factoryUnitTracking = tracking;
        await idb.set('factory_unit_tracking', factoryUnitTracking);
        
        return tracking;
    }
    
    async function syncFactoryProductionStats() {
        const tracking = await updateFormulaInventory();
        
        updateUnitsAvailableIndicator();
        updateFactoryUnitsAvailableStats();
        updateFactorySummaryCard();
        
        return tracking;
    }
    
    function validateFormulaAvailability(storeType, requestedUnits) {
        let formulaStore = 'standard';
        if (storeType === 'STORE_C' || storeType === 'asaan') {
            formulaStore = 'asaan';
        }
        
        const available = factoryUnitTracking[formulaStore]?.available || 0;
        return {
            available: available,
            sufficient: available >= requestedUnits,
            deficit: Math.max(0, requestedUnits - available)
        };
    }
    
    function updateUnitsAvailableIndicator() {
        const store = document.getElementById('storeSelector').value;
        let formulaStore = 'standard';
        if (store === 'STORE_C') {
            formulaStore = 'asaan';
        }
        
        const available = factoryUnitTracking[formulaStore]?.available || 0;
        const indicator = document.getElementById('currentUnitsAvailable');
        const warning = document.getElementById('insufficientUnitsWarning');
        
        let indicatorClass = 'units-available-good';
        if (available < 10) {
            indicatorClass = 'units-available-warning';
        }
        if (available <= 0) {
            indicatorClass = 'units-available-danger';
        }
        
        indicator.className = `units-available-indicator ${indicatorClass}`;
        indicator.textContent = `${available} units available`;
        
        const requestedUnits = parseFloat(document.getElementById('formula-units').value) || 0;
        if (requestedUnits > available) {
            warning.classList.remove('hidden');
        } else {
            warning.classList.add('hidden');
        }
    }
    
    // UPDATED: Calculate dynamic production cost (without X factor)
    function calculateDynamicProductionCost() {
        const net = parseFloat(document.getElementById('net-wt').value) || 0;
        const store = document.getElementById('storeSelector').value;
        const formulaUnits = parseFloat(document.getElementById('formula-units').value) || 0;
        
        const costData = calculateDynamicCost(store, formulaUnits, net);
        
        let formulaStore = 'standard';
        let salePrice = 0;
        
        if (store === 'STORE_C') {
            formulaStore = 'asaan';
            salePrice = factorySalePrices.asaan || 0;
        } else {
            salePrice = factorySalePrices.standard || 0;
        }
        
        document.getElementById('formula-unit-cost-display').innerText = `Rs ${safeValue(costData.costPerUnit).toFixed(2)}/unit`;
        document.getElementById('total-formula-cost-display').innerText = `Rs ${safeValue(costData.totalFormulaCost).toFixed(2)}`;
        document.getElementById('dynamic-cost-per-kg').innerText = `Rs ${safeValue(costData.dynamicCostPerKg).toFixed(2)}/kg`;
        document.getElementById('factory-cost-price').innerText = `Rs ${safeValue(costData.dynamicCostPerKg).toFixed(2)}/kg`;
        
        document.getElementById('production-sale-price-display').innerText = `Rs ${safeValue(salePrice).toFixed(2)}/kg`;
        document.getElementById('profit-sale-price').innerText = `Rs ${safeValue(salePrice).toFixed(2)}/kg`;
        
        const totalCost = net * costData.dynamicCostPerKg;
        document.getElementById('display-cost-value').innerText = `Rs ${safeValue(totalCost).toFixed(2)}`;
        
        const profitPerKg = salePrice - costData.dynamicCostPerKg;
        document.getElementById('profit-per-kg').innerText = `Rs ${safeValue(profitPerKg).toFixed(2)}`;
        
        updateUnitsAvailableIndicator();
    }
    
    // NEW: Update production cost when store changes
    function updateProductionCostOnStoreChange() {
        const store = document.getElementById('storeSelector').value;
        currentStore = store;
        
        let formulaStore = 'standard';
        let salePrice = 0;
        
        if (store === 'STORE_C') {
            formulaStore = 'asaan';
            salePrice = factorySalePrices.asaan || 0;
        } else {
            salePrice = factorySalePrices.standard || 0;
        }
        
        document.getElementById('production-sale-price-display').innerText = `Rs ${safeValue(salePrice).toFixed(2)}/kg`;
        document.getElementById('profit-sale-price').innerText = `Rs ${safeValue(salePrice).toFixed(2)}/kg`;
        
        calculateDynamicProductionCost();
        updatePaymentStatusVisibility(); // NEW: Show/hide payment status toggle
    }
    
    // --- PRODUCTION TAB UPDATES (FIXED) ---
    function calcNet() {
        const g = parseFloat(document.getElementById('gross-wt').value) || 0;
        const c = parseFloat(document.getElementById('cont-wt').value) || 0;
        
        const net = Math.max(0, g - c);
        document.getElementById('net-wt').value = net.toFixed(3);
        
        calculateDynamicProductionCost();
    }

    async function deleteProdEntry(id) {
    const entryToDelete = db.find(item => item.id === id);
    if (!entryToDelete) return;

    // Custom message based on whether it's a Return or Actual Production
    const isReturn = entryToDelete.isReturn === true;
    const confirmMsg = isReturn 
        ? "Remove this Return record? (This will decrease your available stock)" 
        : "Delete this production record permanently? (Inventory will be adjusted)";

    if (confirm(confirmMsg)) {
        // Register deletion for your backup/tombstone system
        if (typeof registerDeletion === 'function') await registerDeletion(id);

        // Remove from database
        db = db.filter(item => item.id !== id);
        await idb.set('mfg_pro_pkr', db);

        // Sync and Refresh
        notifyDataChange('all');
        syncFactoryProductionStats();
        await refreshAllDisplays();

        // Show a specific toast/alert for returns
        if (isReturn) {
            alert("Return record removed. Stock circulation reversed.");
        } else {
            alert("Production record deleted. Inventory adjusted automatically.");
        }
    }
}

    
  // --- UPDATED: Sales Tab Inventory Validation ---
// Replace the entire saveCustomerSale function with this updated version:

async function saveCustomerSale() {
    const date = document.getElementById('cust-date').value;
    const name = document.getElementById('cust-name').value.trim();
    const quantity = parseFloat(document.getElementById('cust-quantity').value) || 0;
    const store = document.querySelector('input[name="supply-store"]:checked').value;
    const paymentType = document.querySelector('input[name="payment-type"]:checked').value;
    const salesRep = document.querySelector('input[name="sales-rep"]:checked').value;
     const phoneInput = document.getElementById('new-cust-phone');
    const phoneNumber = (!document.getElementById('new-customer-phone-container').classList.contains('hidden')) 
                        ? phoneInput.value.trim() 
                        : '';
    // --- INVENTORY VALIDATION LOGIC ---
    if (!date) {
        alert("Please select a date.");
        return;
    }
    
    if (!name) {
        alert("Please enter customer name.");
        return;
    }
    
    if (quantity <= 0) {
        alert("Please enter a valid quantity.");
        return;
    }
    
    // === UPDATED: Calculate available inventory INCLUDING RETURNS ===
    
    // Step 1: Calculate total production for the selected date
    let storeSpecificProduction = 0;
    
    db.forEach(production => {
        if (production.date === date) {
            if (store === 'STORE_A' && production.store === 'STORE_A') {
                storeSpecificProduction += production.net || 0;
            } else if (store === 'STORE_B' && production.store === 'STORE_B') {
                storeSpecificProduction += production.net || 0;
            } else if (store === 'STORE_C' && production.store === 'STORE_C') {
                storeSpecificProduction += production.net || 0;
            }
        }
    });
    
    // Step 2: Calculate total sales already made for this date and store
    let storeSpecificSales = 0;
    
    customerSales.forEach(sale => {
        if (sale.date === date && sale.supplyStore === store) {
            storeSpecificSales += sale.quantity || 0;
        }
    });
    
    // === NEW: Step 3: Add returns to available inventory ===
    let storeReturns = 0;
    
    stockReturns.forEach(returnEntry => {
        if (returnEntry.date === date && returnEntry.store === store) {
            storeReturns += returnEntry.quantity || 0;
        }
    });
    
    // Step 4: Calculate TOTAL available inventory (Production + Returns - Sales)
    const totalAvailableInventory = storeSpecificProduction + storeReturns;
    const storeAvailableInventory = totalAvailableInventory - storeSpecificSales;
    
    // Step 5: Validate inventory availability
    
    // Check 1: Overall production validation
    if (totalAvailableInventory === 0) {
        alert(` Inventory Validation Failed!\n\nNo production recorded for ${date}.\nYou cannot sell what has not been produced.\n\nPlease check production records.`);
        return;
    }
    
    // Check 2: Store-specific inventory validation
    if (storeSpecificProduction === 0 && storeReturns === 0) {
        alert(` Store Inventory Validation Failed!\n\nNo production or returns for ${getStoreLabel(store)} store on ${date}.\n\nAvailable stores with production:\n${getAvailableStoresForDate(date)}`);
        return;
    }
    
    // Check 3: Prevent negative inventory (store-specific)
    const remainingAfterSale = storeAvailableInventory - quantity;
    if (remainingAfterSale < 0) {
        alert(` Insufficient Stock!\n\nSelected date: ${date}\nStore: ${getStoreLabel(store)}\n\n Production: ${storeSpecificProduction.toFixed(3)} kg\n Returns: ${storeReturns.toFixed(3)} kg\n\n Total Available: ${totalAvailableInventory.toFixed(3)} kg\n Already Sold: ${storeSpecificSales.toFixed(3)} kg\n\n Current Stock: ${storeAvailableInventory.toFixed(3)} kg\n Sale Quantity: ${quantity.toFixed(3)} kg\n Shortage: ${Math.abs(remainingAfterSale).toFixed(3)} kg\n\nPlease reduce sale quantity or check production records.`);
        return;
    }
    
    // --- INVENTORY VALIDATION PASSED - Proceed with sale ---
    
    // Calculate sale values
    const costData = calculateSalesCost(store, quantity);
    const totalCost = costData.totalCost;
    const totalValue = costData.totalValue;
    const profit = totalValue - totalCost;
    
    // Check if customer already exists
    const existingCustomer = customerSales.find(s => s.customerName.toLowerCase() === name.toLowerCase());
    let existingCredit = 0;
    
    if (existingCustomer) {
        customerSales.forEach(sale => {
            if (sale.customerName.toLowerCase() === name.toLowerCase() && 
                sale.paymentType === 'CREDIT' && 
                !sale.creditReceived) {
                existingCredit += sale.totalValue;
            }
        });
    }
    
    // For credit sales, check if customer already has outstanding credit
    if (paymentType === 'CREDIT') {
        const creditWarningThreshold = 5000;
        if (existingCredit > creditWarningThreshold) {
            if (!confirm(` Credit Sale Warning!\n\nCustomer "${name}" already has outstanding credit: Rs ${existingCredit.toFixed(2)}\n\nNew credit: Rs ${totalValue.toFixed(2)}\nTotal will be: Rs ${(existingCredit + totalValue).toFixed(2)}\n\nProceed with sale?`)) {
                return;
            }
        }
    }
    
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${ampm}`;
    
    // --- CREATE RECORD ---
    const saleRecord = {
        id: generateUUID('sale'),
        timestamp: Date.now(),
        date: date,
        time: timeString,
        customerName: name,
        customerPhone: phoneNumber, // Save Phone Number
        quantity: quantity,
        supplyStore: store,
        paymentType: paymentType,
        salesRep: salesRep,
        totalCost: totalCost,
        totalValue: totalValue,
        profit: profit,
        creditReceived: paymentType === 'CASH' ? true : false,
        timestamp: new Date(date).getTime(),
        // --- ISOLATION FLAG ---
        isRepModeEntry: false // Tag as Admin Mode
        
    };
    

    customerSales.push(saleRecord);
    await idb.set('customer_sales', customerSales);
    
    // Realtime Broadcast
    emitSyncUpdate({ customer_sales: customerSales });
    
    // Clear form
    document.getElementById('cust-name').value = '';
    document.getElementById('cust-quantity').value = '';
    document.getElementById('payment-cash').checked = true;
    document.getElementById('supply-store-a').checked = true;
    
        // Hide phone input
    if(phoneInput) phoneInput.value = '';
    document.getElementById('new-customer-phone-container').classList.add('hidden');
    // Update UI
    refreshCustomerSales();
    refreshEntityList();
    
    alert(` Sale recorded successfully!\n\nDate: ${date}\nCustomer: ${name}\nQuantity: ${quantity.toFixed(3)} kg\nStore: ${getStoreLabel(store)}\nTotal Value: Rs ${totalValue.toFixed(2)}\nPayment: ${paymentType}\n\n Inventory Status:\n\n Production: ${storeSpecificProduction.toFixed(3)} kg\n Returns: ${storeReturns.toFixed(3)} kg\n Total Available: ${totalAvailableInventory.toFixed(3)} kg\n Previous Sales: ${storeSpecificSales.toFixed(3)} kg\n Remaining Stock: ${remainingAfterSale.toFixed(3)} kg`);
}

// Helper function to get store label
function getStoreLabel(storeCode) {
    switch(storeCode) {
        case 'STORE_A': return 'ZUBAIR';
        case 'STORE_B': return 'MAHMOOD';
        case 'STORE_C': return 'ASAAN';
        default: return storeCode;
    }
}

// Helper function to get available stores for a date
function getAvailableStoresForDate(date) {
    const stores = new Set();
    
    db.forEach(production => {
        if (production.date === date && production.net > 0) {
            stores.add(getStoreLabel(production.store));
        }
    });
    
    return Array.from(stores).join(', ') || 'None';
}

// Helper function to calculate sales cost
function calculateSalesCost(store, quantity) {
    let costPerKg = 0;
    let salePricePerKg = 0;
    
    // Determine cost based on store
    if (store === 'STORE_C') {
        // Asaan store - use Asaan formula
        const formulaCost = getCostPerUnit('asaan');
        const adjustmentFactor = factoryCostAdjustmentFactor.asaan || 1;
        costPerKg = adjustmentFactor > 0 ? formulaCost / adjustmentFactor : formulaCost;
        salePricePerKg = factorySalePrices.asaan || 0;
    } else {
        // Standard store (Zubair/Mahmood) - use Standard formula
        const formulaCost = getCostPerUnit('standard');
        const adjustmentFactor = factoryCostAdjustmentFactor.standard || 1;
        costPerKg = adjustmentFactor > 0 ? formulaCost / adjustmentFactor : formulaCost;
        salePricePerKg = factorySalePrices.standard || 0;
    }
    
    const totalCost = quantity * costPerKg;
    const totalValue = quantity * salePricePerKg;
    
    return {
        costPerKg: costPerKg,
        salePricePerKg: salePricePerKg,
        totalCost: totalCost,
        totalValue: totalValue
    };
}

// Helper function to get cost per unit (already defined elsewhere, but included for completeness)
function getCostPerUnit(storeType) {
    const formula = factoryDefaultFormulas[storeType];
    if (!formula || formula.length === 0) return 0;
    
    let totalMaterialCost = 0;
    formula.forEach(item => {
        totalMaterialCost += (item.cost * item.quantity);
    });
    
    const additionalCost = factoryAdditionalCosts[storeType] || 0;
    return totalMaterialCost + additionalCost;
}

// Also update the calculateCustomerSale() function to show inventory status
function calculateCustomerSale() {
    const quantity = parseFloat(document.getElementById('cust-quantity').value) || 0;
    const date = document.getElementById('cust-date').value;
    const store = document.querySelector('input[name="supply-store"]:checked').value;
    
    // Calculate sale values first
    const costData = calculateSalesCost(store, quantity);
    
    // Update UI with calculated values
    document.getElementById('cust-total-cost').textContent = costData.totalCost.toFixed(2);
    document.getElementById('cust-total-value').textContent = costData.totalValue.toFixed(2);
    document.getElementById('cust-profit').textContent = (costData.totalValue - costData.totalCost).toFixed(2);
    
    // === UPDATED: Show inventory status INCLUDING RETURNS ===
    if (date) {
        // Calculate production
        let storeProduction = 0;
        db.forEach(production => {
            if (production.date === date && production.store === store) {
                storeProduction += production.net || 0;
            }
        });
        
        // === NEW: Calculate returns ===
        let storeReturns = 0;
        stockReturns.forEach(returnEntry => {
            if (returnEntry.date === date && returnEntry.store === store) {
                storeReturns += returnEntry.quantity || 0;
            }
        });
        
        // Calculate sales
        let storeSales = 0;
        customerSales.forEach(sale => {
            if (sale.date === date && sale.supplyStore === store) {
                storeSales += sale.quantity || 0;
            }
        });
        
        // Total available = Production + Returns
        const totalAvailable = storeProduction + storeReturns;
        const availableInventory = totalAvailable - storeSales;
        
        // Show warning if inventory is low
        const inventoryWarning = document.getElementById('inventory-warning') || createInventoryWarningElement();
        
        if (quantity > availableInventory) {
            inventoryWarning.innerHTML = ` Warning: Only ${availableInventory.toFixed(3)} kg available.<br><small>Production: ${storeProduction.toFixed(2)} kg + Returns: ${storeReturns.toFixed(2)} kg = ${totalAvailable.toFixed(2)} kg total</small>`;
            inventoryWarning.style.display = 'block';
            inventoryWarning.style.color = 'var(--danger)';
            inventoryWarning.style.background = 'rgba(220, 38, 38, 0.1)';
        } else if (availableInventory < (quantity * 1.5)) {
            inventoryWarning.innerHTML = ` Inventory: ${availableInventory.toFixed(3)} kg available (${(availableInventory - quantity).toFixed(3)} kg remaining)<br><small>Production: ${storeProduction.toFixed(2)} kg + Returns: ${storeReturns.toFixed(2)} kg</small>`;
            inventoryWarning.style.display = 'block';
            inventoryWarning.style.color = 'var(--warning)';
            inventoryWarning.style.background = 'rgba(245, 158, 11, 0.1)';
        } else {
            inventoryWarning.innerHTML = ` Inventory: ${availableInventory.toFixed(3)} kg available<br><small>Production: ${storeProduction.toFixed(2)} kg + Returns: ${storeReturns.toFixed(2)} kg = ${totalAvailable.toFixed(2)} kg total</small>`;
            inventoryWarning.style.display = 'block';
            inventoryWarning.style.color = 'var(--accent-emerald)';
            inventoryWarning.style.background = 'rgba(5, 150, 105, 0.1)';
        }
    }
}
// --- AUTO-FILL CUSTOMER NAME FUNCTION ---
function autoFillCustomerName() {
    const repRadio = document.querySelector('input[name="sales-rep"]:checked');
    const nameInput = document.getElementById('cust-name');
    
    // Get Payment Radio Buttons
    const cashRadio = document.getElementById('payment-cash');
    const creditRadio = document.getElementById('payment-credit');

    if (repRadio) {
        if (repRadio.value === 'NONE') {
            // Direct Sale Logic
            nameInput.value = '';
            nameInput.placeholder = "Enter Customer Name";
            nameInput.readOnly = false;
            
            // Re-enable Cash option and default to it
            if (cashRadio) {
                cashRadio.disabled = false;
                cashRadio.checked = true;
            }
        } else {
            // Representative Logic (Noran or Noman)
            nameInput.value = repRadio.value;
            nameInput.readOnly = true;
            
            // FORCE CREDIT SELECTION
            if (creditRadio) {
                creditRadio.checked = true;
            }
            
            // Disable Cash option so user cannot accidentally change it
            if (cashRadio) {
                cashRadio.disabled = true;
            }
        }
    }
    
    // Update customer info display
    if (nameInput.value) {
        calculateCustomerStatsForDisplay(nameInput.value);
    } else {
        const infoDisplay = document.getElementById('customer-info-display');
        if (infoDisplay) {
            infoDisplay.classList.add('hidden');
        }
    }
}
// Helper function to create inventory warning element
function createInventoryWarningElement() {
    const warningDiv = document.createElement('div');
    warningDiv.id = 'inventory-warning';
    warningDiv.style.fontSize = '0.8rem';
    warningDiv.style.marginTop = '8px';
    warningDiv.style.padding = '6px';
    warningDiv.style.borderRadius = '6px';
    warningDiv.style.display = 'none';
    
    const salesSection = document.querySelector('#tab-sales .section.liquid-card');
    const calculateButton = salesSection.querySelector('.btn-main');
    salesSection.insertBefore(warningDiv, calculateButton);
    
    return warningDiv;
}


// --- REPLACE YOUR EXISTING deleteCustomerSale FUNCTION WITH THIS ---
async function deleteCustomerSale(id) {
    if(confirm("Delete this sale transaction permanently?")) {
     await registerDeletion(id);
        customerSales = customerSales.filter(item => item.id !== id);
        await idb.set('customer_sales', customerSales);
        
        refreshCustomerSales(); 
        calculateNetCash();     
        calculateCashTracker(); 
        renderCustomersTable();
        
        // --- NEW: LINKAGE UPDATE ---
        // Forces Production inventory to "Add Back" the deleted sales quantity
        updateAllStoresOverview(currentOverviewMode);
        
        alert("Transaction deleted! Inventory adjusted automatically.");
    }
}



    // --- CALCULATOR TAB UPDATES (USING DIVIDED BY X LOGIC) ---
    function calculateSales() {
    const seller = document.getElementById('sellerSelect').value;
    
    const costPerKg = calculateSalesCostPerKg('standard');
    const salePrice = factorySalePrices.standard || 0;

    const sold = parseFloat(document.getElementById('totalSold').value) || 0;
    const ret = parseFloat(document.getElementById('returnedQuantity').value) || 0;
    const cred = parseFloat(document.getElementById('creditSales').value) || 0;
    const prev = parseFloat(document.getElementById('prevCreditReceived').value) || 0;
    const rec = parseFloat(document.getElementById('receivedCash').value) || 0;

    const netSold = Math.max(0, sold - ret);
    const cashQty = Math.max(0, netSold - cred);
    const expected = (cashQty * salePrice) + prev;
    
    document.getElementById('totalExpectedCash').textContent = safeValue(expected).toFixed(2);

    const diff = rec - expected;
    const box = document.getElementById('discrepancyBox');
    
    if(Math.abs(diff) < 0.01) {
        box.className = 'result-box discrepancy-ok';
        document.getElementById('discrepancyStatus').innerText = "PERFECT MATCH ";
    } else if(diff < -0.01) { 
        box.className = 'result-box discrepancy-alert';
        document.getElementById('discrepancyStatus').innerText = `SHORT: Rs ${Math.abs(diff).toFixed(2)}`;
    } else {
        box.className = 'result-box discrepancy-ok';
        document.getElementById('discrepancyStatus').innerText = `OVER: Rs ${diff.toFixed(2)}`;
    }
}
    
// --- ENHANCED RETURN HANDLING SYSTEM ---

// 1. Initialize return storage
let stockReturns = [];
// ============================================
// SUPABASE CLOUD SYNC & SIGNAL SYSTEM
// ============================================

const SUPABASE_URL = 'https://znxhlwbmoqwoijkhglcb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpueGhsd2Jtb3F3b2lqa2hnbGNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4OTA1MjIsImV4cCI6MjA4NDQ2NjUyMn0.4RuwqqM-uxGRzpCxtgHx572OdFICfZjMXYFOHRU3lrI';

// --- GLOBAL VARIABLES (Declared ONCE) ---
let supabaseClient = null;
let currentUser = null;
let isSyncing = false;
    let realtimeChannel = null;
    let socketReconnectTimer = null;
    let pendingSocketUpdate = false;
    let socketDebounceTimer = null;
    let dbWakeUpAttempted = false;
    let heartbeatInterval = null;
    let autoSaveTimer = null;
    let broadcastQueue = [];

    // --- SIGNAL INDICATOR UPDATE ---
    function updateSignal(status) {
        const dot = document.getElementById('connection-indicator');
        if (!dot) return;

        dot.className = ''; // Reset
        if (status === 'online') {
            dot.classList.add('signal-online');
            dot.title = "Live Connection Active";
        } else if (status === 'connecting') {
            dot.classList.add('signal-connecting');
            dot.title = "Connecting...";
        } else {
            dot.classList.add('signal-offline');
            dot.title = "Offline / Socket Disconnected";
        }
    }

    // --- ROBUST REALTIME SUBSCRIPTION ---
    function updateSignalUI(status) {
        const dot = document.getElementById('connection-indicator');
        if (!dot) return;
        
        dot.className = ''; // Clear classes
        if (status === 'online') {
            dot.classList.add('sig-online');
        } else if (status === 'connecting') {
            dot.classList.add('sig-connecting');
        } else {
            // Red is the default
        }
    }

    // --- LIVE PULSE INDICATOR ---
    function flashLivePulse() {
        const dot = document.getElementById('connection-indicator');
        if (!dot) return;
        dot.style.transform = 'scale(1.8)';
        dot.style.boxShadow = '0 0 20px #10b981';
        setTimeout(() => {
            dot.style.transform = '';
            dot.style.boxShadow = '';
        }, 300);
    }

    // --- BROADCAST EMITTER ---
    async function emitSyncUpdate(payload) {
        if (!realtimeChannel || realtimeChannel.state !== 'joined') {
            console.log(" Channel not ready, queuing broadcast...");
            broadcastQueue.push(payload);
            return;
        }

        flashLivePulse();
        const { error } = await realtimeChannel.send({
            type: 'broadcast',
            event: 'sync_update',
            payload: {
                ...payload,
                senderId: currentUser.id,
                timestamp: Date.now()
            }
        });

        if (error) {
            console.error(" Broadcast Error:", error);
            broadcastQueue.push(payload);
        }
    }

    // --- PROCESS QUEUED BROADCASTS ---
    function processBroadcastQueue() {
        if (broadcastQueue.length > 0 && realtimeChannel && realtimeChannel.state === 'joined') {
            console.log(` Sending ${broadcastQueue.length} queued broadcasts...`);
            while (broadcastQueue.length > 0) {
                const payload = broadcastQueue.shift();
                emitSyncUpdate(payload);
            }
        }
    }

    async function subscribeToRealtime() {
        if (!supabaseClient || !currentUser) return;

        updateSignalUI('connecting');

        if (realtimeChannel) {
            await supabaseClient.removeChannel(realtimeChannel);
        }

        realtimeChannel = supabaseClient
            .channel(`sync:${currentUser.id}`)
            .on(
                'postgres_changes',
                {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'user_data',
                    filter: `user_id=eq.${currentUser.id}`
                },
                async (payload) => {
                    const cloudTime = new Date(payload.new.last_synced).getTime();
                    const localTimeStr = await idb.get('last_synced');
                    const localTime = localTimeStr ? new Date(localTimeStr).getTime() : 0;

                    if (cloudTime > (localTime + 1000)) {
                        if (socketDebounceTimer) clearTimeout(socketDebounceTimer);
                        socketDebounceTimer = setTimeout(() => {
                            pullDataFromCloud(true);
                        }, 1000);
                    }
                }
            )
            .on(
                'broadcast',
                { event: 'sync_update' },
                async ({ payload }) => {
                    console.log(" Realtime Packet Received:", payload);
                    flashLivePulse();
                    
                    // 1. Inject into local variables with conflict handling
                    if (payload.mfg_pro_pkr) db = resolveDataConflicts(db, payload.mfg_pro_pkr, deletedRecordIds);
                    if (payload.customer_sales) customerSales = resolveDataConflicts(customerSales, payload.customer_sales, deletedRecordIds);
                    if (payload.payment_transactions) paymentTransactions = resolveDataConflicts(paymentTransactions, payload.payment_transactions, deletedRecordIds);
                    if (payload.stock_returns) stockReturns = resolveDataConflicts(stockReturns, payload.stock_returns, deletedRecordIds);
                    if (payload.rep_sales) repSales = resolveDataConflicts(repSales, payload.rep_sales, deletedRecordIds);
                    
                    // 2. Save to IndexedDB
                    await Promise.all([
                        idb.set('mfg_pro_pkr', db),
                        idb.set('customer_sales', customerSales),
                        idb.set('payment_transactions', paymentTransactions),
                        idb.set('stock_returns', stockReturns),
                        idb.set('rep_sales', repSales)
                    ]);

                    // 3. Instant UI Refresh
                    refreshAllDisplays();
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    updateSignalUI('online');
                    console.log("Socket: Connected");
                    processBroadcastQueue();
                } else {
                    updateSignalUI('offline');
                    console.log("Socket: Disconnected/Error");
                }
            });
    }


// --- HELPER: PULL EXECUTION ---
async function executeSmartPull() {
    await pullDataFromCloud(true);
    if (pendingSocketUpdate) {
        pendingSocketUpdate = false;
        setTimeout(executeSmartPull, 1000);
    } else {
        showToast('Data synced via Live Socket', 'success');
    }
}

// --- HELPER: RECONNECT LOGIC ---
function scheduleSocketReconnect() {
    if (socketReconnectTimer) clearTimeout(socketReconnectTimer);
    socketReconnectTimer = setTimeout(() => {
        console.log(' Reconnecting...');
        subscribeToRealtime();
    }, 5000);
}

// --- INITIALIZATION ---
function initSupabase() {
    if (typeof window.supabase === 'undefined') return;
    try {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                currentUser = session?.user;
                hideAuthOverlay();
                if (event === 'SIGNED_IN') {
                    startDatabaseHeartbeat();
                    await wakeUpDatabaseAndSync();
                    await subscribeToRealtime();
                }
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                if (realtimeChannel) await supabaseClient.removeChannel(realtimeChannel);
                realtimeChannel = null;
                updateSignal('offline');
            }
        });
        
        checkAuthState();

        // Network Status Listeners
        window.addEventListener('online', () => {
            console.log(' Online detected');
            if (currentUser) subscribeToRealtime();
        });
        window.addEventListener('offline', () => {
            console.log(' Offline detected');
            updateSignal('offline');
        });
        
        // Tab Visibility Listener
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && currentUser) {
                const state = realtimeChannel?.state;
                if (state !== 'joined') await subscribeToRealtime();
            }
        });

    } catch (e) {
        console.error('Supabase Init Error:', e);
    }
}



// ============================================
// ROBUST SMART MERGE (WITH DELETION PROTECTION)
// ============================================
function mergeDatasets(localArray, cloudArray) {
    if (!Array.isArray(localArray)) localArray = [];
    if (!Array.isArray(cloudArray)) cloudArray = [];

    const mergedMap = new Map();

    // 1. Process CLOUD data first
    cloudArray.forEach(item => {
        if (item && item.id) {
            // CRITICAL CHECK: Has this ID been deleted locally?
            if (deletedRecordIds.has(item.id)) {
                console.log(`[RESTORE BLOCKED] Item ${item.id} was deleted locally. Ignoring cloud copy.`);
                return; // Skip this item
            }
            mergedMap.set(item.id, item);
        }
    });

    // 2. Process LOCAL data (Local edits override cloud)
    localArray.forEach(localItem => {
        if (!localItem || !localItem.id) return;
        
        // Note: We don't need to check deletedRecordIds for localArray 
        // because if it's in localArray, it hasn't been deleted yet.
        
        const cloudItem = mergedMap.get(localItem.id);

        // CASE A: NEW RECORD
        // If it exists locally but not in cloud, it's a new entry. Save it.
        if (!cloudItem) {
            mergedMap.set(localItem.id, localItem);
            return;
        }

        // CASE B: CONFLICT RESOLUTION (Existing Record)
        // We compare the quality of Local vs Cloud to decide who wins.

        // --- PROTECTION 1: DATA CORRUPTION RECOVERY (Calculator Tab) ---
        // If Local has valid numbers but Cloud has corrupted/null values, Local overrides.
        // This prevents a syncing error from wiping out your calculated math.
        const isFinancialRecord = (localItem.totalSold !== undefined || localItem.revenue !== undefined);
        if (isFinancialRecord) {
            const localHasData = (localItem.totalSold > 0 || localItem.revenue > 0);
            const cloudIsCorrupt = (cloudItem.totalSold === undefined || cloudItem.totalSold === null || cloudItem.revenue === null);
            
            if (localHasData && cloudIsCorrupt) {
                console.log(`[MERGE PROTECTION] Restoring corrupted financial record: ${localItem.id}`);
                mergedMap.set(localItem.id, localItem);
                return;
            }
        }

        // --- PROTECTION 2: REP MODE INTEGRITY (Sales Tab) ---
        // If Local knows this is a "Rep Mode" entry but Cloud missed the flag, Local wins.
        // This stops Admin data from accidentally overwriting Rep restrictions.
        if (localItem.isRepModeEntry === true && !cloudItem.isRepModeEntry) {
            mergedMap.set(localItem.id, localItem);
            return;
        }

        // --- PROTECTION 3: PRODUCTION LOGIC (Returns & Formulas) ---
        // If Local marks this as a "Return" or has "Formula Units" linked, but Cloud doesn't, Local wins.
        // This ensures inventory calculations don't break.
        if (localItem.isReturn === true && !cloudItem.isReturn) {
            mergedMap.set(localItem.id, localItem);
            return;
        }
        if ((localItem.formulaUnits > 0 && !cloudItem.formulaUnits) || 
            (localItem.formulaCost > 0 && !cloudItem.formulaCost)) {
            mergedMap.set(localItem.id, localItem);
            return;
        }

        // --- PROTECTION 4: FACTORY SUPPLIER LINKS (Factory Tab) ---
        // If Local has a specific Supplier ID linked to a material, preserve it.
        if (localItem.supplierId && !cloudItem.supplierId) {
            mergedMap.set(localItem.id, localItem);
            return;
        }

        // --- PROTECTION 5: PAYMENT STATUS (Payments Tab) ---
        // If Local says a transaction is "Paid" (or has a specific type) that differs from cloud defaults.
        if (localItem.paymentStatus === 'paid' && cloudItem.paymentStatus !== 'paid') {
            mergedMap.set(localItem.id, localItem);
            return;
        }

        // --- STANDARD CHECK: TIME AUTHORITY ---
        // If no specific data integrity issues are found, we trust the most recent edit.
        // We normalize dates to timestamps to ensure accurate comparison.
        const localTime = localItem.timestamp || new Date(localItem.date).getTime() || 0;
        const cloudTime = cloudItem.timestamp || new Date(cloudItem.date).getTime() || 0;

        // If Local is newer (or equal), update the Cloud version.
        if (localTime >= cloudTime) {
            mergedMap.set(localItem.id, localItem);
        }
    });

    // Return the clean, merged list
    return Array.from(mergedMap.values());
}
// ============================================
//  ONE-CLICK SMART SYNC (Silent Capable)
// ============================================

// ============================================
//  SMART SYNC: NEWEST WINS (Time-based Validation)
// ============================================

// 1. Helper: The Decision Engine
// Compares two arrays and returns a single array where the newest version of every item wins.
function resolveDataConflicts(localArray, cloudArray, deletedIdsSet) {
    if (!Array.isArray(localArray)) localArray = [];
    if (!Array.isArray(cloudArray)) cloudArray = [];

    const masterMap = new Map();

    // STEP A: Load CLOUD data first
    cloudArray.forEach(item => {
        // If this item was deleted locally, do not load it
        if (item.id && !deletedIdsSet.has(item.id)) {
            masterMap.set(item.id, item);
        }
    });

    // STEP B: Overlay LOCAL data
    localArray.forEach(localItem => {
        // If this item was deleted (tombstoned), skip it
        if (!localItem.id || deletedIdsSet.has(localItem.id)) return;

        const cloudItem = masterMap.get(localItem.id);

        if (!cloudItem) {
            // CASE 1: Exists locally but not in cloud -> It's a new entry. ADD IT.
            masterMap.set(localItem.id, localItem);
        } else {
            // CASE 2: Exists in both -> COMPARE TIMESTAMPS
            const localTime = localItem.timestamp || new Date(localItem.date).getTime() || 0;
            const cloudTime = cloudItem.timestamp || new Date(cloudItem.date).getTime() || 0;

            if (localTime >= cloudTime) {
                // Local is newer (or equal). Local OVERWRITES Cloud.
                masterMap.set(localItem.id, localItem);
                console.log(`[SYNC] Local update won for ID: ${localItem.id}`);
            } else {
                // Cloud is newer. Keep Cloud version.
                // (This happens if another device made an edit recently)
                console.log(`[SYNC] Cloud update won for ID: ${localItem.id}`);
                // No action needed, cloudItem is already in the map
            }
        }
    });

    return Array.from(masterMap.values());
}

// 2. Main Sync Execution Function
async function performOneClickSync(silent = false) {
    if (!supabaseClient || !currentUser) {
        if (!silent) {
            showToast("Please sign in to Sync.", "warning");
            showAuthOverlay();
        }
        return;
    }

    if (isSyncing) return;
    isSyncing = true;

    const btn = document.getElementById('sync-btn');
    const originalText = btn ? btn.innerHTML : '';

    try {
        if (!silent) {
            if (btn) {
                btn.innerHTML = 'Syncing...';
                btn.disabled = true;
            }
            showToast(" Comparing Local vs Cloud Data...", "info");
        }

        // --- 1. FETCH CLOUD DATA ---
        const { data, error } = await supabaseClient
            .from('user_data')
            .select('data, last_synced')
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (error && error.code !== 'PGRST116') throw error;

        let cloudData = data?.data || {};

        // --- 2. MERGE DELETED RECORDS (Graveyard) ---
        // We merge deletion logs so we don't accidentally restore deleted items
        const cloudDeleted = new Set(cloudData.deleted_records || []);
        const localDeleted = new Set(deletedRecordIds);
        const mergedDeletedIds = new Set([...localDeleted, ...cloudDeleted]);
        deletedRecordIds = mergedDeletedIds; // Update global set

        // --- 3. EXECUTE "NEWEST WINS" LOGIC FOR ALL TABLES ---
        // This ensures if Local has a newer timestamp, it effectively writes to the cloud
        
        db = resolveDataConflicts(db, cloudData.mfg_pro_pkr, deletedRecordIds);
        customerSales = resolveDataConflicts(customerSales, cloudData.customer_sales, deletedRecordIds);
        repSales = resolveDataConflicts(repSales, cloudData.rep_sales, deletedRecordIds);
        salesHistory = resolveDataConflicts(salesHistory, cloudData.noman_history, deletedRecordIds);
        factoryInventoryData = resolveDataConflicts(factoryInventoryData, cloudData.factory_inventory_data, deletedRecordIds);
        factoryProductionHistory = resolveDataConflicts(factoryProductionHistory, cloudData.factory_production_history, deletedRecordIds);
        paymentEntities = resolveDataConflicts(paymentEntities, cloudData.payment_entities, deletedRecordIds);
        paymentTransactions = resolveDataConflicts(paymentTransactions, cloudData.payment_transactions, deletedRecordIds);
        stockReturns = resolveDataConflicts(stockReturns, cloudData.stock_returns, deletedRecordIds);

        // Settings (Prefer Local settings if changed recently, otherwise fallback)
        // For settings, we usually just push local if it exists, or take cloud if local is empty
        const finalSettings = {
            factory_default_formulas: factoryDefaultFormulas,
            factory_additional_costs: factoryAdditionalCosts,
            factory_cost_adjustment_factor: factoryCostAdjustmentFactor,
            factory_sale_prices: factorySalePrices,
            factory_unit_tracking: factoryUnitTracking,
            naswar_default_settings: defaultSettings
        };

        // --- 4. SAVE MERGED DATA TO LOCAL STORAGE (IDB) ---
        await Promise.all([
            idb.set('mfg_pro_pkr', db),
            idb.set('customer_sales', customerSales),
            idb.set('rep_sales', repSales),
            idb.set('noman_history', salesHistory),
            idb.set('factory_inventory_data', factoryInventoryData),
            idb.set('factory_production_history', factoryProductionHistory),
            idb.set('payment_entities', paymentEntities),
            idb.set('payment_transactions', paymentTransactions),
            idb.set('stock_returns', stockReturns),
            idb.set('deleted_records', Array.from(deletedRecordIds)), // Save combined deletions
            // Save Settings
            idb.set('factory_default_formulas', factoryDefaultFormulas),
            idb.set('factory_additional_costs', factoryAdditionalCosts),
            idb.set('factory_cost_adjustment_factor', factoryCostAdjustmentFactor),
            idb.set('factory_sale_prices', factorySalePrices)
        ]);

        // --- 5. WRITE TO CLOUD (This fulfills "Cloud written by Local") ---
        // We push the resolved, merged lists back to the cloud.
        if (!silent) showToast(" Updating Cloud Database...", "info");

        const now = new Date().toISOString();
        const finalPayload = {
            mfg_pro_pkr: db,
            customer_sales: customerSales,
            rep_sales: repSales,
            noman_history: salesHistory,
            factory_inventory_data: factoryInventoryData,
            factory_production_history: factoryProductionHistory,
            payment_entities: paymentEntities,
            payment_transactions: paymentTransactions,
            stock_returns: stockReturns,
            deleted_records: Array.from(deletedRecordIds),
            ...finalSettings,
            appMode: appMode,
            repProfile: currentRepProfile,
            adminPin: adminPin
        };

        const { error: uploadError } = await supabaseClient
            .from('user_data')
            .upsert({ 
                user_id: currentUser.id, 
                data: finalPayload,
                last_synced: now 
            }, { onConflict: 'user_id' });

        if (uploadError) throw uploadError;

        await idb.set('last_synced', now);

        // --- 6. REFRESH UI ---
        await refreshAllDisplays();
        
        const display = document.getElementById('lastSyncDisplay');
        if (display) display.textContent = `Last Sync: ${new Date().toLocaleTimeString()}`;

        if (!silent) {
            showToast("Sync Complete! Cloud Updated.", "success");
            if(typeof closeDataMenu === 'function') closeDataMenu();
        }

    } catch (e) {
        console.error("Sync Error:", e);
        if (!silent) showToast("Sync Failed: " + e.message, "error");
    } finally {
        isSyncing = false;
        if (!silent && btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
}

// ============================================
// SIMPLIFIED BACKUP & RESTORE (NO MERGE)
// ============================================

// --- PUSH TO CLOUD (BACKUP) - DIRECT UPLOAD ---
// This takes your LOCAL data and overwrites the CLOUD data.
async function pushDataToCloud(silent = false) {
    if (!supabaseClient) return;
    if (isSyncing) return; 
    isSyncing = true;

    let btn = null;
    let originalText = '';

    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
    
    if (sessionError || !session) {
        if (!silent) {
            showToast('Session expired. Please sign in again.', 'warning');
            showAuthOverlay();
        }
        isSyncing = false;
        return; 
    }

    currentUser = session.user;

    try {
        if (!silent) {
            const menuBtn = document.querySelector('#dataMenuOverlay .btn-main');
            if (menuBtn) {
                btn = menuBtn;
                originalText = btn.innerText;
                btn.textContent = ' Uploading...';
                btn.disabled = true;
            } else {
                showToast(' Backing up to Cloud...', 'info');
            }
        }

        // STEP 1: PREPARE DATA PACKAGE
        // We take exactly what is currently in memory/storage
        const finalData = {
            mfg_pro_pkr: db,
            customer_sales: customerSales,
            rep_sales: repSales,
            noman_history: salesHistory,
            factory_inventory_data: factoryInventoryData,
            factory_production_history: factoryProductionHistory,
            payment_entities: paymentEntities,
            payment_transactions: paymentTransactions,
            stock_returns: stockReturns,
            
            // Settings
            factory_default_formulas: factoryDefaultFormulas,
            factory_additional_costs: factoryAdditionalCosts,
            factory_cost_adjustment_factor: factoryCostAdjustmentFactor,
            factory_sale_prices: factorySalePrices,
            factory_unit_tracking: factoryUnitTracking,
            naswar_default_settings: defaultSettings,
            
            // App State
            deleted_records: Array.from(deletedRecordIds),
            appMode: appMode,
            repProfile: currentRepProfile,
            adminPin: adminPin
        };

        // STEP 2: DIRECT UPLOAD
        const now = new Date().toISOString();
        
        // Save local timestamp first
        await idb.set('last_synced', now); 

        const { error } = await supabaseClient
            .from('user_data')
            .upsert({ 
                user_id: currentUser.id, 
                data: finalData,
                last_synced: now 
            }, { onConflict: 'user_id' });

        if (error) throw error;
        
        if (!silent) {
            showToast('Cloud Backup Complete', 'success');
            const display = document.getElementById('lastSyncDisplay');
            if (display) display.textContent = `Last Cloud Sync: ${new Date().toLocaleString()}`;
        }
        console.log(` Data Uploaded at ${new Date().toLocaleTimeString()}`);

    } catch (error) {
        console.error('Backup Error:', error);
        if (!silent) showToast(`Backup failed: ${error.message}`, 'error');
    } finally {
        isSyncing = false;
        if (btn) {
            btn.innerText = originalText || 'Backup to Cloud';
            btn.disabled = false;
        }
    }
}

// --- PULL FROM CLOUD (RESTORE) - DIRECT DOWNLOAD ---
// This takes CLOUD data and overwrites your LOCAL data.
async function pullDataFromCloud(silent = false) {
    if (!currentUser || !supabaseClient) return;

    if (isSyncing) {
        if (!silent) showToast('Sync in progress...', 'info');
        return;
    }
    isSyncing = true;

    try {
        if (!silent) showToast(' Downloading cloud data...', 'info');

        const { data, error } = await supabaseClient
            .from('user_data')
            .select('data, last_synced')
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (error && error.code !== 'PGRST116') throw error;

        if (!data || !data.data) {
            if (!silent) showToast('Cloud is empty. Nothing to restore.', 'info');
            isSyncing = false;
            return;
        }

        const cloud = data.data;

        // 1. UPDATE GLOBAL VARIABLES DIRECTLY (No Merging)
        db = cloud.mfg_pro_pkr || [];
        customerSales = cloud.customer_sales || [];
        repSales = cloud.rep_sales || [];
        salesHistory = cloud.noman_history || [];
        factoryInventoryData = cloud.factory_inventory_data || [];
        factoryProductionHistory = cloud.factory_production_history || [];
        paymentEntities = cloud.payment_entities || [];
        paymentTransactions = cloud.payment_transactions || [];
        stockReturns = cloud.stock_returns || [];
        
        // Settings
        factoryDefaultFormulas = cloud.factory_default_formulas || factoryDefaultFormulas;
        factoryAdditionalCosts = cloud.factory_additional_costs || factoryAdditionalCosts;
        factoryCostAdjustmentFactor = cloud.factory_cost_adjustment_factor || factoryCostAdjustmentFactor;
        factorySalePrices = cloud.factory_sale_prices || factorySalePrices;
        factoryUnitTracking = cloud.factory_unit_tracking || factoryUnitTracking;
        defaultSettings = cloud.naswar_default_settings || defaultSettings;

        // Restore Deleted Records Set
        if (cloud.deleted_records && Array.isArray(cloud.deleted_records)) {
            deletedRecordIds = new Set(cloud.deleted_records);
        }

        // 2. SAVE TO INDEXEDDB
        const idbPromises = [
            idb.set('mfg_pro_pkr', db),
            idb.set('customer_sales', customerSales),
            idb.set('rep_sales', repSales),
            idb.set('noman_history', salesHistory),
            idb.set('factory_inventory_data', factoryInventoryData),
            idb.set('factory_production_history', factoryProductionHistory),
            idb.set('payment_entities', paymentEntities),
            idb.set('payment_transactions', paymentTransactions),
            idb.set('stock_returns', stockReturns),
            
            idb.set('factory_default_formulas', factoryDefaultFormulas),
            idb.set('factory_additional_costs', factoryAdditionalCosts),
            idb.set('factory_cost_adjustment_factor', factoryCostAdjustmentFactor),
            idb.set('factory_sale_prices', factorySalePrices),
            idb.set('factory_unit_tracking', factoryUnitTracking),
            idb.set('naswar_default_settings', defaultSettings),
            idb.set('deleted_records', Array.from(deletedRecordIds)),
            
            idb.set('last_synced', new Date().toISOString())
        ];

        await Promise.all(idbPromises);

        if (!silent) showToast(' Data Restored Successfully ', 'success');
        
        // 3. REFRESH UI ELEMENTS
        updateUnitsAvailableIndicator();
        await refreshAllDisplays();

    } catch (error) {
        console.error('Cloud Restore Error:', error);
        if (!silent) showToast('Restore failed. Using local data.', 'error');
    } finally {
        isSyncing = false;
    }
}

// ============================================
// SEAMLESS BACKGROUND BACKUP (DEBOUNCER)
// ============================================

let seamlessBackupTimer = null;
const SEAMLESS_DELAY_MS = 5000; // Wait 5 seconds after last change

function triggerSeamlessBackup() {
    // 1. Clear any pending backup since a new change just happened
    if (seamlessBackupTimer) {
        clearTimeout(seamlessBackupTimer);
    }

    // 2. Set a new timer
    seamlessBackupTimer = setTimeout(async () => {
        // Only run if we are logged in
        if (currentUser && supabaseClient) {
            console.log(" Seamless backup triggering...");
            
            // Call the main push function in SILENT mode (true)
            // This ensures no toast notifications disturb the user
            await pushDataToCloud(true); 
        }
    }, SEAMLESS_DELAY_MS);
}

// --- DATABASE HEARTBEAT (KEEP ALIVE) ---
function startDatabaseHeartbeat() {
    stopDatabaseHeartbeat();
    heartbeatInterval = setInterval(async () => {
        if (!supabaseClient || !currentUser) {
            stopDatabaseHeartbeat();
            return;
        }
        try {
            await supabaseClient.from('user_data').select('user_id').eq('user_id', currentUser.id).limit(1);
        } catch (error) {
            dbWakeUpAttempted = false;
        }
    }, 240000); // 4 minutes
}

function stopDatabaseHeartbeat() {
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
    }
}

// --- AUTO-SYNC SCHEDULER (5 Minutes) ---
const AUTO_BACKUP_INTERVAL = 300000; // 5 minutes (in milliseconds)

function scheduleAutoBackup() {
    clearAutoBackup();
    // Only schedule if user is logged in
    if (!currentUser) return;

    console.log(" Background Sync scheduled for every 5 minutes");
    
    autoSaveTimer = setInterval(async () => {
        // Check session validity silently
        const { data } = await supabaseClient.auth.getSession();
        if (!data.session) {
            console.log(" Session expired, stopping auto-sync");
            clearAutoBackup();
            return;
        }
        
        // Run Silent Sync
        await performOneClickSync(true); 
    }, AUTO_BACKUP_INTERVAL);
}

function clearAutoBackup() {
    if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
        autoSaveTimer = null;
    }
}


function clearAutoBackup() {
    if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
        autoSaveTimer = null;
    }
}

// --- HELPER: WAKE UP DB ---
async function wakeUpDatabase() {
    if (!supabaseClient || !currentUser) return false;
    try {
        const wakeUpPromise = supabaseClient.from('user_data').select('user_id').eq('user_id', currentUser.id).limit(1);
        const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 45000));
        await Promise.race([wakeUpPromise, timeoutPromise]);
        dbWakeUpAttempted = true;
        return true;
    } catch (error) {
        return false;
    }
}

// --- HELPER: WAKE AND SYNC ---
async function wakeUpDatabaseAndSync() {
    showToast('Connecting to cloud...', 'info');
    const awake = await wakeUpDatabase();
    if (awake) {
        await pullDataFromCloud(true);
    } else {
        setTimeout(async () => {
            const retryAwake = await wakeUpDatabase();
            if (retryAwake) await pullDataFromCloud(true);
        }, 5000);
    }
}

// --- TRIGGER CLOUD ACTION (UI BUTTONS) ---
async function triggerCloudAction(action) {
    if (!supabaseClient) {
        showToast("Cloud system not initialized. Check internet.", "error");
        return;
    }

    if (isSyncing) {
        console.warn(" Resetting stuck sync.");
        isSyncing = false; 
    }

    if (!currentUser) {
        closeDataMenu();
        showToast("Please sign in to access Cloud functions.", "info");
        showAuthOverlay();
        return;
    }

    if (action === 'backup') {
        // This is now a "Sync" (Merge and Push)
        await pushDataToCloud(false); 
    }
    
    if (action === 'restore') {
        if(confirm("UPDATE FROM CLOUD?\n\nThis will merge cloud data into your device.\nAny newer local changes will be kept.\n\nContinue?")) {
            closeDataMenu();
            showToast("Starting Update...", "info");
            await pullDataFromCloud(false); 
        }
    }
}

// --- CHECKS ON LOAD ---
async function checkAuthState() {
    if (!supabaseClient) return;
    const { data: { user } } = await supabaseClient.auth.getUser();
    
    if (user) {
        currentUser = user;
        startDatabaseHeartbeat();
        scheduleAutoBackup();
        addSignOutButton();
        await wakeUpDatabaseAndSync();
    }
}



// --- REDESIGNED AUTH UI ---
function createAuthOverlay() {
    const existing = document.getElementById('auth-overlay');
    if (existing) existing.remove();
    
    const overlay = document.createElement('div');
    overlay.id = 'auth-overlay';
    // Matches the app's bg-gradient
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(135deg, rgba(240, 248, 255, 0.95) 0%, rgba(230, 240, 255, 0.95) 100%);
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        z-index: 99999; display: flex; align-items: center; justify-content: center;
    `;
    
    // Liquid Card styling to match main app cards
    overlay.innerHTML = `
        <div class="liquid-card" style="max-width: 400px; width: 90%; padding: 40px 30px; text-align: center; border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(37, 99, 235, 0.15);">
            <div style="font-size: 3.5rem; margin-bottom: 10px;"></div>
            <h2 class="shimmer-text" style="font-family: 'sans-serif', cursive; font-size: 2.5rem; margin: 0 0 20px 0;">
               GULL AND ZUBAIR NASWAR DEALER'S
            </h2>
            
            <p style="color: var(--text-muted); margin-bottom: 30px; font-size: 0.9rem;">
                Sign in or create an account to sync your data
            </p>
            
            <form id="auth-form" style="display: flex; flex-direction: column; gap: 15px;">
                <input type="email" id="auth-email" placeholder="Email Address" required 
                    style="width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; box-sizing: border-box; color: var(--text-main);">
                
                <input type="password" id="auth-password" placeholder="Password" required 
                    style="width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; box-sizing: border-box; color: var(--text-main);">
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="submit" class="btn btn-main" style="flex: 1; padding: 12px; font-size: 1rem; border-radius: 12px;">
                        Sign In
                    </button>
                    <button type="button" id="auth-signup-btn" class="btn" style="flex: 1; padding: 12px; font-size: 1rem; border-radius: 12px; background: var(--input-bg); border: 1px solid var(--glass-border); color: var(--text-main);">
                        Sign Up
                    </button>
                </div>
            </form>
            
            <div id="auth-message" style="font-size: 0.8rem; margin-top: 15px; min-height: 20px;"></div>
            
            <button id="auth-offline-btn" class="btn-theme" 
                style="margin-top: 25px; font-size: 0.75rem; width: 100%; opacity: 0.7;">
                Continue Offline (No Sync)
            </button>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Check dark mode preference to adjust overlay background immediately
    if (document.body.classList.contains('dark-mode')) {
        overlay.style.background = 'linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%)';
    }

    // Attach Event Listeners
    document.getElementById('auth-form').addEventListener('submit', handleSignIn);
    
    // Wire up the new Sign Up button
    document.getElementById('auth-signup-btn').addEventListener('click', (e) => {
        e.preventDefault(); // Prevent form submission
        handleSignUp();
    });

    document.getElementById('auth-offline-btn').addEventListener('click', () => {
        if (confirm('Data will only be saved on this device. Continue?')) {
            hideAuthOverlay();
        }
    });
}



function showAuthOverlay() {
    let overlay = document.getElementById('auth-overlay');
    if (!overlay) {
        createAuthOverlay();
    } else {
        overlay.style.display = 'flex';
    }
}

function hideAuthOverlay() {
    const overlay = document.getElementById('auth-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

async function handleSignIn(e) {
    e.preventDefault();
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    const messageDiv = document.getElementById('auth-message');
    
    if (!email || !password) {
        messageDiv.textContent = ' Please enter both email and password';
        messageDiv.style.color = 'var(--warning)';
        return;
    }
    
    messageDiv.textContent = ' Signing in...';
    messageDiv.style.color = 'var(--accent)';
    
    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        messageDiv.textContent = ' Success! Loading your data...';
        messageDiv.style.color = 'var(--accent-emerald)';
        
    } catch (error) {
        console.error('Sign in error:', error);
        messageDiv.textContent = ' ' + (error.message || 'Sign in failed. Check your credentials.');
        messageDiv.style.color = 'var(--danger)';
    }
}

async function handleSignUp() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    const messageDiv = document.getElementById('auth-message');
    
    if (!email || !password) {
        messageDiv.textContent = ' Please enter email and password';
        messageDiv.style.color = 'var(--danger)';
        return;
    }
    
    if (password.length < 6) {
        messageDiv.textContent = ' Password must be at least 6 characters';
        messageDiv.style.color = 'var(--danger)';
        return;
    }
    
    messageDiv.textContent = ' Creating account...';
    messageDiv.style.color = 'var(--accent)';
    
    try {
        const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        messageDiv.textContent = ' Account created! Please check your email to confirm.';
        messageDiv.style.color = 'var(--accent-emerald)';
        
    } catch (error) {
        console.error('Sign up error:', error);
        messageDiv.textContent = ' ' + (error.message || 'Sign up failed. Try a different email.');
        messageDiv.style.color = 'var(--danger)';
    }
}

async function signOut() {
    if (!confirm('Sign out and return to login screen?')) return;
    
    try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        
        currentUser = null;
        showAuthOverlay();
        
    } catch (error) {
        console.error('Sign out error:', error);
        showToast('Sign out failed', 'error');
    }
}

function addSignOutButton() {
    // Remove existing button if any
    removeSignOutButton();
    
    const systemControls = document.querySelector('.system-controls');
    if (systemControls && currentUser) {
        const btnContainer = systemControls.querySelector('div');
        if (btnContainer) {
            const signOutBtn = document.createElement('button');
            
        }
    }
}


function removeSignOutButton() {
    const btn = document.getElementById('cloud-signout-btn');
    if (btn) btn.remove();
}
// 2. UI Control for Return Section
function handleReturnQtyInput() {
    const retQty = parseFloat(document.getElementById('returnedQuantity').value) || 0;
    const section = document.getElementById('returnStoreSection');
    
    if (retQty > 0) {
        section.classList.remove('hidden');
    } else {
        section.classList.add('hidden');
    }
    
    if (typeof calculateSales === 'function') calculateSales();
}

// 3. FIXED: Save Transaction with Return Processing
async function saveTransaction() {
    // 1. Get DOM Elements & Values
    const seller = document.getElementById('sellerSelect').value;
    const date = document.getElementById('sale-date').value;
    
    // 2. Strict Number Parsing (Defaults to 0.00 if empty/invalid)
    const sold = parseFloat(document.getElementById('totalSold').value) || 0;
    const ret = parseFloat(document.getElementById('returnedQuantity').value) || 0;
    const cred = parseFloat(document.getElementById('creditSales').value) || 0;
    const prev = parseFloat(document.getElementById('prevCreditReceived').value) || 0;
    const rec = parseFloat(document.getElementById('receivedCash').value) || 0;
    
    // 3. Get Selected Store for Returns
    let selectedStore = null;
    if (ret > 0) {
        selectedStore = document.querySelector('input[name="return-store"]:checked');
        if (!selectedStore) {
            alert(" Please select a store (ZUBAIR or MAHMOOD) for the returned stock!");
            return;
        }
    }

    // 4. Pricing Logic
    const costPerKg = calculateSalesCostPerKg('standard') || 0;
    const salePrice = factorySalePrices.standard || 0;

    // 5. Validations
    if(!date) return alert("Please select a date");
    if(salePrice <= 0) return alert("Please set a sale price in Factory Formulas first");
    if(ret > sold) return alert("Returned quantity cannot exceed total sold");

    // 6. Calculations (Safe Math)
    const netSold = Math.max(0, sold - ret);
    const cashQty = Math.max(0, netSold - cred);
    const creditValue = cred * salePrice;
    const revenue = netSold * salePrice;
    const totalCost = netSold * costPerKg;
    const profit = revenue - totalCost;
    const totalExpected = (cashQty * salePrice) + prev;

    // 7. Status Text (Directly from logic, not DOM dependency)
    const diff = rec - totalExpected;
    let statusText = "PERFECT MATCH ";
    let statusClass = "result-box discrepancy-ok";
    
    if (Math.abs(diff) > 0.01) {
        if (diff < 0) {
            statusText = `SHORT: Rs ${Math.abs(diff).toFixed(2)}`;
            statusClass = "result-box discrepancy-alert";
        } else {
            statusText = `OVER: Rs ${diff.toFixed(2)}`;
            statusClass = "result-box discrepancy-ok";
        }
    }

    // 8. Process Return (Inventory Update)
    if (ret > 0 && selectedStore) {
        await processReturnToProduction(selectedStore.value, ret, date, seller);
    }

    // 9. CONSTRUCT ROBUST DATA OBJECT
    // We explicitly define every property to ensure NO data is missing
    const entry = {
        id: generateUUID('calc'),
        seller: seller,
        date: date,
        timestamp: new Date(date).getTime(),
        
        // Financials
        unitPrice: Number(salePrice.toFixed(2)),
        costPrice: Number(costPerKg.toFixed(2)),
        revenue: Number(revenue.toFixed(2)),
        profit: Number(profit.toFixed(2)),
        totalCost: Number(totalCost.toFixed(2)),
        
        // Quantities
        totalSold: Number(sold.toFixed(3)),
        returned: Number(ret.toFixed(3)),
        returnStore: selectedStore ? selectedStore.value : null,
        creditQty: Number(cred.toFixed(3)),
        cashQty: Number(cashQty.toFixed(3)),
        
        // Cash Flow
        creditValue: Number(creditValue.toFixed(2)),
        prevColl: Number(prev.toFixed(2)),
        totalExpected: Number(totalExpected.toFixed(2)),
        received: Number(rec.toFixed(2)),
        
        // UI State
        statusText: statusText,
        statusClass: statusClass,
        linkedSalesIds: []
    };

    // 10. Link to Sales Entries (Admin Mode)
    const linkedIds = await markSalesEntriesAsReceived(seller, sold);
    entry.linkedSalesIds = linkedIds;

    // 11. Save to IndexedDB
    let history = await idb.get('noman_history', []);
    if (!Array.isArray(history)) history = [];
    history.push(entry);
    await idb.set('noman_history', history);
    
    // Notify Sync System
    notifyDataChange('calculator');

    // 12. Cleanup UI
    document.getElementById('totalSold').value = '';
    document.getElementById('returnedQuantity').value = '';
    document.getElementById('creditSales').value = '';
    document.getElementById('prevCreditReceived').value = '';
    document.getElementById('receivedCash').value = '';
    document.getElementById('returnStoreSection').classList.add('hidden');
    
    showToast(`Transaction saved! ${linkedIds.length} sales entries reconciled.`, 'success');
    
    // 13. Refresh Everything
    await refreshAllDisplays();
}

// --- ROBUST CUSTOMER EXPORT FUNCTION ---
function exportCustomerData(type) {
    // 1. Define CSV Header
    let csvContent = "data:text/csv;charset=utf-8,";
    const fileName = type === 'rep' ? "My_Customer_List.csv" : "All_Customers_List.csv";
    
    csvContent += "Customer Name,Phone,Current Debt (Rs),Total Qty Sold (kg),Last Transaction\n";

    // 2. Prepare Data Map
    const customerMap = new Map();

    // Helper to initialize customer object
    const initCust = (name) => ({
        name: name,
        phone: "N/A",
        debt: 0,
        qty: 0,
        lastDate: ""
    });

    // 3. SCAN SALES HISTORY (Primary Source of Truth)
    customerSales.forEach(sale => {
        // Filter based on Export Type
        const isRepMode = (type === 'rep');
        
        // Skip if this sale doesn't match the requested mode
        // If type is 'rep', we ONLY want rep entries for the current profile
        // If type is 'admin', we ONLY want admin entries (isRepModeEntry !== true)
        if (isRepMode) {
            if (sale.isRepModeEntry !== true || sale.salesRep !== currentRepProfile) return;
        } else {
            if (sale.isRepModeEntry === true) return;
        }

        const name = sale.customerName;
        if (!name) return;

        // Get or Create Customer Record
        if (!customerMap.has(name)) {
            customerMap.set(name, initCust(name));
        }
        const cust = customerMap.get(name);

        // Update Phone if found in transaction
        if (sale.customerPhone) cust.phone = sale.customerPhone;

        // Calculate Debt & Qty
        cust.qty += (sale.quantity || 0);
        
        if (sale.paymentType === 'CREDIT' && !sale.creditReceived) {
            cust.debt += (sale.totalValue || 0);
        }
        if (sale.paymentType === 'COLLECTION') {
            cust.debt -= (sale.totalValue || 0);
        }

        // Track Last Activity Date
        if (sale.date > cust.lastDate) cust.lastDate = sale.date;
    });

    // 4. SCAN ENTITIES (To fill in missing phones or customers with 0 sales but debt)
    // Only do this for Admin export, as Reps might not have access to global entities
    if (type === 'admin') {
        paymentEntities.forEach(entity => {
            if (entity.type === 'payor') { // Only Customers
                if (!customerMap.has(entity.name)) {
                    // Customer exists in entities but has no sales record (maybe manual entry)
                    const newCust = initCust(entity.name);
                    newCust.phone = entity.phone || "N/A";
                    customerMap.set(entity.name, newCust);
                } else {
                    // Customer exists, just update phone if missing
                    const existing = customerMap.get(entity.name);
                    if (existing.phone === "N/A" && entity.phone) {
                        existing.phone = entity.phone;
                    }
                }
            }
        });
    }

    // 5. GENERATE CSV ROWS
    if (customerMap.size === 0) {
        showToast("No customers found to export.", "warning");
        return;
    }

    customerMap.forEach(cust => {
        // Sanitize strings for CSV (escape quotes)
        const safeName = cust.name.replace(/"/g, '""');
        const safePhone = cust.phone.replace(/"/g, '""');
        
        csvContent += `"${safeName}","${safePhone}",${cust.debt.toFixed(2)},${cust.qty.toFixed(3)},"${cust.lastDate}"\n`;
    });

    // 6. TRIGGER DOWNLOAD
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast(`Exported ${customerMap.size} customers successfully!`, "success");
}


// 5. NEW FUNCTION: Mark sales entries as received (oldest first)
async function markSalesEntriesAsReceived(seller, quantityToMark) {
    if (!seller || seller === 'COMBINED' || quantityToMark <= 0) return [];
    
    const linkedIds = [];
    let remainingQty = quantityToMark;
    
    // Get all pending credit sales for this representative (oldest first)
    const pendingSales = customerSales
        .filter(sale => 
            sale.salesRep === seller && 
            sale.paymentType === 'CREDIT' && 
            !sale.creditReceived
        )
        .sort((a, b) => a.timestamp - b.timestamp); // Sort by oldest first
    
    // Mark entries as received until we've covered the quantity
    for (const sale of pendingSales) {
        if (remainingQty <= 0) break;
        
        if (sale.quantity <= remainingQty) {
            // Fully mark this entry as received
            sale.creditReceived = true;
            sale.creditReceivedDate = new Date().toISOString().split('T')[0];
            sale.creditReceivedTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            sale.paymentType = 'CASH'; // Change to cash for calculations
            
            linkedIds.push(sale.id);
            remainingQty -= sale.quantity;
        } else {
            // This entry is larger than remaining quantity
            // Note: We cannot partially mark an entry, so we stop here
            break;
        }
    }
    
    // Save updated sales data
    if (linkedIds.length > 0) {
        await idb.set('customer_sales', customerSales);
    }
    
    return linkedIds;
}
    
    // --- UPDATE ALL TABS WITH FACTORY COSTS ---
    function updateAllTabsWithFactoryCosts() {
        const storeSelector = document.getElementById('storeSelector');
        if (storeSelector) {
            updateUnitsAvailableIndicator();
            updateProductionCostOnStoreChange();
        }
        
        const supplyStore = document.querySelector('input[name="supply-store"]:checked');
        if (supplyStore) {
            calculateCustomerSale();
        }
        
        calculateSales();
        updateFactoryUnitsAvailableStats();
        updateFactorySummaryCard();
    }
    
    // --- PERCENTAGE TOGGLE FOR PIE CHARTS ---
    function togglePercentage(chartId) {
    // Fix: Map correct HTML IDs to Chart IDs
    let btnId = '';
    
    if (chartId === 'mfgPieChart') {
        btnId = 'mfgPiePercentageToggle'; // Matches HTML ID
    } else if (chartId === 'custPaymentChart') {
        btnId = 'custPaymentPercentageToggle'; // Matches HTML ID
    } else if (chartId === 'compositionChart') {
        btnId = 'compositionPercentageToggle'; // Matches HTML ID
    }
    
    const btn = document.getElementById(btnId);
    
    if (!btn) {
        console.error("Toggle Button not found for:", btnId);
        return;
    }
    
    switch(chartId) {
        case 'mfgPieChart':
            mfgPieChartShowPercentage = !mfgPieChartShowPercentage;
            btn.textContent = mfgPieChartShowPercentage ? 'Show Values' : 'Show %';
            updateMfgPieChart();
            break;
        case 'custPaymentChart':
            custPaymentChartShowPercentage = !custPaymentChartShowPercentage;
            btn.textContent = custPaymentChartShowPercentage ? 'Show Values' : 'Show %';
            updateCustomerPieChart();
            break;
        case 'compositionChart':
            compositionChartShowPercentage = !compositionChartShowPercentage;
            btn.textContent = compositionChartShowPercentage ? 'Show Values' : 'Show %';
            updateCompositionChart();
            break;
    }
}

    
    function updateMfgPieChart() {
        if (!mfgPieChart) return;
        
        const data = mfgPieChart.data.datasets[0].data;
        const total = data.reduce((a, b) => a + b, 0);
        
        if (mfgPieChartShowPercentage) {
            mfgPieChart.data.datasets[0].data = data.map(value => total > 0 ? ((value / total) * 100).toFixed(1) : 0);
            mfgPieChart.options.plugins.tooltip = {
                callbacks: {
                    label: function(context) {
                        return `${context.label}: ${context.parsed}%`;
                    }
                }
            };
        } else {
            updateMfgCharts();
        }
        
        mfgPieChart.update();
    }
    
    function updateCustomerPieChart() {
        if (!custPaymentChart) return;
        
        const data = custPaymentChart.data.datasets[0].data;
        const total = data.reduce((a, b) => a + b, 0);
        
        if (custPaymentChartShowPercentage) {
            custPaymentChart.data.datasets[0].data = data.map(value => total > 0 ? ((value / total) * 100).toFixed(1) : 0);
            custPaymentChart.options.plugins.tooltip = {
                callbacks: {
                    label: function(context) {
                        return `${context.label}: ${context.parsed}%`;
                    }
                }
            };
        } else {
            updateCustomerCharts();
        }
        
        custPaymentChart.update();
    }
    
    async function updateCompositionChart() {
        if (!salesCompChart) return;
        
        const data = salesCompChart.data.datasets[0].data;
        const total = data.reduce((a, b) => a + b, 0);
        
        if (compositionChartShowPercentage) {
            salesCompChart.data.datasets[0].data = data.map(value => total > 0 ? ((value / total) * 100).toFixed(1) : 0);
            salesCompChart.options.plugins.tooltip = {
                callbacks: {
                    label: function(context) {
                        return `${context.label}: ${context.parsed}%`;
                    }
                }
            };
        } else {
            const seller = document.getElementById('sellerSelect').value;
            if (seller === 'COMBINED') {
                const comp = await calculateComparisonData();
                updateSalesCharts(comp);
            }
        }
        
        salesCompChart.update();
    }

    // --- INDIVIDUAL SALES REP PERFORMANCE CHARTS (UPDATED WITH ALL TIMES) ---
    async function setIndChartMode(mode) {
        currentIndMode = mode;
        
        document.getElementById('ind-week-btn').className = `toggle-opt ${mode === 'week' ? 'active' : ''}`;
        document.getElementById('ind-month-btn').className = `toggle-opt ${mode === 'month' ? 'active' : ''}`;
        document.getElementById('ind-year-btn').className = `toggle-opt ${mode === 'year' ? 'active' : ''}`;
        document.getElementById('ind-all-btn').className = `toggle-opt ${mode === 'all' ? 'active' : ''}`;
        
        await updateIndChart();
    }
    
    async function setIndChartMetric(metric) {
        currentIndMetric = metric;
        await updateIndChart();
    }
    
    async function updateIndChart() {
        const seller = document.getElementById('sellerSelect').value;
        if (seller === 'COMBINED') return;
        
        if(indPerformanceChart) indPerformanceChart.destroy();
        
        let history; history = await idb.get('noman_history', []);
        const sellerHistory = history.filter(h => h.seller === seller);
        const now = new Date(document.getElementById('sale-date').value);
        const selectedYear = now.getFullYear();
        const selectedMonth = now.getMonth();
        const selectedDay = now.getDate();
        
        let labels = [];
        let data = [];
        
        if (currentIndMode === 'week') {
            for(let i=6; i>=0; i--) {
                const d = new Date(now);
                d.setDate(now.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('en-US', {weekday:'short'}));
                
                let metricValue = 0;
                sellerHistory.forEach(h => {
                    if(h.date === dateStr) {
                        metricValue += getMetricValue(h, currentIndMetric);
                    }
                });
                data.push(metricValue);
            }
        } else if (currentIndMode === 'month') {
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            data = new Array(daysInMonth).fill(0);
            sellerHistory.forEach(h => {
                const d = new Date(h.date);
                if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                    const day = d.getDate();
                    data[day - 1] += getMetricValue(h, currentIndMetric);
                }
            });
        } else if (currentIndMode === 'year') {
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            labels = months;
            data = new Array(12).fill(0);
            sellerHistory.forEach(h => {
                const d = new Date(h.date);
                if(d.getFullYear() === now.getFullYear()) {
                    const month = d.getMonth();
                    data[month] += getMetricValue(h, currentIndMetric);
                }
            });
        } else if (currentIndMode === 'all') {
            const allMonths = [];
            const monthData = {};
            
            sellerHistory.forEach(h => {
                const d = new Date(h.date);
                const monthYear = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = `${d.toLocaleDateString('en-US', {month:'short'})} ${d.getFullYear()}`;
                
                if (!monthData[monthYear]) {
                    monthData[monthYear] = {
                        label: monthLabel,
                        value: 0
                    };
                }
                monthData[monthYear].value += getMetricValue(h, currentIndMetric);
            });
            
            const sortedMonths = Object.keys(monthData).sort();
            sortedMonths.forEach(monthKey => {
                labels.push(monthData[monthKey].label);
                data.push(monthData[monthKey].value);
            });
            
            if (labels.length > 12) {
                labels = labels.slice(-12);
                data = data.slice(-12);
            }
        }
        
        const colors = {
            text: '#1e3a8a',
            grid: 'rgba(37, 99, 235, 0.1)'
        };
        
        const sellerColor = seller === 'NORAN SHAH' ? '#2563eb' : '#059669';
        
        indPerformanceChart = new Chart(document.getElementById('indPerformanceChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: getMetricLabel(currentIndMetric),
                    data: data,
                    backgroundColor: sellerColor + '80',
                    borderColor: sellerColor,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: `${getMetricLabel(currentIndMetric)} - ${currentIndMode === 'all' ? 'All Times' : currentIndMode.charAt(0).toUpperCase() + currentIndMode.slice(1) + 'ly'} View`,
                        color: colors.text,
                        font: { size: 13, weight: 'bold' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: colors.grid },
                        ticks: { color: colors.text }
                    },
                    x: {
                        ticks: { color: colors.text, maxRotation: 45 }
                    }
                }
            }
        });
    }
    
    function getMetricValue(historyItem, metric) {
        switch(metric) {
            case 'weight':
                return ((historyItem.totalSold || 0) - (historyItem.returned || 0)) || 0;
            case 'value':
                return historyItem.revenue || 0;
            case 'cost':
                return historyItem.totalCost || 0;
            case 'profit':
                return historyItem.profit || 0;
            case 'cash':
                return (historyItem.cashQty * (historyItem.unitPrice || historyItem.revenue / (historyItem.totalSold - historyItem.returned) || 0)) || 0;
            case 'credit':
                return historyItem.creditValue || 0;
            default:
                return 0;
        }
    }
    
    function getMetricLabel(metric) {
        switch(metric) {
            case 'weight': return 'Weight (kg)';
            case 'value': return 'Total Value (Rs)';
            case 'cost': return 'Total Cost (Rs)';
            case 'profit': return 'Net Profit (Rs)';
            case 'cash': return 'Cash Sales (Rs)';
            case 'credit': return 'Credit Sales (Rs)';
            default: return '';
        }
    }

    // --- STORE COMPARISON FUNCTIONS ---
    function setStoreComparisonMetric(metric, event) {
        if (event) {
            event.preventDefault();
        }
        currentStoreComparisonMetric = metric;
        
        document.querySelectorAll('.metric-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        if (event && event.target) {
            event.target.classList.add('active');
        }
        
        updateStoreComparisonChart(currentOverviewMode);
    }

    function updateStoreComparisonChart(mode = 'day') {
        if(storeComparisonChart) storeComparisonChart.destroy();
        
        const selectedDate = document.getElementById('sys-date').value;
        const selectedDateObj = new Date(selectedDate);
        const selectedYear = selectedDateObj.getFullYear();
        const selectedMonth = selectedDateObj.getMonth();
        const selectedDay = selectedDateObj.getDate();
        
        const stores = ['STORE_A', 'STORE_B', 'STORE_C'];
        const storeLabels = ['ZUBAIR', 'MAHMOOD', 'ASAAN'];
        const storeColors = ['#3b82f6', '#8b5cf6', '#10b981'];
        
        let data = [];
        let metricLabel = '';
        
        stores.forEach(store => {
            let storeData = {
                weight: 0,
                value: 0,
                cost: 0,
                profit: 0
            };
            
            db.forEach(item => {
                const itemDate = new Date(item.date);
                const itemYear = itemDate.getFullYear();
                const itemMonth = itemDate.getMonth();
                const itemDay = itemDate.getDate();
                
                let includeItem = false;
                
                if (mode === 'day' && item.date === selectedDate) {
                    includeItem = true;
                } else if (mode === 'week') {
                    const weekStart = new Date(selectedDateObj);
                    weekStart.setDate(selectedDay - 6);
                    if (itemDate >= weekStart && itemDate <= selectedDateObj) {
                        includeItem = true;
                    }
                } else if (mode === 'month' && itemYear === selectedYear && itemMonth === selectedMonth) {
                    includeItem = true;
                } else if (mode === 'year' && itemYear === selectedYear) {
                    includeItem = true;
                } else if (mode === 'all') {
                    includeItem = true;
                }
                
                if (includeItem && item.store === store) {
                    storeData.weight += item.net;
                    storeData.value += item.totalSale;
                    storeData.cost += item.totalCost;
                    storeData.profit += item.profit;
                }
            });
            
            data.push(storeData[currentStoreComparisonMetric]);
        });
        
        switch(currentStoreComparisonMetric) {
            case 'weight': metricLabel = 'Weight (kg)'; break;
            case 'value': metricLabel = 'Total Value (Rs)'; break;
            case 'cost': metricLabel = 'Total Cost (Rs)'; break;
            case 'profit': metricLabel = 'Net Profit (Rs)'; break;
        }
        
        const colors = {
            text: '#1e3a8a',
            grid: 'rgba(37, 99, 235, 0.1)'
        };
        
        storeComparisonChart = new Chart(document.getElementById('storeComparisonChart'), {
            type: 'bar',
            data: {
                labels: storeLabels,
                datasets: [{
                    label: metricLabel,
                    data: data,
                    backgroundColor: storeColors,
                    borderColor: storeColors,
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: `Store Comparison by ${metricLabel} (${mode === 'all' ? 'All Times' : mode.charAt(0).toUpperCase() + mode.slice(1)})`,
                        color: colors.text,
                        font: { size: 13, weight: 'bold' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: colors.grid },
                        ticks: { color: colors.text }
                    },
                    x: {
                        ticks: { color: colors.text }
                    }
                }
            }
        });
    }

    // --- SEARCH FUNCTIONALITIES ---
    // 7. UPDATED: Production History Display (Show Return Badge)
function refreshUI() {
    const selectedDate = document.getElementById('sys-date').value;
    if (!selectedDate) return;
    
    // Parse selected date strictly from string
    const [sYear, sMonth, sDay] = selectedDate.split('-').map(Number);
    const selectedDateObj = new Date(sYear, sMonth - 1, sDay); // Local time object for week calc
    
    const weekStart = new Date(selectedDateObj);
    weekStart.setDate(selectedDateObj.getDate() - 6);
    // Reset weekStart to midnight to ensure accurate comparison
    weekStart.setHours(0,0,0,0);
    
    let stats = { 
        day: {q:0, p:0, c:0, v:0, fu:0, fc:0}, 
        week: {q:0, p:0, c:0, v:0, fu:0, fc:0}, 
        month: {q:0, p:0, c:0, v:0, fu:0, fc:0}, 
        year: {q:0, p:0, c:0, v:0, fu:0, fc:0},
        all: {q:0, p:0, c:0, v:0, fu:0, fc:0}
    };
    
    const histContainer = document.getElementById('prodHistoryList');
    let filteredData = currentProductionView === 'combined' ? db : db.filter(item => item.store === currentStore);

    const sortedDb = [...filteredData].sort((a, b) => {
        if (a.date === selectedDate && b.date !== selectedDate) return -1;
        if (a.date !== selectedDate && b.date === selectedDate) return 1;
        return b.timestamp - a.timestamp;
    });

    let htmlBuffer = '';

    sortedDb.forEach(item => {
        if(!item.date) return;

        // STRICT DATE PARSING: Split string to avoid Timezone shifts
        const [rowYear, rowMonth, rowDay] = item.date.split('-').map(Number);
        
        // Create a local date object for range comparisons (Week)
        const rowDateObj = new Date(rowYear, rowMonth - 1, rowDay);
        rowDateObj.setHours(0,0,0,0);

        // Daily Match
        if(item.date === selectedDate) { 
            stats.day.q += item.net; stats.day.p += item.profit; stats.day.c += item.totalCost;
            stats.day.v += item.totalSale; stats.day.fu += (item.formulaUnits || 0); stats.day.fc += (item.formulaCost || 0);
        }
        
        // Weekly Match
        if(rowDateObj >= weekStart && rowDateObj <= selectedDateObj) { 
            stats.week.q += item.net; stats.week.p += item.profit; stats.week.c += item.totalCost;
            stats.week.v += item.totalSale; stats.week.fu += (item.formulaUnits || 0); stats.week.fc += (item.formulaCost || 0);
        }
        
        // Monthly Match (Compare Year and Month directly)
        if(rowYear === sYear && rowMonth === sMonth) { 
            stats.month.q += item.net; stats.month.p += item.profit; stats.month.c += item.totalCost;
            stats.month.v += item.totalSale; stats.month.fu += (item.formulaUnits || 0); stats.month.fc += (item.formulaCost || 0);
        }
        
        // Yearly Match
        if(rowYear === sYear) { 
            stats.year.q += item.net; stats.year.p += item.profit; stats.year.c += item.totalCost;
            stats.year.v += item.totalSale; stats.year.fu += (item.formulaUnits || 0); stats.year.fc += (item.formulaCost || 0);
        }
        
        stats.all.q += item.net; stats.all.p += item.profit; stats.all.c += item.totalCost;
        stats.all.v += item.totalSale; stats.all.fu += (item.formulaUnits || 0); stats.all.fc += (item.formulaCost || 0);

        // HTML Generation (kept original)
        const isSelected = item.date === selectedDate;
        const highlightClass = isSelected ? 'highlight-card' : '';
        const dateDisplay = isSelected ? `${item.date} (Selected)` : item.date;
        const storeBadgeClass = item.store === 'STORE_A' ? 'store-a' : item.store === 'STORE_B' ? 'store-b' : 'store-c';
        const storeLabel = item.store === 'STORE_A' ? 'ZUBAIR' : item.store === 'STORE_B' ? 'MAHMOOD' : 'ASAAN';
        
        let returnBadge = '';
        if (item.isReturn) {
            returnBadge = `<span class="payment-badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); top: 35px; right: 12px;"> RETURN</span>`;
        }
        
        let paymentBadge = '';
        if (item.store === 'STORE_C' && item.paymentStatus === 'CREDIT' && !item.isReturn) {
            paymentBadge = `<span class="payment-badge credit" style="top: 35px; right: 12px;">CREDIT</span>`;
        }

        htmlBuffer += `
            <div class="card liquid-card ${highlightClass}">
                ${currentProductionView === 'combined' ? `<span class="store-badge ${storeBadgeClass}">${storeLabel}</span>` : ''}
                ${returnBadge}
                ${paymentBadge}
                <h4>${dateDisplay} @ ${item.time}</h4>
                ${item.isReturn ? `<p style="color:var(--accent-emerald); font-size:0.75rem; font-style:italic;">Returned by ${item.returnedBy || 'Representative'}</p>` : ''}
                <p><span>Net Weight:</span> <span class="qty-val">${item.net.toFixed(3)} kg</span></p>
                <p><span>Cost Price:</span> <span class="cost-val">Rs ${item.cp.toFixed(2)}/kg</span></p>
                <p><span>Sale Price:</span> <span class="rev-val">Rs ${item.sp.toFixed(2)}/kg</span></p>
                <hr>
                <p><span>Total Cost:</span> <span class="cost-val">Rs ${item.totalCost.toFixed(2)}</span></p>
                <p><span>Total Value:</span> <span class="rev-val">Rs ${item.totalSale.toFixed(2)}</span></p>
                <p><span>Net Profit:</span> <span class="profit-val">Rs ${item.profit.toFixed(2)}</span></p>
                ${item.paymentStatus === 'CREDIT' && !item.isReturn ? `<p><span>Payment:</span> <span class="cost-val" style="color:var(--credit-color);">Credit</span></p>` : ''}
                ${item.formulaUnits && !item.isReturn ? `<p><span>Formula Units:</span> <span class="qty-val">${item.formulaUnits.toFixed(3)}</span></p>` : ''}
                ${item.formulaCost && !item.isReturn ? `<p><span>Formula Cost:</span> <span class="cost-val">Rs ${item.formulaCost.toFixed(2)}</span></p>` : ''}
                <button class="btn btn-danger" style="width:100%; font-size:9px; padding:4px; margin-top:8px;" onclick="(async () => { await deleteProdEntry('${item.id}') })()">Delete</button>
            </div>
        `;
    });
    
    histContainer.innerHTML = htmlBuffer || `<p style="text-align:center; color:var(--text-muted); width:100%; font-size:0.85rem;">No records found for this selection.</p>`;

    const updateStats = (idPrefix, statObj) => {
        document.getElementById(`${idPrefix}-qty`).innerText = `${safeValue(statObj.q).toFixed(3)} kg`;
        document.getElementById(`${idPrefix}-value`).innerText = `Rs ${safeValue(statObj.v).toFixed(2)}`;
        document.getElementById(`${idPrefix}-cost`).innerText = `Rs ${safeValue(statObj.c).toFixed(2)}`;
        document.getElementById(`${idPrefix}-profit`).innerText = `Rs ${safeValue(statObj.p).toFixed(2)}`;
        document.getElementById(`${idPrefix}-formula-units`).innerText = `${safeValue(statObj.fu).toFixed(3)}`;
        document.getElementById(`${idPrefix}-formula-cost`).innerText = `Rs ${safeValue(statObj.fc).toFixed(2)}`;
    };

    updateStats('day', stats.day);
    updateStats('week', stats.week);
    updateStats('month', stats.month);
    updateStats('year', stats.year);
    updateStats('all', stats.all);
    
    updateMfgCharts();
    if (currentProductionView === 'combined') {
        updateAllStoresOverview(currentOverviewMode);
    }
    updateUnitsAvailableIndicator();
}

    function filterCalculatorHistory() {
        const searchTerm = document.getElementById('calculator-search').value.toLowerCase();
        const allCards = document.querySelectorAll('#historyList .card');
        
        allCards.forEach(card => {
            const cardText = card.textContent.toLowerCase();
            const sellerElement = card.querySelector('.seller-badge');
            const sellerText = sellerElement ? sellerElement.textContent.toLowerCase() : '';
            
            if (cardText.includes(searchTerm) || sellerText.includes(searchTerm)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function filterCustomerTransactions() {
        const searchTerm = document.getElementById('customer-search').value.toLowerCase();
        const allCards = document.querySelectorAll('#custHistoryList .card');
        
        allCards.forEach(card => {
            const customerName = card.querySelector('.customer-name')?.textContent.toLowerCase() || '';
            if (customerName.includes(searchTerm)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }
// UPDATED: Add supplier indicator in renderEntityTable
// Variable to track the active entity being managed
let currentEntityId = null;
let currentQuickType = 'OUT';

async function renderEntityTable() {
    const tbody = document.getElementById('entity-table-body');
    const filter = document.getElementById('entity-list-filter').value.toLowerCase();
    
    // Safety check
    if (!tbody) return;
    tbody.innerHTML = '';

    // Calculate Balances
    const balances = calculateEntityBalances();
    let totalReceivables = 0;
    let totalPayables = 0;

    // Sort entities by balance magnitude (Highest debts/credits first)
    const sortedEntities = [...paymentEntities].sort((a, b) => {
        const balA = Math.abs(balances[a.id] || 0);
        const balB = Math.abs(balances[b.id] || 0);
        return balB - balA;
    });

    if (sortedEntities.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:15px; color:var(--text-muted);">No entities found</td></tr>`;
    }

    sortedEntities.forEach(entity => {
        if (filter && !entity.name.toLowerCase().includes(filter)) return;

        const balance = balances[entity.id] || 0;
        
        // Update Totals
        if (balance > 0) totalPayables += balance; // Positive means we owe them (Liability)
        else totalReceivables += Math.abs(balance); // Negative means they owe us (Asset)

        // Determine Styles
        let balanceHtml = '';
        if (balance > 0.01) {
            balanceHtml = `<span style="color:var(--danger); font-weight:800;">Payable: Rs ${balance.toFixed(0)}</span>`;
        } else if (balance < -0.01) {
            balanceHtml = `<span style="color:var(--accent-emerald); font-weight:800;">Receivable: Rs ${Math.abs(balance).toFixed(0)}</span>`;
        } else {
            balanceHtml = `<span style="color:var(--text-muted);">Settled</span>`;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="text-align:left;">
                <div style="font-weight:700;">${entity.name}</div>
                <div style="font-size:0.65rem; color:var(--text-muted);">${entity.type.toUpperCase()}</div>
            </td>
            <td style="text-align:right;">${balanceHtml}</td>
            <td style="text-align:right; font-size:0.75rem;">${entity.phone || '-'}</td>
            <td style="text-align:center;">
                <button class="btn-theme" style="padding:4px 10px; font-size:0.75rem;" 
                    onclick="openEntityDetailsOverlay(${entity.id})">
                    Manage
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Update Footer Totals
    document.getElementById('total-receivables').innerText = `Rs ${totalReceivables.toFixed(2)}`;
    document.getElementById('total-payables').innerText = `Rs ${totalPayables.toFixed(2)}`;
}

// NEW: Helper function to determine dynamic role
// --- UPDATED: DYNAMIC ROLE HELPER ---
function getDynamicRole(balance) {
    // Threshold to handle floating point errors
    if (balance > 0.01) {
        // Positive Balance: They owe me money (Receivable/Asset)
        return {
            label: 'Receivable',
            icon: '',
            colorClass: 'entity-balance-positive',
            badgeColor: 'linear-gradient(135deg, #059669 0%, #047857 100%)', // Green
            sign: '+'
        };
    } else if (balance < -0.01) {
        // Negative Balance: I owe them money (Payable/Liability)
        return {
            label: 'Payable',
            icon: '',
            colorClass: 'entity-balance-negative',
            badgeColor: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)', // Red
            sign: '' // Negative sign is automatic in number formatting
        };
    } else {
        // Zero Balance: Settled
        return {
            label: 'Settled',
            icon: '',
            colorClass: 'entity-balance-neutral',
            badgeColor: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', // Blue
            sign: ''
        };
    }
}


function filterEntityList() {
    const searchTerm = document.getElementById('entity-list-search')?.value.toLowerCase() || '';
    
    if (entityListViewType === 'table') {
        const rows = document.querySelectorAll('#entityListBody tr');
        rows.forEach(row => {
            const entityName = row.querySelector('strong')?.textContent.toLowerCase() || '';
            const phone = row.querySelector('div[style*="font-size:0.7rem"]')?.textContent.toLowerCase() || '';
            
            if (entityName.includes(searchTerm) || phone.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    } else {
        const cards = document.querySelectorAll('#entityListBody .entity-card');
        cards.forEach(card => {
            const cardText = card.textContent.toLowerCase();
            if (cardText.includes(searchTerm)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }
}

function refreshEntityBalances() {
    refreshEntityList();
    alert("Entity balances refreshed!");
}

function viewEntityTransactions(entityId) {
    const entity = paymentEntities.find(e => e.id === entityId);
    if (!entity) return;
    
    const entityTransactions = paymentTransactions.filter(t => t.entityId === entityId);
    
    let message = `Transactions for ${entity.name}\n\n`;
    
    if (entityTransactions.length === 0) {
        message += "No transactions found.";
    } else {
        entityTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        let totalIn = 0, totalOut = 0;
        
        entityTransactions.forEach((t, index) => {
            const typeText = t.type === 'IN' ? 'RECEIVED' : 'PAID';
            const amount = t.amount.toFixed(2);
            
            message += `${index + 1}. ${t.date} ${t.time || ''}\n`;
            message += `   ${typeText}: Rs ${amount}\n`;
            message += `   Description: ${t.description}\n`;
            message += `   ---\n`;
            
            if (t.type === 'IN') totalIn += t.amount;
            else totalOut += t.amount;
        });
        
        const netBalance = totalIn - totalOut;
        message += `\nSUMMARY:\n`;
        message += `Total Received: Rs ${totalIn.toFixed(2)}\n`;
        message += `Total Paid: Rs ${totalOut.toFixed(2)}\n`;
        message += `Net Balance: Rs ${netBalance.toFixed(2)}\n`;
    }
    
    alert(message);
}

// --- UPDATED: REFRESH PAYMENT TAB FUNCTION ---
async function refreshPaymentTab() {
    // First ensure all suppliers are properly loaded into entities
    await syncSuppliersToEntities();
    
    renderEntities();
    calculateNetCash();
    calculatePaymentSummaries();
    refreshEntityList();
    calculateCashTracker();
    
    // Render transaction history
    const historyList = document.getElementById('paymentHistoryList');
    historyList.innerHTML = '';
    
    // Sort by date (newest first)
    const sortedTransactions = [...paymentTransactions].sort((a, b) => b.timestamp - a.timestamp);
    
    sortedTransactions.forEach(transaction => {
        const entity = paymentEntities.find(e => e.id === transaction.entityId);
        const badgeClass = transaction.type === 'IN' ? 'transaction-in' : 'transaction-out';
        const badgeText = transaction.type === 'IN' ? 'IN' : 'OUT';
        
        const card = document.createElement('div');
        card.className = 'card liquid-card';
        card.innerHTML = `
            <span class="transaction-badge ${badgeClass}">${badgeText}</span>
            <h4>${transaction.date} @ ${transaction.time}</h4>
            <div class="customer-name">${entity ? entity.name : 'Unknown Entity'}</div>
            <p><span>Type:</span> <span>${entity ? (entity.type === 'payee' ? 'Payee' : 'Payor') : 'Unknown'}</span></p>
            <p><span>Description:</span> <span>${transaction.description}</span></p>
            <hr>
            <p><span>Amount:</span> <span class="${transaction.type === 'IN' ? 'profit-val' : 'cost-val'}">${Math.abs(transaction.amount).toFixed(2)}</span></p>
            <button class="btn btn-danger" style="width:100%; font-size:9px; padding:4px; margin-top:8px;" onclick="(async () => { await deletePaymentTransaction(${transaction.id}) })()">Delete</button>
        `;
        historyList.appendChild(card);
    });
    
    if (sortedTransactions.length === 0) {
        historyList.innerHTML = '<p style="text-align:center; color:var(--text-muted); width:100%; font-size:0.85rem;">No payment transactions found.</p>';
    }
}

// --- NEW FUNCTION: SYNC SUPPLIERS TO ENTITIES ---
async function syncSuppliersToEntities() {
    // Look through factory inventory for materials with suppliers
    factoryInventoryData.forEach(material => {
        if (material.supplierName && !paymentEntities.some(e => 
            e.name === material.supplierName && e.type === 'payee')) {
            
            // Add missing supplier to entities
            paymentEntities.push({
                id: Date.now(),
                name: material.supplierName,
                type: 'payee',
                phone: material.supplierContact || '',
                wallet: '',
                createdAt: Date.now(),
                updatedAt: Date.now(),
                isSupplier: true,
                supplierCategory: 'raw_materials'
            });
        }
    });
    
    await idb.set('payment_entities', paymentEntities);
}
    // --- Backup & Restore ---
    async function unifiedBackup() {
    if (currentUser) {
        if (confirm(' Backup to cloud?\n\nYes = Cloud backup\nNo = Download file')) {
            await pushDataToCloud();
            return;
        }
    }
        const data = { 
            mfg: db, 
            sales: await idb.get('noman_history', []),
            customerSales: await idb.get('customer_sales', []),
            factoryInventoryData: factoryInventoryData,
            factoryProductionHistory: factoryProductionHistory,
            factoryDefaultFormulas: factoryDefaultFormulas,
            factoryAdditionalCosts: factoryAdditionalCosts,
            factoryCostAdjustmentFactor: factoryCostAdjustmentFactor,
            factorySalePrices: factorySalePrices,
            factoryUnitTracking: factoryUnitTracking,
            paymentEntities: paymentEntities,
            paymentTransactions: paymentTransactions,
            settings: await idb.get('naswar_default_settings', defaultSettings)
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const timestamp = new Date().toISOString().split('T')[0];
    a.download = `NaswarDealers_Backup_${timestamp}.json`;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    alert("Backup created successfully!");
}
async function unifiedRestore(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.mfg && data.sales) {
                if (confirm("This will merge the backup file with your current data.\n\nDeleted items will remain deleted.")) {
                    
                    // 1. FIRST: Update the Graveyard (Tombstones)
                    // If the backup file knows about deleted items, add them to our list
                    if (data.deleted_records && Array.isArray(data.deleted_records)) {
                        data.deleted_records.forEach(id => deletedRecordIds.add(id));
                        await idb.set('deleted_records', Array.from(deletedRecordIds));
                        console.log(`[RESTORE] Merged deletion records. Total tombstoned: ${deletedRecordIds.size}`);
                    }

                    // 2. HELPER: The Gatekeeper Function
                    // Returns TRUE only if the item's ID is NOT in the graveyard
                    const isAlive = (item) => {
                        if (!item || !item.id) return false;
                        if (deletedRecordIds.has(item.id)) {
                            console.log(`[LOCAL RESTORE BLOCKED] Item ${item.id} is deleted. Skipping.`);
                            return false;
                        }
                        return true;
                    };

                    // 3. FILTER & SAVE DATA
                    // We filter every array from the file against the tombstone list
                    
                    const cleanMfg = (data.mfg || []).filter(isAlive);
                    await idb.set('mfg_pro_pkr', cleanMfg);

                    const cleanSales = (data.sales || []).filter(isAlive);
                    await idb.set('noman_history', cleanSales);

                    const cleanCustSales = (data.customerSales || []).filter(isAlive);
                    await idb.set('customer_sales', cleanCustSales);

                    const cleanRepSales = (data.repSales || []).filter(isAlive);
                    await idb.set('rep_sales', cleanRepSales);
                    
                    // Factory Data
                    const cleanFactoryInv = (data.factoryInventoryData || []).filter(isAlive);
                    await idb.set('factory_inventory_data', cleanFactoryInv);

                    const cleanFactoryHist = (data.factoryProductionHistory || []).filter(isAlive);
                    await idb.set('factory_production_history', cleanFactoryHist);

                    // Payments Data
                    // Note: Entities are rarely "deleted" in the same way, but transactions definitely are
                    const cleanPaymentTrans = (data.paymentTransactions || []).filter(isAlive);
                    await idb.set('payment_transactions', cleanPaymentTrans);
                    
                    if (data.paymentEntities) await idb.set('payment_entities', data.paymentEntities);

                    // Settings & Config (These usually don't have IDs to check)
                    if (data.factoryDefaultFormulas) await idb.set('factory_default_formulas', data.factoryDefaultFormulas);
                    if (data.factoryAdditionalCosts) await idb.set('factory_additional_costs', data.factoryAdditionalCosts);
                    if (data.factoryCostAdjustmentFactor) await idb.set('factory_cost_adjustment_factor', data.factoryCostAdjustmentFactor);
                    if (data.factorySalePrices) await idb.set('factory_sale_prices', data.factorySalePrices);
                    if (data.settings) await idb.set('naswar_default_settings', data.settings);
                    
                    // 4. RELOAD EVERYTHING
                    await loadAllData();
                    syncFactoryProductionStats();
                    await refreshAllDisplays();
                    
                    alert(`Restore Complete!\nBlocked ${((data.mfg?.length || 0) - cleanMfg.length)} deleted items from reappearing.`);
                }
            } else { 
                alert("Invalid backup file structure"); 
            }
        } catch (err) { 
            alert("Error reading file: " + err.message); 
            console.error(err);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// --- FACTORY TAB INITIALIZATION FUNCTION ---
function initFactoryTab() {
    const factoryDateInput = document.getElementById('factory-date');
    if (!factoryDateInput.value) {
        const today = new Date().toISOString().split('T')[0];
     
    }
    
    if (!currentFactorySummaryMode) {
        currentFactorySummaryMode = 'all';
    }
    
    refreshFactoryTab();
    
    const toggles = document.querySelectorAll('#tab-factory .section:nth-child(4) .toggle-group .toggle-opt');
    toggles.forEach((opt) => {
        if (opt.textContent.trim().toLowerCase() === 'all times') {
            opt.classList.add('active');
        } else {
            opt.classList.remove('active');
        }
    });
}
// --- UPDATED: TAB NAVIGATION FUNCTION ---
async function showTab(tab) {
    // 1. Hide all tabs initially
    document.getElementById('tab-prod').className = 'hidden';
    document.getElementById('tab-sales').className = 'hidden';
    document.getElementById('tab-calc').className = 'hidden';
    document.getElementById('tab-factory').className = 'hidden';
    document.getElementById('tab-payments').className = 'hidden';
    document.getElementById('tab-rep').className = 'hidden'; // Added rep tab handling

    // 2. Show the selected tab
    const selectedTabElement = document.getElementById('tab-' + tab);
    if (selectedTabElement) selectedTabElement.className = '';

    // 3. Update Bottom Navigation Active States
    document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', 
            (tab === 'prod' && i === 0) || 
            (tab === 'sales' && i === 1) || 
            (tab === 'calc' && i === 2) ||
            (tab === 'factory' && i === 3) ||
            (tab === 'payments' && i === 4) ||
            (tab === 'rep' && i === 5) // New index for Rep Tab
        );
    });
    
    // 4. Smooth scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // 5. Specific Tab Logic
    if(tab === 'sales') { 
        refreshCustomerSales(); 
        updateCustomerCharts(); 
    }
    if(tab === 'calc') await loadSalesData(currentCompMode);
    if(tab === 'prod') refreshUI();
    if(tab === 'factory') initFactoryTab();
    if(tab === 'payments') refreshPaymentTab();
    // 6. REP TAB LOGIC (Updated)
    if(tab === 'rep') {
        const repHeader = document.getElementById('rep-header');
        const adminControls = document.getElementById('admin-rep-controls');
        const newTransCard = document.getElementById('rep-new-transaction-card'); // Get the card

        if (appMode === 'admin') {
            // --- ADMIN VIEW ---
            // Show Admin Controls (Map + Selector)
            if(adminControls) {
                adminControls.classList.remove('hidden');
                adminControls.style.display = 'block';
            }
                  // NEW: Sync Admin Date Picker with Main Date Picker
                const mainDate = document.getElementById('rep-date').value;
                const adminDate = document.getElementById('admin-rep-date');
                if(adminDate && mainDate) {
                    adminDate.value = mainDate;
                }
            
            // Hide "Locked" Header
            if(repHeader) repHeader.style.display = 'none';
            
            // HIDE New Transaction Card in Admin Mode
            if(newTransCard) newTransCard.style.display = 'none';
            
            // Render Map immediately if in Admin View
            setTimeout(() => {
                if (typeof updateRepLiveMap === 'function') updateRepLiveMap();
            }, 200);

        } else {
             // --- REP MODE ---
            // HIDE Admin Controls (Map + Selector)
            if(adminControls) {
                adminControls.classList.add('hidden');
                adminControls.style.display = 'none';
            }
            // SHOW "Locked" Header
            if(repHeader) {
                repHeader.classList.remove('hidden');
                repHeader.style.display = 'flex';
            }
            
            // SHOW New Transaction Card in Rep Mode
            if(newTransCard) newTransCard.style.display = 'block';
        }
        
        // Render data for the active profile
        if(typeof refreshRepUI === 'function') refreshRepUI();
    }
    
    // 7. Sync Notify
    setTimeout(() => notifyDataChange(tab), 100);
}
// --- NEW: Handle Admin Date Change ---
function handleAdminRepDateChange(val) {
    // 1. Update the main (hidden) rep-date input
    // This ensures renderRepHistory() and other functions use the correct date
    const mainInput = document.getElementById('rep-date');
    if(mainInput) {
        mainInput.value = val;
    }

    // 2. Refresh UI (Map and History Tables)
    refreshRepUI();
    
    // 3. Update Map specifically if needed
    if (typeof updateRepLiveMap === 'function') {
        updateRepLiveMap();
    }
}

// --- NEW FUNCTION: ADMIN REP SELECTION ---
function adminSwitchRepProfile(newProfile) {
    if (appMode !== 'admin') return;
    
    currentRepProfile = newProfile;
    
    // Update UI
    refreshRepUI();
    
    // Optional: Visual Feedback
    if(typeof showToast === 'function') {
        showToast(`Viewing dashboard for ${newProfile}`, 'info');
    }
}


    // --- CHARTS AND GRAPHS FUNCTIONS (UPDATED WITH ALL TIMES) ---
    function setMfgChartMode(mode) {
        currentMfgMode = mode;
        document.getElementById('mfg-week-btn').className = `toggle-opt ${mode === 'week' ? 'active' : ''}`;
        document.getElementById('mfg-month-btn').className = `toggle-opt ${mode === 'month' ? 'active' : ''}`;
        document.getElementById('mfg-year-btn').className = `toggle-opt ${mode === 'year' ? 'active' : ''}`;
        document.getElementById('mfg-all-btn').className = `toggle-opt ${mode === 'all' ? 'active' : ''}`;
        updateMfgCharts();
    }

    function updateMfgCharts() {
        if(mfgBarChart) mfgBarChart.destroy();
        if(mfgPieChart) mfgPieChart.destroy();

        let filteredData = currentProductionView === 'combined' ? db : db.filter(item => item.store === currentStore);

        let labels = [], dataQty = [];
        let totalCost = 0, totalProfit = 0, totalValue = 0;
        const selectedDate = document.getElementById('sys-date').value;
        const selectedDateObj = new Date(selectedDate);
        const selectedYear = selectedDateObj.getFullYear();
        const selectedMonth = selectedDateObj.getMonth();
        const selectedDay = selectedDateObj.getDate();
        const colors = {
            text: '#1e3a8a',
            grid: 'rgba(37, 99, 235, 0.1)'
        };

        if (currentMfgMode === 'week') {
            for(let i=6; i>=0; i--) {
                const d = new Date(selectedDateObj);
                d.setDate(selectedDay - i);
                const dateStr = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('en-US', {weekday:'short'}));
                let dayQty = 0;
                filteredData.forEach(item => { 
                    if(item.date === dateStr) { 
                        dayQty += item.net; 
                    } 
                });
                dataQty.push(dayQty);
            }
        } else if (currentMfgMode === 'month') {
            const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
            labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            dataQty = new Array(daysInMonth).fill(0);
            filteredData.forEach(item => {
                const d = new Date(item.date);
                if(d.getMonth() === selectedMonth && d.getFullYear() === selectedYear) {
                    dataQty[d.getDate() - 1] += item.net;
                }
            });
        } else if (currentMfgMode === 'year') {
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            labels = months;
            dataQty = new Array(12).fill(0);
            filteredData.forEach(item => {
                const d = new Date(item.date);
                if(d.getFullYear() === selectedYear) {
                    dataQty[d.getMonth()] += item.net;
                }
            });
        } else if (currentMfgMode === 'all') {
            const monthData = {};
            
            filteredData.forEach(item => {
                const d = new Date(item.date);
                const monthYear = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = `${d.toLocaleDateString('en-US', {month:'short'})} ${d.getFullYear()}`;
                
                if (!monthData[monthYear]) {
                    monthData[monthYear] = {
                        label: monthLabel,
                        qty: 0
                    };
                }
                monthData[monthYear].qty += item.net;
            });
            
            const sortedMonths = Object.keys(monthData).sort();
            sortedMonths.forEach(monthKey => {
                labels.push(monthData[monthKey].label);
                dataQty.push(monthData[monthKey].qty);
            });
            
            if (labels.length > 12) {
                labels = labels.slice(-12);
                dataQty = dataQty.slice(-12);
            }
        }

        filteredData.forEach(item => {
            const d = new Date(item.date);
            const dYear = d.getFullYear();
            const dMonth = d.getMonth();
            const dDay = d.getDate();
            
            let include = false;
            
            if(currentMfgMode === 'week') {
                const weekStart = new Date(selectedDateObj);
                weekStart.setDate(selectedDay - 6);
                if(d >= weekStart && d <= selectedDateObj) include = true;
            }
            if(currentMfgMode === 'month' && dYear === selectedYear && dMonth === selectedMonth) include = true;
            if(currentMfgMode === 'year' && dYear === selectedYear) include = true;
            if(currentMfgMode === 'all') include = true;
            
            if(include) {
                totalCost += item.totalCost;
                totalProfit += item.profit;
                totalValue += item.totalSale;
            }
        });

        mfgBarChart = new Chart(document.getElementById('mfgBarChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Net Production (kg)',
                    data: dataQty,
                    backgroundColor: 'rgba(37, 99, 235, 0.6)',
                    borderColor: '#2563eb',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { labels: { color: colors.text } },
                    title: { 
                        display: true, 
                        text: `Production Quantity (${currentMfgMode === 'all' ? 'All Times' : currentMfgMode.charAt(0).toUpperCase() + currentMfgMode.slice(1)})`, 
                        color: colors.text, 
                        font: { size: 13, weight: 'bold' } 
                    }
                },
                scales: {
                    y: { grid: { color: colors.grid }, ticks: { color: colors.text }, beginAtZero: true },
                    x: { ticks: { color: colors.text, maxRotation: currentMfgMode === 'all' ? 45 : 0 } }
                }
            }
        });

        const pieData = [totalCost, totalProfit];
        const pieLabels = ['Total Cost', 'Net Profit'];
        
        mfgPieChart = new Chart(document.getElementById('mfgPieChart'), {
            type: 'pie',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: ['#dc2626', '#2563eb'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position:'bottom', labels: { color: colors.text, font: { size: 10 } } },
                    title: { 
                        display: true, 
                        text: mfgPieChartShowPercentage ? 
                            `Financials (Percentage) - ${currentMfgMode === 'all' ? 'All Times' : currentMfgMode.charAt(0).toUpperCase() + currentMfgMode.slice(1)}` : 
                            `Financials: Rs ${safeValue(totalValue).toFixed(0)} Total - ${currentMfgMode === 'all' ? 'All Times' : currentMfgMode.charAt(0).toUpperCase() + currentMfgMode.slice(1)}`, 
                        color: colors.text,
                        font: { size: 13, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (mfgPieChartShowPercentage) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${percentage}%`;
                                } else {
                                    return `${context.label}: Rs ${context.parsed.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            }
        });
        
        if (mfgPieChartShowPercentage) {
            updateMfgPieChart();
        }
    }
        // --- HELPER FUNCTIONS ---
function getCostPerUnit(storeType) {
    const formula = factoryDefaultFormulas[storeType];
    if (!formula || formula.length === 0) return 0;
    
    let totalMaterialCost = 0;
    formula.forEach(item => {
        totalMaterialCost += (item.cost * item.quantity);
    });
    
    const additionalCost = factoryAdditionalCosts[storeType] || 0;
    return totalMaterialCost + additionalCost;
}

function getWeightPerUnit(storeType) {
    const formula = factoryDefaultFormulas[storeType];
    if (!formula || formula.length === 0) return 0;
    
    let totalWeight = 0;
    formula.forEach(item => {
        totalWeight += item.quantity;
    });
    return totalWeight;
}

function getPreviousDayAvailableUnits(storeType, currentDate) {
    const previousDate = new Date(currentDate);
    previousDate.setDate(previousDate.getDate() - 1);
    const previousDateStr = previousDate.toISOString().split('T')[0];
    
    // Get previous day's data
    const prevProduction = db.filter(item => item.date === previousDateStr);
    const prevFactoryProduction = factoryProductionHistory.filter(item => item.date === previousDateStr);
    
    // Calculate previous day's available units
    const prevUsed = prevProduction.filter(item => item.formulaStore === storeType)
        .reduce((sum, item) => sum + (item.formulaUnits || 0), 0);
    const prevProduced = prevFactoryProduction.filter(item => item.store === storeType)
        .reduce((sum, item) => sum + (item.units || 0), 0);
    
    // Recursively get previous day's previous available
    if (previousDate >= new Date('2020-01-01')) { // Set a reasonable start date
        const prevPrevAvailable = getPreviousDayAvailableUnits(storeType, previousDate);
        return Math.max(0, prevPrevAvailable + prevProduced - prevUsed);
    }
    
    return 0; // Base case for earliest date
}

// --- FACTORY TAB: DATE-BASED STATISTICS (UPDATED FOR CONSISTENCY) ---
async function updateFactoryUnitsAvailableStats() {
    // --- STANDARD STORE CALCULATIONS ---
    // Get data from PRODUCTION TAB (db) for consistency
    const stdProductionData = db.filter(item => {
        // Standard store includes STORE_A and STORE_B
        return item.store === 'STORE_A' || item.store === 'STORE_B';
    });
    
    // Calculate from Factory Production History
    const stdProducedUnits = factoryProductionHistory
        .filter(item => item.store === 'standard')
        .reduce((sum, item) => sum + (item.units || 0), 0);
    
    // CONSISTENT: Use Production Tab data
    const stdUsedUnits = stdProductionData.reduce((sum, item) => sum + (item.formulaUnits || 0), 0);
    const stdOutputQuantity = stdProductionData.reduce((sum, item) => sum + (item.net || 0), 0);
    const stdTotalCost = stdProductionData.reduce((sum, item) => sum + (item.totalCost || 0), 0);
    const stdTotalSaleValue = stdProductionData.reduce((sum, item) => sum + (item.totalSale || 0), 0);
    const stdTotalProfit = stdProductionData.reduce((sum, item) => sum + (item.profit || 0), 0);
    
    const stdAvailableUnits = Math.max(0, stdProducedUnits - stdUsedUnits);
    
    // Per unit calculations
    const stdCostPerUnit = getCostPerUnit('standard');
    const stdTotalCostValue = stdCostPerUnit * stdAvailableUnits;
    const stdProfitPerKg = stdOutputQuantity > 0 ? stdTotalProfit / stdOutputQuantity : 0;
    const stdProfitPerUnit = stdUsedUnits > 0 ? stdTotalProfit / stdUsedUnits : 0;
    
    // Raw materials
    const stdWeightPerUnit = getWeightPerUnit('standard');
    const stdRawMaterialsUsed = stdWeightPerUnit * stdUsedUnits;
    const stdMaterialsValue = stdTotalCost; // Use actual cost from production tab
    
    // Update DOM for Standard Store
    document.getElementById('factoryStdUnits').innerText = stdAvailableUnits.toFixed(2);
    document.getElementById('factoryStdUsedUnits').innerText = stdUsedUnits.toFixed(2);
    document.getElementById('factoryStdUnitCost').innerText = await formatCurrency(stdCostPerUnit);
    document.getElementById('factoryStdTotalVal').innerText = await formatCurrency(stdTotalCostValue);
    document.getElementById('factoryStdOutput').innerText = stdOutputQuantity.toFixed(3) + ' kg';
    document.getElementById('factoryStdRawUsed').innerText = stdRawMaterialsUsed.toFixed(3) + ' kg';
    document.getElementById('factoryStdMatVal').innerText = await formatCurrency(stdMaterialsValue);
    document.getElementById('factoryStdProfit').innerText = await formatCurrency(stdTotalProfit);
    document.getElementById('factoryStdProfitUnit').innerText = await formatCurrency(stdProfitPerKg) + '/kg';

    // --- ASAAN STORE CALCULATIONS ---
    // Get data from PRODUCTION TAB (db) for consistency
    const asaanProductionData = db.filter(item => item.store === 'STORE_C');
    
    // Calculate from Factory Production History
    const asaanProducedUnits = factoryProductionHistory
        .filter(item => item.store === 'asaan')
        .reduce((sum, item) => sum + (item.units || 0), 0);
    
    // CONSISTENT: Use Production Tab data
    const asaanUsedUnits = asaanProductionData.reduce((sum, item) => sum + (item.formulaUnits || 0), 0);
    const asaanOutputQuantity = asaanProductionData.reduce((sum, item) => sum + (item.net || 0), 0);
    const asaanTotalCost = asaanProductionData.reduce((sum, item) => sum + (item.totalCost || 0), 0);
    const asaanTotalSaleValue = asaanProductionData.reduce((sum, item) => sum + (item.totalSale || 0), 0);
    const asaanTotalProfit = asaanProductionData.reduce((sum, item) => sum + (item.profit || 0), 0);
    
    const asaanAvailableUnits = Math.max(0, asaanProducedUnits - asaanUsedUnits);
    
    // Per unit calculations
    const asaanCostPerUnit = getCostPerUnit('asaan');
    const asaanTotalCostValue = asaanCostPerUnit * asaanAvailableUnits;
    const asaanProfitPerKg = asaanOutputQuantity > 0 ? asaanTotalProfit / asaanOutputQuantity : 0;
    const asaanProfitPerUnit = asaanUsedUnits > 0 ? asaanTotalProfit / asaanUsedUnits : 0;
    
    // Raw materials
    const asaanWeightPerUnit = getWeightPerUnit('asaan');
    const asaanRawMaterialsUsed = asaanWeightPerUnit * asaanUsedUnits;
    const asaanMaterialsValue = asaanTotalCost; // Use actual cost from production tab
    
    // Update DOM for Asaan Store
    document.getElementById('factoryAsaanUnits').innerText = asaanAvailableUnits.toFixed(2);
    document.getElementById('factoryAsaanUsedUnits').innerText = asaanUsedUnits.toFixed(2);
    document.getElementById('factoryAsaanUnitCost').innerText = await formatCurrency(asaanCostPerUnit);
    document.getElementById('factoryAsaanTotalVal').innerText = await formatCurrency(asaanTotalCostValue);
    document.getElementById('factoryAsaanOutput').innerText = asaanOutputQuantity.toFixed(3) + ' kg';
    document.getElementById('factoryAsaanRawUsed').innerText = asaanRawMaterialsUsed.toFixed(3) + ' kg';
    document.getElementById('factoryAsaanMatVal').innerText = await formatCurrency(asaanMaterialsValue);
    document.getElementById('factoryAsaanProfit').innerText = await formatCurrency(asaanTotalProfit);
    document.getElementById('factoryAsaanProfitUnit').innerText = await formatCurrency(asaanProfitPerKg) + '/kg';
}

// --- FACTORY SUMMARY CARD (UPDATED FOR CONSISTENCY) ---
async function updateFactorySummaryCard() {
    const mode = currentFactorySummaryMode || 'all';
    const selectedDateVal = document.getElementById('factory-date').value || new Date().toISOString().split('T')[0];
    const selectedDate = new Date(selectedDateVal);
    const selectedYear = selectedDate.getFullYear();
    const selectedMonth = selectedDate.getMonth();
    const selectedDay = selectedDate.getDate();
    
    let totalProduced = 0, totalConsumed = 0, totalCost = 0, totalOutput = 0, totalProfit = 0;
    let totalRawUsed = 0, totalMatValue = 0, totalSaleValue = 0;
    
    // Count produced units from factory
    factoryProductionHistory.forEach(entry => {
        const entryDate = new Date(entry.date);
        let include = false;
        
        if (mode === 'daily' && entry.date === selectedDateVal) include = true;
        else if (mode === 'weekly') {
            const weekStart = new Date(selectedDate);
            weekStart.setDate(selectedDay - 6);
            if (entryDate >= weekStart && entryDate <= selectedDate) include = true;
        }
        else if (mode === 'monthly' && entryDate.getMonth() === selectedMonth && entryDate.getFullYear() === selectedYear) include = true;
        else if (mode === 'yearly' && entryDate.getFullYear() === selectedYear) include = true;
        else if (mode === 'all') include = true;
        
        if (include) {
            totalProduced += entry.units || 0;
        }
    });
    
    // CONSISTENT: Get all values from Production Tab (db)
    db.forEach(entry => {
        const entryDate = new Date(entry.date);
        let include = false;
        
        if (mode === 'daily' && entry.date === selectedDateVal) include = true;
        else if (mode === 'weekly') {
            const weekStart = new Date(selectedDate);
            weekStart.setDate(selectedDay - 6);
            if (entryDate >= weekStart && entryDate <= selectedDate) include = true;
        }
        else if (mode === 'monthly' && entryDate.getMonth() === selectedMonth && entryDate.getFullYear() === selectedYear) include = true;
        else if (mode === 'yearly' && entryDate.getFullYear() === selectedYear) include = true;
        else if (mode === 'all') include = true;
        
        if (include) {
            // Use ACTUAL values from production tab
            totalConsumed += entry.formulaUnits || 0;
            totalOutput += entry.net || 0;
            totalCost += entry.totalCost || 0;
            totalSaleValue += entry.totalSale || 0;
            totalProfit += entry.profit || 0;
            
            // Calculate raw materials
            const formulaStore = entry.formulaStore || (entry.store === 'STORE_C' ? 'asaan' : 'standard');
            const weightPerUnit = getWeightPerUnit(formulaStore);
            totalRawUsed += weightPerUnit * (entry.formulaUnits || 0);
        }
    });
    
    totalMatValue = totalCost; // Use actual cost from production
    
    const totalAvailable = Math.max(0, totalProduced - totalConsumed);
    const avgCostPerUnit = totalConsumed > 0 ? totalCost / totalConsumed : 0;
    const avgProfitPerKg = totalOutput > 0 ? totalProfit / totalOutput : 0;
    
    document.getElementById('factorySumUnits').innerText = totalAvailable.toFixed(2);
    document.getElementById('factorySumUsedUnits').innerText = totalConsumed.toFixed(2);
    document.getElementById('factorySumUnitCost').innerText = await formatCurrency(avgCostPerUnit);
    document.getElementById('factorySumTotalCost').innerText = await formatCurrency(totalCost);
    document.getElementById('factorySumOutput').innerText = totalOutput.toFixed(3) + ' kg';
    document.getElementById('factorySumRawUsed').innerText = totalRawUsed.toFixed(3) + ' kg';
    document.getElementById('factorySumMatVal').innerText = await formatCurrency(totalMatValue);
    document.getElementById('factorySumProfit').innerText = await formatCurrency(totalProfit);
    document.getElementById('factorySumProfitUnit').innerText = await formatCurrency(avgProfitPerKg) + '/kg';
}

// Helper function to get initial available units for a date range
function getInitialAvailableForRange(storeType, mode, endDate) {
    const end = new Date(endDate);
    let startDate = new Date(end);
    
    if (mode === 'weekly') {
        startDate.setDate(end.getDate() - 6);
    } else if (mode === 'monthly') {
        startDate = new Date(end.getFullYear(), end.getMonth(), 1);
    } else if (mode === 'yearly') {
        startDate = new Date(end.getFullYear(), 0, 1);
    }
    
    // Get available units at the start of the range
    return getPreviousDayAvailableUnits(storeType, startDate);
}

// --- REFRESH FACTORY TAB ---
function refreshFactoryTab() {
    const factoryDateInput = document.getElementById('factory-date');
    if (!factoryDateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        factoryDateInput.value = today;
        currentFactoryDate = today;
    } else {
        currentFactoryDate = factoryDateInput.value;
    }
    
    // Update all factory displays with CONSISTENT data
    updateFactoryUnitsAvailableStats();
    updateFactorySummaryCard();
    renderFactoryHistory();
    renderFactoryInventory();
    calculateFactoryProduction();
}

// --- UPDATE ALL TABS WITH FACTORY COSTS (CALL AFTER ANY CHANGE) ---
function updateAllTabsWithFactoryCosts() {
    const storeSelector = document.getElementById('storeSelector');
    if (storeSelector) {
        updateUnitsAvailableIndicator();
        updateProductionCostOnStoreChange();
    }
    
    const supplyStore = document.querySelector('input[name="supply-store"]:checked');
    if (supplyStore) {
        calculateCustomerSale();
    }
    
    calculateSales();
    updateFactoryUnitsAvailableStats(); // Ensures consistency
    updateFactorySummaryCard();
    refreshUI(); // Refresh production tab to sync
}

// --- INITIALIZE FACTORY TAB ---
function initFactoryTab() {
    // Set default date to today if not already set
    const factoryDateInput = document.getElementById('factory-date');
    if (!factoryDateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        factoryDateInput.value = today;
        currentFactoryDate = today;
    }
    
    // Refresh factory displays with CONSISTENT data
    refreshFactoryTab();
    
    // Initialize toggles
    document.querySelectorAll('#tab-factory .toggle-group .toggle-opt').forEach((opt, index) => {
        if (index === 0) opt.classList.add('active');
        else opt.classList.remove('active');
    });
}


    // --- PRODUCTION VIEW TOGGLE ---
    function setProductionView(view, event) {
        currentProductionView = view;
        
        document.querySelectorAll('.production-toggle-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        if (event && event.target) {
            event.target.classList.add('active');
        }
        
        const entrySection = document.getElementById('production-entry-section');
        if (view === 'store') {
            entrySection.classList.remove('hidden');
        } else {
            entrySection.classList.add('hidden');
        }
        
        refreshUI();
    }
function updateAllStoresOverview(mode = 'day') {
    currentOverviewMode = mode;
    
    const selectedDate = document.getElementById('sys-date').value;
    const selectedDateObj = new Date(selectedDate);
    const selectedYear = selectedDateObj.getFullYear();
    const selectedMonth = selectedDateObj.getMonth();
    
    const stores = ['STORE_A', 'STORE_B', 'STORE_C'];
    const storeNames = ['ZUBAIR', 'MAHMOOD', 'ASAAN'];
    const storeColors = ['store-a', 'store-b', 'store-c'];
    
    // FIX 1: Initialize Combined Totals with 'sold' and 'productionCredit'
    let totalCombined = {
        production: 0,
        returns: 0,
        sold: 0,          // Added: Track combined sales
        qty: 0,           // Total In (Prod + Returns)
        value: 0,
        cost: 0,
        profit: 0,
        formulaUnits: 0,
        formulaCost: 0,
        productionCredit: 0 // Added: Track combined credit (if applicable)
    };

    const allStoresGrid = document.getElementById('all-stores-grid');
    allStoresGrid.innerHTML = '';
    
    const allTimesCard = document.getElementById('all-times-production-card');
    if (allTimesCard) {
        allTimesCard.style.display = (mode === 'all') ? '' : 'none';
    }
    
    stores.forEach((store, index) => {
        // Initialize Store Data
        let storeData = {
            production: 0, 
            returns: 0,    
            sold: 0,      // Added for local calculation
            value: 0,
            cost: 0,
            profit: 0,
            formulaUnits: 0,
            formulaCost: 0,
            productionCredit: 0
        };
        
        // 1. SCAN PRODUCTION DB (Inventory IN & Credit Logic)
        db.forEach(item => {
            const itemDate = new Date(item.date);
            const itemYear = itemDate.getFullYear();
            const itemMonth = itemDate.getMonth();
            
            let includeItem = false;
            
            // STRICT DATE FILTERING
            if (mode === 'day' && item.date === selectedDate) includeItem = true;
            else if (mode === 'week') {
                const weekStart = new Date(selectedDateObj);
                weekStart.setDate(selectedDateObj.getDate() - 6);
                if (itemDate >= weekStart && itemDate <= selectedDateObj) includeItem = true;
            }
            else if (mode === 'month' && itemYear === selectedYear && itemMonth === selectedMonth) includeItem = true;
            else if (mode === 'year' && itemYear === selectedYear) includeItem = true;
            else if (mode === 'all') includeItem = true;
            
            // STRICT STORE FILTERING
            if (includeItem && item.store === store) {
                if (item.isReturn) {
                    storeData.returns += item.net;
                    
                    // FIX 2: SUBTRACT Credit on Returns for Store C
                    // If goods are returned, the credit/debt associated with them should decrease
                    if (store === 'STORE_C') {
                        storeData.productionCredit -= (item.totalSale || 0);
                    }
                } else {
                    storeData.production += item.net;
                    storeData.formulaUnits += (item.formulaUnits || 0);
                    storeData.formulaCost += (item.formulaCost || 0);
                    
                    // ADD Credit on Production for Store C
                    if (store === 'STORE_C' && item.paymentStatus === 'CREDIT') {
                        storeData.productionCredit += (item.totalSale || 0);
                    }
                }
                
                // Aggregates (Value/Cost/Profit)
                // Note: For returns, these add to the "Inventory Value" available
                storeData.value += item.totalSale;
                storeData.cost += item.totalCost;
                storeData.profit += item.profit;
            }
        });

        // 2. SCAN SALES DB (Inventory OUT)
        let soldQty = 0;

        customerSales.forEach(sale => {
            // ISOLATION: Ignore Rep Mode sales for inventory
            if (sale.isRepModeEntry === true) return;
            
            const saleDate = new Date(sale.date);
            const saleYear = saleDate.getFullYear();
            const saleMonth = saleDate.getMonth();
            
            let includeSale = false;

            if (mode === 'day' && sale.date === selectedDate) includeSale = true;
            else if (mode === 'week') {
                const weekStart = new Date(selectedDateObj);
                weekStart.setDate(selectedDateObj.getDate() - 6);
                if (saleDate >= weekStart && saleDate <= selectedDateObj) includeSale = true;
            }
            else if (mode === 'month' && saleYear === selectedYear && saleMonth === selectedMonth) includeSale = true;
            else if (mode === 'year' && saleYear === selectedYear) includeSale = true;
            else if (mode === 'all') includeSale = true;

            if (includeSale && sale.supplyStore === store) {
                soldQty += (sale.quantity || 0);
            }
        });

        storeData.sold = soldQty;

        // 3. Calculate Remaining (Current Stock)
        const totalIn = storeData.production + storeData.returns;
        const remainingQty = totalIn - soldQty;

        // 4. Update Combined Totals (FIX 3: Accumulate Sold and Credit)
        totalCombined.production += storeData.production;
        totalCombined.returns += storeData.returns;
        totalCombined.sold += storeData.sold; // Fixed: Now summing sold qty
        totalCombined.qty += totalIn;
        totalCombined.value += storeData.value;
        totalCombined.cost += storeData.cost;
        totalCombined.profit += storeData.profit;
        totalCombined.formulaUnits += storeData.formulaUnits;
        totalCombined.formulaCost += storeData.formulaCost;
        totalCombined.productionCredit += storeData.productionCredit;
        
        // 5. Build HTML for Individual Stores
        let extraInfoHtml = '';
        if (store === 'STORE_C') {
            extraInfoHtml = `<p><span>Production Credit:</span> <span style="color:var(--warning); font-weight:800;">Rs ${safeValue(storeData.productionCredit).toFixed(2)}</span></p>`;
        }

        let returnsHtml = '';
        if (storeData.returns > 0) {
            returnsHtml = `<p><span>Returns Recvd:</span> <span style="color:#10b981; font-weight:800;">+${safeValue(storeData.returns).toFixed(2)} kg</span></p>`;
        }

        const card = document.createElement('div');
        card.className = `overview-card liquid-card`;
        
        card.innerHTML = `
            <span class="store-badge ${storeColors[index]}">${storeNames[index]}</span>
            <h4>${storeNames[index]} (${mode === 'all' ? 'All Times' : mode.charAt(0).toUpperCase() + mode.slice(1)})</h4>
            
            <p><span>Produced:</span> <span class="qty-val" style="color:var(--text-main);">${safeValue(storeData.production).toFixed(2)} kg</span></p>
            ${returnsHtml}
            <p><span>Sold (Sales Tab):</span> <span class="cost-val">${safeValue(soldQty).toFixed(2)} kg</span></p>
            
            <div style="border-top:1px dashed var(--glass-border); margin:4px 0; padding-top:4px;">
                <p><span>Remaining:</span> <span class="profit-val" style="font-size:1.1rem;">${safeValue(remainingQty).toFixed(2)} kg</span></p>
            </div>
            
            <div style="background:rgba(37,99,235,0.03); padding:5px; border-radius:6px; margin:5px 0;">
                <p><span>Formula Units:</span> <span class="qty-val" style="font-weight:700;">${safeValue(storeData.formulaUnits).toFixed(2)}</span></p>
                <p><span>Formula Cost:</span> <span class="cost-val" style="font-weight:700;">Rs ${safeValue(storeData.formulaCost).toFixed(2)}</span></p>
            </div>

            <hr>
            <p><span>Total Value:</span> <span class="rev-val">Rs ${safeValue(storeData.value).toFixed(2)}</span></p>
            ${extraInfoHtml}
            <p><span>Net Profit:</span> <span class="profit-val">Rs ${safeValue(storeData.profit).toFixed(2)}</span></p>
        `;
        allStoresGrid.appendChild(card);
    });
    
    // 6. Build Combined Card (FIXED: Now includes Sold and Remaining)
    const combinedRemaining = totalCombined.qty - totalCombined.sold;
    
    const combinedCard = document.createElement('div');
    combinedCard.className = `overview-card liquid-card highlight-card`;
    combinedCard.innerHTML = `
        <h4 style="color: var(--accent);">Total Combined</h4>
        <p><span>Fresh Production:</span> <span class="qty-val">${safeValue(totalCombined.production).toFixed(3)} kg</span></p>
        ${totalCombined.returns > 0 ? `<p><span>Total Returns:</span> <span style="color:#10b981; font-weight:800;">+${safeValue(totalCombined.returns).toFixed(3)} kg</span></p>` : ''}
        <p><span>Total Sold:</span> <span class="cost-val">${safeValue(totalCombined.sold).toFixed(3)} kg</span></p>
        
        <div style="border-top:1px dashed var(--glass-border); margin:4px 0; padding-top:4px;">
             <p><span>Total Remaining:</span> <span class="profit-val" style="font-size:1.1rem;">${safeValue(combinedRemaining).toFixed(3)} kg</span></p>
        </div>

        <p><span>Total Formula Units:</span> <span class="qty-val">${safeValue(totalCombined.formulaUnits).toFixed(2)}</span></p>
        <p><span>Total Formula Cost:</span> <span class="cost-val">Rs ${safeValue(totalCombined.formulaCost).toFixed(2)}</span></p>
        <hr style="margin:8px 0;">
        
        <p><span>Total Value:</span> <span class="rev-val">Rs ${safeValue(totalCombined.value).toFixed(2)}</span></p>
        ${totalCombined.productionCredit > 0 ? `<p><span>Total Credit:</span> <span style="color:var(--warning); font-weight:800;">Rs ${safeValue(totalCombined.productionCredit).toFixed(2)}</span></p>` : ''}
        <p><span>Total Cost:</span> <span class="cost-val">Rs ${safeValue(totalCombined.cost).toFixed(2)}</span></p>
        <p><span>Net Profit:</span> <span class="profit-val">Rs ${safeValue(totalCombined.profit).toFixed(2)}</span></p>
    `;
    allStoresGrid.appendChild(combinedCard);
    
    updateStoreComparisonChart(mode);
}




    // --- CUSTOMER SALES FUNCTIONS (UPDATED WITH ALL TIMES) ---
    function setCustomerChartMode(mode) {
        currentCustomerChartMode = mode;
        document.getElementById('cust-week-btn').className = `toggle-opt ${mode === 'week' ? 'active' : ''}`;
        document.getElementById('cust-month-btn').className = `toggle-opt ${mode === 'month' ? 'active' : ''}`;
        document.getElementById('cust-year-btn').className = `toggle-opt ${mode === 'year' ? 'active' : ''}`;
        document.getElementById('cust-all-btn').className = `toggle-opt ${mode === 'all' ? 'active' : ''}`;
        updateCustomerCharts();
    }

    function updateCustomerCharts() {
        if(custSalesChart) custSalesChart.destroy();
        if(custPaymentChart) custPaymentChart.destroy();

        const selectedDate = document.getElementById('cust-date').value;
        if (!selectedDate) return;
        
        const selectedDateObj = new Date(selectedDate);
        const selectedYear = selectedDateObj.getFullYear();
        const selectedMonth = selectedDateObj.getMonth();
        const selectedDay = selectedDateObj.getDate();
        
        let labels = [], cashData = [], creditData = [];
        let totalCash = 0, totalCredit = 0;
        const colors = {
            text: '#1e3a8a',
            grid: 'rgba(37, 99, 235, 0.1)'
        };

        if (currentCustomerChartMode === 'week') {
            for(let i=6; i>=0; i--) {
                const d = new Date(selectedDateObj);
                d.setDate(selectedDay - i);
                const dateStr = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('en-US', {weekday:'short'}));
                let dayCash = 0, dayCredit = 0;
                customerSales.forEach(item => { 
                    if(item.date === dateStr) {
                        if(item.paymentType === 'CASH' || item.creditReceived) {
                            dayCash += item.totalValue;
                        } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
                            dayCredit += item.totalValue;
                        }
                    }
                });
                cashData.push(dayCash);
                creditData.push(dayCredit);
            }
        } else if (currentCustomerChartMode === 'month') {
            const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
            labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            cashData = new Array(daysInMonth).fill(0);
            creditData = new Array(daysInMonth).fill(0);
            customerSales.forEach(item => {
                const d = new Date(item.date);
                if(d.getMonth() === selectedMonth && d.getFullYear() === selectedYear) {
                    if(item.paymentType === 'CASH' || item.creditReceived) {
                        cashData[d.getDate() - 1] += item.totalValue;
                    } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
                        creditData[d.getDate() - 1] += item.totalValue;
                    }
                }
            });
        } else if (currentCustomerChartMode === 'year') {
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            labels = months;
            cashData = new Array(12).fill(0);
            creditData = new Array(12).fill(0);
            customerSales.forEach(item => {
                const d = new Date(item.date);
                if(d.getFullYear() === selectedYear) {
                    if(item.paymentType === 'CASH' || item.creditReceived) {
                        cashData[d.getMonth()] += item.totalValue;
                    } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
                        creditData[d.getMonth()] += item.totalValue;
                    }
                }
            });
        } else if (currentCustomerChartMode === 'all') {
            const monthData = {};
            
            customerSales.forEach(item => {
                const d = new Date(item.date);
                const monthYear = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = `${d.toLocaleDateString('en-US', {month:'short'})} ${d.getFullYear()}`;
                
                if (!monthData[monthYear]) {
                    monthData[monthYear] = {
                        label: monthLabel,
                        cash: 0,
                        credit: 0
                    };
                }
                
                if(item.paymentType === 'CASH' || item.creditReceived) {
                    monthData[monthYear].cash += item.totalValue;
                } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
                    monthData[monthYear].credit += item.totalValue;
                }
            });
            
            const sortedMonths = Object.keys(monthData).sort();
            sortedMonths.forEach(monthKey => {
                labels.push(monthData[monthKey].label);
                cashData.push(monthData[monthKey].cash);
                creditData.push(monthData[monthKey].credit);
            });
            
            if (labels.length > 12) {
                labels = labels.slice(-12);
                cashData = cashData.slice(-12);
                creditData = creditData.slice(-12);
            }
        }

        customerSales.forEach(item => {
        // FILTER: Exclude Rep Data from Charts
        if (item.isRepModeEntry === true || (item.salesRep && item.salesRep !== 'NONE')) return;
            const d = new Date(item.date);
            const dYear = d.getFullYear();
            const dMonth = d.getMonth();
            const dDay = d.getDate();
            
            let include = false;
            
            if(currentCustomerChartMode === 'week') {
                const weekStart = new Date(selectedDateObj);
                weekStart.setDate(selectedDay - 6);
                if(d >= weekStart && d <= selectedDateObj) include = true;
            }
            if(currentCustomerChartMode === 'month' && dYear === selectedYear && dMonth === selectedMonth) include = true;
            if(currentCustomerChartMode === 'year' && dYear === selectedYear) include = true;
            if(currentCustomerChartMode === 'all') include = true;
            
            if(include) {
                if(item.paymentType === 'CASH' || item.creditReceived) {
                    totalCash += item.totalValue;
                } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
                    totalCredit += item.totalValue;
                }
            }
        });

        custSalesChart = new Chart(document.getElementById('custSalesChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Cash Sales (Inc. Received Credits)',
                        data: cashData,
                        backgroundColor: 'rgba(5, 150, 105, 0.6)',
                        borderColor: '#059669',
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: 'Pending Credits',
                        data: creditData,
                        backgroundColor: 'rgba(245, 158, 11, 0.6)',
                        borderColor: '#f59e0b',
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { labels: { color: colors.text, font: { size: 10 } } },
                    title: { 
                        display: true, 
                        text: `Sales by Payment Type (${currentCustomerChartMode === 'all' ? 'All Times' : currentCustomerChartMode.charAt(0).toUpperCase() + currentCustomerChartMode.slice(1)})`, 
                        color: colors.text,
                        font: { size: 13, weight: 'bold' }
                    }
                },
                scales: {
                    y: { 
                        stacked: true,
                        grid: { color: colors.grid }, 
                        ticks: { color: colors.text }, 
                        beginAtZero: true 
                    },
                    x: { 
                        stacked: true,
                        ticks: { color: colors.text, maxRotation: currentCustomerChartMode === 'all' ? 45 : 0 } 
                    }
                }
            }
        });

        const pieData = [totalCash, totalCredit];
        const pieLabels = ['Cash Sales (Inc. Received Credits)', 'Pending Credits'];
        
        custPaymentChart = new Chart(document.getElementById('custPaymentChart'), {
            type: 'pie',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: ['#059669', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position:'bottom', labels: { color: colors.text, font: { size: 10 } } },
                    title: { 
                        display: true, 
                        text: custPaymentChartShowPercentage ? 
                            `Payment Distribution (Percentage) - ${currentCustomerChartMode === 'all' ? 'All Times' : ''}` : 
                            `Total: Rs ${safeValue(totalCash + totalCredit).toFixed(0)} - ${currentCustomerChartMode === 'all' ? 'All Times' : ''}`, 
                        color: colors.text,
                        font: { size: 13, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (custPaymentChartShowPercentage) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${percentage}%`;
                                } else {
                                    return `${context.label}: Rs ${context.parsed.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            }
        });
        
        if (custPaymentChartShowPercentage) {
            updateCustomerPieChart();
        }
    }

    function refreshCustomerSales() {
    const selectedDate = document.getElementById('cust-date').value;
    if (!selectedDate) return;
    
    const selectedDateObj = new Date(selectedDate);
    const selectedYear = selectedDateObj.getFullYear();
    const selectedMonth = selectedDateObj.getMonth();
    const selectedDay = selectedDateObj.getDate();
    
    const weekStart = new Date(selectedDateObj);
    weekStart.setDate(selectedDay - 6);
    
    let stats = {
        day: {q:0, v:0, cash:0, credit:0, profit:0},
        week: {q:0, v:0, cash:0, credit:0, profit:0},
        month: {q:0, v:0, cash:0, credit:0, profit:0},
        year: {q:0, v:0, cash:0, credit:0, profit:0},
        all: {q:0, v:0, cash:0, credit:0, profit:0}
    };

    const histContainer = document.getElementById('custHistoryList');
    histContainer.innerHTML = '';

    const sortedSales = [...customerSales].sort((a,b) => {
        if (a.date === selectedDate && b.date !== selectedDate) return -1;
        if (a.date !== selectedDate && b.date === selectedDate) return 1;
        return b.timestamp - a.timestamp;
    });

    sortedSales.forEach(item => {
        // --- STRICT FILTER: Exclude Rep Data from Summaries ---
        // Exclude if tagged as Rep Mode OR if a specific Sales Rep is assigned
        if (item.isRepModeEntry === true || (item.salesRep && item.salesRep !== 'NONE')) return;
        
        const rowDate = new Date(item.date);
        const rowYear = rowDate.getFullYear();
        const rowMonth = rowDate.getMonth();
        const rowDay = rowDate.getDate();

        if(item.date === selectedDate) {
            stats.day.q += item.quantity;
            stats.day.v += item.totalValue;
            stats.day.profit += item.profit;
            if(item.paymentType === 'CASH' || item.creditReceived) {
                stats.day.cash += item.totalValue;
            } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
                stats.day.credit += item.totalValue;
            }
        }

        if(rowDate >= weekStart && rowDate <= selectedDateObj) {
            stats.week.q += item.quantity;
            stats.week.v += item.totalValue;
            stats.week.profit += item.profit;
            if(item.paymentType === 'CASH' || item.creditReceived) {
                stats.week.cash += item.totalValue;
            } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
                stats.week.credit += item.totalValue;
            }
        }

        if(rowYear === selectedYear && rowMonth === selectedMonth) {
            stats.month.q += item.quantity;
            stats.month.v += item.totalValue;
            stats.month.profit += item.profit;
            if(item.paymentType === 'CASH' || item.creditReceived) {
                stats.month.cash += item.totalValue;
            } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
                stats.month.credit += item.totalValue;
            }
        }

        if(rowYear === selectedYear) {
            stats.year.q += item.quantity;
            stats.year.v += item.totalValue;
            stats.year.profit += item.profit;
            if(item.paymentType === 'CASH' || item.creditReceived) {
                stats.year.cash += item.totalValue;
            } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
                stats.year.credit += item.totalValue;
            }
        }
        
        stats.all.q += item.quantity;
        stats.all.v += item.totalValue;
        stats.all.profit += item.profit;
        if(item.paymentType === 'CASH' || item.creditReceived) {
            stats.all.cash += item.totalValue;
        } else if(item.paymentType === 'CREDIT' && !item.creditReceived) {
            stats.all.credit += item.totalValue;
        }
    });

    document.getElementById('cust-day-qty').innerText = safeValue(stats.day.q).toFixed(2) + ' kg';
    document.getElementById('cust-day-value').innerText = 'Rs ' + safeValue(stats.day.v).toFixed(2);
    document.getElementById('cust-day-cash').innerText = 'Rs ' + safeValue(stats.day.cash).toFixed(2);
    document.getElementById('cust-day-credit').innerText = 'Rs ' + safeValue(stats.day.credit).toFixed(2);
    document.getElementById('cust-day-profit').innerText = 'Rs ' + safeValue(stats.day.profit).toFixed(2);

    document.getElementById('cust-week-qty').innerText = safeValue(stats.week.q).toFixed(2) + ' kg';
    document.getElementById('cust-week-value').innerText = 'Rs ' + safeValue(stats.week.v).toFixed(2);
    document.getElementById('cust-week-cash').innerText = 'Rs ' + safeValue(stats.week.cash).toFixed(2);
    document.getElementById('cust-week-credit').innerText = 'Rs ' + safeValue(stats.week.credit).toFixed(2);
    document.getElementById('cust-week-profit').innerText = 'Rs ' + safeValue(stats.week.profit).toFixed(2);

    document.getElementById('cust-month-qty').innerText = safeValue(stats.month.q).toFixed(2) + ' kg';
    document.getElementById('cust-month-value').innerText = 'Rs ' + safeValue(stats.month.v).toFixed(2);
    document.getElementById('cust-month-cash').innerText = 'Rs ' + safeValue(stats.month.cash).toFixed(2);
    document.getElementById('cust-month-credit').innerText = 'Rs ' + safeValue(stats.month.credit).toFixed(2);
    document.getElementById('cust-month-profit').innerText = 'Rs ' + safeValue(stats.month.profit).toFixed(2);

    document.getElementById('cust-year-qty').innerText = safeValue(stats.year.q).toFixed(2) + ' kg';
    document.getElementById('cust-year-value').innerText = 'Rs ' + safeValue(stats.year.v).toFixed(2);
    document.getElementById('cust-year-cash').innerText = 'Rs ' + safeValue(stats.year.cash).toFixed(2);
    document.getElementById('cust-year-credit').innerText = 'Rs ' + safeValue(stats.year.credit).toFixed(2);
    document.getElementById('cust-year-profit').innerText = 'Rs ' + safeValue(stats.year.profit).toFixed(2);
    
    document.getElementById('cust-all-qty').innerText = safeValue(stats.all.q).toFixed(2) + ' kg';
    document.getElementById('cust-all-value').innerText = 'Rs ' + safeValue(stats.all.v).toFixed(2);
    document.getElementById('cust-all-cash').innerText = 'Rs ' + safeValue(stats.all.cash).toFixed(2);
    document.getElementById('cust-all-credit').innerText = 'Rs ' + safeValue(stats.all.credit).toFixed(2);
    document.getElementById('cust-all-profit').innerText = 'Rs ' + safeValue(stats.all.profit).toFixed(2);
    
    const allTimesCard = document.getElementById('all-times-sales-card');
    allTimesCard.style.display = 'none';

    sortedSales.forEach(item => {
        // ISOLATION: Skip rep mode entries in the display loop too
        if (item.isRepModeEntry === true) return;
        
        const isSelected = item.date === selectedDate;
        const highlightClass = isSelected ? 'highlight-card' : '';
        const dateDisplay = isSelected ? `${item.date} (Selected)` : item.date;
        
        const creditReceived = item.creditReceived || false;
        const paymentType = item.paymentType;
        const badgeClass = creditReceived ? 'received' : paymentType.toLowerCase();
        const badgeText = creditReceived ? 'RECEIVED' : paymentType;
        
        const supplyTagClass = item.supplyStore === 'STORE_A' ? 'store-a' : 
                             item.supplyStore === 'STORE_B' ? 'store-b' : 'store-c';
        const supplyTagText = item.supplyStore === 'STORE_A' ? 'ZUBAIR' : 
                            item.supplyStore === 'STORE_B' ? 'MAHMOOD' : 'ASAAN';

// Rep Indicator (New visual aid)
        let repBadge = '';
        if (item.salesRep && item.salesRep !== 'NONE') {
            repBadge = `<span style="font-size:0.65rem; background:#e0e7ff; color:#3730a3; padding:2px 6px; border-radius:4px; margin-left:5px;"> ${item.salesRep.split(' ')[0]}</span>`;
        }
        const card = document.createElement('div');
        card.className = `card liquid-card ${highlightClass}`;
        
        let creditSection = '';
        if (paymentType === 'CREDIT' && !creditReceived) {
            creditSection = `
            <div class="credit-checkbox-container" onclick="(async () => { await toggleCustomerCreditReceived(${item.id}, event) })()">
                <input type="checkbox" class="credit-checkbox" onclick="(async () => { await toggleCustomerCreditReceived(${item.id}, event); })()">
                <label class="credit-checkbox-label">Mark as Received</label>
            </div>
            `;
        } else if (paymentType === 'CREDIT' && creditReceived) {
            creditSection = `<div class="received-indicator">Credit Received </div>`;
        }
        
        const supplySection = `<div class="supply-tag ${supplyTagClass}">Supply: ${supplyTagText}</div>`;

        card.innerHTML = `
            <div class="payment-badge ${badgeClass}">${badgeText}</div>
            <div class="customer-name" style="margin-top: 12px;">${item.customerName} ${repBadge}</div>
            <h4 style="margin-top: 5px; font-size: 0.85rem; color: var(--text-muted);">${dateDisplay}</h4>
            <div class="supply-tag ${supplyTagClass}">Supply: ${supplyTagText}</div>
            <hr>
            <p><span>Quantity:</span> <span class="qty-val">${safeValue(item.quantity).toFixed(3)} kg</span></p>
                   
            <p><span>Total Value:</span> <span class="rev-val">Rs ${safeValue(item.totalValue).toFixed(2)}</span></p>
            <p><span>Net Profit:</span> <span class="profit-val">Rs ${safeValue(item.profit).toFixed(2)}</span></p>
            ${creditSection}
         <button class="btn btn-danger" style="width:100%; font-size:9px; padding:4px; margin-top:8px;" onclick="(async () => { await deleteCustomerSale('${item.id}') })()">Delete</button>
        `;
        histContainer.appendChild(card);
    });
    
    renderCustomersTable(); 
    updateCustomerCharts();
}


    async function toggleCustomerCreditReceived(id, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const saleIndex = customerSales.findIndex(item => item.id === id);
        
        if (saleIndex !== -1) {
            customerSales[saleIndex].creditReceived = !customerSales[saleIndex].creditReceived;
            await idb.set('customer_sales', customerSales);
            
            if (customerSales[saleIndex].creditReceived) {
                customerSales[saleIndex].paymentType = 'CASH';
                await idb.set('customer_sales', customerSales);
            }
            
            refreshCustomerSales();
            updateCustomerCharts();
        }
    }

    async function deleteCustomerSale(id) {
        if(confirm("Delete this sale transaction permanently?")) {
            customerSales = customerSales.filter(item => item.id !== id);
            await idb.set('customer_sales', customerSales);
            refreshCustomerSales();
            alert("Transaction deleted!");
        }
    }

    // --- CALCULATOR TAB FUNCTIONS (UPDATED WITH ALL TIMES) ---
    async function calculateComparisonData() {
        const compMode = currentCompMode;
        const selectedDate = document.getElementById('sale-date').value;
        const selectedDateObj = new Date(selectedDate);
        const selectedYear = selectedDateObj.getFullYear();
        const selectedMonth = selectedDateObj.getMonth();
        const selectedDay = selectedDateObj.getDate();
        
        let history; history = await idb.get('noman_history', []);
        
        const comp = { 
            "NORAN SHAH": {prof:0, rev:0, sold:0, ret:0, cred:0, cash:0, coll:0, giv:0, cost:0}, 
            "NOMAN SHAH": {prof:0, rev:0, sold:0, ret:0, cred:0, cash:0, coll:0, giv:0, cost:0} 
        };
        
        history.forEach(h => {
            const hDate = new Date(h.date);
            const hYear = hDate.getFullYear();
            const hMonth = hDate.getMonth();
            const hDay = hDate.getDate();
            
            let includeInComp = false;
            if (compMode === 'all') includeInComp = true;
            else if (compMode === 'week') {
                const weekStart = new Date(selectedDateObj);
                weekStart.setDate(selectedDay - 6);
                if(hDate >= weekStart && hDate <= selectedDateObj) includeInComp = true;
            }
            else if (compMode === 'month' && hYear === selectedYear && hMonth === selectedMonth) includeInComp = true;
            else if (compMode === 'year' && hYear === selectedYear) includeInComp = true;

            if(includeInComp && comp[h.seller]) { 
                comp[h.seller].prof += h.profit; 
                comp[h.seller].rev += h.revenue; 
                comp[h.seller].cost += (h.totalCost || 0);
                comp[h.seller].sold += h.totalSold; 
                comp[h.seller].ret += h.returned; 
                comp[h.seller].cred += h.creditQty; 
                comp[h.seller].cash += h.cashQty; 
                comp[h.seller].coll += h.prevColl; 
                comp[h.seller].giv += h.creditValue; 
            }
        });
        
        return comp;
    }

   function createReportHTML(title, data, isHistory = false, id = null, sellerName = null, isHighlight = false) {
    // 1. Calculate safe values with fallbacks
    const creditVal = safeValue(data.creditVal);
    const collected = safeValue(data.collected);
    const balance = creditVal - collected;
    
    const received = safeValue(data.received);
    const expected = safeValue(data.expected);
    const discrepancy = received - expected;
    
    // 2. Status Determination
    const balClass = balance > 0 ? 'balance-pos' : 'balance-neg';
    
    let discClass = 'qty-val'; 
    let discText = `Rs ${Math.abs(discrepancy).toFixed(2)}`;
    
    if (Math.abs(discrepancy) < 0.01) {
        discClass = 'units-available-good';
        discText = "Perfect Match";
    } else if (discrepancy < 0) {
        discClass = 'cost-val';
        discText = `SHORT: Rs ${Math.abs(discrepancy).toFixed(2)}`;
    } else {
        discClass = 'profit-val';
        discText = `OVER: Rs ${discrepancy.toFixed(2)}`;
    }

    // 3. Status Text Fallback (Use calculated if stored text is missing)
    const displayStatusText = data.statusText || discText;
    const displayStatusClass = data.statusClass || (Math.abs(discrepancy) < 0.01 ? 'result-box discrepancy-ok' : 'result-box discrepancy-alert');

    const badge = sellerName ? `<span class="seller-badge ${sellerName === 'NORAN SHAH' ? 'noran-badge' : 'noman-badge'}">${sellerName.split(' ')[0]}</span>` : '';
    const highlightClass = isHighlight ? 'highlight-card' : '';
    
    let html = `<div class="card liquid-card ${highlightClass}">${badge}<h4>${title}</h4>
    <p><span>Total Sold:</span> <span class="qty-val">${safeValue(data.sold).toFixed(2)}</span></p>
    <p><span>Returned:</span> <span class="qty-val">${safeValue(data.ret).toFixed(2)}</span></p>
    <p><span>Cash Qty:</span> <span class="qty-val">${safeValue(data.cash).toFixed(2)}</span></p>
    <p><span>Credit Qty:</span> <span class="qty-val">${safeValue(data.cred).toFixed(2)}</span></p>
    <hr>
    <p><span>Revenue:</span> <span class="rev-val">Rs ${safeValue(data.revenue).toFixed(2)}</span></p>
    <p><span>Profit:</span> <span class="profit-val">Rs ${safeValue(data.profit).toFixed(2)}</span></p>
    <p><span>Credit Out:</span> <span class="cost-val">Rs ${creditVal.toFixed(2)}</span></p>
    <p><span>Credit In:</span> <span class="profit-val">Rs ${collected.toFixed(2)}</span></p>
    <p><span>Net Debt:</span> <span class="${balClass}">Rs ${balance.toFixed(2)}</span></p>
    <hr>
    <p><span>Expected Cash:</span> <span class="qty-val" style="color:var(--text-main);">Rs ${expected.toFixed(2)}</span></p>
    <p><span>Received Cash:</span> <span class="qty-val" style="font-weight:800; color:var(--text-main);">Rs ${received.toFixed(2)}</span></p>
    <p><span>Discrepancy:</span> <span class="${discClass}">${discText}</span></p>
    `;
    
    if (isHistory) {
        html += `
        <div style="padding: 8px; border-radius: 6px; text-align: center; margin-top: 8px; font-size: 10px;" class="${displayStatusClass}">${displayStatusText}</div>
        <button class="btn btn-danger" style="width:100%; font-size:9px; padding:4px; margin-top:8px;" onclick="(async () => { await deleteSalesEntry('${id}') })()"
>Delete</button>`;
    }
    html += `</div>`;
    return html;
}


    // Find "function loadSalesData" and replace it with this:
// --- ENHANCED CALCULATOR TAB: AUTOMATIC CREDIT TRACKING ---

// 1. Calculate all-time total sold quantity for a representative from Sales Tab
// 1. Calculate all-time pending credit sales for a representative (ADMIN DATA ONLY)
function calculateTotalSoldForRepresentative(seller) {
    if (!seller || seller === 'COMBINED') return 0;
    
    let totalSold = 0;
    
    // Filter for Admin-assigned stock (isRepModeEntry !== true)
    customerSales.forEach(sale => {
        if (sale.salesRep === seller && 
            sale.paymentType === 'CREDIT' && 
            !sale.creditReceived &&
            sale.isRepModeEntry !== true) { // ISOLATION: Fetch only Admin entries
            totalSold += (sale.quantity || 0);
        }
    });
    
    return totalSold;
}


// --- ENHANCED CALCULATOR TAB: AUTOMATIC CREDIT TRACKING ---

// 2. Auto-Fill Calculator Fields with ISOLATED Data
function autoFillTotalSoldQuantity() {
    const seller = document.getElementById('sellerSelect').value;
    const date = document.getElementById('sale-date').value;

    const totalSoldField = document.getElementById('totalSold');
    const creditSalesField = document.getElementById('creditSales'); // CREDIT SALES QTY
    const recoveredField = document.getElementById('prevCreditReceived'); // RECOVERED CREDIT
    
    if (!totalSoldField) return;
    
    if (seller === 'COMBINED') {
        totalSoldField.value = '';
        totalSoldField.readOnly = true;
        return;
    }
    
    // --- FIELD 1: TOTAL SOLD (Read-Only) ---
    // SOURCE: customerSales (Admin Data)
    // REASON: This represents stock given BY Admin TO Rep. It stays in customerSales.
    const totalSold = calculateTotalSoldForRepresentative(seller);
    
    totalSoldField.value = totalSold.toFixed(3);
    totalSoldField.readOnly = true;
    totalSoldField.style.background = 'rgba(37, 99, 235, 0.1)';
    totalSoldField.style.color = 'var(--accent)';
    totalSoldField.style.fontWeight = 'bold';
    totalSoldField.style.border = '1px solid var(--accent)';
    
    // --- FIELDS 2 & 3: CREDIT SALES & RECOVERED ---
    // SOURCE: repSales (Rep Data) <<--- CHANGED THIS SOURCE
    // REASON: This represents activity done BY the Rep. It is now in repSales.
    let creditSalesKg = 0;
    let recoveredCash = 0;
    
    // Iterate through the new repSales array
    repSales.forEach(sale => {
        // Filter: Must be this Rep AND this Date
        if (sale.salesRep === seller && sale.date === date) {
            
            // 2. Credit Sales Qty (Rep sold on credit)
            if (sale.paymentType === 'CREDIT') {
                creditSalesKg += (sale.quantity || 0);
            }
            
            // 3. Recovered Credit (Rep collected cash)
            if (sale.paymentType === 'COLLECTION') {
                recoveredCash += (sale.totalValue || 0);
            }
        }
    });
    
    // Apply values to inputs
    if(creditSalesField) {
        creditSalesField.value = creditSalesKg.toFixed(3);
        styleAutoFilledField(creditSalesField);
    }
    
    if(recoveredField) {
        recoveredField.value = recoveredCash.toFixed(2);
        styleAutoFilledField(recoveredField);
    }
    
    // Trigger Calculation to update expected cash
    calculateSales();
}

function styleAutoFilledField(field) {
    field.style.background = 'rgba(5, 150, 105, 0.1)'; // Different color (Greenish) to indicate Rep Data
    field.style.color = 'var(--accent-emerald)';
    field.style.fontWeight = 'bold';
    field.style.border = '1px solid var(--accent-emerald)';
}



// 3. Enhanced loadSalesData to include auto-fill
async function loadSalesData(compMode = 'all') {
    currentCompMode = compMode;
    
    // 1. Setup UI
    ['week', 'month', 'year', 'all'].forEach(m => {
        const btn = document.getElementById(`comp-${m}-btn`);
        if(btn) btn.className = `toggle-opt ${m === compMode ? 'active' : ''}`;
    });
    
    const seller = document.getElementById('sellerSelect').value;
    const searchDate = document.getElementById('sale-date').value;
    
    autoFillTotalSoldQuantity(); // Trigger auto-fill
    
    const isCombined = seller === "COMBINED";
    const label = isCombined ? "Combined" : seller;
    
    document.getElementById('reportSellerName').innerText = label;
    document.getElementById('debtSellerName').innerText = label;
    document.getElementById('selectedSellerName').innerText = label;
    document.getElementById('entrySection').className = isCombined ? "hidden" : "";
    document.getElementById('combinedSection').className = isCombined ? "" : "hidden";
    document.getElementById('individualChartSection').className = isCombined ? "hidden" : "";

    // 2. Fetch Data
    let history = await idb.get('noman_history', []);
    if (!Array.isArray(history)) history = [];

    // 3. Filter & Sort
    let displayList = isCombined ? history : history.filter(h => h.seller === seller);
    displayList.sort((a,b) => {
         if (a.date === searchDate && b.date !== searchDate) return -1;
         if (a.date !== searchDate && b.date === searchDate) return 1;
         return b.timestamp - a.timestamp;
    });

    const ranges = {
        d: { sold:0, ret:0, cash:0, cred:0, creditVal:0, collected:0, profit:0, revenue:0, expected:0, received:0 },
        w: { sold:0, ret:0, cash:0, cred:0, creditVal:0, collected:0, profit:0, revenue:0, expected:0, received:0 },
        m: { sold:0, ret:0, cash:0, cred:0, creditVal:0, collected:0, profit:0, revenue:0, expected:0, received:0 },
        y: { sold:0, ret:0, cash:0, cred:0, creditVal:0, collected:0, profit:0, revenue:0, expected:0, received:0 },
        a: { sold:0, ret:0, cash:0, cred:0, creditVal:0, collected:0, profit:0, revenue:0, expected:0, received:0 }
    };
    
    // 4. Render History List
    const list = document.getElementById('historyList'); 
    list.innerHTML = '';
    
    displayList.forEach(h => {
         const isHighlight = h.date === searchDate;
         const dateTitle = isHighlight ? `${h.date} (Selected)` : h.date;
         
         // Critical: Correct property mapping from DB Object (h) to Report Function
         list.innerHTML += createReportHTML(
             dateTitle, 
             { 
                 sold: h.totalSold, 
                 ret: h.returned, 
                 cash: h.cashQty, 
                 cred: h.creditQty, 
                 revenue: h.revenue, 
                 profit: h.profit, 
                 creditVal: h.creditValue, 
                 collected: h.prevColl, 
                 expected: h.totalExpected, 
                 received: h.received, 
                 statusClass: h.statusClass, 
                 statusText: h.statusText
             }, 
             true, h.id, isCombined ? h.seller : null, isHighlight
         );
    });

    // 5. Calculate Aggregates
    const now = new Date(searchDate);
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - 6);
    
    let ltCr = 0, ltCl = 0; // Lifetime trackers

    const debtFilterList = isCombined ? history : history.filter(h => h.seller === seller);
    
    debtFilterList.forEach(h => {
        const hDate = new Date(h.date);
        
        ltCr += (h.creditValue || 0); 
        ltCl += (h.prevColl || 0);
        
        if(h.date === searchDate) addToRange(ranges.d, h);
        if(hDate >= weekStart && hDate <= now) addToRange(ranges.w, h);
        if(hDate.getMonth() === now.getMonth() && hDate.getFullYear() === now.getFullYear()) addToRange(ranges.m, h);
        if(hDate.getFullYear() === now.getFullYear()) addToRange(ranges.y, h);
        addToRange(ranges.a, h);
    });

    // 6. Update Summary Reports
    document.getElementById('dailyReport').innerHTML = createReportHTML("Daily View", ranges.d);
    document.getElementById('weeklyReport').innerHTML = createReportHTML("Weekly View", ranges.w);
    document.getElementById('monthlyReport').innerHTML = createReportHTML("Monthly View", ranges.m);
    document.getElementById('yearlyReport').innerHTML = createReportHTML("Yearly View", ranges.y);
    document.getElementById('allTimeReport').innerHTML = createReportHTML("All Time Summary", ranges.a);
    
    document.getElementById('ltCredit').innerText = "Rs " + safeValue(ltCr).toFixed(2);
    document.getElementById('ltCollected').innerText = "Rs " + safeValue(ltCl).toFixed(2);
    document.getElementById('ltBalance').innerText = "Rs " + safeValue(ltCr - ltCl).toFixed(2);

    if(isCombined) {
        const comp = await calculateComparisonData();
        updateSalesCharts(comp);
        const noranWin = comp["NORAN SHAH"].prof > comp["NOMAN SHAH"].prof;
        document.getElementById('thNoran').innerHTML = "NORAN " + (noranWin ? "" : "");
        document.getElementById('thNoman').innerHTML = "NOMAN " + (!noranWin ? "" : "");
        document.getElementById('comparisonBody').innerHTML = `
            <tr><td>Qty Sold</td><td>${safeValue(comp["NORAN SHAH"].sold).toFixed(2)}</td><td>${safeValue(comp["NOMAN SHAH"].sold).toFixed(2)}</td></tr>
            <tr><td>Returns</td><td>${safeValue(comp["NORAN SHAH"].ret).toFixed(2)}</td><td>${safeValue(comp["NOMAN SHAH"].ret).toFixed(2)}</td></tr>
            <tr><td>Total Cost</td><td style="color:var(--danger)">Rs ${safeValue(comp["NORAN SHAH"].cost).toFixed(2)}</td><td style="color:var(--danger)">Rs ${safeValue(comp["NOMAN SHAH"].cost).toFixed(2)}</td></tr>
            <tr><td>Gross Revenue (Value)</td><td class="rev-val">Rs ${safeValue(comp["NORAN SHAH"].rev).toFixed(2)}</td><td class="rev-val">Rs ${safeValue(comp["NOMAN SHAH"].rev).toFixed(2)}</td></tr>
            <tr class="winner-cell"><td>Net Profit (Value)</td><td>Rs ${safeValue(comp["NORAN SHAH"].prof).toFixed(2)}</td><td>Rs ${safeValue(comp["NOMAN SHAH"].prof).toFixed(2)}</td></tr>
        `;

        document.getElementById('comparisonBody').innerHTML += `
            <tr><td>Credit Issued</td><td>Rs ${safeValue(comp["NORAN SHAH"].giv).toFixed(2)}</td><td>Rs ${safeValue(comp["NOMAN SHAH"].giv).toFixed(2)}</td></tr>
            <tr><td>Credit Recovered</td><td style="color:var(--accent)">Rs ${safeValue(comp["NORAN SHAH"].coll).toFixed(2)}</td><td style="color:var(--accent)">Rs ${safeValue(comp["NOMAN SHAH"].coll).toFixed(2)}</td></tr>
        `;
    } else {
        await updateIndChart();
    }
}


    function addToRange(range, h) {
        range.sold += h.totalSold; 
        range.ret += h.returned; 
        range.cash += h.cashQty; 
        range.cred += h.creditQty;
        range.creditVal += h.creditValue; 
        range.collected += h.prevColl; 
        range.profit += h.profit; 
        range.revenue += h.revenue;
        range.expected += (h.totalExpected || 0);
    range.received += (h.received || 0);
    }

    function updateSalesCharts(comp) {
        if(!comp) return;
        const selectedMetric = document.getElementById('metricSelector').value;
        const metricLabel = document.getElementById('metricSelector').options[document.getElementById('metricSelector').selectedIndex].text;
        const colors = {
            text: '#1e3a8a',
            grid: 'rgba(37, 99, 235, 0.1)'
        };

        if(salesPerfChart) salesPerfChart.destroy();
        salesPerfChart = new Chart(document.getElementById('performanceChart'), {
            type: 'bar',
            data: { 
                labels: ['Noran Shah', 'Noman Shah'], 
                datasets: [{ 
                    label: metricLabel, 
                    data: [comp["NORAN SHAH"][selectedMetric], comp["NOMAN SHAH"][selectedMetric]], 
                    backgroundColor: ['#2563eb', '#059669'],
                    borderRadius: 6
                }] 
            },
            options: { 
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { beginAtZero: true, grid: { color: colors.grid }, ticks: { color: colors.text } },
                    x: { ticks: { color: colors.text } }
                } 
            }
        });

        const totalCashValue = comp["NORAN SHAH"].rev - comp["NORAN SHAH"].giv + comp["NOMAN SHAH"].rev - comp["NOMAN SHAH"].giv;
        const totalCreditValue = comp["NORAN SHAH"].giv + comp["NOMAN SHAH"].giv;
        
        const totalSold = comp["NORAN SHAH"].sold + comp["NOMAN SHAH"].sold;
        const totalReturned = comp["NORAN SHAH"].ret + comp["NOMAN SHAH"].ret;
        const totalRevenue = comp["NORAN SHAH"].rev + comp["NOMAN SHAH"].rev;
        const avgPrice = totalSold > 0 ? totalRevenue / totalSold : 0;
        const totalReturnValue = totalReturned * avgPrice;

        const pieData = [totalCashValue, totalCreditValue, totalReturnValue];
        const pieLabels = ['Cash Sale Value', 'Credit Value', 'Return Value'];
        
        if(salesCompChart) salesCompChart.destroy();
        salesCompChart = new Chart(document.getElementById('compositionChart'), {
            type: 'pie',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: ['#059669', '#f59e0b', '#dc2626'],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: colors.text, boxWidth: 12, font: { size: 10 } } },
                    title: { 
                        display: true, 
                        text: compositionChartShowPercentage ? 
                            'Market Composition (Percentage)' : 
                            'Market Composition', 
                        color: colors.text,
                        font: { size: 13, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (compositionChartShowPercentage) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${percentage}%`;
                                } else {
                                    return `${context.label}: Rs ${context.parsed.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            }
        });
        
        if (compositionChartShowPercentage) {
            updateCompositionChart();
        }
    }

    // 4. NEW: Process Return to Production
async function processReturnToProduction(storeKey, quantity, date, seller) {
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${ampm}`;

    // Determine formula store and sale price
    let formulaStore = 'standard';
    let salePrice = factorySalePrices.standard || 0;
    
    // Get cost data for this return
    const costPerKg = calculateSalesCostPerKg(formulaStore);
    const totalCost = quantity * costPerKg;
    const totalSale = quantity * salePrice;
    const profit = totalSale - totalCost;

    // Create a production entry for the returned goods
    const returnEntry = {
        id: Date.now(),
        date: date,
        time: timeString,
        store: storeKey,
        net: quantity,
        cp: costPerKg,
        sp: salePrice,
        totalCost: totalCost,
        totalSale: totalSale,
        profit: profit,
        formulaUnits: 0, // Returns don't consume formula units
        formulaStore: formulaStore,
        formulaCost: 0,
        paymentStatus: 'CASH',
        timestamp: new Date(date).getTime(),
        isReturn: true, // Mark as return entry
        returnedBy: seller,
        returnNote: `Returned by ${seller}`
    };

    // Add to production database
    db.push(returnEntry);
    await idb.set('mfg_pro_pkr', db);
    
    // Record in returns log
    const returnLogEntry = {
        id: Date.now(),
        date: date,
        time: timeString,
        store: storeKey,
        quantity: quantity,
        seller: seller,
        timestamp: Date.now()
    };
    
    stockReturns.push(returnLogEntry);
    await idb.set('stock_returns', stockReturns);
    
    console.log(` Return processed: ${quantity} kg added to ${storeKey} inventory`);
}



// 6. NEW: Reverse Return from Production
async function reverseReturnFromProduction(storeKey, quantity, date) {
    // Find and remove the return entry from production database
    const returnEntryIndex = db.findIndex(item => 
        item.store === storeKey && 
        item.net === quantity && 
        item.date === date && 
        item.isReturn === true
    );
    
    if (returnEntryIndex !== -1) {
        db.splice(returnEntryIndex, 1);
        await idb.set('mfg_pro_pkr', db);
        console.log(` Return reversed: ${quantity} kg removed from ${storeKey} inventory`);
    }
    
    // Remove from returns log
    const returnLogIndex = stockReturns.findIndex(r => 
        r.store === storeKey && 
        r.quantity === quantity && 
        r.date === date
    );
    
    if (returnLogIndex !== -1) {
        stockReturns.splice(returnLogIndex, 1);
        await idb.set('stock_returns', stockReturns);
    }
}

    // --- UTILITY FUNCTIONS ---
    async function formatCurrency(num) {
        if (typeof num !== 'number') num = parseFloat(num) || 0;
        return 'PKR ' + num.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }

    function safeValue(value) {
        return isNaN(value) || !isFinite(value) ? 0 : value;
    }

    // --- REFRESH ALL DISPLAYS (STABILIZED) ---
    async function refreshAllDisplays() {
        // 1. Force Recalculation of Factory Units (Fixes fluctuation)
        await syncFactoryProductionStats();
        
        // 2. Refresh all other tabs
        refreshUI(); // Production Tab
        refreshCustomerSales(); // Sales Tab
        await loadSalesData(currentCompMode); // Calculator Tab
        initFactoryTab(); // Factory Tab
        
        // 3. Refresh Payments if active
        if (document.getElementById('tab-payments') && !document.getElementById('tab-payments').classList.contains('hidden')) {
            refreshPaymentTab();
        }
        
        // 4. Update Header Stats
        calculateNetCash();

        // 5. Refresh Rep Tab if active
        if (appMode === 'rep') {
            renderRepHistory();
            renderRepCustomerTable();
        }
    }

// ==========================================
// CONSOLIDATED APP INITIALIZATION
// ==========================================

document.addEventListener('DOMContentLoaded', async function() {
    // 1. Strict Initialization: Ensure no UI rendering until loadAllData is complete
    console.log(" System Initializing ");
    
    try {
        // Initialize IndexedDB and load all data first
        await loadAllData();
        await migrateRepData(); // Run migration after loading
        console.log(" Data loaded successfully from IndexedDB.");
    } catch (e) {
        console.error(" Critical Initialization Error:", e);
        alert("Failed to initialize database. Please refresh the page.");
        return;
    }

    // ----------------------------------------------------
    // 2. CORE SETUP & SECURITY (Must run first)
    // ----------------------------------------------------
    
    // Apply Theme Preference
    await initTheme(); 

    // Enforce Security Modes (Admin vs Rep)
    // We check this immediately to lock UI if necessary
    await enforceRepModeLock(); 
    preventAdminAccess();

    // Check Biometric Lock (Async)
    // If enabled, this triggers the lock overlay immediately
    await checkBiometricLock(); 

    // Initialize Supabase Connectivity
    // Small timeout ensures the external library script has parsed
    setTimeout(() => {
        if (typeof initSupabase === 'function') {
            console.log(' Initializing Cloud Sync...');
            initSupabase();
        } else {
            console.error(" Supabase client not loaded.");
        }
    }, 100);

    // ----------------------------------------------------
    // 3. UI INITIALIZATION (Inputs & Toggles)
    // ----------------------------------------------------

    // Set Default Dates for ALL Date Inputs to Today
    const today = new Date().toISOString().split('T')[0];
    const dateInputIds = [
        'sys-date', 
        'sale-date', 
        'cust-date', 
        'factory-date', 
        'paymentDate', 
        'rep-date'
    ];
    
    dateInputIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
    });
    
    // Sync Factory Date Global Variable
    currentFactoryDate = today;

    // Initialize Biometric Button State in Menu
    if (await idb.get('bio_enabled') === 'true') {
        const bioBtn = document.getElementById('bio-toggle-btn');
        if (bioBtn) {
            bioBtn.innerText = "Disable Biometric Lock";
            bioBtn.onclick = disableBiometricLock;
            bioBtn.classList.add('active');
        }
    }

    // Pre-fill Admin Settings inputs (if in Admin mode)
    if (appMode === 'admin') {
        const pinInput = document.getElementById('setting-admin-pin');
        if (pinInput) pinInput.value = adminPin;
        
        const repSelect = document.getElementById('setting-rep-select');
        if (repSelect) repSelect.value = currentRepProfile;
    }

    // ----------------------------------------------------
    // 3. EVENT LISTENERS SETUP
    // ----------------------------------------------------

    // Factory Date Change Listener
    const factoryDateEl = document.getElementById('factory-date');
    if (factoryDateEl) {
        factoryDateEl.addEventListener('change', function() {
            currentFactoryDate = this.value;
            updateFactorySummaryCard();
        });
    }

    // Calculator Auto-Fill Listeners (Seller or Date change)
    const sellerSelect = document.getElementById('sellerSelect');
    const saleDate = document.getElementById('sale-date');
    
    if (sellerSelect) sellerSelect.addEventListener('change', autoFillTotalSoldQuantity);
    if (saleDate) saleDate.addEventListener('change', autoFillTotalSoldQuantity);

    // Production Payment Status Toggle Listener
    const storeSelector = document.getElementById('storeSelector');
    if (storeSelector) {
        storeSelector.addEventListener('change', updateProductionCostOnStoreChange);
    }

  

    // ----------------------------------------------------
    // 4. DATA RENDERING & FINAL DISPLAY REFRESH
    // ----------------------------------------------------

    // Initialize Splash Screen Animation
    initSplashScreen();

    // Set Default View States
    setProductionView('combined');
    
    // Sync Unit Statistics
    syncFactoryProductionStats();
    
    // Sync Cost Calculations across tabs
    updateAllTabsWithFactoryCosts();

    // Force a full UI Refresh
    // This calls: refreshUI(), refreshCustomerSales(), await loadSalesData(), refreshPaymentTab()
    await refreshAllDisplays();

    // Rep Mode Specific Refresh (if active)
    if (appMode === 'rep') {
        if (typeof renderRepHistory === 'function') renderRepHistory();
        if (typeof renderRepCustomerTable === 'function') renderRepCustomerTable();
    }

    // ----------------------------------------------------
    // 5. CLEANUP
    // ----------------------------------------------------

    // Hide Splash Screen after delay
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if (splash) splash.style.display = 'none';
        console.log(" Initialization Complete");
    }, 1500);
});

    // Ensure your deleteCustomerSale looks like this to keep dashboard sync:
async function deleteCustomerSale(id) {
    if(confirm("Delete this sale transaction permanently?")) {
        customerSales = customerSales.filter(item => item.id !== id);
        await idb.set('customer_sales', customerSales);
        
        refreshCustomerSales(); // Refreshes the list
        calculateNetCash();     // Syncs the Economic Dashboard
        calculateCashTracker(); // Syncs the Cash Tracker
        renderCustomersTable();
        alert("Transaction deleted!");
    }
}
// Close search dropdown when clicking outside
document.addEventListener('click', function(e) {
    const searchContainer = document.getElementById('cust-name').parentElement;
    const resultsDiv = document.getElementById('customer-search-results');
    if (!searchContainer.contains(e.target)) {
        resultsDiv.classList.add('hidden');
    }
});
// --- FIX: MISSING OVERVIEW MODE FUNCTION ---
function setOverviewMode(mode) {
    currentOverviewMode = mode;
    
    // Update active class on buttons
    const buttons = ['day', 'week', 'month', 'year', 'all'];
    buttons.forEach(btnMode => {
        const btn = document.getElementById(`overview-${btnMode}-btn`);
        if (btn) {
            if (btnMode === mode) btn.classList.add('active');
            else btn.classList.remove('active');
        }
    });

    // Refresh the overview with the new mode
    updateAllStoresOverview(mode);
}


    
// --- FIXED: DELETE CALCULATOR ENTRY (Reverts Sales & Reverses Returns) ---
async function deleteSalesEntry(id) {
    let history; history = await idb.get('noman_history', []);
    const entryToDelete = history.find(h => h.id === id);

    if (entryToDelete) {
        const linkedCount = entryToDelete.linkedSalesIds ? entryToDelete.linkedSalesIds.length : 0;
        let confirmMsg = `Permanently delete this record for ${entryToDelete.seller} on ${entryToDelete.date}?`;
        
        if (linkedCount > 0) {
            confirmMsg += `\n\n This will REVERT ${linkedCount} linked sales entries back to 'Pending Credit'.`;
        }
        
        // Add warning if there were returns
        if (entryToDelete.returned > 0 && entryToDelete.returnStore) {
            confirmMsg += `\n\n This will also REMOVE ${entryToDelete.returned} kg from ${getStoreLabel(entryToDelete.returnStore)} inventory (reversing the return).`;
        }
        
        if (confirm(confirmMsg)) {
                await registerDeletion(id);
            
            // 1. REVERT LINKED SALES (Mark them as Pending Credit again)
            if (entryToDelete.linkedSalesIds && entryToDelete.linkedSalesIds.length > 0) {
                await revertSpecificSalesEntries(entryToDelete.linkedSalesIds);
            }

            // 2. REVERSE THE RETURN (Remove from Production Tab)
            if (entryToDelete.returned > 0 && entryToDelete.returnStore) {
                await reverseReturnFromProduction(entryToDelete.returnStore, entryToDelete.returned, entryToDelete.date);
            }

            // 3. DELETE THE CALCULATOR ENTRY
            const newHistory = history.filter(h => h.id !== id);
            await idb.set('noman_history', newHistory);

            // 4. REFRESH ALL DATA
            refreshAllCalculations(); // Updates Net Cash, Cash Tracker, etc.
            await loadSalesData(currentCompMode); // Refreshes Calculator Tab
            refreshCustomerSales(); // Refreshes Sales Tab
            refreshUI(); // Refreshes Production Tab (Removes the return card)
            updateAllStoresOverview(currentOverviewMode); // Updates Summary Cards

            showToast(`Record deleted! Linked sales reverted & returns removed.`, 'success');
        }
    } else {
        alert("Error: Record not found.");
    }
}

// Helper 1: Revert specific sales entries by ID
async function revertSpecificSalesEntries(saleIds) {
    if (!saleIds || saleIds.length === 0) return 0;
    
    let revertedCount = 0;
    
    saleIds.forEach(saleId => {
        const saleIndex = customerSales.findIndex(s => s.id === saleId);
        
        if (saleIndex !== -1) {
            const sale = customerSales[saleIndex];
            
            // Revert status
            sale.creditReceived = false;
            sale.paymentType = 'CREDIT'; // Force back to Credit
            
            // Remove timestamp markers
            delete sale.creditReceivedDate;
            delete sale.creditReceivedTime;
            
            revertedCount++;
        }
    });
    
    if (revertedCount > 0) {
        await idb.set('customer_sales', customerSales);
        notifyDataChange('all');

    
        console.log(` Reverted ${revertedCount} linked sales to pending credit.`);
    }
    
    return revertedCount;
}

// Helper 2: Reverse Return from Production Database
async function reverseReturnFromProduction(storeKey, quantity, date) {
    // 1. Remove from Production DB (The visual card)
    // We look for an entry that matches Store, Quantity, Date AND has isReturn flag
    const returnEntryIndex = db.findIndex(item => 
        item.store === storeKey && 
        Math.abs(item.net - quantity) < 0.001 && // Float safe comparison
        item.date === date && 
        item.isReturn === true
    );
    
    if (returnEntryIndex !== -1) {
        db.splice(returnEntryIndex, 1);
        await idb.set('mfg_pro_pkr', db);
        console.log(` Return reversed: Removed ${quantity} kg from ${storeKey} production DB`);
    } else {
        console.warn("Could not find matching return entry in Production DB to delete.");
    }
    
    // 2. Remove from Returns Log (The background math)
    const returnLogIndex = stockReturns.findIndex(r => 
        r.store === storeKey && 
        Math.abs(r.quantity - quantity) < 0.001 && 
        r.date === date
    );
    
    if (returnLogIndex !== -1) {
        stockReturns.splice(returnLogIndex, 1);
        await idb.set('stock_returns', stockReturns);
        console.log(` Return reversed: Removed from stock returns log`);
    }
}





  
    // Add this function to your JavaScript
// --- ENTITY CARD VIEW FUNCTIONS ---
let entityViewMode = 'detailed'; // 'detailed' or 'compact'

function toggleEntityViewMode() {
    const toggleBtn = document.getElementById('entityViewModeToggle');
    const entityGrid = document.getElementById('entityCardsGrid');
    
    if (entityViewMode === 'detailed') {
        entityViewMode = 'compact';
        entityGrid.classList.add('compact');
        toggleBtn.title = "Switch to Detailed View";
        toggleBtn.textContent = '';
    } else {
        entityViewMode = 'detailed';
        entityGrid.classList.remove('compact');
        toggleBtn.title = "Switch to Compact View";
        toggleBtn.textContent = '';
    }
    
    renderEntityTable();
}

// ============================================
// FIXED: ENTITY BALANCE CALCULATION (Proper Ledger Logic)
// ============================================

function calculateEntityBalances() {
    const balances = {};
    
    // Initialize all entities at 0
    paymentEntities.forEach(entity => {
        balances[entity.id] = 0;
    });

    // Process all TRANSACTIONS (The Ledger)
    paymentTransactions.forEach(transaction => {
        if (balances[transaction.entityId] !== undefined) {
            if (transaction.type === 'OUT') {
                // Money OUT: I paid them
                // Effect: DECREASES what I owe them (reduces liability)
                // Balance becomes MORE NEGATIVE (I paid off debt)
                balances[transaction.entityId] -= transaction.amount;
            } else if (transaction.type === 'IN') {
                // Money IN: They paid me
                // Effect: INCREASES what they owe me (creates receivable)
                // Balance becomes MORE POSITIVE (they now owe me)
                balances[transaction.entityId] += transaction.amount;
            }
        }
    });
    
    // Process all SUPPLIER INVOICES (Unpaid Liabilities)
    factoryInventoryData.forEach(material => {
        if (material.supplierId && material.totalPayable && material.paymentStatus === 'pending') {
            if (balances[material.supplierId] !== undefined) {
                // Unpaid Purchase = Liability = I owe them
                // Balance becomes MORE POSITIVE (I need to pay them)
                balances[material.supplierId] += material.totalPayable;
            }
        }
    });
    
    return balances;
}

// Helper function to get dynamic role based on balance
function getDynamicRole(balance) {
    if (balance > 0.01) {
        // Positive Balance: I owe them money (Payable/Liability)
        return {
            label: 'Payable',
            icon: '',
            colorClass: 'entity-balance-negative',
            badgeColor: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)',
            sign: '+'
        };
    } else if (balance < -0.01) {
        // Negative Balance: They owe me money (Receivable/Asset)
        return {
            label: 'Receivable',
            icon: '',
            colorClass: 'entity-balance-positive',
            badgeColor: 'linear-gradient(135deg, #059669 0%, #047857 100%)',
            sign: ''
        };
    } else {
        // Zero Balance: Settled
        return {
            label: 'Settled',
            icon: '',
            colorClass: 'entity-balance-neutral',
            badgeColor: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
            sign: ''
        };
    }
}

// Helper function to get dynamic role based on balance
function getDynamicRole(balance) {
    if (balance > 0.01) {
        // Positive Balance: I owe them money (Payable/Liability)
        return {
            label: 'Payable',
            icon: '',
            colorClass: 'entity-balance-negative',
            badgeColor: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)',
            sign: '+'
        };
    } else if (balance < -0.01) {
        // Negative Balance: They owe me money (Receivable/Asset)
        return {
            label: 'Receivable',
            icon: '',
            colorClass: 'entity-balance-positive',
            badgeColor: 'linear-gradient(135deg, #059669 0%, #047857 100%)',
            sign: ''
        };
    } else {
        // Zero Balance: Settled
        return {
            label: 'Settled',
            icon: '',
            colorClass: 'entity-balance-neutral',
            badgeColor: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
            sign: ''
        };
    }
}
function filterEntityCards() {
    const searchTerm = document.getElementById('entity-list-search').value.toLowerCase().trim();
    const entityCards = document.querySelectorAll('#entityCardsGrid .entity-card-compact');
    
    if (!searchTerm) {
        entityCards.forEach(card => card.style.display = '');
        return;
    }
    
    entityCards.forEach(card => {
        const entityName = card.querySelector('.entity-name').textContent.toLowerCase();
        const entityType = card.querySelector('.entity-type-badge').textContent.toLowerCase();
        const entityPhone = card.querySelector('.entity-contact')?.textContent?.toLowerCase() || '';
        const cardText = (entityName + ' ' + entityType + ' ' + entityPhone).toLowerCase();
        
        if (cardText.includes(searchTerm)) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}
// --- ENTITY CREATION LOGIC ---

// 1. Open the "Add Entity" Modal
function openEntityManagement() {
    // Reset the ID so we know we are creating a NEW entity
    editingEntityId = null; 
    
    // Clear the form fields
    document.getElementById('entityName').value = '';
    document.getElementById('entityType').value = 'payee'; // Default
    document.getElementById('entityPhone').value = '';
    document.getElementById('entityWallet').value = '';
    
    // Set Title
    document.getElementById('entityManagementModalTitle').innerText = 'Add New Entity';
    
    // Show Overlay
    document.getElementById('entityManagementOverlay').style.display = 'flex';
}

// 2. Close the Modal
function closeEntityManagement() {
    document.getElementById('entityManagementOverlay').style.display = 'none';
}

// 3. Save the Entity (Create or Update)
async function saveEntity() {
    const name = document.getElementById('entityName').value.trim();
    const type = document.getElementById('entityType').value;
    const phone = document.getElementById('entityPhone').value.trim();
    const wallet = document.getElementById('entityWallet').value.trim();
    
    if (!name) {
        showToast("Please enter an entity name", "warning");
        return;
    }
    
    // Check for duplicates
    const exists = paymentEntities.some(e => e.name.toLowerCase() === name.toLowerCase() && e.id !== editingEntityId);
    if(exists) {
        showToast("An entity with this name already exists", "warning");
        return;
    }
    
    if (editingEntityId) {
        // UPDATE EXISTING
        const index = paymentEntities.findIndex(e => e.id === editingEntityId);
        if (index !== -1) {
            paymentEntities[index] = {
                ...paymentEntities[index],
                name,
                type,
                phone,
                wallet,
                updatedAt: Date.now()
            };
            showToast("Entity updated successfully", "success");
        }
    } else {
        // CREATE NEW
        paymentEntities.push({
            id: generateUUID('ent'),
            name,
            type,
            phone,
            wallet,
            createdAt: Date.now(),
            updatedAt: Date.now()
        });
        showToast("New entity added", "success");
    }
    
    // Persist to Database
    await idb.set('payment_entities', paymentEntities);
    notifyDataChange('all');
    
    // Close Modal and Refresh Table
    closeEntityManagement();
    renderEntityTable(); 
    calculateNetCash();
}

// 4. Edit Function (Called from the "Manage" button inside the table if needed)
// Note: The main management is done via the new Overlay, but this allows editing the Name/Phone
function editEntityBasicInfo(id) {
    const entity = paymentEntities.find(e => e.id === id);
    if (entity) {
        editingEntityId = id;
        document.getElementById('entityName').value = entity.name;
        document.getElementById('entityType').value = entity.type;
        document.getElementById('entityPhone').value = entity.phone || '';
        document.getElementById('entityWallet').value = entity.wallet || '';
        
        document.getElementById('entityManagementModalTitle').innerText = 'Edit Entity Info';
        document.getElementById('entityManagementOverlay').style.display = 'flex';
    }
}

// Replace the refreshEntityList() function call in refreshPaymentTab() with renderEntityTable()
async function refreshPaymentTab() {
    // First ensure all suppliers are properly loaded into entities
    await syncSuppliersToEntities();
    
    renderEntities();
    calculateNetCash();
    calculatePaymentSummaries();
    renderEntityTable(); // Changed from refreshEntityList()
    calculateCashTracker();
    
    // Render transaction history
    const historyList = document.getElementById('paymentHistoryList');
    if (!historyList) {
        console.error("Payment history list element not found");
        return;
    }
    
    historyList.innerHTML = '';
    
    // Sort by date (newest first)
    const sortedTransactions = [...paymentTransactions].sort((a, b) => b.timestamp - a.timestamp);
    
    sortedTransactions.forEach(transaction => {
        const entity = paymentEntities.find(e => e.id === transaction.entityId);
        const badgeClass = transaction.type === 'IN' ? 'transaction-in' : 'transaction-out';
        const badgeText = transaction.type === 'IN' ? 'IN' : 'OUT';
        
        const card = document.createElement('div');
        card.className = 'card liquid-card';
        card.innerHTML = `
            <span class="transaction-badge ${badgeClass}">${badgeText}</span>
            <h4>${transaction.date} @ ${transaction.time || 'N/A'}</h4>
            <div class="customer-name">${entity ? entity.name : 'Unknown Entity'}</div>
            <p><span>Type:</span> <span>${entity ? (entity.type === 'payee' ? 'Payee' : 'Payor') : 'Unknown'}</span></p>
            <p><span>Description:</span> <span>${transaction.description || 'No description'}</span></p>
            <hr>
            <p><span>Amount:</span> <span class="${transaction.type === 'IN' ? 'profit-val' : 'cost-val'}">Rs ${safeValue(transaction.amount).toFixed(2)}</span></p>
            <button class="btn btn-danger" style="width:100%; font-size:9px; padding:4px; margin-top:8px;" onclick="(async () => { await deletePaymentTransaction(${transaction.id}) })()">Delete</button>
        `;
        historyList.appendChild(card);
    });
    
    if (sortedTransactions.length === 0) {
        historyList.innerHTML = '<p style="text-align:center; color:var(--text-muted); width:100%; font-size:0.85rem;">No payment transactions found.</p>';
    }
    
    console.log(`Rendered ${sortedTransactions.length} payment transactions`);
}

// Also update the selectEntity function to highlight the selected card
function selectEntity(id) {
    selectedEntityId = id;
    const entitySelect = document.getElementById('paymentEntity');
    entitySelect.value = id;
    
    // Update card selection
    document.querySelectorAll('#entityCardsGrid .entity-card-compact').forEach(card => {
        card.classList.remove('active');
        if (parseInt(card.dataset.id) === id) {
            card.classList.add('active');
            
            // Scroll into view if needed
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
    });
    
    // Update chip selection (for the quick entity scroller)
    document.querySelectorAll('.entity-chip').forEach(chip => {
        chip.classList.remove('active');
        if (parseInt(chip.dataset.id) === id) {
            chip.classList.add('active');
        }
    });
}

// Update the refreshEntityBalances function
function refreshEntityBalances() {
    renderEntityTable();
    alert("Entity balances refreshed!");
}


// Replace the incomplete getMetricValue function with this:
function getMetricValue(historyItem, metric) {
    switch(metric) {
        case 'weight':
            return ((historyItem.totalSold || 0) - (historyItem.returned || 0)) || 0;
        case 'value':
            return historyItem.revenue || 0;
        case 'cost':
            return historyItem.totalCost || 0;
        case 'profit':
            return historyItem.profit || 0;
        case 'cash':
            return (historyItem.received || 0);
        case 'credit':
            return historyItem.creditValue || 0;
        default:
            return 0;
    }
}

function getMetricLabel(metric) {
    switch(metric) {
        case 'weight': return 'Weight (kg)';
        case 'value': return 'Revenue (Rs)';
        case 'cost': return 'Cost (Rs)';
        case 'profit': return 'Profit (Rs)';
        case 'cash': return 'Cash (Rs)';
        case 'credit': return 'Credit (Rs)';
        default: return 'Metric';
    }
}
// UPDATED: deleteFactoryInventoryItem with supplier cleanup
async function deleteFactoryInventoryItem() {
    if (editingFactoryInventoryId && confirm("Delete this inventory item permanently?\n\nThis will also unlink any supplier associations and reverse related transactions.")) {
        const material = factoryInventoryData.find(i => i.id === editingFactoryInventoryId);
        
        if (material && material.supplierId) {
            // Unlink supplier first (this reverses transactions)
            await unlinkSupplierFromMaterial(material);
        }
        
        // Delete the material
        factoryInventoryData = factoryInventoryData.filter(item => item.id !== editingFactoryInventoryId);
        await idb.set('factory_inventory_data', factoryInventoryData);
        notifyDataChange('all');

        
        closeFactoryInventoryModal();
        renderFactoryInventory();
        refreshPaymentTab();
        calculateNetCash();
        
        showToast("Inventory item deleted!", 'success');
    }
}
// Add these at the top of your JavaScript or with other helper functions
function safeValue(value) {
    return isNaN(value) || !value ? 0 : value;
}

// FIND THIS FUNCTION (usually at the bottom of your script) AND REPLACE IT
function formatCurrency(value) {
    // Removed 'async' keyword to return string immediately
    if (typeof value !== 'number') value = parseFloat(value) || 0;
    return 'PKR ' + value.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
}

// Add validation and error handling for payment data
async function initPaymentData() {
    try {
        paymentEntities = await idb.get('payment_entities', []);
        paymentTransactions = await idb.get('payment_transactions', []);
        
        // Validate data structure
        if (!Array.isArray(paymentEntities)) paymentEntities = [];
        if (!Array.isArray(paymentTransactions)) paymentTransactions = [];
        
        // Clean invalid transactions
        paymentTransactions = paymentTransactions.filter(t => 
            t && t.id && t.entityId && (t.type === 'IN' || t.type === 'OUT') && typeof t.amount === 'number'
        );
        
        console.log(`Loaded ${paymentEntities.length} entities and ${paymentTransactions.length} transactions`);
    } catch (e) {
        console.error("Error loading payment data:", e);
        paymentEntities = [];
        paymentTransactions = [];
    }
}
initPaymentData();
// Missing update functions


// --- CUSTOMER SEARCH & MANAGEMENT FUNCTIONS ---

// --- FIX: Advanced Customer Search & Selection ---

// 1. Enhanced Search Function
function searchCustomers(query) {
    const resultsDiv = document.getElementById('customer-search-results');
    if (!query || query.length < 1) {
        resultsDiv.classList.add('hidden');
        return;
    }

    // ISOLATION: Only show customers from Admin entries (isRepModeEntry !== true)
    const uniqueCustomers = [...new Set(customerSales
        .filter(s => s.isRepModeEntry !== true) 
        .map(s => s.customerName)
        .filter(n => n))];

    const matches = uniqueCustomers.filter(name => 
        name.toLowerCase().includes(query.toLowerCase())
    );

    // Render Dropdown
    if (matches.length > 0) {
        let html = '';
        matches.forEach(name => {
            const safeName = name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            html += `
                <div style="padding: 10px; cursor: pointer; border-bottom: 1px solid var(--glass-border); font-size: 0.85rem; color: var(--text-main); background: var(--input-bg);" 
                     onmousedown="selectCustomer('${safeName}')"
                     onmouseover="this.style.background='var(--highlight-bg)'" 
                     onmouseout="this.style.background='var(--input-bg)'">
                    <strong>${name}</strong>
                </div>`;
        });
        resultsDiv.innerHTML = html;
        resultsDiv.classList.remove('hidden');
    } else {
        resultsDiv.innerHTML = `
            <div style="padding: 10px; font-size: 0.8rem; color: var(--text-muted); background: var(--input-bg);">
                No match in Admin records. "${query}" will be created.
            </div>`;
        resultsDiv.classList.remove('hidden');
    }
}


// --- FIX: Corrected Selection Function (No Infinite Loop) ---
function selectCustomer(name) {
    console.log("Selecting customer:", name); 
    
    const input = document.getElementById('cust-name');
    const resultsDiv = document.getElementById('customer-search-results');
    
    if(input) {
        // Just update the value
        input.value = name;
        
        // REMOVED: input.dispatchEvent(new Event('change')); 
        // ^ This line was causing the crash.
    }
    
    if(resultsDiv) {
        resultsDiv.classList.add('hidden');
    }
    
    // Update the UI stats directly
    if(typeof calculateCustomerStatsForDisplay === 'function') {
        calculateCustomerStatsForDisplay(name); 
    }
}



// 3. Calculate and display specific customer stats (Credit & Qty)
async function calculateCustomerStatsForDisplay(name) {
    if (!name) return;

    // Filter sales for this customer
    const sales = customerSales.filter(s => s.customerName.toLowerCase() === name.toLowerCase());
    
    if (sales.length === 0) {
        // New customer
        document.getElementById('customer-info-display').classList.add('hidden');
        return;
    }

    let totalCredit = 0;
    let totalQty = 0;

    sales.forEach(s => {
        totalQty += (s.quantity || 0);
        // Sum outstanding credit
        if (s.paymentType === 'CREDIT' && !s.creditReceived) {
            totalCredit += (s.totalValue || 0);
        }
    });

    // Update UI Elements
    document.getElementById('customer-current-credit').innerText = await formatCurrency(totalCredit);
    document.getElementById('customer-total-quantity').innerText = totalQty.toFixed(2) + ' kg';
    
    // Show the info card
    document.getElementById('customer-info-display').classList.remove('hidden');
}
// 4. Render the Main Customers Table (The "Customers Card")
async function renderCustomersTable() {
    const tbody = document.getElementById('customers-table-body');
    const filterValue = document.getElementById('customer-filter').value.toLowerCase();
    
    tbody.innerHTML = ''; 
    const customerStats = {};
    
    customerSales.forEach(sale => {
        // --- ISOLATION: Skip Rep Mode Entries ---
        if (sale.isRepModeEntry === true) return;

        const name = sale.customerName;
        if (!customerStats[name]) {
            customerStats[name] = { name: name, credit: 0, quantity: 0, lastSaleDate: 0 };
        }
        
        customerStats[name].quantity += (sale.quantity || 0);
        
        if (sale.paymentType === 'CREDIT' && !sale.creditReceived) {
            customerStats[name].credit += (sale.totalValue || 0);
        }
        
        const timestamp = new Date(sale.date).getTime();
        if (timestamp > customerStats[name].lastSaleDate) {
            customerStats[name].lastSaleDate = timestamp;
        }
    });

    // 2. Sort and Filter
    let sortedCustomers = Object.values(customerStats).sort((a, b) => {
        if (b.credit !== a.credit) return b.credit - a.credit; 
        return b.lastSaleDate - a.lastSaleDate; 
    });

    if (filterValue) {
        sortedCustomers = sortedCustomers.filter(c => c.name.toLowerCase().includes(filterValue));
    }

    document.getElementById('customer-count').innerText = `${sortedCustomers.length} active`;

    let totalOutstanding = 0;
    let totalGlobalQty = 0;

    // 3. Render Rows
    if (sortedCustomers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:15px; color:var(--text-muted);">No customers found</td></tr>`;
    } else {
        sortedCustomers.forEach(c => {
            totalOutstanding += c.credit;
            totalGlobalQty += c.quantity;

            const row = document.createElement('tr');
            const creditStyle = c.credit > 0 ? 'color:var(--warning); font-weight:800;' : 'color:var(--text-muted); opacity:0.5;';
            
            row.innerHTML = `
                <td style="text-align:left; font-weight:600;">${c.name}</td>
                <td style="text-align:right; ${creditStyle}">Rs ${safeValue(c.credit).toFixed(0)}</td>
                <td style="text-align:right;">${safeValue(c.quantity).toFixed(1)}</td>
                <td style="text-align:center;">
                    <button class="btn-theme" style="padding:4px 10px; font-size:0.75rem;" 
                        onclick="event.stopPropagation(); openCustomerManagement('${c.name.replace(/'/g, "\\'")}')">
                        Edit
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    document.getElementById('customers-total-credit').innerText = await formatCurrency(totalOutstanding);
    document.getElementById('customers-total-quantity').innerText = totalGlobalQty.toFixed(2) + ' kg';
}
// --- NEW CUSTOMER MANAGEMENT LOGIC ---

let currentManagingCustomer = null;

async function openCustomerManagement(customerName) {
    currentManagingCustomer = customerName;
    document.getElementById('manageCustomerTitle').innerText = customerName;
    document.getElementById('bulkPaymentAmount').value = '';
    
    document.getElementById('customerManagementOverlay').style.display = 'flex';
    renderCustomerTransactions(customerName);
}

function closeCustomerManagement() {
    document.getElementById('customerManagementOverlay').style.display = 'none';
    currentManagingCustomer = null;
    
    // Refresh calculations
    if(typeof refreshAllCalculations === 'function') {
        refreshAllCalculations();
    }
    
    // Refresh customer tables
    if(typeof renderCustomersTable === 'function') {
        renderCustomersTable();
    }
    
    // If in rep mode, refresh rep table
    if(appMode === 'rep' && typeof renderRepCustomerTable === 'function') {
        renderRepCustomerTable();
    }
}

async function renderCustomerTransactions(name) {
    const list = document.getElementById('customerManagementHistoryList');
    list.innerHTML = '';

    // Filter sales for this customer
    const transactions = customerSales.filter(s => s.customerName === name);
    
    // Find entity data
    const entity = paymentEntities.find(e => e.name.toLowerCase() === name.toLowerCase() && e.type === 'payor');
    
    // Determine Phone & Address to display
    const phone = entity?.phone || transactions.find(t => t.customerPhone)?.customerPhone || '';
    const address = entity?.address || ''; // New field

    // Update Header with Edit Button
    const headerTitle = document.getElementById('manageCustomerTitle');
    headerTitle.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px;">
            <span>${name}</span>
            <button class="btn-theme" style="padding:2px 6px; font-size:0.8rem; border:1px solid var(--accent); color:var(--accent); border-radius:50%;" 
                onclick="openCustomerEditModal('${name.replace(/'/g, "\\'")}')" title="Edit Contact Info">
                
            </button>
        </div>
        <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal; margin-top:4px;">
            ${phone ? ` ${phone}` : 'No Phone'} ${address ? `|  ${address}` : ''}
        </div>
    `;

    // Calculate Stats
    let currentDebt = 0;
    transactions.forEach(t => {
        if(t.paymentType === 'CREDIT' && !t.creditReceived) currentDebt += t.totalValue;
    });
    
    document.getElementById('manageCustomerStats').innerText = `Current Debt: ${formatCurrency(currentDebt)}`;

    // Sort: Pending Credits First, then Newest Date
    transactions.sort((a,b) => {
        const aPending = (a.paymentType === 'CREDIT' && !a.creditReceived) ? 1 : 0;
        const bPending = (b.paymentType === 'CREDIT' && !b.creditReceived) ? 1 : 0;
        if (bPending !== aPending) return bPending - aPending;
        return b.timestamp - a.timestamp;
    });

    if(transactions.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No history found</div>';
        return;
    }

    for (const t of transactions) {
        const isCredit = t.paymentType === 'CREDIT';
        const item = document.createElement('div');
        item.className = 'cust-history-item';
        
        let statusClass = t.creditReceived ? 'paid' : 'pending';
        let btnText = t.creditReceived ? 'PAID' : 'PENDING';
        let toggleBtnHtml = '';
        
        if(isCredit) {
            // FIX IS HERE: Added single quotes around ${t.id}
            toggleBtnHtml = `<button class="status-toggle-btn ${statusClass}" onclick="toggleSingleTransactionStatus('${t.id}')">${btnText}</button>`;
        } else {
            toggleBtnHtml = `<span class="status-toggle-btn" style="background:rgba(37, 99, 235, 0.1); color:var(--accent);">CASH SALE</span>`;
        }

        item.innerHTML = `
            <div class="cust-history-info">
                <div style="font-weight:700; font-size:0.85rem; color:var(--text-main);">${t.date}</div>
                <div style="font-size:0.75rem; color:var(--text-muted);">
                    ${t.quantity.toFixed(2)} kg @ ${formatCurrency(t.totalValue)}
                </div>
                <div style="font-size:0.7rem; color:var(--text-muted); margin-top:2px;">
                    ${getStoreLabel(t.supplyStore)}
                </div>
            </div>
            <div class="cust-history-actions">
                ${toggleBtnHtml}
                <button class="btn btn-sm btn-danger" style="padding:4px 8px;" onclick="deleteTransactionFromOverlay('${t.id}')"></button>
            </div>
        `;
        list.appendChild(item);
    }
}



async function toggleSingleTransactionStatus(id) {
    const index = customerSales.findIndex(s => s.id === id);
    if(index !== -1) {
        const sale = customerSales[index];
        sale.creditReceived = !sale.creditReceived;
        
        // If changing to received, logically update paymentType for cash flow calcs if needed
        // but keeping it as CREDIT type preserves history that it WAS a credit sale
        
        await idb.set('customer_sales', customerSales);
        notifyDataChange('all');

        renderCustomerTransactions(currentManagingCustomer);
        refreshAllCalculations(); // Update net cash immediately
    }
}

async function deleteTransactionFromOverlay(id) {
    if(confirm("Permanently delete this record?")) {
        customerSales = customerSales.filter(s => s.id !== id);
        await idb.set('customer_sales', customerSales);
        renderCustomerTransactions(currentManagingCustomer);
        refreshAllCalculations();
        notifyDataChange('all');

    }
}

async function processBulkPayment() {
    const amount = parseFloat(document.getElementById('bulkPaymentAmount').value);
    if(!amount || amount <= 0) {
        alert("Please enter a valid amount");
        return;
    }

    let remaining = amount;
    let updatedCount = 0;

    // Get pending credits for this customer, sorted OLDER first
    const pending = customerSales.filter(s => 
        s.customerName === currentManagingCustomer && 
        s.paymentType === 'CREDIT' && 
        !s.creditReceived
    ).sort((a,b) => a.timestamp - b.timestamp);

    if(pending.length === 0) {
        alert("No pending credit transactions found for this customer.");
        return;
    }

    pending.forEach(sale => {
        if(remaining >= sale.totalValue) {
            sale.creditReceived = true;
            sale.creditReceivedDate = new Date().toISOString().split('T')[0];
            remaining -= sale.totalValue;
            updatedCount++;
        }
    });

    if(updatedCount > 0) {
        await idb.set('customer_sales', customerSales);
        notifyDataChange('all');

        let msg = `Successfully cleared ${updatedCount} transaction(s).`;
        if(remaining > 0 && remaining < amount) {
            msg += `\nRemaining unallocated cash: ${await formatCurrency(remaining)}`;
        } else if (remaining === amount) {
            msg = "Amount was not enough to clear the oldest transaction fully. No changes made.";
        }
        
        alert(msg);
        document.getElementById('bulkPaymentAmount').value = '';
        renderCustomerTransactions(currentManagingCustomer);
        refreshAllCalculations();
    } else {
        alert(`Amount (${await formatCurrency(amount)}) is smaller than the oldest transaction (${await formatCurrency(pending[0].totalValue)}). \n\nPlease enter an amount sufficient to clear at least one full transaction.`);
    }
}

function filterCustomerManagementHistory() {
    const term = document.getElementById('cust-trans-search').value.toLowerCase();
    const items = document.querySelectorAll('.cust-history-item');
    
    items.forEach(item => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(term) ? 'flex' : 'none';
    });
}

// ========== NEW FUNCTION: Refresh All Calculations ==========
function refreshAllCalculations() {
    // This function recalculates everything to ensure consistency
    
    // 1. Refresh Cash Tracker (uses NET calculations)
    calculateCashTracker();
    
    // 2. Refresh Economic Dashboard
    calculateNetCash();
    
    // 3. Refresh Payment Summaries
    calculatePaymentSummaries();
    
    // 4. Refresh Entity Balances
    refreshEntityBalances();
    
    // 5. Update any production displays that might be affected
    updateUnitsAvailableIndicator();
    
    console.log("All calculations refreshed with NET values");
}

// Call this when any sales or production data changes
// You can add this to your existing save functions:
// - await recordEntry()
// - await saveCustomerSale()
// - await saveTransaction()
// ================================================
// LIQUID GLASSMORPHISM TOAST NOTIFICATION SYSTEM
// ================================================

// Inject toast styles
const toastStyles = document.createElement('style');
toastStyles.innerHTML = `
/* --- LIQUID GLASS TOAST STYLES --- */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
    width: 320px;
    max-width: 90%;
}

.liquid-toast {
    background: var(--glass);
    backdrop-filter: var(--backdrop-blur);
    -webkit-backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 16px 20px;
    box-shadow: var(--shadow), 0 6px 20px rgba(37, 99, 235, 0.15);
    position: relative;
    overflow: hidden;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
}

.liquid-toast::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.3), transparent);
}

.liquid-toast::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent-emerald));
    transform: scaleX(1);
    transform-origin: left;
    transition: transform 3s linear;
}

.liquid-toast.show {
    transform: translateX(0);
    opacity: 1;
}

.liquid-toast.hiding {
    transform: translateX(100%);
    opacity: 0;
}

.toast-content {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.toast-icon {
    font-size: 1.4rem;
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(37, 99, 235, 0.1);
    color: var(--accent);
}

.toast-icon.success { background: rgba(5, 150, 105, 0.1); color: var(--accent-emerald); }
.toast-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
.toast-icon.error { background: rgba(220, 38, 38, 0.1); color: var(--danger); }
.toast-icon.info { background: rgba(37, 99, 235, 0.1); color: var(--accent); }

.toast-text {
    flex: 1;
    font-size: 0.85rem;
    line-height: 1.4;
    color: var(--text-main);
    font-weight: 400;
}

.toast-close {
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-size: 1rem;
    cursor: pointer;
    padding: 0;
    margin-left: 8px;
    transition: color 0.2s;
    flex-shrink: 0;
    opacity: 0.7;
}

.toast-close:hover {
    color: var(--accent);
    opacity: 1;
}

.toast-progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent-emerald));
    width: 100%;
    transform-origin: left;
    animation: progressBar 3s linear forwards;
}

@keyframes progressBar {
    from { transform: scaleX(1); }
    to { transform: scaleX(0); }
}

/* Dark mode adjustments */
body.dark-mode .liquid-toast {
    background: rgba(30, 41, 59, 0.92);
    border-color: rgba(96, 165, 250, 0.15);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25), 0 6px 20px rgba(59, 130, 246, 0.15);
}

body.dark-mode .toast-close:hover {
    color: var(--accent);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .toast-container {
        width: 90%;
        left: 5%;
        right: 5%;
        align-items: center;
    }
    
    .liquid-toast {
        width: 100%;
    }
}

/* Toast types */
.toast-success { border-left: 4px solid var(--accent-emerald); }
.toast-warning { border-left: 4px solid var(--warning); }
.toast-error { border-left: 4px solid var(--danger); }
.toast-info { border-left: 4px solid var(--accent); }
`;
document.head.appendChild(toastStyles);

// Create toast container
const toastContainer = document.createElement('div');
toastContainer.className = 'toast-container';
document.body.appendChild(toastContainer);

// Toast function
function showToast(message, type = 'info', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `liquid-toast toast-${type}`;
    
    const icons = {
        success: '',
        warning: '',
        error: '',
        info: ''
    };
    
    toast.innerHTML = `
        <div class="toast-content">
            <div class="toast-icon ${type}">${icons[type] || icons.info}</div>
            <div class="toast-text">${message}</div>
            <button class="toast-close" onclick="this.closest('.liquid-toast').remove()"></button>
        </div>
        <div class="toast-progress-bar"></div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Auto-remove
    const removeToast = () => {
        toast.classList.remove('show');
        toast.classList.add('hiding');
        setTimeout(() => {
            if (toast.parentNode === toastContainer) {
                toastContainer.removeChild(toast);
            }
        }, 300);
    };
    
    // Progress bar animation
    setTimeout(removeToast, duration);
    
    // Close on click
    toast.addEventListener('click', (e) => {
        if (!e.target.classList.contains('toast-close')) {
            removeToast();
        }
    });
    
    return toast;
}

// Hijack the alert system
const originalAlert = window.alert;
window.alert = function(message) {
    // Check if message contains success keywords
    if (typeof message === 'string') {
        const lowerMsg = message.toLowerCase();
        if (lowerMsg.includes('success') || lowerMsg.includes('saved') || lowerMsg.includes('successfully')) {
            showToast(message, 'success', 3000);
            return;
        } else if (lowerMsg.includes('error') || lowerMsg.includes('failed') || lowerMsg.includes('invalid')) {
            showToast(message, 'error', 4000);
            return;
        } else if (lowerMsg.includes('warning') || lowerMsg.includes('caution') || lowerMsg.includes('insufficient')) {
            showToast(message, 'warning', 4000);
            return;
        }
    }
    
    // Default to info toast
    showToast(message, 'info', 3000);
};

// Also add a direct toast function for manual use
window.showToast = showToast;

// Enhanced console logging for debugging
console.oldLog = console.log;
console.log = function(...args) {
    console.oldLog(...args);
    // Optionally show toasts for important logs
    if (args[0] && typeof args[0] === 'string' && args[0].startsWith('[TOAST]')) {
        const message = args.slice(1).join(' ');
        const type = args[0].includes('SUCCESS') ? 'success' : 
                    args[0].includes('ERROR') ? 'error' : 
                    args[0].includes('WARNING') ? 'warning' : 'info';
        showToast(message, type, 3000);
    }
};

// --- 1. INITIALIZE RETURN STORAGE ---
// This stores returns separately so Factory Production records stay clean


// --- 2. UI CONTROL ---
function handleReturnQtyInput() {
    const retQty = parseFloat(document.getElementById('returnedQuantity').value) || 0;
    const section = document.getElementById('returnStoreSection');
    if (retQty > 0) {
        section.style.display = 'block';
    } else {
        section.style.display = 'none';
    }
    // Call your existing calculation if it exists
    if (typeof calculateSales === 'function') calculateSales();
}
// --- FIX: Advanced Customer Table Filter ---
function filterCustomers() {
    const input = document.getElementById('customer-filter');
    const filter = input.value.toLowerCase();
    const tbody = document.getElementById('customers-table-body');
    const rows = tbody.getElementsByTagName('tr');

    // Counters for UI feedback
    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
        // Look in the first cell (Name)
        const nameCell = rows[i].getElementsByTagName('td')[0];
        
        if (nameCell) {
            // Get text from the name cell, ignoring any child elements if necessary
            const txtValue = nameCell.textContent || nameCell.innerText;
            
            if (txtValue.toLowerCase().indexOf(filter) > -1) {
                rows[i].style.display = "";
                visibleCount++;
            } else {
                rows[i].style.display = "none";
            }
        }
    }
    
    // Update the counter text
    const counterElement = document.getElementById('customer-count');
    if(counterElement) {
        counterElement.innerText = `${visibleCount} visible`;
    }
}

async function openDataMenu() {
    // 1. Remove the blocking check for Rep Mode
    // previously: if(appMode === 'rep') { return; }

    // 2. Control Visibility of Admin Section
    const adminSection = document.getElementById('admin-controls-section');
    
    if (adminSection) {
        if (appMode === 'rep') {
            // Hide Admin Controls if in Rep Mode
            adminSection.style.display = 'none';
        } else {
            // Show Admin Controls if in Admin Mode
            adminSection.style.display = 'block';
        }
    }
    
    // 3. Show the Menu Overlay
    document.getElementById('dataMenuOverlay').style.display = 'flex';
    
    // 4. Update Sync Status Display
    const lastSync = await idb.get('last_synced');
    const display = document.getElementById('lastSyncDisplay');
    if (display) {
        display.textContent = lastSync ? 
            `Last Cloud Sync: ${new Date(lastSync).toLocaleString()}` : 
            'Not synced yet';
    }
}

function closeDataMenu() {
    document.getElementById('dataMenuOverlay').style.display = 'none';
}

// FIX 13: Remove these functions as they are redundant and bypass the new triggerCloudAction logic
// async function triggerCloudBackup() {
//     closeDataMenu();
//     await pushDataToCloud(); // Calls existing cloud backup logic
// }

// async function triggerCloudRestore() {
//     closeDataMenu();
//     if(confirm(" Overwrite current data with Cloud data?")) {
//         await pullDataFromCloud(); // Calls existing cloud restore logic
//     }
// }

async function triggerLocalBackup() {
    closeDataMenu();
    
    const data = { 
        mfg: db, 
        sales: await idb.get('noman_history', []),
        customerSales: await idb.get('customer_sales', []),
        repSales: await idb.get('rep_sales', []),
        factoryInventoryData: factoryInventoryData,
        factoryProductionHistory: factoryProductionHistory,
        factoryDefaultFormulas: factoryDefaultFormulas,
        factoryAdditionalCosts: factoryAdditionalCosts,
        factoryCostAdjustmentFactor: factoryCostAdjustmentFactor,
        factorySalePrices: factorySalePrices,
        factoryUnitTracking: factoryUnitTracking,
        paymentEntities: paymentEntities,
        paymentTransactions: paymentTransactions,
        stockReturns: stockReturns, 
        settings: await idb.get('naswar_default_settings', defaultSettings),
        
        // CRITICAL: Save the Graveyard to the file!
        deleted_records: Array.from(deletedRecordIds) 
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const timestamp = new Date().toISOString().split('T')[0];
    a.download = `NaswarDealers_Backup_${timestamp}.json`;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showToast("Backup file with Deletion History downloaded!", "success");
}


// ============================================
// UPLOAD OLD BACKUP FILE DIRECTLY TO CLOUD
// ============================================
// Reads a local .json backup file picked by the user and pushes it
// straight to Supabase  without touching IndexedDB or reloading the page.
// This solves the Android problem where IndexedDB data is lost but
// you still have the .json file saved on the phone.
async function uploadOldDataToCloud(event) {
    const file = event.target.files[0];
    // Reset the input so the same file can be picked again if needed
    event.target.value = '';
    if (!file) return;

    // --- GATE 1: Must be logged in ---
    if (!supabaseClient || !currentUser) {
        showToast('Please sign in first before uploading.', 'warning');
        closeDataMenu();
        showAuthOverlay();
        return;
    }

    // --- GATE 2: Prevent two uploads at the same time ---
    if (isSyncing) {
        showToast('Another sync is running. Please wait.', 'info');
        return;
    }

    closeDataMenu();
    showToast('Reading backup file...', 'info');

    // --- STEP 1: Read the file the user picked ---
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);

            // --- VALIDATE: Make sure this is actually one of our backup files ---
            if (!data.mfg && !data.customerSales && !data.paymentEntities) {
                showToast('This file does not look like a valid backup.', 'error');
                return;
            }

            // --- STEP 2: Ask the user to confirm ---
            if (!confirm(
                'UPLOAD TO CLOUD\n\n' +
                'This will merge this backup file into your cloud database.\n\n' +
                ' Records already in the cloud will NOT be deleted.\n' +
                ' If the same record exists in both places, the newer one wins.\n' +
                ' Deleted records (tombstones) will be respected.\n\n' +
                'Continue?'
            )) return;

            isSyncing = true;
            showToast('Uploading to cloud...', 'info');

            // --- STEP 3: Normalize the file ---
            // Old backups use "mfg" for production. Cloud uses "mfg_pro_pkr".
            // Old backups use "sales" for noman_history. We map them here.
            const normalized = {
                mfg_pro_pkr:                  data.mfg                          || data.mfg_pro_pkr                || [],
                noman_history:                data.sales                        || data.noman_history              || [],
                customer_sales:               data.customerSales                || data.customer_sales            || [],
                rep_sales:                    data.repSales                     || data.rep_sales                 || [],
                factory_inventory_data:       data.factoryInventoryData         || data.factory_inventory_data    || [],
                factory_production_history:   data.factoryProductionHistory     || data.factory_production_history|| [],
                payment_entities:             data.paymentEntities              || data.payment_entities          || [],
                payment_transactions:         data.paymentTransactions          || data.payment_transactions      || [],
                stock_returns:                data.stockReturns                 || data.stock_returns             || [],
                factory_default_formulas:     data.factoryDefaultFormulas       || data.factory_default_formulas  || { standard: [], asaan: [] },
                factory_additional_costs:     data.factoryAdditionalCosts       || data.factory_additional_costs  || { standard: 0, asaan: 0 },
                factory_cost_adjustment_factor: data.factoryCostAdjustmentFactor || data.factory_cost_adjustment_factor || { standard: 1, asaan: 1 },
                factory_sale_prices:          data.factorySalePrices            || data.factory_sale_prices       || { standard: 0, asaan: 0 },
                factory_unit_tracking:        data.factoryUnitTracking          || data.factory_unit_tracking     || {
                                                  standard: { produced: 0, consumed: 0, available: 0, unitCostHistory: [] },
                                                  asaan:    { produced: 0, consumed: 0, available: 0, unitCostHistory: [] }
                                              },
                naswar_default_settings:      data.settings                     || data.naswar_default_settings   || {},
                deleted_records:              data.deleted_records              || [],
                appMode:                      data.appMode                      || 'admin',
                repProfile:                   data.repProfile                   || 'NORAN SHAH',
                adminPin:                     data.adminPin                     || '1234'
            };

            // --- STEP 4: Build the tombstone set from the file ---
            const fileTombstones = new Set(normalized.deleted_records);

            // --- STEP 5: Filter out any tombstoned records from every array ---
            const filterAlive = (arr) => {
                if (!Array.isArray(arr)) return [];
                return arr.filter(item => {
                    if (!item || !item.id) return false;
                    if (fileTombstones.has(item.id)) return false;
                    return true;
                });
            };

            normalized.mfg_pro_pkr                = filterAlive(normalized.mfg_pro_pkr);
            normalized.noman_history              = filterAlive(normalized.noman_history);
            normalized.customer_sales             = filterAlive(normalized.customer_sales);
            normalized.rep_sales                  = filterAlive(normalized.rep_sales);
            normalized.factory_inventory_data     = filterAlive(normalized.factory_inventory_data);
            normalized.factory_production_history = filterAlive(normalized.factory_production_history);
            normalized.payment_entities           = filterAlive(normalized.payment_entities);
            normalized.payment_transactions       = filterAlive(normalized.payment_transactions);
            normalized.stock_returns              = filterAlive(normalized.stock_returns);

            // --- STEP 6: FETCH what is already in the cloud ---
            const { data: cloudRow, error: fetchError } = await supabaseClient
                .from('user_data')
                .select('data')
                .eq('user_id', currentUser.id)
                .maybeSingle();

            if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;

            let cloudData = (cloudRow && cloudRow.data) ? cloudRow.data : {};

            // --- STEP 7: MERGE  file data INTO cloud data ---
            // For each array: combine cloud + file, deduplicate by ID.
            // If the same ID exists in both, the one with the newer timestamp wins.
            function mergeArrays(cloudArr, fileArr) {
                if (!Array.isArray(cloudArr)) cloudArr = [];
                if (!Array.isArray(fileArr)) fileArr = [];

                const map = new Map();

                // Load cloud records first
                cloudArr.forEach(item => {
                    if (item && item.id) map.set(item.id, item);
                });

                // Overlay file records  newer timestamp wins
                fileArr.forEach(item => {
                    if (!item || !item.id) return;
                    if (fileTombstones.has(item.id)) return;

                    const existing = map.get(item.id);
                    if (!existing) {
                        map.set(item.id, item);
                    } else {
                        const fileTime  = item.timestamp      || new Date(item.date  || 0).getTime() || 0;
                        const cloudTime = existing.timestamp  || new Date(existing.date || 0).getTime() || 0;

                        if (fileTime >= cloudTime) {
                            map.set(item.id, item);
                        }
                    }
                });

                return Array.from(map.values());
            }

            const merged = {
                mfg_pro_pkr:                  mergeArrays(cloudData.mfg_pro_pkr,                  normalized.mfg_pro_pkr),
                noman_history:                mergeArrays(cloudData.noman_history,                normalized.noman_history),
                customer_sales:               mergeArrays(cloudData.customer_sales,               normalized.customer_sales),
                rep_sales:                    mergeArrays(cloudData.rep_sales,                    normalized.rep_sales),
                factory_inventory_data:       mergeArrays(cloudData.factory_inventory_data,       normalized.factory_inventory_data),
                factory_production_history:   mergeArrays(cloudData.factory_production_history,   normalized.factory_production_history),
                payment_entities:             mergeArrays(cloudData.payment_entities,             normalized.payment_entities),
                payment_transactions:         mergeArrays(cloudData.payment_transactions,         normalized.payment_transactions),
                stock_returns:                mergeArrays(cloudData.stock_returns,                normalized.stock_returns),

                factory_default_formulas:       cloudData.factory_default_formulas       || normalized.factory_default_formulas,
                factory_additional_costs:       cloudData.factory_additional_costs       || normalized.factory_additional_costs,
                factory_cost_adjustment_factor: cloudData.factory_cost_adjustment_factor || normalized.factory_cost_adjustment_factor,
                factory_sale_prices:            cloudData.factory_sale_prices            || normalized.factory_sale_prices,
                factory_unit_tracking:          cloudData.factory_unit_tracking          || normalized.factory_unit_tracking,
                naswar_default_settings:        cloudData.naswar_default_settings        || normalized.naswar_default_settings,

                deleted_records: [...new Set([
                    ...(cloudData.deleted_records || []),
                    ...normalized.deleted_records
                ])],

                appMode:     cloudData.appMode     || normalized.appMode,
                repProfile:  cloudData.repProfile  || normalized.repProfile,
                adminPin:    cloudData.adminPin    || normalized.adminPin
            };

            // --- STEP 8: PUSH the merged payload to Supabase ---
            const now = new Date().toISOString();
            const { error: uploadError } = await supabaseClient
                .from('user_data')
                .upsert({
                    user_id:     currentUser.id,
                    data:        merged,
                    last_synced: now
                }, { onConflict: 'user_id' });

            if (uploadError) throw uploadError;

            // --- STEP 9: Count records for the success message ---
            const counts = {
                production:    normalized.mfg_pro_pkr.length,
                sales:         normalized.noman_history.length,
                customerSales: normalized.customer_sales.length,
                repSales:      normalized.rep_sales.length,
                factory:       normalized.factory_inventory_data.length + normalized.factory_production_history.length,
                payments:      normalized.payment_entities.length + normalized.payment_transactions.length,
                returns:       normalized.stock_returns.length
            };
            const total = Object.values(counts).reduce((a, b) => a + b, 0);

            showToast('Upload Complete! ' + total + ' records merged to cloud.', 'success');
            console.log('[UPLOAD OLD DATA] Success. Counts:', counts);

        } catch (err) {
            console.error('[UPLOAD OLD DATA] Error:', err);
            showToast('Upload failed: ' + err.message, 'error');
        } finally {
            isSyncing = false;
        }
    };

    reader.onerror = () => {
        showToast('Failed to read the file. Try again.', 'error');
        isSyncing = false;
    };

    reader.readAsText(file);
}

// Ensure compatibility if unifiedBackup is called elsewhere
async function unifiedBackup() {
    await openDataMenu(); 
}

// --- BIOMETRIC AUTHENTICATION MODULE ---

const BiometricAuth = {
    // Check if device supports biometrics
    isAvailable: async () => {
        if (!window.PublicKeyCredential) return false;
        
        // Check for platform authenticator (TouchID/FaceID/Windows Hello)
        const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
        return available;
    },

    // Convert string to Uint8Array (needed for WebAuthn)
    _strToBin: (str) => {
        return Uint8Array.from(str, c => c.charCodeAt(0));
    },

    // Convert ArrayBuffer to Base64 (to save in IndexedDB)
    _bufToBase64: (buffer) => {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    },

    // Convert Base64 to ArrayBuffer
    _base64ToBuf: (base64) => {
        const binary_string = window.atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes.buffer;
    },

    // REGISTER: Create a new biometric lock
    register: async (username = 'User') => {
        try {
            if (!await BiometricAuth.isAvailable()) {
                throw new Error("Biometrics not available on this device.");
            }

            // Random challenge (usually from server, but generated locally here)
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            const userId = new Uint8Array(16);
            window.crypto.getRandomValues(userId);

            const publicKey = {
                challenge: challenge,
                rp: { name: "Naswar Dealers App" }, // Name shown in the prompt
                user: {
                    id: userId,
                    name: username,
                    displayName: username
                },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                authenticatorSelection: {
                    authenticatorAttachment: "platform", // Forces TouchID/FaceID
                    userVerification: "required"
                },
                timeout: 60000
            };

            const credential = await navigator.credentials.create({ publicKey });
            
            // Save the Credential ID to recognize this user later
            const credId = BiometricAuth._bufToBase64(credential.rawId);
            await idb.set('bio_cred_id', credId);
            await idb.set('bio_enabled', 'true');
            notifyDataChange('all');

            return true;
        } catch (err) {
            console.error("Biometric Registration Failed:", err);
            throw err;
        }
    },

    // AUTHENTICATE: Unlock using biometrics
    authenticate: async () => {
        try {
            const savedCredId = await idb.get('bio_cred_id');
            if (!savedCredId) throw new Error("No biometric set up found.");

            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            const publicKey = {
                challenge: challenge,
                allowCredentials: [{
                    id: BiometricAuth._base64ToBuf(savedCredId),
                    type: "public-key",
                    transports: ["internal"] // hints at internal authenticators
                }],
                userVerification: "required"
            };

            await navigator.credentials.get({ publicKey });
            return true; // If this line is reached, authentication passed
        } catch (err) {
            console.error("Authentication failed", err);
            return false;
        }
    }
};

// --- UI INTEGRATION FUNCTIONS ---

async function enableBiometricLock() {
    try {
        const success = await BiometricAuth.register("Manager");
        if(success) {
            showToast("Biometric Lock Enabled! ", "success");
            // Update UI to show it's enabled
            document.getElementById('bio-toggle-btn').innerText = "Disable Biometric Lock";
            document.getElementById('bio-toggle-btn').onclick = disableBiometricLock;
        }
    } catch (e) {
        showToast("Setup failed: " + e.message, "error");
    }
}

async function disableBiometricLock() {
    if(confirm("Remove biometric lock?")) {
        await idb.remove('bio_enabled');
        await idb.remove('bio_cred_id');
        showToast("Biometric Lock Removed", "info");
        document.getElementById('bio-toggle-btn').innerText = "Enable Biometric Lock ";
        document.getElementById('bio-toggle-btn').onclick = enableBiometricLock;
    }
}

// Replace the existing checkBiometricLock function
async function checkBiometricLock() {
    // 1. Force read from IndexedDB to ensure we have the persistent value
    const isEnabled = await idb.get('bio_enabled');
    
    // 2. Strict check: string 'true' or boolean true
    if (isEnabled === 'true' || isEnabled === true) {
        // Create a lock screen overlay
        const lockScreen = document.createElement('div');
        lockScreen.id = 'app-lock-screen';
        lockScreen.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-gradient); z-index: 100000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px);
        `;
        
        lockScreen.innerHTML = `
            <div style="font-size: 3rem; margin-bottom: 20px;"></div>
            <h2 style="color: var(--text-main); margin-bottom: 10px;">Security Locked</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Biometric authentication required</p>
            <button class="btn btn-main" style="margin-top: 25px; padding: 12px 30px;" onclick="triggerUnlock()">
                Unlock App
            </button>
        `;
        document.body.appendChild(lockScreen);

        // Define unlock function
        window.triggerUnlock = async () => {
            try {
                const success = await BiometricAuth.authenticate();
                if (success) {
                    const screen = document.getElementById('app-lock-screen');
                    if(screen) screen.remove();
                    showToast("Unlocked Successfully", "success");
                } else {
                    showToast("Authentication Failed. Try again.", "error");
                }
            } catch (e) {
                console.error(e);
                showToast("Biometric Error: " + e.message, "error");
            }
        };

        // Try to unlock automatically immediately
        setTimeout(() => window.triggerUnlock(), 500);
    }
}



// ==========================================
// SALES REP SYSTEM (With Admin Linkage)
// ==========================================

let repTransactionMode = 'sale'; // 'sale' or 'collection'

// --- 1. UI TOGGLES ---
async function setRepMode(mode) {
    repTransactionMode = mode;
    
    // Update Buttons
    document.getElementById('btn-mode-sale').className = `toggle-opt ${mode === 'sale' ? 'active' : ''}`;
    document.getElementById('btn-mode-coll').className = `toggle-opt ${mode === 'collection' ? 'active' : ''}`;
    
    // Toggle Fields
    if(mode === 'sale') {
        document.getElementById('rep-sale-inputs').classList.remove('hidden');
        document.getElementById('rep-coll-inputs').classList.add('hidden');
        document.getElementById('rep-result-label').innerText = "Total Sale Value:";
        calculateRepSalePreview();
    } else {
        document.getElementById('rep-sale-inputs').classList.add('hidden');
        document.getElementById('rep-coll-inputs').classList.remove('hidden');
        document.getElementById('rep-result-label').innerText = "New Balance After Collection:";
        // Reset preview
        const currentDebtText = document.getElementById('rep-customer-current-credit').innerText.replace('Rs ','').replace(/,/g,'');
        const currentDebt = parseFloat(currentDebtText) || 0;
        document.getElementById('rep-total-value').innerText = "Rs " + await formatCurrency(currentDebt).replace('PKR ','');
    }
}

// --- 2. ISOLATED CUSTOMER SEARCH ---
function searchRepCustomers(query) {
    const resultsDiv = document.getElementById('rep-customer-search-results');
    if (!query || query.length < 1) { resultsDiv.classList.add('hidden'); return; }

    // ISOLATION: Only show customers for THIS Rep created in Rep Mode
    const myCustomers = repSales.filter(s => 
        s.salesRep === currentRepProfile
    );
    
    const uniqueNames = [...new Set(myCustomers.map(s => s.customerName))];
    const matches = uniqueNames.filter(name => name.toLowerCase().includes(query.toLowerCase()));

    let html = '';
    if (matches.length > 0) {
        matches.forEach(name => {
            const safeName = name.replace(/'/g, "\\'");
            html += `<div style="padding:10px; cursor:pointer; border-bottom:1px solid var(--glass-border); font-size:0.85rem; background: var(--input-bg);" 
                     onmousedown="selectRepCustomer('${safeName}')"
                     onmouseover="this.style.background='var(--highlight-bg)'" 
                     onmouseout="this.style.background='var(--input-bg)'">
                    <strong>${name}</strong>
                </div>`;
        });
    } else {
        html = `<div style="padding:10px; color:var(--text-muted); font-size:0.8rem; background: var(--input-bg);">
                New customer "${query}" will be created
            </div>`;
    }
    
    resultsDiv.innerHTML = html;
    resultsDiv.classList.remove('hidden');
}


function selectRepCustomer(name) {
    document.getElementById('rep-cust-name').value = name;
    document.getElementById('rep-customer-search-results').classList.add('hidden');
    calculateRepCustomerStats(name);
}

// --- 3. CUSTOMER STATS & LOGIC ---
function calculateRepCustomerStats(name) {
    // Validate that this isn't a representative name
    if(name === 'NORAN SHAH' || name === 'NOMAN SHAH') {
        document.getElementById('rep-customer-info-display').classList.add('hidden');
        showToast("Cannot create transaction with representative name", "warning");
        return;
    }
    
    // Calculate total debt for this specific customer
    const history = repSales.filter(s => 
        s.customerName.toLowerCase() === name.toLowerCase() &&
        s.salesRep === currentRepProfile
    );
    
    let debt = 0;
    
    history.forEach(h => {
        // Add Credit Sales
        if (h.paymentType === 'CREDIT' && !h.creditReceived) debt += (h.totalValue || 0);
        // Subtract Collections
        if (h.paymentType === 'COLLECTION') debt -= (h.totalValue || 0);
    });

    document.getElementById('rep-customer-current-credit').innerText = "Rs " + debt.toFixed(2);
    document.getElementById('rep-customer-info-display').classList.remove('hidden');
    
    // Update preview if in collection mode
    if(repTransactionMode === 'collection') {
        const inputAmt = parseFloat(document.getElementById('rep-amount-collected').value) || 0;
        document.getElementById('rep-total-value').innerText = "Rs " + (debt - inputAmt).toFixed(2);
    }
}

function calculateRepSalePreview() {
    if(repTransactionMode === 'sale') {
        const qty = parseFloat(document.getElementById('rep-quantity').value) || 0;
        // STRATEGY: Use Default Factory Price
        const salePrice = factorySalePrices.standard || 0; 
        document.getElementById('rep-total-value').innerText = "Rs " + (qty * salePrice).toFixed(2);
    }
}

// Event listener for collection input to update dynamic balance
document.getElementById('rep-amount-collected').addEventListener('input', function() {
    const currentDebt = parseFloat(document.getElementById('rep-customer-current-credit').innerText.replace('Rs ','')) || 0;
    const inputAmt = parseFloat(this.value) || 0;
    document.getElementById('rep-total-value').innerText = "Rs " + (currentDebt - inputAmt).toFixed(2);
});
// --- 4. SAVE TRANSACTION (HANDLES BOTH MODES) ---
async function saveRepTransaction() {
    const date = document.getElementById('rep-date').value;
    const name = document.getElementById('rep-cust-name').value.trim();
    
    // --- PHONE ---
    const phoneInput = document.getElementById('rep-new-cust-phone');
    const phoneNumber = (!document.getElementById('rep-new-customer-phone-container').classList.contains('hidden')) 
                        ? phoneInput.value.trim() 
                        : '';

    // ---  GPS CAPTURE ---
    let gpsCoords = null;
    try {
        gpsCoords = await getPosition(); 
    } catch (e) {
        console.log("GPS unavailable");
    }

    if(!date || !name) { showToast("Date and Name required", "warning"); return; }

    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
    
    // Standard Pricing for Reps
    const costPerKg = calculateSalesCostPerKg('standard');
    const salePrice = factorySalePrices.standard || 0;

    let transactionRecord = {};

    if(repTransactionMode === 'sale') {
        const qty = parseFloat(document.getElementById('rep-quantity').value) || 0;
        const payType = document.querySelector('input[name="rep-payment"]:checked').value; 
        
        if(qty <= 0) { showToast("Enter Quantity", "warning"); return; }

        const totalValue = qty * salePrice;
        
        transactionRecord = {
            id: generateUUID('rep_sale'),
            date: date,
            time: timeString,
            customerName: name,
            customerPhone: phoneNumber, 
            quantity: qty,
            supplyStore: 'STORE_A', 
            paymentType: payType, 
            salesRep: currentRepProfile, 
            gps: gpsCoords, 
            totalCost: qty * costPerKg,
            totalValue: totalValue,
            profit: totalValue - (qty * costPerKg),
            creditReceived: (payType === 'CASH'), 
            timestamp: Date.now(),
            isRepModeEntry: true,
            affectsInventory: false
        };

    } else {
        // COLLECTION MODE
        const amount = parseFloat(document.getElementById('rep-amount-collected').value) || 0;
        if(amount <= 0) { showToast("Enter Amount", "warning"); return; }

        transactionRecord = {
            id: generateUUID('rep_coll'),
            date: date,
            time: timeString,
            customerName: name,
            customerPhone: phoneNumber,
            quantity: 0, 
            supplyStore: 'STORE_A',
            paymentType: 'COLLECTION', 
            salesRep: currentRepProfile,
            gps: gpsCoords,
            totalCost: 0,
            totalValue: amount, 
            profit: amount, 
            creditReceived: true,
            isCollection: true, 
            timestamp: Date.now(),
            isRepModeEntry: true,
            affectsInventory: false
        };
    }

    repSales.push(transactionRecord);
    await idb.set('rep_sales', repSales);
    
    // --- NOTIFY SYNC & CLEANUP ---
    notifyDataChange('all');

    // === NEW: TRIGGER AUTO LOCATION UPDATE ===
    // This runs silently in the background
    if (gpsCoords) {
        autoUpdateCustomerLocation(name, gpsCoords);
    }
    // =========================================

    document.getElementById('rep-quantity').value = '';
    document.getElementById('rep-cust-name').value = '';
    document.getElementById('rep-amount-collected').value = '';
    document.getElementById('rep-customer-info-display').classList.add('hidden');
    document.getElementById('rep-total-value').innerText = 'Rs 0.00';
    
    if(phoneInput) phoneInput.value = '';
    document.getElementById('rep-new-customer-phone-container').classList.add('hidden');

    refreshRepUI();
    showToast("Transaction Saved Successfully", "success");
    notifyDataChange('sales');
}
// --- AUTO-LOCATION UPDATE LOGIC ---

// Helper: Calculate distance between two GPS points in meters (Haversine Formula)
function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Radius of the earth in meters
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distance in meters
}

function deg2rad(deg) {
    return deg * (Math.PI / 180);
}

// Main Logic: Check history and update customer default location
async function autoUpdateCustomerLocation(customerName, currentGps) {
    if (!currentGps || !currentGps.lat || !currentGps.lng) return;

    // 1. Check if Customer Entity exists
    const entityIndex = paymentEntities.findIndex(e => e.name.toLowerCase() === customerName.toLowerCase());
    
    // If customer doesn't exist in entities yet, wait for next sync or manual add
    if (entityIndex === -1) return; 

    const entity = paymentEntities[entityIndex];

    // 2. If address is already set, don't overwrite it automatically (preserve manual edits)
    if (entity.address && entity.address.length > 5) return;

    // 3. Scan Rep Sales History for this customer
    // We look for ONE other transaction close to this spot
    const matchFound = repSales.some(sale => {
        // Skip the transaction we just saved (it might not be in the array yet, or has same timestamp)
        if (sale.timestamp > Date.now() - 2000) return false; 

        if (sale.customerName.toLowerCase() === customerName.toLowerCase() && sale.gps) {
            const dist = getDistanceFromLatLonInMeters(
                currentGps.lat, currentGps.lng,
                sale.gps.lat, sale.gps.lng
            );
            // If within 100 meters, consider it the "Same Coordinate"
            return dist < 100; 
        }
        return false;
    });

    // 4. If a match is found (Multiple transactions at same spot), update the Entity
    if (matchFound) {
        const coordsString = `GPS: ${currentGps.lat.toFixed(5)}, ${currentGps.lng.toFixed(5)}`;
        
        // Update the entity in memory
        paymentEntities[entityIndex].address = coordsString;
        paymentEntities[entityIndex].updatedAt = Date.now();

        // Save to Database
        await idb.set('payment_entities', paymentEntities);
        
        // Notify Sync
        notifyDataChange('entities');
        
        console.log(`[AUTO-LOC] Default location updated for ${customerName}: ${coordsString}`);
        if (typeof showToast === 'function') {
            showToast(`Location confirmed! Saved as default for ${customerName}.`, "success");
        }
    }
}

// ==========================================
//  LIVE TRACKING MAP FUNCTIONS (LEAFLET)
// ==========================================

let repMap = null;
let repMapMarkers = [];
let repPolyline = null;

// Helper to safely get GPS coordinates
function getPosition() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            resolve(null);
            return;
        }
        navigator.geolocation.getCurrentPosition(
            (position) => resolve({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
            }),
            (error) => {
                console.log("GPS Error:", error);
                resolve(null); // Resolve null on error so app doesn't crash
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    });
}

// Initialize Map (Call this once when app loads or Admin tab opens)
function initRepMap() {
    if (repMap) return; // Already initialized or container missing

    const mapContainer = document.getElementById('rep-map-container');
    if (!mapContainer) return;

    // Default to Bannu coordinates, zoom level 13
    repMap = L.map('rep-map-container').setView([32.9910, 70.6055], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(repMap);
}

// Render the Route on the Map
function updateRepLiveMap() {
    // 1. Safety Checks
    if (typeof L === 'undefined') return;
    const container = document.getElementById('rep-map-container');
    
    // Only run if the map container is actually visible (Admin mode)
    if (!container || container.offsetParent === null) return;

    if (!repMap) initRepMap();

    // 2. Clear existing markers and lines
    repMapMarkers.forEach(layer => repMap.removeLayer(layer));
    repMapMarkers = [];
    if (repPolyline) {
        repMap.removeLayer(repPolyline);
        repPolyline = null;
    }

    const dateInput = document.getElementById('rep-date');
    const selectedDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];

    // 3. Filter data for Selected Rep and Date
    const dailyRoute = repSales
        .filter(s => s.salesRep === currentRepProfile && s.date === selectedDate && s.gps)
        .sort((a, b) => a.timestamp - b.timestamp);

    if (dailyRoute.length === 0) {
        return;
    }

    const latLngs = [];

    // 4. Plot Markers
    dailyRoute.forEach(txn => {
        if (txn.gps && txn.gps.lat && txn.gps.lng) {
            const lat = txn.gps.lat;
            const lng = txn.gps.lng;
            latLngs.push([lat, lng]);

            // UPDATED: Color Logic for  Sale |  Collection |  Credit
            let color = '#3b82f6'; // Default Blue (Cash Sale)
            let typeStr = 'Cash Sale';
            let detailStr = `${txn.quantity.toFixed(2)} kg`;

            if (txn.paymentType === 'COLLECTION') { 
                color = '#10b981'; // Green (Collection)
                typeStr = 'Collection';
                detailStr = `Rs ${txn.totalValue.toFixed(2)}`;
            } else if (txn.paymentType === 'CREDIT') {
                color = '#f59e0b'; // Yellow/Orange (Credit Sale)
                typeStr = 'Credit Sale';
                detailStr = `${txn.quantity.toFixed(2)} kg (Credit)`;
            }

            // Create a custom circle marker
            const marker = L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            })
            .bindPopup(`
                <strong>${txn.customerName}</strong><br>
                <small>${txn.time}</small><br>
                <span style="color:${color}; font-weight:bold;">${typeStr}</span>: ${detailStr}
            `);

            marker.addTo(repMap);
            repMapMarkers.push(marker);
        }
    });

    // 5. Draw Path (Polyline)
    if (latLngs.length > 1) {
        repPolyline = L.polyline(latLngs, {
            color: '#2563eb', 
            weight: 3,
            opacity: 0.6,
            dashArray: '5, 10'
        }).addTo(repMap);
    }

    // 6. Fit Bounds to show all points
    if (repMapMarkers.length > 0) {
        const group = new L.featureGroup(repMapMarkers);
        repMap.fitBounds(group.getBounds().pad(0.1));
    }
}

// Function to switch view in Admin Mode
function adminSwitchRepProfile(newProfile) {
    if (appMode !== 'admin') return;
    
    currentRepProfile = newProfile;
    
    // Update Tables and Map
    refreshRepUI();
    
    // Small delay to allow UI to settle before map resize
    setTimeout(updateRepLiveMap, 200);
    
    if(typeof showToast === 'function') {
        showToast(`Viewing dashboard for ${newProfile}`, 'info');
    }
}


    

// --- 5. RENDER REP TABLES ---
function renderRepCustomerTable() {
    const tbody = document.getElementById('rep-customers-table-body');
    if (!tbody) {
        console.error('Table body element not found');
        return;
    }
    
    const filterInput = document.getElementById('rep-filter');
    const filter = filterInput ? filterInput.value.toLowerCase() : '';
    tbody.innerHTML = '';

    // ISOLATION: Filter strictly for Rep Mode entries
    const myData = repSales.filter(s => 
        s.salesRep === currentRepProfile 
    );
    
    const custMap = {};

    myData.forEach(s => {
        if(!custMap[s.customerName]) custMap[s.customerName] = { debt: 0, count: 0 };
        custMap[s.customerName].count++;
        // Calculate Net Debt
        if(s.paymentType === 'CREDIT' && !s.creditReceived) custMap[s.customerName].debt += s.totalValue;
        if(s.paymentType === 'COLLECTION') custMap[s.customerName].debt -= s.totalValue;
    });

    const sortedCustomers = Object.keys(custMap).sort();
    
    if(sortedCustomers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--text-muted); font-size: 0.9rem;">No customers yet. Add your first sale to get started!</td></tr>`;
        return;
    }

    let visibleCount = 0;
    sortedCustomers.forEach(name => {
        if(filter && !name.toLowerCase().includes(filter)) return;
        visibleCount++;
        const data = custMap[name];
        
        const tr = document.createElement('tr');
        tr.style.display = 'table-row'; // Ensure row is visible
        tr.innerHTML = `
            <td style="text-align:left; padding-left: 16px; padding-top: 12px; padding-bottom: 12px;"><strong style="color: var(--text-main);">${name}</strong></td>
            <td style="text-align:right; color:${data.debt > 1 ? 'var(--warning)' : 'var(--accent-emerald)'}; font-weight: 700; font-size: 0.85rem;">
                Rs ${data.debt.toLocaleString()}
            </td>
            <td style="text-align:right; color: var(--text-muted); font-size: 0.8rem;">${data.count} ${data.count === 1 ? 'transaction' : 'transactions'}</td>
            <td style="text-align:center; padding-right: 16px;">
                <button class="btn-theme" style="padding:5px 12px; font-size:0.7rem; border-radius: 8px; font-weight: 600;" 
                    onclick="event.stopPropagation(); openRepCustomerManagement('${name.replace(/'/g, "\\'")}')">
                     View
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // If filter excluded all results
    if(visibleCount === 0 && sortedCustomers.length > 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--text-muted); font-size: 0.9rem;">No customers match "${filter}"</td></tr>`;
    }
}

// --- 3. OPEN CUSTOMER MANAGEMENT FOR REP (SIMPLIFIED VERSION) ---
async function openRepCustomerManagement(customerName) {
    // Use the existing customer management overlay
    currentManagingCustomer = customerName;
    
    // Filter transactions for this specific customer and rep
    const customerTransactions = repSales.filter(s => 
        s.customerName === customerName && 
        s.salesRep === currentRepProfile
    );
    
    // Calculate current debt
    let currentDebt = 0;
    customerTransactions.forEach(t => {
        if(t.paymentType === 'CREDIT' && !t.creditReceived) {
            currentDebt += t.totalValue;
        }
        if(t.paymentType === 'COLLECTION') {
            currentDebt -= t.totalValue;
        }
    });
    
    // Update overlay title and stats
    document.getElementById('manageCustomerTitle').innerText = customerName;
    document.getElementById('manageCustomerStats').innerText = `Current Debt: ${await formatCurrency(currentDebt)}`;
    document.getElementById('bulkPaymentAmount').value = '';
    
    // Show the overlay
    document.getElementById('customerManagementOverlay').style.display = 'flex';
    
    // Render transactions (filtered for this rep)
    renderRepCustomerTransactions(customerName);
}
async function renderRepCustomerTransactions(name) {
    const list = document.getElementById('customerManagementHistoryList');
    list.innerHTML = '';

    // Filter sales for this customer AND this rep
    const transactions = repSales.filter(s => 
        s.customerName === name && 
        s.salesRep === currentRepProfile
    );
    
    // Find entity data
    const entity = paymentEntities.find(e => e.name.toLowerCase() === name.toLowerCase());
    
    // Determine Phone & Address
    const phone = entity?.phone || transactions.find(t => t.customerPhone)?.customerPhone || '';
    const address = entity?.address || '';

    // Update Header with Edit Button
    const headerTitle = document.getElementById('manageCustomerTitle');
    headerTitle.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px;">
            <span>${name}</span>
            <button class="btn-theme" style="padding:2px 6px; font-size:0.8rem; border:1px solid var(--accent); color:var(--accent); border-radius:50%;" 
                onclick="openCustomerEditModal('${name.replace(/'/g, "\\'")}')" title="Edit Contact Info">
                
            </button>
        </div>
        <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal; margin-top:4px;">
            ${phone ? ` ${phone}` : 'No Phone'} ${address ? `|  ${address}` : ''}
        </div>
    `;
    
    // Calculate Stats
    let currentDebt = 0;
    transactions.forEach(t => {
        if(t.paymentType === 'CREDIT' && !t.creditReceived) currentDebt += t.totalValue;
        if(t.paymentType === 'COLLECTION') currentDebt -= t.totalValue;
    });
    
    document.getElementById('manageCustomerStats').innerText = `Current Debt: ${formatCurrency(currentDebt)}`;

    // Sort: Pending Credits First, then Newest Date
    transactions.sort((a,b) => {
        const aPending = (a.paymentType === 'CREDIT' && !a.creditReceived) ? 1 : 0;
        const bPending = (b.paymentType === 'CREDIT' && !b.creditReceived) ? 1 : 0;
        if (bPending !== aPending) return bPending - aPending;
        return b.timestamp - a.timestamp;
    });

    if(transactions.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No history found</div>';
        return;
    }

    for (const t of transactions) {
        const isCredit = t.paymentType === 'CREDIT';
        const isCollection = t.paymentType === 'COLLECTION';
        const item = document.createElement('div');
        item.className = 'cust-history-item';
        
        let statusClass = t.creditReceived ? 'paid' : 'pending';
        let btnText = t.creditReceived ? 'PAID' : 'PENDING';
        let toggleBtnHtml = '';
        
        if(isCredit) {
            // FIXED: Added quotes around t.id
            toggleBtnHtml = `<button class="status-toggle-btn ${statusClass}" onclick="toggleSingleTransactionStatus('${t.id}')">${btnText}</button>`;
        } else if(isCollection) {
            toggleBtnHtml = `<span class="status-toggle-btn" style="background:rgba(5, 150, 105, 0.1); color:var(--accent-emerald);"> COLLECTION</span>`;
        } else {
            toggleBtnHtml = `<span class="status-toggle-btn" style="background:rgba(37, 99, 235, 0.1); color:var(--accent);">CASH SALE</span>`;
        }

        item.innerHTML = `
            <div class="cust-history-info">
                <div style="font-weight:700; font-size:0.85rem; color:var(--text-main);">${t.date}</div>
                <div style="font-size:0.75rem; color:var(--text-muted);">
                    ${isCollection ? `Collection: ${formatCurrency(t.totalValue)}` : `${t.quantity.toFixed(2)} kg @ ${formatCurrency(t.totalValue)}`}
                </div>
                <div style="font-size:0.7rem; color:var(--text-muted); margin-top:2px;">
                    ${getStoreLabel(t.supplyStore)}
                </div>
            </div>
            <div class="cust-history-actions">
                ${toggleBtnHtml}
                <button class="btn btn-sm btn-danger" style="padding:4px 8px;" onclick="deleteRepTransaction('${t.id}')"></button>
            </div>
        `;
        list.appendChild(item);
    }
}
// --- NEW CUSTOMER DETAILS EDIT LOGIC ---

function openCustomerEditModal(customerName) {
    document.getElementById('edit-cust-name').value = customerName;
    
    // Find existing entity data
    const entity = paymentEntities.find(e => e.name.toLowerCase() === customerName.toLowerCase());
    
    // Find phone from sales records if not in entity
    const saleRecord = repSales.find(s => s.customerName === customerName && s.customerPhone);
    
    // Populate Fields
    document.getElementById('edit-cust-phone').value = entity?.phone || saleRecord?.customerPhone || '';
    document.getElementById('edit-cust-address').value = entity?.address || '';
    
    document.getElementById('customerEditOverlay').style.display = 'flex';
}

function closeCustomerEditModal() {
    document.getElementById('customerEditOverlay').style.display = 'none';
}

async function saveCustomerDetails() {
    const name = document.getElementById('edit-cust-name').value;
    const phone = document.getElementById('edit-cust-phone').value.trim();
    const address = document.getElementById('edit-cust-address').value.trim();
    
    if (!name) return;

    // 1. Find or Create Entity
    let entity = paymentEntities.find(e => e.name.toLowerCase() === name.toLowerCase());
    
    if (entity) {
        // Update existing
        entity.phone = phone;
        entity.address = address; // Add address field
        entity.updatedAt = Date.now();
    } else {
        // Create new 'Payor' entity if it doesn't exist
        entity = {
            id: Date.now(),
            name: name,
            type: 'payor',
            phone: phone,
            address: address,
            wallet: '',
            createdAt: Date.now(),
            updatedAt: Date.now()
        };
        paymentEntities.push(entity);
    }
    
    // 2. Save Entity Data
    await idb.set('payment_entities', paymentEntities);
    
    // 3. Update Sales Records (Optional: Update flat phone data in sales history for consistency)
    let salesUpdated = false;
    repSales.forEach(sale => {
        if(sale.customerName === name && sale.customerPhone !== phone) {
            sale.customerPhone = phone;
            salesUpdated = true;
        }
    });
    
    if(salesUpdated) {
        await idb.set('rep_sales', repSales);
    }
    
    // 4. Sync & Refresh
    notifyDataChange('entities');
    closeCustomerEditModal();
    
    // Refresh the background transaction view to show new details immediately
    if (appMode === 'rep') {
        renderRepCustomerTransactions(name);
    } else {
        renderCustomerTransactions(name);
    }
    
    showToast("Customer details updated successfully", "success");
}
// --- PRECISION AUTO-LOCATION (Optimized for Bannu/Pakistan) ---
async function fetchDeviceLocation() {
    const statusDiv = document.getElementById('location-status');
    const addressInput = document.getElementById('edit-cust-address');
    const btn = document.querySelector('button[onclick="fetchDeviceLocation()"]');
    
    // 1. Check Support
    if (!navigator.geolocation) {
        statusDiv.textContent = "GPS not supported on this device.";
        statusDiv.style.color = "var(--danger)";
        return;
    }

    // 2. UI Loading State
    if(btn) btn.disabled = true;
    statusDiv.innerHTML = '<span class="update-indicator"></span> Pinpointing satellite location...';
    statusDiv.style.color = "var(--accent)";
    addressInput.placeholder = "Fetching location...";

    // 3. High Accuracy GPS Settings
    const gpsOptions = {
        enableHighAccuracy: true,
        timeout: 20000, // 20 seconds to get a lock
        maximumAge: 0   // Force new reading
    };

    navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        // Immediate Fallback: Save Coordinates + Google Maps Link
        // (This ensures that even if the name fails, the location is saved precisely)
        const googleMapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
        const coordsText = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
        
        statusDiv.textContent = `GPS Accuracy: ${Math.round(accuracy)}m. Decoding name...`;

        try {
            // 4. Call API with 'extratags' to find local names
            const controller = new AbortController();
            const apiTimeout = setTimeout(() => controller.abort(), 10000);

            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&extratags=1&namedetails=1`,
                { headers: { 'User-Agent': 'NaswarApp/1.0' }, signal: controller.signal }
            );
            
            clearTimeout(apiTimeout);

            if (!response.ok) throw new Error("Map API Error");

            const data = await response.json();
            
            if (data && data.address) {
                const addr = data.address;
                
                // --- CUSTOM PARSING FOR BANNU AREAS ---
                // We prioritize specific landmarks over generic district names
                
                // 1. Specific Place Name (Mosque, Shop, School, etc.)
                const placeName = addr.amenity || addr.shop || addr.building || addr.tourism || addr.historic || addr.leisure || addr.office || '';
                
                // 2. Local Area / Neighborhood (Suburb, Hamlet, Village)
                // In Bannu, 'hamlet' or 'village' often holds the area name like "Sikander Khel"
                const localArea = addr.neighbourhood || addr.suburb || addr.hamlet || addr.village || addr.quarter || '';
                
                // 3. Road / Street (Often missing, but good if present)
                const road = addr.road || addr.pedestrian || addr.street || '';
                
                // 4. City / Town
                const city = addr.town || addr.city || addr.county || 'Bannu';

                // --- BUILD THE STRING ---
                let finalAddress = "";

                if (placeName) {
                    // Result: "Jamia Masjid, ..."
                    finalAddress += placeName + ", ";
                }
                
                if (road) {
                    // Result: "Main Bazaar Road, ..."
                    finalAddress += road + ", ";
                } else if (!placeName) {
                    // If no road AND no place name, generic marker
                    finalAddress += "Near ";
                }

                if (localArea) {
                    // Result: "... Sikander Khel, ..."
                    finalAddress += localArea + ", ";
                }

                finalAddress += city;

                // CLEANUP: If parsing failed and we only got "Bannu", fallback to formatted API name
                // or keep the coordinates if the name is too vague.
                if (finalAddress.trim() === "Bannu" || finalAddress.trim() === "Near Bannu") {
                     // Try to use the full display name but remove the country/postcode to keep it short
                     const parts = data.display_name.split(', ');
                     // Take the first 3 parts (usually Spot, Road, Area)
                     finalAddress = parts.slice(0, 3).join(', ');
                }

                // Append Coordinates to ensure precision for delivery
                addressInput.value = `${finalAddress} (${coordsText})`;
                
                statusDiv.textContent = ` Location Found: ${localArea || placeName || city}`;
                statusDiv.style.color = "var(--accent-emerald)";
                
                if(typeof showToast === 'function') showToast("Address updated successfully", "success");

            } else {
                throw new Error("Address not found");
            }
        } catch (error) {
            console.error("Geocoding error:", error);
            // FAILSAFE: If Internet fails or Map API fails, stick with Coordinates
            // This allows the user to copy-paste the numbers into Google Maps later
            addressInput.value = `GPS: ${coordsText}`;
            statusDiv.textContent = "Address lookup failed. Saved GPS Coordinates.";
            statusDiv.style.color = "var(--warning)";
        } finally {
            if(btn) btn.disabled = false;
        }

    }, (error) => {
        let msg = "Location error.";
        switch(error.code) {
            case error.PERMISSION_DENIED: msg = " Permission denied. Check Phone Settings."; break;
            case error.POSITION_UNAVAILABLE: msg = " Weak GPS signal. Go outside."; break;
            case error.TIMEOUT: msg = " GPS timeout. Try again."; break;
        }
        statusDiv.textContent = msg;
        statusDiv.style.color = "var(--danger)";
        if(btn) btn.disabled = false;
    }, gpsOptions);
}


// Alias for backward compatibility
const refreshEntityList = renderEntityTable;


function renderRepHistory() {
    const list = document.getElementById('repHistoryList');
    if (!list) return;
    list.innerHTML = '';
    
    // CHANGED: Get date from the input field instead of system "today"
    const dateInput = document.getElementById('rep-date');
    const selectedDate = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];
    
    // Dynamic Header Text
    const isToday = selectedDate === new Date().toISOString().split('T')[0];
    const headerText = isToday ? "Today's Activity" : `Activity for ${selectedDate}`;

    // Filter data by the SELECTED date
    const activityData = repSales
        .filter(s => 
            s.salesRep === currentRepProfile && 
            s.date === selectedDate // Match the date picker
        )
        .sort((a,b) => b.timestamp - a.timestamp);

    if(activityData.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted);">No activity found for ${selectedDate}</div>`;
        return;
    }

    // Create compact list view
    let tableHTML = `
        <div class="section liquid-card" style="padding: 15px;">
            <h4 style="margin: 0 0 15px 0; color: var(--accent); font-size: 0.9rem;">${headerText}</h4>
            <div style="max-height: 400px; overflow-y: auto;">
    `;

    activityData.forEach(item => {
        let typeIcon = '';
        let typeColor = '';
        let qtyAmount = '';
        
        if(item.paymentType === 'COLLECTION') {
            typeIcon = ''; // Added icon for visual clarity
            typeColor = 'var(--accent-emerald)';
            qtyAmount = `Collected: Rs ${item.totalValue.toFixed(2)}`;
        } else if (item.paymentType === 'CREDIT') {
            typeIcon = '';
            typeColor = 'var(--warning)';
            qtyAmount = `${item.quantity.toFixed(2)} kg - Rs ${item.totalValue.toFixed(2)}`;
        } else {
            typeIcon = '';
            typeColor = 'var(--accent)';
            qtyAmount = `${item.quantity.toFixed(2)} kg - Rs ${item.totalValue.toFixed(2)}`;
        }

        tableHTML += `
            <div style="
                display: flex; 
                justify-content: space-between; 
                align-items: center;
                padding: 12px;
                margin-bottom: 8px;
                background: var(--input-bg);
                border-radius: 10px;
                border: 1px solid var(--glass-border);
                transition: all 0.2s;
            ">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span style="font-size: 1.2rem;">${typeIcon}</span>
                        <strong style="color: var(--text-main); font-size: 0.9rem;">${item.customerName}</strong>
                    </div>
                    <div style="font-size: 0.75rem; color: ${typeColor}; font-weight: 600;">
                        ${qtyAmount}
                    </div>
                </div>
                <div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                    <div style="font-size: 0.7rem; color: var(--text-muted);">
                        ${item.time}
                    </div>
                    <button class="btn btn-danger btn-sm" style="padding: 2px 8px; font-size: 0.7rem;" onclick="(async () => { await deleteRepTransaction('${item.id}') })()">
                        Delete
                    </button>
                </div>
            </div>
        `;
    });

    tableHTML += `
            </div>
        </div>
    `;

    list.innerHTML = tableHTML;
}


function refreshRepUI() {
    renderRepCustomerTable();
    renderRepHistory();
    
    // Only update map if in Admin mode (Reps don't need to track themselves)
    if (appMode === 'admin') {
        // Check if map function exists to prevent errors
        if (typeof updateRepLiveMap === 'function') {
            // Small timeout to allow the div to become visible
            setTimeout(updateRepLiveMap, 200); 
        }
    }
}

// ==========================================
// ADMIN & REP MODE LOGIC (GLOBAL SCOPE)
// ==========================================

// Global Settings
let appMode = 'admin'; 
let currentRepProfile = 'NORAN SHAH';
let adminPin = '1234';

// 1. ACTIVATE REP MODE (Called from Data Menu)
async function activateRepMode() {
    const newPinInput = document.getElementById('setting-admin-pin');
    const selectedRepInput = document.getElementById('setting-rep-select');
    
    // Safety check if elements exist
    if (!newPinInput || !selectedRepInput) {
        console.error("Admin controls not found in DOM");
        return;
    }

    const newPin = newPinInput.value;
    const selectedRep = selectedRepInput.value;
    
    if(newPin.length < 4) {
        alert("Please set a 4-digit PIN first.");
        return;
    }
    
    if(confirm(`Confirm locking this device for ${selectedRep}?\n\nYou will need the PIN to access Admin tabs again.`)) {
        adminPin = newPin;
        currentRepProfile = selectedRep;
        appMode = 'rep';
        
        await idb.set('adminPin', adminPin);
        await idb.set('repProfile', currentRepProfile);
        await idb.set('appMode', appMode);
        notifyDataChange('all');

        lockToRepMode();
        
        // Close menu if function exists
        if(typeof closeDataMenu === 'function') closeDataMenu();
    }
}

// 2. LOCK UI (Hides Admin Tabs)
function lockToRepMode() {
    // 1. Hide Standard Nav Tabs (Bottom Bar)
    const nav = document.querySelector('.nav-tabs');
    if(nav) nav.style.display = 'none';
    
    // 2. Hide all main content tabs initially
    ['prod', 'sales', 'calc', 'factory', 'payments'].forEach(t => {
        const el = document.getElementById('tab-' + t);
        if(el) el.classList.add('hidden');
    });
    
    // 3. Force Show Rep Tab
    const repTab = document.getElementById('tab-rep');
    if(repTab) repTab.classList.remove('hidden');
    
    // 4. HIDE ADMIN CARD (Map + Selector) - Critical Fix
    const adminControls = document.getElementById('admin-rep-controls');
    if(adminControls) {
        adminControls.classList.add('hidden'); // Use class to hide
        adminControls.style.display = 'none';  // Double ensure with inline style
    }

    // 5. SHOW REP HEADER (Locked State)
    const repHeader = document.getElementById('rep-header');
    if(repHeader) {
        repHeader.classList.remove('hidden');
        repHeader.style.display = 'flex';
    }
    
    // 6. Update Display Name
    const nameDisplay = document.getElementById('current-rep-name-display');
    if(nameDisplay) nameDisplay.innerText = currentRepProfile;
    
   // 7. Refresh Data
    if(typeof refreshRepUI === 'function') refreshRepUI();

    // 8. SHOW New Transaction Card Immediately (FIX)
    const newTransCard = document.getElementById('rep-new-transaction-card');
    if(newTransCard) {
        newTransCard.style.display = 'block';
    }
}


// 3. OPEN ADMIN PIN MODAL
function openAdminPinModal() {
    const modal = document.getElementById('adminPinOverlay');
    if(modal) {
        modal.style.display = 'flex';
        const input = document.getElementById('admin-pin-input');
        if(input) {
            input.value = '';
            input.focus();
        }
    }
}

// 4. CLOSE ADMIN PIN MODAL
function closeAdminPinModal() {
    const modal = document.getElementById('adminPinOverlay');
    if(modal) modal.style.display = 'none';
}

// 5. VERIFY PIN & UNLOCK
async function verifyAdminPin() {
    const input = document.getElementById('admin-pin-input').value;
    if (input === adminPin) {
        await unlockAdminMode();
    } else {
        alert("Incorrect PIN");
        document.getElementById('admin-pin-input').value = '';
    }
}

// 6. UNLOCK ADMIN MODE
// ==========================================
// PERSISTENT MODE LOCK (ENHANCED)
// ==========================================

// --- 1. CHECK MODE ON EVERY PAGE LOAD ---
async function enforceRepModeLock() {
    const storedMode = await idb.get('appMode');
    
    if (storedMode === 'rep') {
        // Force lock to rep mode
        appMode = 'rep';
        currentRepProfile = await idb.get('repProfile') || 'NORAN SHAH';
        adminPin = await idb.get('adminPin') || '1234';
        
        // Lock UI immediately
        lockToRepMode();
        
        console.log(' Rep Mode Enforced:', currentRepProfile);
    }
}

// --- 2. PREVENT ACCESS TO ADMIN TABS IN REP MODE ---
function preventAdminAccess() {
    if (appMode === 'rep') {
        // Override showTab function to block admin tabs
        const originalShowTab = window.showTab;
        window.showTab = function(tab) {
            const adminTabs = ['prod', 'sales', 'calc', 'factory', 'payments'];
            
            if (adminTabs.includes(tab)) {
                showToast(" Access Denied - Admin PIN Required", "warning");
                openAdminPinModal();
                return;
            }
            
            // Allow rep tab
            if (tab === 'rep' || !adminTabs.includes(tab)) {
                if (typeof originalShowTab === 'function') {
                    originalShowTab(tab);
                }
            }
        };
        
        // Hide admin tabs from navigation
        const navTabs = document.querySelectorAll('.tab-btn');
        navTabs.forEach((btn, index) => {
            const tabNames = ['prod', 'sales', 'calc', 'factory', 'payments'];
            if (tabNames.includes(tabNames[index])) {
                btn.style.display = 'none';
            }
        });
    }
}

// --- 3. ENHANCED UNLOCK FUNCTION ---
async function unlockAdminMode() {
    appMode = 'admin';
    await idb.set('appMode', 'admin');
    notifyDataChange('all');

    // Restore navigation
    const nav = document.querySelector('.nav-tabs');
    if(nav) nav.style.display = 'flex';
    
    // Show all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.style.display = '';
    });
    
    // Restore original showTab if it was overridden
    location.reload(); // Safest way to restore all functionality
}

// --- 4. INITIALIZE ON LOAD (ENHANCED) ---
document.addEventListener('DOMContentLoaded', async function() {
    // CRITICAL: Enforce mode lock first
    await enforceRepModeLock();
    
    // Then prevent access
    preventAdminAccess();
    
    // Pre-fill settings if in admin mode
    if (appMode === 'admin') {
        const pinInput = document.getElementById('setting-admin-pin');
        if(pinInput) pinInput.value = adminPin;
        
        const repSelect = document.getElementById('setting-rep-select');
        if(repSelect) repSelect.value = currentRepProfile;
    }
});





    async function deleteRepTransaction(id) {
    if (confirm("Delete this transaction permanently?")) {
        // 1. Filter out the transaction from the repSales array
        repSales = repSales.filter(transaction => transaction.id !== id);
        
        // 2. Save the updated array back to IndexedDB
        await idb.set('rep_sales', repSales);      notifyDataChange('all');

        // 3. REFRESH UI: Update the specific Rep History List
        // FIX: The function to render rep history is renderRepHistory(), not renderTodayActivity
        if (typeof renderRepHistory === 'function') {
            renderRepHistory();
        }
        
        // Also refresh the rep customer list table
        if (typeof renderRepCustomerTable === 'function') {
            renderRepCustomerTable();
        }

        // 4. Update stats and other tabs in background
        if (typeof refreshAllCalculations === 'function') {
            refreshAllCalculations();
        }
        
        // 5. Notify the sync system
        if (typeof notifyDataChange === 'function') {
            notifyDataChange('sales');
        }

        showToast("Transaction deleted successfully", "success");
    }
}

// --- NEW CUSTOMER DETECTION LOGIC ---

// Unified handler for inputting names
function handleCustomerInput(query, mode) {
    const isRep = mode === 'rep';
    const listId = isRep ? 'rep-customer-search-results' : 'customer-search-results';
    const phoneContainerId = isRep ? 'rep-new-customer-phone-container' : 'new-customer-phone-container';
    
    // 1. Run the existing search logic to populate dropdown
    if (isRep) {
        searchRepCustomers(query); 
    } else {
        searchCustomers(query);
    }

    const resultsDiv = document.getElementById(listId);
    const phoneContainer = document.getElementById(phoneContainerId);

    // 2. Check if the typed name matches an existing customer exactly
    // We get the list of existing names from our sales history/entities
    const allSales = isRep ? 
        repSales.filter(s => s.salesRep === currentRepProfile) : 
        customerSales.filter(s => s.isRepModeEntry !== true);
        
    const existingNames = [...new Set(allSales.map(s => s.customerName.toLowerCase()))];
    
    // If query has length AND is NOT in the existing list -> Show Phone Input
    if (query.length > 2 && !existingNames.includes(query.toLowerCase())) {
        phoneContainer.classList.remove('hidden');
    } else {
        phoneContainer.classList.add('hidden');
    }
}

// Update the selection function to hide phone field if existing customer selected
const originalSelectCustomer = window.selectCustomer || selectCustomer;
window.selectCustomer = function(name) {
    originalSelectCustomer(name); // Call original logic
    document.getElementById('new-customer-phone-container').classList.add('hidden');
    document.getElementById('new-cust-phone').value = ''; // Clear value
};

const originalSelectRepCustomer = window.selectRepCustomer || selectRepCustomer;
window.selectRepCustomer = function(name) {
    originalSelectRepCustomer(name); // Call original logic
    document.getElementById('rep-new-customer-phone-container').classList.add('hidden');
    document.getElementById('rep-new-cust-phone').value = ''; // Clear value
};


// ==========================================
// THEME INITIALIZATION
// ==========================================

// Initialize theme on page load
async function initTheme() {
    const savedTheme = await idb.get('theme') || 'dark';
    const html = document.documentElement;
    html.setAttribute('data-theme', savedTheme);
    
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        themeToggle.textContent = savedTheme === 'dark' ? '' : '';
        themeToggle.title = savedTheme === 'dark' ? "Switch to Light Mode" : "Switch to Dark Mode";
    }
    
    // Update meta theme-color
    const metaThemeColor = document.querySelector('meta[name="theme-color"]');
    if (metaThemeColor) {
        metaThemeColor.setAttribute('content', savedTheme === 'light' ? '#ffffff' : '#000000');
    }
}

// Run on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTheme);
} else {
    initTheme();
}



</script>
</body>
</html>
